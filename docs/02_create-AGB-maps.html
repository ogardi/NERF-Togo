<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4.2.2 Calibration et prédiction | SNSF-Togo_Manuel.utf8</title>
  <meta name="description" content="République Togolaise —<br />
Système Nationale de Surveillance des Forêts</div>" />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="4.2.2 Calibration et prédiction | SNSF-Togo_Manuel.utf8" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://ogardi.github.io/SNSF-Togo" />
  <meta property="og:image" content="https://ogardi.github.io/SNSF-Togoimages/NERF-Togo.png" />
  
  <meta name="github-repo" content="ogardi/NERF-Togo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4.2.2 Calibration et prédiction | SNSF-Togo_Manuel.utf8" />
  
  
  <meta name="twitter:image" content="https://ogardi.github.io/SNSF-Togoimages/NERF-Togo.png" />

<meta name="author" content="Oliver Gardi, Fifonsi Dangbo, Sophie Dzigbod, Ditorgue Bakabima" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="01_compile-IFN.html"/>
<link rel="next" href="00_analyse-ER.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://ogardi.github.io/SNSF-Togo"><b>Manuel SNSF Togo</b><br>NRF v1.1 ( <i>en révision</i> )</a></li>
<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Préface</a></li>
<li class="chapter" data-level="1" data-path="00_introduction.html"><a href="00_introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="01_arrangements.html"><a href="01_arrangements.html"><i class="fa fa-check"></i><b>1.1</b> Arrangements institutionelles</a></li>
<li class="chapter" data-level="1.2" data-path="02_how-to.html"><a href="02_how-to.html"><i class="fa fa-check"></i><b>1.2</b> Pour commencer</a><ul>
<li class="chapter" data-level="1.2.1" data-path="02_how-to.html"><a href="02_how-to.html#travailler-avec-le-snsf"><i class="fa fa-check"></i><b>1.2.1</b> Travailler avec le SNSF</a></li>
<li class="chapter" data-level="1.2.2" data-path="03_commencer.html"><a href="03_commencer.html"><i class="fa fa-check"></i><b>1.2.2</b> Structure du répértoire</a></li>
<li class="chapter" data-level="1.2.3" data-path="03_commencer.html"><a href="03_commencer.html#creation-dun-nouveau-projet"><i class="fa fa-check"></i><b>1.2.3</b> Création d’un nouveau projet</a></li>
<li class="chapter" data-level="1.2.4" data-path="03_commencer.html"><a href="03_commencer.html#NRF-set-up.R"><i class="fa fa-check"></i><b>1.2.4</b> Définition des variables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="00_STSS.html"><a href="00_STSS.html"><i class="fa fa-check"></i><b>2</b> Système de Surveillance Terrestre</a><ul>
<li class="chapter" data-level="2.1" data-path="01_Landsat.html"><a href="01_Landsat.html"><i class="fa fa-check"></i><b>2.1</b> Données de base</a><ul>
<li class="chapter" data-level="2.1.1" data-path="01_Landsat.html"><a href="01_Landsat.html#SSTS-Landsat"><i class="fa fa-check"></i><b>2.1.1</b> Images Landsat</a></li>
<li class="chapter" data-level="2.1.2" data-path="02_Worldclim.html"><a href="02_Worldclim.html"><i class="fa fa-check"></i><b>2.1.2</b> WorldClim</a></li>
<li class="chapter" data-level="2.1.3" data-path="03_SRTM.html"><a href="03_SRTM.html"><i class="fa fa-check"></i><b>2.1.3</b> SRTM</a></li>
<li class="chapter" data-level="2.1.4" data-path="04_SoilGrids.html"><a href="04_SoilGrids.html"><i class="fa fa-check"></i><b>2.1.4</b> SoilGrids</a></li>
<li class="chapter" data-level="2.1.5" data-path="05_ProREDD.html"><a href="05_ProREDD.html"><i class="fa fa-check"></i><b>2.1.5</b> ProREDD</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="01_sampling-grid.html"><a href="01_sampling-grid.html"><i class="fa fa-check"></i><b>2.2</b> Collecte des données</a><ul>
<li class="chapter" data-level="2.2.1" data-path="01_sampling-grid.html"><a href="01_sampling-grid.html#reseau-dechantillonnage"><i class="fa fa-check"></i><b>2.2.1</b> Réseau d’échantillonnage</a></li>
<li class="chapter" data-level="2.2.2" data-path="02_training-plots.html"><a href="02_training-plots.html"><i class="fa fa-check"></i><b>2.2.2</b> Parcelles d’entraînement</a></li>
<li class="chapter" data-level="2.2.3" data-path="03_validation-plots.html"><a href="03_validation-plots.html"><i class="fa fa-check"></i><b>2.2.3</b> Parcelles de validation</a></li>
<li class="chapter" data-level="2.2.4" data-path="04_outil-QGIS.html"><a href="04_outil-QGIS.html"><i class="fa fa-check"></i><b>2.2.4</b> Outil QGIS</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="00_IFN.html"><a href="00_IFN.html"><i class="fa fa-check"></i><b>3</b> Inventaire Forestier National</a><ul>
<li class="chapter" data-level="3.1" data-path="01_IFN-1.html"><a href="01_IFN-1.html"><i class="fa fa-check"></i><b>3.1</b> IFN-1 (2015/16)</a><ul>
<li class="chapter" data-level="3.1.1" data-path="01_IFN-1.html"><a href="01_IFN-1.html#methode"><i class="fa fa-check"></i><b>3.1.1</b> <span>Méthode</span></a></li>
<li class="chapter" data-level="3.1.2" data-path="01_IFN-1.html"><a href="01_IFN-1.html#donnees"><i class="fa fa-check"></i><b>3.1.2</b> Données</a></li>
<li class="chapter" data-level="3.1.3" data-path="01_IFN-1.html"><a href="01_IFN-1.html#resultats"><i class="fa fa-check"></i><b>3.1.3</b> <span>Résultats</span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="00_NRF-MRV.html"><a href="00_NRF-MRV.html"><i class="fa fa-check"></i><b>4</b> Analyses NRF/MRV</a><ul>
<li class="chapter" data-level="4.1" data-path="00_analyse-FCC.html"><a href="00_analyse-FCC.html"><i class="fa fa-check"></i><b>4.1</b> Analyse surfaces forestiers</a><ul>
<li class="chapter" data-level="4.1.1" data-path="01_create-FC-maps.html"><a href="01_create-FC-maps.html"><i class="fa fa-check"></i><b>4.1.1</b> Production des cartes Forêt/Non-Forêt</a></li>
<li class="chapter" data-level="4.1.2" data-path="02_clean-FC-maps.html"><a href="02_clean-FC-maps.html"><i class="fa fa-check"></i><b>4.1.2</b> Nettoyage des cartes brutes</a></li>
<li class="chapter" data-level="4.1.3" data-path="03_validate-FC-maps.html"><a href="03_validate-FC-maps.html"><i class="fa fa-check"></i><b>4.1.3</b> Validation des cartes</a></li>
<li class="chapter" data-level="4.1.4" data-path="04_FC-maps-accuracy.html"><a href="04_FC-maps-accuracy.html"><i class="fa fa-check"></i><b>4.1.4</b> Analyse de la précision</a></li>
<li class="chapter" data-level="4.1.5" data-path="05_analyse-FC-maps.html"><a href="05_analyse-FC-maps.html"><i class="fa fa-check"></i><b>4.1.5</b> Analyse des cartes</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="00_analyse-AGB.html"><a href="00_analyse-AGB.html"><i class="fa fa-check"></i><b>4.2</b> Analyse biomasse aérienne</a><ul>
<li class="chapter" data-level="4.2.1" data-path="01_compile-IFN.html"><a href="01_compile-IFN.html"><i class="fa fa-check"></i><b>4.2.1</b> Analyse des données IFN</a></li>
<li class="chapter" data-level="4.2.2" data-path="02_create-AGB-maps.html"><a href="02_create-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.2</b> Calibration et prédiction</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="00_analyse-ER.html"><a href="00_analyse-ER.html"><i class="fa fa-check"></i><b>4.3</b> Analyse émissions/séquestrations</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/ogardi/SNSF-Togo">Dépôt du code sur GitHub</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><div class="line-block">République Togolaise —<br />
Système Nationale de Surveillance des Forêts</div></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="NRF-agb-maps" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Calibration et prédiction</h3>
<div id="description-1" class="section level4 unnumbered">
<h4>Description</h4>
<p>A partir de la <strong>biomasse aérienne déterminée sur les parcelles IFN en 2015/16</strong> (t/ha matière sèche), un modèle de biomasse est calibré sur bases de <a href="01_Landsat.html#SSTS-Landsat">l’image satellitaire Landsat</a> de 2015 (bandes et indices <code>B, G, R, NIR, SWIR1, SWIR2, nbr, ndmi, ndvi, evi</code>) et les <a href="02_Worldclim.html#SSTS-Worldclim">données climatiques Worldclim</a> (<code>BIO1, BIO4, BIO12, BIO15</code>). Ce sont les mêmes variables qui ont déjà été utilisées pour la <a href="01_create-FC-maps.html#NRF-create-fc-maps">classification forêt/non-forêt</a>.</p>
<p><strong>Dans une première étape, les variables sont extraites</strong>, c’est-à-dire que les valeurs des pixels sous les rayons des parcelles sont lues à partir des images Landsat et Worldclim et moyennées en conséquence. Ensuite, les variable sont mis en correspandance avec les biomasses aériennes à travers un <strong>modèle de régression <code>RandomForest</code></strong>. Ce modèle est utilisé pour créer une carte de la biomasse aérienne pour l’année 2015.</p>
<p>En supposant que la biomasse sur la plupart des pixels reste constante, <strong>la carte de la biomasse aérienne 2015 est utilisée comme base pour calibrer des cartes pour les années 2003 et 2018</strong> (début et fin de la période de référence) avec la même méthode: 0,1% des pixels de la carte de la biomasse 2015 (environ 100 000 pixels) sont utilisés comme pixels d’entraînement pour la calibration d’un modèle RandomForest qui est ensuite utilisé pour la production de la carte.</p>
</div>
<div id="example-8" class="section level4">
<h4><span class="header-section-number">4.2.2.1</span> Example</h4>
<p>Répartition spatiale des <strong>945 placettes d’inventaire de l’IFN-1</strong> (la taille du cercle correspond à la biomasse trouvée sur les placettes) et carte de la biomasse aérienne résultant. Le diagramme de dispersion montre la correlation entre la biomasse sur la carte et celle trouvé sur les parcelles de l’IFN (R<sup>2</sup> = 70.7%). La carte sous-estime les fortes biomasses (effet de saturation).</p>
<p><img src="images/AGB-refmap-2015.png" /></p>
<p>Utilisation de la <strong>carte de biomasse 2015 comme référence pour la calibration des cartes 2003 et 2018</strong>. Le détail montre une région au sud de Kpalimé.</p>
<p><img src="images/AGB-rawmaps.png" /></p>
</div>
<div id="script-r-03_nrf-mrv02_agb_src02_create-agb-maps.r" class="section level4 unnumbered">
<h4>Script R: <code>03_NRF-MRV/02_AGB/_src/02_create-AGB-maps.R</code></h4>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="co">###############################################################################</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="co"># 02_create-AGB-maps.R: Modélisation et création des cartes de biomasse</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="co"># -----------------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co"># Bern University of Applied Sciences</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="co"># Oliver Gardi, &lt;oliver.gardi@bfh.ch&gt;</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="co"># 13 Mai 2020</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="co"># Définitions des variables ===================================================</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"></a>
<a class="sourceLine" id="cb22-10" data-line-number="10">AGB.STRATA     &lt;-<span class="st"> </span><span class="dv">10</span>     <span class="co"># Nombre de strates de biomasse pour l&#39;échantillonnage</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11">N.PIXELS       &lt;-<span class="st"> </span><span class="ot">NA</span>     <span class="co"># Nombre de pixels non-NA (sera déterminé plus tard)</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12">SAMPLE.RATIO   &lt;-<span class="st"> </span><span class="fl">0.001</span>  <span class="co"># Rapport des pixels non-NA à échantilloner</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13">CAL.RATIO      &lt;-<span class="st"> </span><span class="dv">1</span>      <span class="co"># Rapport des pixels à échantillonner pour la calibration </span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14"></a>
<a class="sourceLine" id="cb22-15" data-line-number="15"><span class="co"># Bandes à utiliser pour la modélisation forêt vs. non-forêt</span></a>
<a class="sourceLine" id="cb22-16" data-line-number="16">PREDICTORS  &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;B&quot;</span>, <span class="st">&quot;G&quot;</span>, <span class="st">&quot;R&quot;</span>, <span class="st">&quot;NIR&quot;</span>, <span class="st">&quot;SWIR1&quot;</span>, <span class="st">&quot;SWIR2&quot;</span>,</a>
<a class="sourceLine" id="cb22-17" data-line-number="17">                 <span class="st">&quot;nbr&quot;</span>, <span class="st">&quot;ndmi&quot;</span>, <span class="st">&quot;ndvi&quot;</span>, <span class="st">&quot;evi&quot;</span>,          </a>
<a class="sourceLine" id="cb22-18" data-line-number="18">                 <span class="st">&quot;BIO1&quot;</span>, <span class="st">&quot;BIO4&quot;</span>, <span class="st">&quot;BIO12&quot;</span>, <span class="st">&quot;BIO15&quot;</span>) </a>
<a class="sourceLine" id="cb22-19" data-line-number="19"></a>
<a class="sourceLine" id="cb22-20" data-line-number="20"><span class="co"># Répertoires</span></a>
<a class="sourceLine" id="cb22-21" data-line-number="21">LANDSAT.DIR &lt;-<span class="st"> </span>DIR.SST.DAT.LST</a>
<a class="sourceLine" id="cb22-22" data-line-number="22">WORLDCLIM.DIR &lt;-<span class="st"> </span>DIR.SST.DAT.WC2</a>
<a class="sourceLine" id="cb22-23" data-line-number="23">REF.DIR &lt;-<span class="st"> </span>DIR.MRV.AGB.REF</a>
<a class="sourceLine" id="cb22-24" data-line-number="24"></a>
<a class="sourceLine" id="cb22-25" data-line-number="25"></a>
<a class="sourceLine" id="cb22-26" data-line-number="26"><span class="co"># Définitions des fonctions ===================================================</span></a>
<a class="sourceLine" id="cb22-27" data-line-number="27"></a>
<a class="sourceLine" id="cb22-28" data-line-number="28"><span class="co"># Charger un image Landsat ----------------------------------------------------</span></a>
<a class="sourceLine" id="cb22-29" data-line-number="29"><span class="co">#</span></a>
<a class="sourceLine" id="cb22-30" data-line-number="30"><span class="co"># @param filename  Chemin du fichier landsat</span></a>
<a class="sourceLine" id="cb22-31" data-line-number="31"><span class="co">#</span></a>
<a class="sourceLine" id="cb22-32" data-line-number="32"><span class="co"># @return          Image Landsat avec bandes nommées </span></a>
<a class="sourceLine" id="cb22-33" data-line-number="33"><span class="co">#</span></a>
<a class="sourceLine" id="cb22-34" data-line-number="34"></a>
<a class="sourceLine" id="cb22-35" data-line-number="35">load.image &lt;-<span class="st"> </span><span class="cf">function</span>(filename) {</a>
<a class="sourceLine" id="cb22-36" data-line-number="36">  image &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="kw">paste0</span>(LANDSAT.DIR, filename))</a>
<a class="sourceLine" id="cb22-37" data-line-number="37">  <span class="kw">names</span>(image) &lt;-<span class="st"> </span>SST.LSBANDS</a>
<a class="sourceLine" id="cb22-38" data-line-number="38">  <span class="kw">return</span>(image)</a>
<a class="sourceLine" id="cb22-39" data-line-number="39">}</a>
<a class="sourceLine" id="cb22-40" data-line-number="40"></a>
<a class="sourceLine" id="cb22-41" data-line-number="41"><span class="co"># Prédiction d&#39;une carte biomasse ---------------------------------------------</span></a>
<a class="sourceLine" id="cb22-42" data-line-number="42"><span class="co">#</span></a>
<a class="sourceLine" id="cb22-43" data-line-number="43"><span class="co"># @param image      Image Landsat à classifier      </span></a>
<a class="sourceLine" id="cb22-44" data-line-number="44"><span class="co"># @param filename   Nom de fichier pour la sauvegarde de la carte</span></a>
<a class="sourceLine" id="cb22-45" data-line-number="45"><span class="co"># @param bioclim    Raster des variables bioclimatiques à utiliser</span></a>
<a class="sourceLine" id="cb22-46" data-line-number="46"><span class="co"># @param train.dat  Tableau des données d&#39;entraînement</span></a>
<a class="sourceLine" id="cb22-47" data-line-number="47"><span class="co"># @param ref.map    Carte de référence</span></a>
<a class="sourceLine" id="cb22-48" data-line-number="48"><span class="co"># @param n.ref.map  Nombre de points à échantilloner</span></a>
<a class="sourceLine" id="cb22-49" data-line-number="49"><span class="co"># @param cal.map    Carte de calibration (autre chemin WRS)</span></a>
<a class="sourceLine" id="cb22-50" data-line-number="50"><span class="co"># @param n.cal.map  Nombre de points à échantilloner</span></a>
<a class="sourceLine" id="cb22-51" data-line-number="51"><span class="co"># @param mask       Masque à utiliser pour ref.map et cal.map</span></a>
<a class="sourceLine" id="cb22-52" data-line-number="52"><span class="co"># @param preds      Variables à utiliser pour le modèle</span></a>
<a class="sourceLine" id="cb22-53" data-line-number="53"><span class="co"># @param type       Modèle de classification ou de regression</span></a>
<a class="sourceLine" id="cb22-54" data-line-number="54"><span class="co"># @param crossval   Faire validation croisée (3 * 10-fold)</span></a>
<a class="sourceLine" id="cb22-55" data-line-number="55"><span class="co"># @param bias.corr  Faire une correction linéaire du bias</span></a>
<a class="sourceLine" id="cb22-56" data-line-number="56"><span class="co"># @param n.cores    Nombre de processeurs à utiliser pour prédiction</span></a>
<a class="sourceLine" id="cb22-57" data-line-number="57"><span class="co">#</span></a>
<a class="sourceLine" id="cb22-58" data-line-number="58"><span class="co"># @return           List avec les éléments </span></a>
<a class="sourceLine" id="cb22-59" data-line-number="59"><span class="co">#                   - model RandomForest, </span></a>
<a class="sourceLine" id="cb22-60" data-line-number="60"><span class="co">#                   - model linéaire du correction du bias</span></a>
<a class="sourceLine" id="cb22-61" data-line-number="61"><span class="co">#                   - carte biomasse</span></a>
<a class="sourceLine" id="cb22-62" data-line-number="62"><span class="co">#</span></a>
<a class="sourceLine" id="cb22-63" data-line-number="63"></a>
<a class="sourceLine" id="cb22-64" data-line-number="64">agb.map &lt;-<span class="st"> </span><span class="cf">function</span>(image, filename, <span class="dt">bioclim=</span><span class="ot">NULL</span>, <span class="dt">train.dat=</span><span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb22-65" data-line-number="65">                    <span class="dt">ref.map=</span><span class="ot">NULL</span>, <span class="dt">n.ref.map=</span><span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb22-66" data-line-number="66">                    <span class="dt">cal.map=</span><span class="ot">NULL</span>, <span class="dt">n.cal.map=</span><span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb22-67" data-line-number="67">                    <span class="dt">mask=</span><span class="ot">NULL</span>, <span class="dt">preds=</span><span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb22-68" data-line-number="68">                    <span class="dt">crossval=</span><span class="ot">FALSE</span>, <span class="dt">bias.corr=</span><span class="ot">TRUE</span>, <span class="dt">n.cores=</span><span class="dv">8</span>) {</a>
<a class="sourceLine" id="cb22-69" data-line-number="69">  </a>
<a class="sourceLine" id="cb22-70" data-line-number="70">  <span class="co"># Ouvrir le fichier journal</span></a>
<a class="sourceLine" id="cb22-71" data-line-number="71">  name &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;[.]tif$&quot;</span>, <span class="st">&quot;&quot;</span>, filename)</a>
<a class="sourceLine" id="cb22-72" data-line-number="72">  txtfile &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">sub</span>(<span class="st">&quot;[.]tif$&quot;</span>, <span class="st">&quot;&quot;</span>, filename), <span class="st">&quot;.txt&quot;</span>)</a>
<a class="sourceLine" id="cb22-73" data-line-number="73">  <span class="kw">cat</span>(<span class="st">&quot;-- Biomass map: &quot;</span>, <span class="kw">basename</span>(filename), <span class="st">&quot;/&quot;</span>, <span class="kw">date</span>(), <span class="st">&quot; --</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">file=</span>txtfile)</a>
<a class="sourceLine" id="cb22-74" data-line-number="74">  </a>
<a class="sourceLine" id="cb22-75" data-line-number="75">  <span class="co"># Tirer des données d&#39;entraînement d&#39;une carte de référence -------</span></a>
<a class="sourceLine" id="cb22-76" data-line-number="76">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(ref.map)) {</a>
<a class="sourceLine" id="cb22-77" data-line-number="77">    <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="st">&quot;    -Masking / buffering reference map ... </span><span class="ch">\n</span><span class="st">&quot;</span>))</a>
<a class="sourceLine" id="cb22-78" data-line-number="78">    <span class="co"># ... couper/masquer avec l&#39;image</span></a>
<a class="sourceLine" id="cb22-79" data-line-number="79">    ref.map  &lt;-<span class="st"> </span><span class="kw">mask</span>(<span class="kw">crop</span>(ref.map, image[[<span class="dv">1</span>]]), <span class="kw">crop</span>(image[[<span class="dv">1</span>]], ref.map))</a>
<a class="sourceLine" id="cb22-80" data-line-number="80">    <span class="co"># ... et masque additionelle (si disponible) </span></a>
<a class="sourceLine" id="cb22-81" data-line-number="81">    <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(mask)) ref.map &lt;-<span class="st"> </span><span class="kw">mask</span>(ref.map, mask)                     </a>
<a class="sourceLine" id="cb22-82" data-line-number="82">    <span class="co"># Découper la carte de calibration (si disponible) </span></a>
<a class="sourceLine" id="cb22-83" data-line-number="83">    <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(cal.map)) {</a>
<a class="sourceLine" id="cb22-84" data-line-number="84">       tmp &lt;-<span class="st"> </span><span class="kw">extend</span>(<span class="kw">crop</span>(cal.map, ref.map), ref.map)</a>
<a class="sourceLine" id="cb22-85" data-line-number="85">       ref.map &lt;-<span class="st"> </span><span class="kw">mask</span>(ref.map, tmp, <span class="dt">inverse=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-86" data-line-number="86">    }</a>
<a class="sourceLine" id="cb22-87" data-line-number="87">    <span class="kw">cat</span>(<span class="st">&quot;    &quot;</span>)</a>
<a class="sourceLine" id="cb22-88" data-line-number="88">    <span class="co"># Tirer des points d&#39;échantillon (stratifié selon classe biomasse) ...</span></a>
<a class="sourceLine" id="cb22-89" data-line-number="89">    <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="st">&quot;    -Sampling map (n=&quot;</span>, AGB.STRATA, <span class="st">&quot;*&quot;</span>, <span class="kw">round</span>(n.ref.map<span class="op">/</span>AGB.STRATA), <span class="st">&quot;) ... &quot;</span>))</a>
<a class="sourceLine" id="cb22-90" data-line-number="90">    ref.pts &lt;-<span class="st"> </span><span class="kw">sampleStratified</span>(<span class="kw">cut</span>(ref.map, AGB.STRATA), </a>
<a class="sourceLine" id="cb22-91" data-line-number="91">                                <span class="kw">round</span>(n.ref.map<span class="op">/</span>AGB.STRATA), <span class="dt">sp=</span><span class="ot">TRUE</span>)[,<span class="op">-</span><span class="dv">1</span>]  </a>
<a class="sourceLine" id="cb22-92" data-line-number="92">    <span class="kw">names</span>(ref.pts) &lt;-<span class="st"> &quot;AGB&quot;</span></a>
<a class="sourceLine" id="cb22-93" data-line-number="93">    <span class="co"># ... extraire les valeurs spectrales et bioclimatique correspondantes ...</span></a>
<a class="sourceLine" id="cb22-94" data-line-number="94">    <span class="kw">cat</span>(<span class="st">&quot;extracting values ... </span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb22-95" data-line-number="95">    ref.dat &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">AGB=</span>raster<span class="op">::</span><span class="kw">extract</span>(ref.map, ref.pts, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="op">-</span><span class="dv">1</span>], </a>
<a class="sourceLine" id="cb22-96" data-line-number="96">                     raster<span class="op">::</span><span class="kw">extract</span>(image, ref.pts, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="op">-</span><span class="dv">1</span>],</a>
<a class="sourceLine" id="cb22-97" data-line-number="97">                     raster<span class="op">::</span><span class="kw">extract</span>(bioclim, ref.pts, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb22-98" data-line-number="98">    </a>
<a class="sourceLine" id="cb22-99" data-line-number="99">    <span class="kw">cat</span>(<span class="st">&quot;Ref-map points: &quot;</span>, <span class="kw">nrow</span>(ref.dat), <span class="st">&quot;/&quot;</span>, ref.map<span class="op">@</span>file<span class="op">@</span>name, <span class="dt">file=</span>txtfile, <span class="dt">append=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-100" data-line-number="100">    <span class="co"># ... et ajouter aux données d&#39;entraînement (si disponible)</span></a>
<a class="sourceLine" id="cb22-101" data-line-number="101">    <span class="cf">if</span>(<span class="kw">is.null</span>(train.dat)) {</a>
<a class="sourceLine" id="cb22-102" data-line-number="102">      train.dat &lt;-<span class="st"> </span>ref.dat</a>
<a class="sourceLine" id="cb22-103" data-line-number="103">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb22-104" data-line-number="104">      train.dat &lt;-<span class="st"> </span><span class="kw">rbind</span>(train.dat, ref.dat)</a>
<a class="sourceLine" id="cb22-105" data-line-number="105">    }</a>
<a class="sourceLine" id="cb22-106" data-line-number="106">  }</a>
<a class="sourceLine" id="cb22-107" data-line-number="107">  </a>
<a class="sourceLine" id="cb22-108" data-line-number="108">  <span class="co"># Ajouter des points d&#39;une carte de calibration -------------------</span></a>
<a class="sourceLine" id="cb22-109" data-line-number="109">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(cal.map)) {</a>
<a class="sourceLine" id="cb22-110" data-line-number="110">    <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="st">&quot;    -Masking calibration map ... </span><span class="ch">\n</span><span class="st">&quot;</span>))</a>
<a class="sourceLine" id="cb22-111" data-line-number="111">    <span class="co"># ... couper/masquer avec l&#39;image</span></a>
<a class="sourceLine" id="cb22-112" data-line-number="112">    cal.map  &lt;-<span class="st"> </span><span class="kw">mask</span>(<span class="kw">crop</span>(cal.map, image[[<span class="dv">1</span>]]), <span class="kw">crop</span>(image[[<span class="dv">1</span>]], cal.map))</a>
<a class="sourceLine" id="cb22-113" data-line-number="113">    <span class="co"># ... et masque additionelle (si disponible)</span></a>
<a class="sourceLine" id="cb22-114" data-line-number="114">    <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(mask)) cal.map &lt;-<span class="st"> </span><span class="kw">mask</span>(cal.map, mask)</a>
<a class="sourceLine" id="cb22-115" data-line-number="115">    <span class="co"># Tirer des points d&#39;échantillon (stratifié selon classe biomasse) ...</span></a>
<a class="sourceLine" id="cb22-116" data-line-number="116">    <span class="kw">cat</span>(<span class="kw">paste0</span>(<span class="st">&quot;    -Sampling map (n=&quot;</span>, AGB.STRATA, <span class="st">&quot;*&quot;</span>, <span class="kw">round</span>(n.cal.map<span class="op">/</span>AGB.STRATA), <span class="st">&quot;) ... &quot;</span>))</a>
<a class="sourceLine" id="cb22-117" data-line-number="117">    cal.pts &lt;-<span class="st"> </span><span class="kw">sampleStratified</span>(<span class="kw">cut</span>(cal.map, AGB.STRATA), </a>
<a class="sourceLine" id="cb22-118" data-line-number="118">                                <span class="kw">round</span>(n.cal.map<span class="op">/</span>AGB.STRATA), <span class="dt">sp=</span><span class="ot">TRUE</span>)[,<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb22-119" data-line-number="119">    <span class="kw">names</span>(cal.pts) &lt;-<span class="st"> &quot;AGB&quot;</span></a>
<a class="sourceLine" id="cb22-120" data-line-number="120">    <span class="co"># ... extraire les valeurs spectrales et bioclimatique correspondantes ...</span></a>
<a class="sourceLine" id="cb22-121" data-line-number="121">    <span class="kw">cat</span>(<span class="st">&quot;extracting values ... </span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb22-122" data-line-number="122">    cal.dat &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">AGB=</span>raster<span class="op">::</span><span class="kw">extract</span>(cal.map, cal.pts, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="op">-</span><span class="dv">1</span>], </a>
<a class="sourceLine" id="cb22-123" data-line-number="123">                     raster<span class="op">::</span><span class="kw">extract</span>(image, cal.pts, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="op">-</span><span class="dv">1</span>],</a>
<a class="sourceLine" id="cb22-124" data-line-number="124">                     raster<span class="op">::</span><span class="kw">extract</span>(bioclim, cal.pts, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb22-125" data-line-number="125">    <span class="co"># ... et ajouter aux points d&#39;entraînement</span></a>
<a class="sourceLine" id="cb22-126" data-line-number="126">    <span class="cf">if</span>(<span class="kw">is.null</span>(train.dat)) {</a>
<a class="sourceLine" id="cb22-127" data-line-number="127">        train.dat &lt;-<span class="st"> </span>cal.dat</a>
<a class="sourceLine" id="cb22-128" data-line-number="128">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb22-129" data-line-number="129">        train.dat &lt;-<span class="st"> </span><span class="kw">rbind</span>(train.dat, cal.dat)</a>
<a class="sourceLine" id="cb22-130" data-line-number="130">    }</a>
<a class="sourceLine" id="cb22-131" data-line-number="131">    <span class="kw">cat</span>(<span class="st">&quot;Cal-map points: &quot;</span>, <span class="kw">nrow</span>(cal.dat), </a>
<a class="sourceLine" id="cb22-132" data-line-number="132">        <span class="st">&quot;from&quot;</span>, cal.map<span class="op">@</span>file<span class="op">@</span>name, <span class="dt">file=</span>txtfile, <span class="dt">append=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-133" data-line-number="133">  }</a>
<a class="sourceLine" id="cb22-134" data-line-number="134">  <span class="co"># Nombre total des points d&#39;entraînement</span></a>
<a class="sourceLine" id="cb22-135" data-line-number="135">  <span class="kw">cat</span>(<span class="st">&quot;Total points:   &quot;</span>, <span class="kw">nrow</span>(train.dat), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">file=</span>txtfile, <span class="dt">append=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-136" data-line-number="136">  </a>
<a class="sourceLine" id="cb22-137" data-line-number="137">  </a>
<a class="sourceLine" id="cb22-138" data-line-number="138">  <span class="co"># Calibration du modèle Random Forest -----------------------------</span></a>
<a class="sourceLine" id="cb22-139" data-line-number="139">  <span class="co"># Utiliser toutes les variables si non-spécifiées dans les paramètres</span></a>
<a class="sourceLine" id="cb22-140" data-line-number="140">  <span class="cf">if</span>(<span class="kw">is.null</span>(preds)) {</a>
<a class="sourceLine" id="cb22-141" data-line-number="141">    preds &lt;-<span class="st"> </span><span class="kw">names</span>(image)</a>
<a class="sourceLine" id="cb22-142" data-line-number="142">    <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(bioclim)) preds &lt;-<span class="st"> </span><span class="kw">c</span>(preds, <span class="kw">names</span>(bioclim))</a>
<a class="sourceLine" id="cb22-143" data-line-number="143">  }</a>
<a class="sourceLine" id="cb22-144" data-line-number="144">  <span class="co"># calibrer RandomForest (mode de régression) </span></a>
<a class="sourceLine" id="cb22-145" data-line-number="145">  <span class="kw">cat</span>(<span class="st">&quot;    -Calibrating RandomForest ... &quot;</span>)</a>
<a class="sourceLine" id="cb22-146" data-line-number="146">  <span class="kw">sink</span>(txtfile, <span class="dt">append=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-147" data-line-number="147">  <span class="co"># Utiliser caret::train pour validation croisée (a besoin de beaucoup de temps)</span></a>
<a class="sourceLine" id="cb22-148" data-line-number="148">  <span class="cf">if</span>(crossval) {</a>
<a class="sourceLine" id="cb22-149" data-line-number="149">    map.model.cv &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="dt">y =</span> train.dat[,<span class="dv">1</span>], </a>
<a class="sourceLine" id="cb22-150" data-line-number="150">                          <span class="dt">x =</span> train.dat[,preds],</a>
<a class="sourceLine" id="cb22-151" data-line-number="151">                          <span class="dt">method =</span> <span class="st">&quot;rf&quot;</span>,              <span class="co"># RandomForest</span></a>
<a class="sourceLine" id="cb22-152" data-line-number="152">                          <span class="dt">importance =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb22-153" data-line-number="153">                          <span class="dt">trControl =</span> <span class="kw">trainControl</span>(</a>
<a class="sourceLine" id="cb22-154" data-line-number="154">                            <span class="dt">method =</span> <span class="st">&quot;repeatedcv&quot;</span>,</a>
<a class="sourceLine" id="cb22-155" data-line-number="155">                            <span class="dt">number =</span> <span class="dv">10</span>,              <span class="co"># k-fold</span></a>
<a class="sourceLine" id="cb22-156" data-line-number="156">                            <span class="dt">repeats =</span> <span class="dv">3</span>))             <span class="co"># répétitions</span></a>
<a class="sourceLine" id="cb22-157" data-line-number="157">    <span class="kw">print</span>(map.model.cv)</a>
<a class="sourceLine" id="cb22-158" data-line-number="158">    map.model &lt;-<span class="st"> </span>map.model.cv<span class="op">$</span>finalModel</a>
<a class="sourceLine" id="cb22-159" data-line-number="159">    <span class="kw">print</span>(map.model)</a>
<a class="sourceLine" id="cb22-160" data-line-number="160">    <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb22-161" data-line-number="161">    <span class="kw">print</span>(<span class="kw">varImp</span>(map.model, <span class="dt">scale=</span><span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb22-162" data-line-number="162">  <span class="co"># autrement randomForest directement</span></a>
<a class="sourceLine" id="cb22-163" data-line-number="163">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb22-164" data-line-number="164">    map.model &lt;-<span class="st"> </span><span class="kw">randomForest</span>(<span class="dt">y=</span>train.dat[,<span class="dv">1</span>], <span class="dt">x=</span>train.dat[,preds], </a>
<a class="sourceLine" id="cb22-165" data-line-number="165">                              <span class="dt">importance=</span><span class="ot">TRUE</span>) <span class="co"># , do.trace=100)</span></a>
<a class="sourceLine" id="cb22-166" data-line-number="166">    <span class="kw">print</span>(map.model)</a>
<a class="sourceLine" id="cb22-167" data-line-number="167">    <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb22-168" data-line-number="168">    <span class="kw">print</span>(<span class="kw">varImp</span>(map.model))</a>
<a class="sourceLine" id="cb22-169" data-line-number="169">  }</a>
<a class="sourceLine" id="cb22-170" data-line-number="170">  <span class="kw">sink</span>()</a>
<a class="sourceLine" id="cb22-171" data-line-number="171">  <span class="co"># Mesures des erreurs</span></a>
<a class="sourceLine" id="cb22-172" data-line-number="172">  <span class="kw">cat</span>(<span class="st">&quot;R2:&quot;</span>, <span class="kw">round</span>(map.model<span class="op">$</span>rsq[<span class="dv">500</span>], <span class="dv">2</span>), </a>
<a class="sourceLine" id="cb22-173" data-line-number="173">      <span class="st">&quot;RMSE:&quot;</span>, <span class="kw">round</span>(<span class="kw">sqrt</span>(map.model<span class="op">$</span>mse[<span class="dv">500</span>]), <span class="dv">2</span>), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb22-174" data-line-number="174">  <span class="co"># Model linéaire de correction du bias</span></a>
<a class="sourceLine" id="cb22-175" data-line-number="175">  <span class="cf">if</span>(bias.corr) {</a>
<a class="sourceLine" id="cb22-176" data-line-number="176">    bc &lt;-<span class="st"> </span><span class="kw">lm</span>(train.dat<span class="op">$</span>AGB <span class="op">~</span><span class="st"> </span>map.model<span class="op">$</span>predicted)</a>
<a class="sourceLine" id="cb22-177" data-line-number="177">    <span class="kw">sink</span>(<span class="kw">paste0</span>(name, <span class="st">&quot;_bc.txt&quot;</span>), <span class="dt">split=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-178" data-line-number="178">    <span class="kw">print</span>(<span class="kw">summary</span>(bc))</a>
<a class="sourceLine" id="cb22-179" data-line-number="179">    <span class="kw">sink</span>()</a>
<a class="sourceLine" id="cb22-180" data-line-number="180">    <span class="kw">save</span>(bc, <span class="dt">file=</span><span class="kw">paste0</span>(name, <span class="st">&quot;_bc.RData&quot;</span>))</a>
<a class="sourceLine" id="cb22-181" data-line-number="181">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb22-182" data-line-number="182">    bc &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb22-183" data-line-number="183">  }</a>
<a class="sourceLine" id="cb22-184" data-line-number="184">  <span class="co"># Diagramme de dispersion prédiction vs. observation</span></a>
<a class="sourceLine" id="cb22-185" data-line-number="185">  <span class="kw">pdf</span>(<span class="kw">paste0</span>(name, <span class="st">&quot;.pdf&quot;</span>))</a>
<a class="sourceLine" id="cb22-186" data-line-number="186">  <span class="kw">plot</span>(train.dat<span class="op">$</span>AGB <span class="op">~</span><span class="st"> </span>map.model<span class="op">$</span>predicted, </a>
<a class="sourceLine" id="cb22-187" data-line-number="187">       <span class="dt">ylab=</span><span class="st">&quot;AGB (tDM/ha)&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;Predicted AGB (tDM/ha)&quot;</span>)</a>
<a class="sourceLine" id="cb22-188" data-line-number="188">  <span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb22-189" data-line-number="189">  <span class="cf">if</span>(bias.corr) {</a>
<a class="sourceLine" id="cb22-190" data-line-number="190">    <span class="kw">abline</span>(bc, <span class="dt">lty=</span><span class="dv">3</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb22-191" data-line-number="191">  }</a>
<a class="sourceLine" id="cb22-192" data-line-number="192">  <span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb22-193" data-line-number="193">  </a>
<a class="sourceLine" id="cb22-194" data-line-number="194">  <span class="co"># Classification de la carte biomasse -----------------------------</span></a>
<a class="sourceLine" id="cb22-195" data-line-number="195">  <span class="kw">dir.create</span>(<span class="kw">dirname</span>(filename), <span class="dt">recursive=</span><span class="ot">TRUE</span>, <span class="dt">showWarnings=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb22-196" data-line-number="196">  <span class="kw">cat</span>(<span class="st">&quot;    -Creating map ... &quot;</span>)</a>
<a class="sourceLine" id="cb22-197" data-line-number="197">  <span class="co"># empiler les couches Landsat et bioclim</span></a>
<a class="sourceLine" id="cb22-198" data-line-number="198">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(bioclim)) image &lt;-<span class="st"> </span><span class="kw">stack</span>(image, <span class="kw">crop</span>(bioclim, image))</a>
<a class="sourceLine" id="cb22-199" data-line-number="199">  <span class="co"># classifier l&#39;image sur différents procésseurs en parallèle</span></a>
<a class="sourceLine" id="cb22-200" data-line-number="200">  <span class="kw">beginCluster</span>(<span class="dt">n=</span>n.cores)</a>
<a class="sourceLine" id="cb22-201" data-line-number="201">  map &lt;-<span class="st"> </span><span class="kw">clusterR</span>(image, predict, <span class="dt">args=</span><span class="kw">list</span>(<span class="dt">model=</span>map.model))</a>
<a class="sourceLine" id="cb22-202" data-line-number="202">  <span class="kw">endCluster</span>()</a>
<a class="sourceLine" id="cb22-203" data-line-number="203">  <span class="co"># appliquer la correction du bias (si disponible)</span></a>
<a class="sourceLine" id="cb22-204" data-line-number="204">  <span class="cf">if</span>(bias.corr) {</a>
<a class="sourceLine" id="cb22-205" data-line-number="205">    <span class="kw">cat</span>(<span class="st">&quot;Applying linear bias correction ...&quot;</span>)</a>
<a class="sourceLine" id="cb22-206" data-line-number="206">    map &lt;-<span class="st"> </span><span class="kw">calc</span>(map, <span class="dt">fun=</span><span class="cf">function</span>(x){bc<span class="op">$</span>coefficients[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>bc<span class="op">$</span>coefficients[<span class="dv">2</span>]<span class="op">*</span>x})</a>
<a class="sourceLine" id="cb22-207" data-line-number="207">  } </a>
<a class="sourceLine" id="cb22-208" data-line-number="208">  <span class="co"># sauvegarder la carte</span></a>
<a class="sourceLine" id="cb22-209" data-line-number="209">  <span class="kw">cat</span>(<span class="st">&quot;writing map ... &quot;</span>)</a>
<a class="sourceLine" id="cb22-210" data-line-number="210">  map &lt;-<span class="st"> </span><span class="kw">writeRaster</span>(map, <span class="dt">filename=</span>filename, </a>
<a class="sourceLine" id="cb22-211" data-line-number="211">                     <span class="dt">format=</span><span class="st">&quot;GTiff&quot;</span>, <span class="dt">datatype=</span><span class="st">&quot;INT2U&quot;</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-212" data-line-number="212">  <span class="kw">cat</span>(<span class="st">&quot;done</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb22-213" data-line-number="213">  </a>
<a class="sourceLine" id="cb22-214" data-line-number="214">  </a>
<a class="sourceLine" id="cb22-215" data-line-number="215">  <span class="kw">cat</span>(<span class="st">&quot;-- Done: &quot;</span>, <span class="kw">basename</span>(filename), <span class="st">&quot;/&quot;</span>, <span class="kw">date</span>(), <span class="st">&quot; --</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">file=</span>txtfile, <span class="dt">append=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-216" data-line-number="216">  </a>
<a class="sourceLine" id="cb22-217" data-line-number="217">  <span class="kw">invisible</span>(<span class="kw">list</span>(</a>
<a class="sourceLine" id="cb22-218" data-line-number="218">    <span class="st">&quot;rf.model&quot;</span> =<span class="st"> </span>map.model,</a>
<a class="sourceLine" id="cb22-219" data-line-number="219">    <span class="st">&quot;bc.model&quot;</span> =<span class="st"> </span>bc,</a>
<a class="sourceLine" id="cb22-220" data-line-number="220">    <span class="st">&quot;map&quot;</span>      =<span class="st"> </span>map</a>
<a class="sourceLine" id="cb22-221" data-line-number="221">  ))</a>
<a class="sourceLine" id="cb22-222" data-line-number="222">}</a>
<a class="sourceLine" id="cb22-223" data-line-number="223">  </a>
<a class="sourceLine" id="cb22-224" data-line-number="224"></a>
<a class="sourceLine" id="cb22-225" data-line-number="225"></a>
<a class="sourceLine" id="cb22-226" data-line-number="226"><span class="co"># COMMENCER LE TRAITEMENT #####################################################</span></a>
<a class="sourceLine" id="cb22-227" data-line-number="227"></a>
<a class="sourceLine" id="cb22-228" data-line-number="228"><span class="co"># Carte de référence 2015 =====================================================</span></a>
<a class="sourceLine" id="cb22-229" data-line-number="229"></a>
<a class="sourceLine" id="cb22-230" data-line-number="230"><span class="co"># Charger images 2015 ---------------------------------------------------------</span></a>
<a class="sourceLine" id="cb22-231" data-line-number="231">ref.p192 &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="kw">paste0</span>(IMAGES.DIR, <span class="st">&quot;/p192/p192_2015_m.tif&quot;</span>))</a>
<a class="sourceLine" id="cb22-232" data-line-number="232">ref.p193 &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="kw">paste0</span>(IMAGES.DIR, <span class="st">&quot;/p193/p193_2015_m.tif&quot;</span>))</a>
<a class="sourceLine" id="cb22-233" data-line-number="233">ref.p194 &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="kw">paste0</span>(IMAGES.DIR, <span class="st">&quot;/p194/p194_2015_m.tif&quot;</span>))</a>
<a class="sourceLine" id="cb22-234" data-line-number="234"><span class="kw">names</span>(ref.p192) &lt;-<span class="st"> </span><span class="kw">names</span>(ref.p193) &lt;-<span class="st"> </span><span class="kw">names</span>(ref.p194) &lt;-<span class="st"> </span>BANDS</a>
<a class="sourceLine" id="cb22-235" data-line-number="235">ref.images &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">p192=</span>ref.p192, <span class="dt">p193=</span>ref.p193, <span class="dt">p194=</span>ref.p194)</a>
<a class="sourceLine" id="cb22-236" data-line-number="236"></a>
<a class="sourceLine" id="cb22-237" data-line-number="237"><span class="co"># Détérminer le nombre de pixels non-NA</span></a>
<a class="sourceLine" id="cb22-238" data-line-number="238">N.PIXELS &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">p192 =</span> <span class="kw">ncell</span>(ref.p192[[<span class="st">&quot;B&quot;</span>]]) <span class="op">-</span><span class="st"> </span><span class="kw">summary</span>(ref.p192)[<span class="st">&quot;NA&#39;s&quot;</span>,<span class="st">&quot;B&quot;</span>],</a>
<a class="sourceLine" id="cb22-239" data-line-number="239">                 <span class="dt">p193 =</span> <span class="kw">ncell</span>(ref.p193[[<span class="st">&quot;B&quot;</span>]]) <span class="op">-</span><span class="st"> </span><span class="kw">summary</span>(ref.p193)[<span class="st">&quot;NA&#39;s&quot;</span>,<span class="st">&quot;B&quot;</span>],</a>
<a class="sourceLine" id="cb22-240" data-line-number="240">                 <span class="dt">p194 =</span> <span class="kw">ncell</span>(ref.p194[[<span class="st">&quot;B&quot;</span>]]) <span class="op">-</span><span class="st"> </span><span class="kw">summary</span>(ref.p194)[<span class="st">&quot;NA&#39;s&quot;</span>,<span class="st">&quot;B&quot;</span>])</a>
<a class="sourceLine" id="cb22-241" data-line-number="241"></a>
<a class="sourceLine" id="cb22-242" data-line-number="242"><span class="co"># Charger variables bioclim</span></a>
<a class="sourceLine" id="cb22-243" data-line-number="243">bioclim.p192 &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="kw">paste0</span>(IMAGES.DIR, <span class="st">&quot;/p192/p192_bioclim.tif&quot;</span>))</a>
<a class="sourceLine" id="cb22-244" data-line-number="244">bioclim.p193 &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="kw">paste0</span>(IMAGES.DIR, <span class="st">&quot;/p193/p193_bioclim.tif&quot;</span>))</a>
<a class="sourceLine" id="cb22-245" data-line-number="245">bioclim.p194 &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="kw">paste0</span>(IMAGES.DIR, <span class="st">&quot;/p194/p194_bioclim.tif&quot;</span>))</a>
<a class="sourceLine" id="cb22-246" data-line-number="246"><span class="kw">names</span>(bioclim.p192) &lt;-<span class="st"> </span><span class="kw">names</span>(bioclim.p193) &lt;-<span class="st"> </span><span class="kw">names</span>(bioclim.p194) &lt;-<span class="st"> </span>BIOCLIM</a>
<a class="sourceLine" id="cb22-247" data-line-number="247">bioclim &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">p192=</span>bioclim.p192, <span class="dt">p193=</span>bioclim.p193, <span class="dt">p194=</span>bioclim.p194)</a>
<a class="sourceLine" id="cb22-248" data-line-number="248"></a>
<a class="sourceLine" id="cb22-249" data-line-number="249"></a>
<a class="sourceLine" id="cb22-250" data-line-number="250"><span class="co"># Charger les données d&#39;inventaire --------------------------------------------</span></a>
<a class="sourceLine" id="cb22-251" data-line-number="251">plots      &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/IFN-plots.csv&quot;</span>)) <span class="co"># , fileEncoding=&quot;macintosh&quot;)</span></a>
<a class="sourceLine" id="cb22-252" data-line-number="252"></a>
<a class="sourceLine" id="cb22-253" data-line-number="253"><span class="co"># Convertir en points spatiales en utilisant les coordonnées</span></a>
<a class="sourceLine" id="cb22-254" data-line-number="254"><span class="kw">coordinates</span>(plots) &lt;-<span class="st"> </span><span class="er">~</span>X<span class="op">+</span>Y   </a>
<a class="sourceLine" id="cb22-255" data-line-number="255"><span class="kw">proj4string</span>(plots) &lt;-<span class="st"> </span>utm<span class="fl">.31</span></a>
<a class="sourceLine" id="cb22-256" data-line-number="256"></a>
<a class="sourceLine" id="cb22-257" data-line-number="257"><span class="co"># Figure de distribution spatiale des points</span></a>
<a class="sourceLine" id="cb22-258" data-line-number="258"><span class="kw">pdf</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/IFN-plots_location.pdf&quot;</span>),</a>
<a class="sourceLine" id="cb22-259" data-line-number="259">    <span class="dt">width=</span><span class="fl">3.5</span>, <span class="dt">height=</span><span class="dv">7</span>)</a>
<a class="sourceLine" id="cb22-260" data-line-number="260"><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb22-261" data-line-number="261"><span class="kw">plot</span>(<span class="kw">spTransform</span>(TGO, utm<span class="fl">.31</span>), <span class="dt">col=</span><span class="st">&quot;lightyellow&quot;</span>)</a>
<a class="sourceLine" id="cb22-262" data-line-number="262"><span class="kw">plot</span>(plots, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="st">&quot;black&quot;</span>, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb22-263" data-line-number="263"><span class="kw">plot</span>(plots, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="st">&quot;darkgreen&quot;</span>, <span class="dt">pch=</span><span class="dv">1</span>, <span class="dt">cex=</span>plots<span class="op">$</span>AGB<span class="op">/</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb22-264" data-line-number="264"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb22-265" data-line-number="265"></a>
<a class="sourceLine" id="cb22-266" data-line-number="266"><span class="co"># Convertir les polygones des parcelles en points spatiaux (centroïdes)</span></a>
<a class="sourceLine" id="cb22-267" data-line-number="267">plots.poly &lt;-<span class="st"> </span><span class="kw">SpatialPolygonsDataFrame</span>(<span class="kw">gBuffer</span>(plots, <span class="dt">byid=</span><span class="ot">TRUE</span>, <span class="dt">width=</span><span class="dv">20</span>), plots<span class="op">@</span>data)</a>
<a class="sourceLine" id="cb22-268" data-line-number="268"></a>
<a class="sourceLine" id="cb22-269" data-line-number="269"></a>
<a class="sourceLine" id="cb22-270" data-line-number="270"><span class="co"># Extraire les valeurs spéctrales pour les parcelles IFN ----------------------</span></a>
<a class="sourceLine" id="cb22-271" data-line-number="271"><span class="kw">registerDoParallel</span>(CORES)</a>
<a class="sourceLine" id="cb22-272" data-line-number="272"><span class="co"># ... pour chaque image Landsat (chemin WRS) ...</span></a>
<a class="sourceLine" id="cb22-273" data-line-number="273">x &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i=</span><span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(ref.images), <span class="dt">.combine=</span>cbind) <span class="op">%:%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-274" data-line-number="274"><span class="st">  </span><span class="co"># ... et pour chaque couche spéctrale (bandes et indices) ...</span></a>
<a class="sourceLine" id="cb22-275" data-line-number="275"><span class="st">  </span><span class="kw">foreach</span>(<span class="dt">j=</span><span class="dv">1</span><span class="op">:</span><span class="kw">nlayers</span>(ref.images[[i]]), <span class="dt">.combine=</span>cbind) <span class="op">%dopar%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb22-276" data-line-number="276">      <span class="co"># ... calculer la valeur moyenne pondérée au dessous de la parcelle IFN</span></a>
<a class="sourceLine" id="cb22-277" data-line-number="277">      raster<span class="op">::</span><span class="kw">extract</span>(ref.images[[i]][[j]], plots.poly, <span class="dt">weights=</span><span class="ot">TRUE</span>, <span class="dt">fun=</span>mean, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb22-278" data-line-number="278">  }</a>
<a class="sourceLine" id="cb22-279" data-line-number="279"></a>
<a class="sourceLine" id="cb22-280" data-line-number="280"><span class="co"># Extraire les valeurs bioclimatiques pour les parcelles IFN (en parallèle)</span></a>
<a class="sourceLine" id="cb22-281" data-line-number="281">x2 &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i=</span><span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(bioclim), <span class="dt">.combine=</span>cbind) <span class="op">%:%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-282" data-line-number="282"><span class="st">  </span><span class="kw">foreach</span>(<span class="dt">j=</span><span class="dv">1</span><span class="op">:</span><span class="kw">nlayers</span>(bioclim[[i]]), <span class="dt">.combine=</span>cbind) <span class="op">%dopar%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb22-283" data-line-number="283">    raster<span class="op">::</span><span class="kw">extract</span>(bioclim[[i]][[j]], plots, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb22-284" data-line-number="284">  }</a>
<a class="sourceLine" id="cb22-285" data-line-number="285"></a>
<a class="sourceLine" id="cb22-286" data-line-number="286"><span class="co"># Séparer les données d&#39;entraînement selon les différents chemins WRS</span></a>
<a class="sourceLine" id="cb22-287" data-line-number="287"><span class="co"># (13 variables spéctrales et 19 variables bioclim pour chaque chemin WRS)</span></a>
<a class="sourceLine" id="cb22-288" data-line-number="288">dat.p192 &lt;-<span class="st"> </span><span class="kw">na.omit</span>(<span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(plots<span class="op">$</span>AGB, x[,<span class="dv">1</span><span class="op">:</span><span class="dv">13</span>], x2[,<span class="dv">1</span><span class="op">:</span><span class="dv">19</span>])))</a>
<a class="sourceLine" id="cb22-289" data-line-number="289">dat.p193 &lt;-<span class="st"> </span><span class="kw">na.omit</span>(<span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(plots<span class="op">$</span>AGB, x[,<span class="dv">14</span><span class="op">:</span><span class="dv">26</span>], x2[,<span class="dv">20</span><span class="op">:</span><span class="dv">38</span>])))</a>
<a class="sourceLine" id="cb22-290" data-line-number="290">dat.p194 &lt;-<span class="st"> </span><span class="kw">na.omit</span>(<span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(plots<span class="op">$</span>AGB, x[,<span class="dv">27</span><span class="op">:</span><span class="dv">39</span>], x2[,<span class="dv">39</span><span class="op">:</span><span class="dv">57</span>])))</a>
<a class="sourceLine" id="cb22-291" data-line-number="291"><span class="kw">names</span>(dat.p192) &lt;-<span class="st"> </span><span class="kw">names</span>(dat.p193) &lt;-<span class="st"> </span><span class="kw">names</span>(dat.p194) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AGB&quot;</span>, SSTS.LSBANDS, SSTS.BIOCLIM)</a>
<a class="sourceLine" id="cb22-292" data-line-number="292">train.data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">p192=</span>dat.p192, <span class="dt">p193=</span>dat.p193, <span class="dt">p194=</span>dat.p194)</a>
<a class="sourceLine" id="cb22-293" data-line-number="293"></a>
<a class="sourceLine" id="cb22-294" data-line-number="294"></a>
<a class="sourceLine" id="cb22-295" data-line-number="295"><span class="co"># Séléction des variables explicatives ----------------------------------------</span></a>
<a class="sourceLine" id="cb22-296" data-line-number="296"><span class="co"># </span><span class="al">TODO</span><span class="co">: inclure la carte de régénération comme prédicteur !</span></a>
<a class="sourceLine" id="cb22-297" data-line-number="297"></a>
<a class="sourceLine" id="cb22-298" data-line-number="298">agb.varsel &lt;-<span class="st"> </span><span class="kw">rfe</span>(<span class="dt">y =</span> dat.p193[,<span class="dv">1</span>],           <span class="co"># biomasse (1ère colonne)</span></a>
<a class="sourceLine" id="cb22-299" data-line-number="299">                  <span class="dt">x =</span> dat.p193[,<span class="op">-</span><span class="dv">1</span>],          <span class="co"># prédicteurs (reste)</span></a>
<a class="sourceLine" id="cb22-300" data-line-number="300">                  <span class="dt">sizes =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb22-301" data-line-number="301">                  <span class="dt">rfeControl =</span> <span class="kw">rfeControl</span>(</a>
<a class="sourceLine" id="cb22-302" data-line-number="302">                    <span class="dt">functions =</span> rfFuncs,      <span class="co"># utiliser RandomForest</span></a>
<a class="sourceLine" id="cb22-303" data-line-number="303">                    <span class="dt">method  =</span> <span class="st">&quot;repeatedcv&quot;</span>,   <span class="co"># validation croisée</span></a>
<a class="sourceLine" id="cb22-304" data-line-number="304">                    <span class="dt">number  =</span> <span class="dv">10</span>,             <span class="co"># 10-fold</span></a>
<a class="sourceLine" id="cb22-305" data-line-number="305">                    <span class="dt">repeats =</span> <span class="dv">3</span>))             <span class="co"># 3 répétitions</span></a>
<a class="sourceLine" id="cb22-306" data-line-number="306"></a>
<a class="sourceLine" id="cb22-307" data-line-number="307"><span class="kw">sink</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2015_AGB_varsel-fin.txt&quot;</span>), <span class="dt">split=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-308" data-line-number="308"><span class="kw">predictors</span>(agb.varsel)</a>
<a class="sourceLine" id="cb22-309" data-line-number="309"><span class="kw">print</span>(agb.varsel)</a>
<a class="sourceLine" id="cb22-310" data-line-number="310"><span class="kw">sink</span>()</a>
<a class="sourceLine" id="cb22-311" data-line-number="311"></a>
<a class="sourceLine" id="cb22-312" data-line-number="312"><span class="kw">pdf</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2015_AGB_varsel-fin.pdf&quot;</span>))</a>
<a class="sourceLine" id="cb22-313" data-line-number="313"><span class="kw">plot</span>(var.sel, <span class="dt">type=</span><span class="kw">c</span>(<span class="st">&quot;g&quot;</span>, <span class="st">&quot;o&quot;</span>))</a>
<a class="sourceLine" id="cb22-314" data-line-number="314"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb22-315" data-line-number="315"></a>
<a class="sourceLine" id="cb22-316" data-line-number="316"><span class="co"># Cartes de référence biomasse aérienne 2015 -------------------------------</span></a>
<a class="sourceLine" id="cb22-317" data-line-number="317"></a>
<a class="sourceLine" id="cb22-318" data-line-number="318"><span class="co"># Chemin WRS p193</span></a>
<a class="sourceLine" id="cb22-319" data-line-number="319"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-320" data-line-number="320">p193.<span class="fl">2015.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p193/p193_2015_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-321" data-line-number="321">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p193&quot;</span>]],</a>
<a class="sourceLine" id="cb22-322" data-line-number="322">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2015_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-323" data-line-number="323">                         <span class="dt">train.dat =</span> train.data[[<span class="st">&quot;p193&quot;</span>]],</a>
<a class="sourceLine" id="cb22-324" data-line-number="324">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-325" data-line-number="325">                         <span class="dt">crossval  =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb22-326" data-line-number="326">                         <span class="dt">bias.corr =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-327" data-line-number="327">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>)</a>
<a class="sourceLine" id="cb22-328" data-line-number="328"></a>
<a class="sourceLine" id="cb22-329" data-line-number="329"><span class="co"># Chemins WRS p192 and p194, utilisant p193 pour calibration</span></a>
<a class="sourceLine" id="cb22-330" data-line-number="330"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-331" data-line-number="331">p192.<span class="fl">2015.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p192/p192_2015_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-332" data-line-number="332">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p192&quot;</span>]],</a>
<a class="sourceLine" id="cb22-333" data-line-number="333">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p192_2015_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-334" data-line-number="334">                         <span class="dt">train.dat =</span> train.data[[<span class="st">&quot;p192&quot;</span>]],</a>
<a class="sourceLine" id="cb22-335" data-line-number="335">                         <span class="co"># calibration avec carte p193 ...</span></a>
<a class="sourceLine" id="cb22-336" data-line-number="336">                         <span class="dt">cal.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-337" data-line-number="337">                         <span class="co"># ... avec au moin 200 points</span></a>
<a class="sourceLine" id="cb22-338" data-line-number="338">                         <span class="dt">n.cal.map =</span> <span class="kw">max</span>(<span class="dv">200</span>, <span class="kw">nrow</span>(train.data[[<span class="st">&quot;p192&quot;</span>]])<span class="op">*</span>CAL.RATIO), </a>
<a class="sourceLine" id="cb22-339" data-line-number="339">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-340" data-line-number="340">                         <span class="dt">crossval  =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-341" data-line-number="341">                         <span class="dt">bias.corr =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-342" data-line-number="342">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>,</a>
<a class="sourceLine" id="cb22-343" data-line-number="343">                         <span class="dt">mask      =</span> TGO)</a>
<a class="sourceLine" id="cb22-344" data-line-number="344"></a>
<a class="sourceLine" id="cb22-345" data-line-number="345"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-346" data-line-number="346">p194.<span class="fl">2015.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p194/p194_2015_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-347" data-line-number="347">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p194&quot;</span>]],</a>
<a class="sourceLine" id="cb22-348" data-line-number="348">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p194_2015_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-349" data-line-number="349">                         <span class="dt">train.dat =</span> train.data[[<span class="st">&quot;p194&quot;</span>]],</a>
<a class="sourceLine" id="cb22-350" data-line-number="350">                         <span class="co"># calibration avec carte p193 ...</span></a>
<a class="sourceLine" id="cb22-351" data-line-number="351">                         <span class="dt">cal.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-352" data-line-number="352">                         <span class="co"># ... avec au moin 200 points</span></a>
<a class="sourceLine" id="cb22-353" data-line-number="353">                         <span class="dt">n.cal.map =</span> <span class="kw">max</span>(<span class="dv">200</span>, <span class="kw">nrow</span>(train.data[[<span class="st">&quot;p194&quot;</span>]])<span class="op">*</span>CAL.RATIO), </a>
<a class="sourceLine" id="cb22-354" data-line-number="354">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-355" data-line-number="355">                         <span class="dt">crossval  =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-356" data-line-number="356">                         <span class="dt">bias.corr =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-357" data-line-number="357">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>,</a>
<a class="sourceLine" id="cb22-358" data-line-number="358">                         <span class="dt">mask      =</span> TGO) </a>
<a class="sourceLine" id="cb22-359" data-line-number="359"></a>
<a class="sourceLine" id="cb22-360" data-line-number="360"><span class="co"># Fusionner les cartes des chemins p192, p193 et p194</span></a>
<a class="sourceLine" id="cb22-361" data-line-number="361">agb<span class="fl">.2015</span> &lt;-<span class="st"> </span><span class="kw">mask</span>(<span class="kw">crop</span>(<span class="kw">mosaic</span>(<span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p192_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-362" data-line-number="362">                             <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2015_AGB_R.tif&quot;</span>)), </a>
<a class="sourceLine" id="cb22-363" data-line-number="363">                             <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p194_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-364" data-line-number="364">                             <span class="dt">fun=</span>mean),  <span class="co"># valeur moyenne pour les superpositions</span></a>
<a class="sourceLine" id="cb22-365" data-line-number="365">                      TGO), </a>
<a class="sourceLine" id="cb22-366" data-line-number="366">                 TGO, </a>
<a class="sourceLine" id="cb22-367" data-line-number="367">                 <span class="dt">filename=</span><span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.tif&quot;</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-368" data-line-number="368"></a>
<a class="sourceLine" id="cb22-369" data-line-number="369"><span class="co"># Sauvgarder un image de la carte biomasse 2015</span></a>
<a class="sourceLine" id="cb22-370" data-line-number="370"><span class="kw">pdf</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.pdf&quot;</span>),</a>
<a class="sourceLine" id="cb22-371" data-line-number="371">    <span class="dt">width=</span><span class="fl">3.5</span>, <span class="dt">height=</span><span class="dv">7</span>)</a>
<a class="sourceLine" id="cb22-372" data-line-number="372"><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb22-373" data-line-number="373"><span class="kw">plot</span>(agb<span class="fl">.2015</span>, <span class="dt">axes=</span><span class="ot">FALSE</span>, <span class="dt">col=</span><span class="kw">brewer.pal</span>(<span class="dv">9</span>, <span class="st">&quot;YlGn&quot;</span>), <span class="dt">zlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">220</span>))</a>
<a class="sourceLine" id="cb22-374" data-line-number="374"><span class="kw">plot</span>(<span class="kw">spTransform</span>(TGO, utm<span class="fl">.31</span>), <span class="dt">add=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-375" data-line-number="375"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb22-376" data-line-number="376"></a>
<a class="sourceLine" id="cb22-377" data-line-number="377"></a>
<a class="sourceLine" id="cb22-378" data-line-number="378"><span class="co"># Correction de la sous-estimation des valeurs biomasse élevés ----------------</span></a>
<a class="sourceLine" id="cb22-379" data-line-number="379"></a>
<a class="sourceLine" id="cb22-380" data-line-number="380"><span class="co"># Diagramme de dispersion carte biomasse 2015 vs. observation parcelles IFN</span></a>
<a class="sourceLine" id="cb22-381" data-line-number="381">plots.poly<span class="op">$</span>AGB.pred &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(agb<span class="fl">.2015</span>, plots.poly, <span class="dt">weights=</span><span class="ot">TRUE</span>, <span class="dt">fun=</span>mean, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb22-382" data-line-number="382"><span class="kw">pdf</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/AGB-model_2015.pdf&quot;</span>))</a>
<a class="sourceLine" id="cb22-383" data-line-number="383"><span class="kw">plot</span>(plots.poly<span class="op">$</span>AGB.pred <span class="op">~</span><span class="st"> </span>plots.poly<span class="op">$</span>AGB, </a>
<a class="sourceLine" id="cb22-384" data-line-number="384">     <span class="dt">xlab=</span><span class="st">&quot;Biomasse aérienne IFN (t/ha)&quot;</span>, </a>
<a class="sourceLine" id="cb22-385" data-line-number="385">     <span class="dt">ylab=</span><span class="st">&quot;Carte AGB 2015 (t/ha)&quot;</span>, </a>
<a class="sourceLine" id="cb22-386" data-line-number="386">     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">350</span>), <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">350</span>))</a>
<a class="sourceLine" id="cb22-387" data-line-number="387"><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">lty=</span><span class="st">&quot;dashed&quot;</span>)</a>
<a class="sourceLine" id="cb22-388" data-line-number="388"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb22-389" data-line-number="389"></a>
<a class="sourceLine" id="cb22-390" data-line-number="390"><span class="co"># Correction pour réduire la sous-estimation des valeurs élevés</span></a>
<a class="sourceLine" id="cb22-391" data-line-number="391">cv &lt;-<span class="st"> </span><span class="kw">train</span>(AGB <span class="op">~</span><span class="st"> </span>AGB.pred, </a>
<a class="sourceLine" id="cb22-392" data-line-number="392">            <span class="dt">data=</span>plots.poly<span class="op">@</span>data[<span class="op">!</span><span class="kw">is.na</span>(plots.poly<span class="op">$</span>AGB.pred),], </a>
<a class="sourceLine" id="cb22-393" data-line-number="393">            <span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>,        <span class="co"># régression linéaire</span></a>
<a class="sourceLine" id="cb22-394" data-line-number="394">            <span class="dt">trControl =</span> <span class="kw">trainControl</span>(</a>
<a class="sourceLine" id="cb22-395" data-line-number="395">              <span class="dt">method =</span> <span class="st">&quot;cv&quot;</span>,      <span class="co"># validation croisée</span></a>
<a class="sourceLine" id="cb22-396" data-line-number="396">              <span class="dt">number =</span> <span class="dv">10</span>))       <span class="co"># 10-fold</span></a>
<a class="sourceLine" id="cb22-397" data-line-number="397">model &lt;-<span class="st"> </span><span class="kw">lm</span>(AGB <span class="op">~</span><span class="st"> </span>AGB.pred, <span class="dt">data=</span>plots.poly<span class="op">@</span>data[<span class="op">!</span><span class="kw">is.na</span>(plots.poly<span class="op">$</span>AGB.pred),])</a>
<a class="sourceLine" id="cb22-398" data-line-number="398"><span class="kw">sink</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_Rc.txt&quot;</span>), <span class="dt">split=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-399" data-line-number="399"><span class="kw">print</span>(cv)</a>
<a class="sourceLine" id="cb22-400" data-line-number="400"><span class="kw">summary</span>(model)</a>
<a class="sourceLine" id="cb22-401" data-line-number="401"><span class="kw">sink</span>()</a>
<a class="sourceLine" id="cb22-402" data-line-number="402">agb<span class="fl">.2015</span> &lt;-<span class="st"> </span><span class="kw">writeRaster</span>(model<span class="op">$</span>coefficients[<span class="st">&quot;(Intercept)&quot;</span>] <span class="op">+</span><span class="st"> </span>model<span class="op">$</span>coefficients[<span class="st">&quot;AGB.pred&quot;</span>] <span class="op">*</span><span class="st"> </span>agb<span class="fl">.2015</span>, </a>
<a class="sourceLine" id="cb22-403" data-line-number="403">                        <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.tif&quot;</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-404" data-line-number="404"></a>
<a class="sourceLine" id="cb22-405" data-line-number="405"><span class="co"># Diagramme de dispersion carte biomasse 2015 corrigé vs. observation parcelles IFN</span></a>
<a class="sourceLine" id="cb22-406" data-line-number="406">agb.pred.c &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(agb<span class="fl">.2015</span>, plots.poly, <span class="dt">weights=</span><span class="ot">TRUE</span>, <span class="dt">fun=</span>mean, <span class="dt">df=</span><span class="ot">TRUE</span>)[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb22-407" data-line-number="407"><span class="kw">pdf</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/AGB-model_2015_c.pdf&quot;</span>))</a>
<a class="sourceLine" id="cb22-408" data-line-number="408"><span class="kw">plot</span>(agb.pred <span class="op">~</span><span class="st"> </span>plots.poly<span class="op">$</span>AGB, </a>
<a class="sourceLine" id="cb22-409" data-line-number="409">     <span class="dt">xlab=</span><span class="st">&quot;Biomasse aérienne IFN (t/ha)&quot;</span>, </a>
<a class="sourceLine" id="cb22-410" data-line-number="410">     <span class="dt">ylab=</span><span class="st">&quot;Carte AGB 2015 (t/ha)&quot;</span>, </a>
<a class="sourceLine" id="cb22-411" data-line-number="411">     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">350</span>), <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">350</span>))</a>
<a class="sourceLine" id="cb22-412" data-line-number="412"><span class="kw">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">lty=</span><span class="st">&quot;dashed&quot;</span>) </a>
<a class="sourceLine" id="cb22-413" data-line-number="413"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb22-414" data-line-number="414"></a>
<a class="sourceLine" id="cb22-415" data-line-number="415"></a>
<a class="sourceLine" id="cb22-416" data-line-number="416"><span class="co"># Carte biomasse 2003 (sur base de la carte 2015) =============================</span></a>
<a class="sourceLine" id="cb22-417" data-line-number="417"></a>
<a class="sourceLine" id="cb22-418" data-line-number="418"><span class="co"># Chemins WRS p193</span></a>
<a class="sourceLine" id="cb22-419" data-line-number="419"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-420" data-line-number="420">p193.<span class="fl">2003.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p193/p193_2003_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-421" data-line-number="421">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p193&quot;</span>]],</a>
<a class="sourceLine" id="cb22-422" data-line-number="422">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2003_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-423" data-line-number="423">                         <span class="dt">train.dat =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb22-424" data-line-number="424">                         <span class="dt">ref.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-425" data-line-number="425">                         <span class="dt">n.ref.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p193&quot;</span>]],</a>
<a class="sourceLine" id="cb22-426" data-line-number="426">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-427" data-line-number="427">                         <span class="dt">crossval  =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-428" data-line-number="428">                         <span class="dt">bias.corr =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb22-429" data-line-number="429">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>)</a>
<a class="sourceLine" id="cb22-430" data-line-number="430"></a>
<a class="sourceLine" id="cb22-431" data-line-number="431"><span class="co"># Chemins WRS p192 and p194, utilisant p193 pour calibration</span></a>
<a class="sourceLine" id="cb22-432" data-line-number="432"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-433" data-line-number="433">p192.<span class="fl">2003.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p192/p192_2003_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-434" data-line-number="434">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p192&quot;</span>]],</a>
<a class="sourceLine" id="cb22-435" data-line-number="435">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p192_2003_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-436" data-line-number="436">                         <span class="dt">train.dat =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb22-437" data-line-number="437">                         <span class="dt">ref.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-438" data-line-number="438">                         <span class="dt">n.ref.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p192&quot;</span>]] <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>CAL.RATIO),</a>
<a class="sourceLine" id="cb22-439" data-line-number="439">                         <span class="dt">cal.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2003_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-440" data-line-number="440">                         <span class="dt">n.cal.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p192&quot;</span>]] <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>CAL.RATIO),</a>
<a class="sourceLine" id="cb22-441" data-line-number="441">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-442" data-line-number="442">                         <span class="dt">crossval  =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-443" data-line-number="443">                         <span class="dt">bias.corr =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-444" data-line-number="444">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>,</a>
<a class="sourceLine" id="cb22-445" data-line-number="445">                         <span class="dt">mask      =</span> TGO)</a>
<a class="sourceLine" id="cb22-446" data-line-number="446"></a>
<a class="sourceLine" id="cb22-447" data-line-number="447"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-448" data-line-number="448">p194.<span class="fl">2003.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p194/p194_2003_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-449" data-line-number="449">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p194&quot;</span>]],</a>
<a class="sourceLine" id="cb22-450" data-line-number="450">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p194_2003_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-451" data-line-number="451">                         <span class="dt">train.dat =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb22-452" data-line-number="452">                         <span class="dt">ref.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-453" data-line-number="453">                         <span class="dt">n.ref.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p194&quot;</span>]] <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>CAL.RATIO),</a>
<a class="sourceLine" id="cb22-454" data-line-number="454">                         <span class="dt">cal.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2003_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-455" data-line-number="455">                         <span class="dt">n.cal.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p194&quot;</span>]] <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>CAL.RATIO), </a>
<a class="sourceLine" id="cb22-456" data-line-number="456">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-457" data-line-number="457">                         <span class="dt">crossval  =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-458" data-line-number="458">                         <span class="dt">bias.corr =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-459" data-line-number="459">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>,</a>
<a class="sourceLine" id="cb22-460" data-line-number="460">                         <span class="dt">mask      =</span> TGO)</a>
<a class="sourceLine" id="cb22-461" data-line-number="461"></a>
<a class="sourceLine" id="cb22-462" data-line-number="462"><span class="co"># Fusionner les cartes des chemins p192, p193 et p194</span></a>
<a class="sourceLine" id="cb22-463" data-line-number="463">agb<span class="fl">.2003</span> &lt;-<span class="st"> </span><span class="kw">mask</span>(<span class="kw">crop</span>(<span class="kw">mosaic</span>(<span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p192_2003_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-464" data-line-number="464">                             <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2003_AGB_R.tif&quot;</span>)), </a>
<a class="sourceLine" id="cb22-465" data-line-number="465">                             <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p194_2003_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-466" data-line-number="466">                             <span class="dt">fun=</span>mean),</a>
<a class="sourceLine" id="cb22-467" data-line-number="467">                      TGO), </a>
<a class="sourceLine" id="cb22-468" data-line-number="468">                 TGO, </a>
<a class="sourceLine" id="cb22-469" data-line-number="469">                 <span class="dt">filename=</span><span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2003_AGB_R.tif&quot;</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb22-470" data-line-number="470"></a>
<a class="sourceLine" id="cb22-471" data-line-number="471"></a>
<a class="sourceLine" id="cb22-472" data-line-number="472"><span class="co"># Carte biomasse 2003 (sur base de la carte 2015) =============================</span></a>
<a class="sourceLine" id="cb22-473" data-line-number="473"></a>
<a class="sourceLine" id="cb22-474" data-line-number="474"><span class="co"># Chemins WRS p193</span></a>
<a class="sourceLine" id="cb22-475" data-line-number="475"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-476" data-line-number="476">p193.<span class="fl">2018.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p193/p193_2018_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-477" data-line-number="477">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p193&quot;</span>]],</a>
<a class="sourceLine" id="cb22-478" data-line-number="478">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2018_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-479" data-line-number="479">                         <span class="dt">train.dat =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb22-480" data-line-number="480">                         <span class="dt">ref.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-481" data-line-number="481">                         <span class="dt">n.ref.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p193&quot;</span>]],</a>
<a class="sourceLine" id="cb22-482" data-line-number="482">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-483" data-line-number="483">                         <span class="dt">crossval  =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-484" data-line-number="484">                         <span class="dt">bias.corr =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb22-485" data-line-number="485">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>)</a>
<a class="sourceLine" id="cb22-486" data-line-number="486"></a>
<a class="sourceLine" id="cb22-487" data-line-number="487"><span class="co"># Chemins WRS p192 and p194, utilisant p193 pour calibration</span></a>
<a class="sourceLine" id="cb22-488" data-line-number="488"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-489" data-line-number="489">p192.<span class="fl">2018.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p192/p192_2018_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-490" data-line-number="490">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p192&quot;</span>]],</a>
<a class="sourceLine" id="cb22-491" data-line-number="491">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p192_2018_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-492" data-line-number="492">                         <span class="dt">train.dat =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb22-493" data-line-number="493">                         <span class="dt">ref.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-494" data-line-number="494">                         <span class="dt">n.ref.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p192&quot;</span>]] <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>CAL.RATIO),</a>
<a class="sourceLine" id="cb22-495" data-line-number="495">                         <span class="dt">cal.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2018_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-496" data-line-number="496">                         <span class="dt">n.cal.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p192&quot;</span>]] <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>CAL.RATIO),</a>
<a class="sourceLine" id="cb22-497" data-line-number="497">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-498" data-line-number="498">                         <span class="dt">crossval  =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-499" data-line-number="499">                         <span class="dt">bias.corr =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-500" data-line-number="500">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>,</a>
<a class="sourceLine" id="cb22-501" data-line-number="501">                         <span class="dt">mask      =</span> TGO)</a>
<a class="sourceLine" id="cb22-502" data-line-number="502"></a>
<a class="sourceLine" id="cb22-503" data-line-number="503"><span class="kw">set.RSEED</span>(RSEED)</a>
<a class="sourceLine" id="cb22-504" data-line-number="504">p194.<span class="fl">2018.</span>agb &lt;-<span class="st"> </span><span class="kw">agb.map</span>(<span class="dt">image     =</span> <span class="kw">load.image</span>(<span class="st">&quot;/p194/p194_2018_m.tif&quot;</span>), </a>
<a class="sourceLine" id="cb22-505" data-line-number="505">                         <span class="dt">bioclim   =</span> bioclim[[<span class="st">&quot;p194&quot;</span>]],</a>
<a class="sourceLine" id="cb22-506" data-line-number="506">                         <span class="dt">filename  =</span> <span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p194_2018_AGB_R.tif&quot;</span>),</a>
<a class="sourceLine" id="cb22-507" data-line-number="507">                         <span class="dt">train.dat =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb22-508" data-line-number="508">                         <span class="dt">ref.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2015_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-509" data-line-number="509">                         <span class="dt">n.ref.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p194&quot;</span>]] <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>CAL.RATIO),</a>
<a class="sourceLine" id="cb22-510" data-line-number="510">                         <span class="dt">cal.map   =</span> <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2018_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-511" data-line-number="511">                         <span class="dt">n.cal.map =</span> SAMPLE.RATIO <span class="op">*</span><span class="st"> </span>N.PIXELS[[<span class="st">&quot;p194&quot;</span>]] <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>CAL.RATIO), </a>
<a class="sourceLine" id="cb22-512" data-line-number="512">                         <span class="dt">preds     =</span> PREDICTORS,</a>
<a class="sourceLine" id="cb22-513" data-line-number="513">                         <span class="dt">crossval  =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-514" data-line-number="514">                         <span class="dt">bias.corr =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb22-515" data-line-number="515">                         <span class="dt">n.cores   =</span> <span class="dv">32</span>,</a>
<a class="sourceLine" id="cb22-516" data-line-number="516">                         <span class="dt">mask      =</span> TGO)</a>
<a class="sourceLine" id="cb22-517" data-line-number="517"></a>
<a class="sourceLine" id="cb22-518" data-line-number="518"><span class="co"># Fusionner les cartes des chemins p192, p193 et p194</span></a>
<a class="sourceLine" id="cb22-519" data-line-number="519">agb<span class="fl">.2018</span> &lt;-<span class="st"> </span><span class="kw">mask</span>(<span class="kw">crop</span>(<span class="kw">mosaic</span>(<span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p192_2018_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-520" data-line-number="520">                             <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p193_2018_AGB_R.tif&quot;</span>)), </a>
<a class="sourceLine" id="cb22-521" data-line-number="521">                             <span class="kw">raster</span>(<span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/p194_2018_AGB_R.tif&quot;</span>)),</a>
<a class="sourceLine" id="cb22-522" data-line-number="522">                             <span class="dt">fun=</span>mean),</a>
<a class="sourceLine" id="cb22-523" data-line-number="523">                      TGO), </a>
<a class="sourceLine" id="cb22-524" data-line-number="524">                 TGO, </a>
<a class="sourceLine" id="cb22-525" data-line-number="525">                 <span class="dt">filename=</span><span class="kw">paste0</span>(REF.DIR, <span class="st">&quot;/TGO_2018_AGB_R.tif&quot;</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="01_compile-IFN.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="00_analyse-ER.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["SNSF-Togo_Manuel.pdf"],
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true,
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
