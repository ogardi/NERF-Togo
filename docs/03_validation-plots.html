<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2.4 Parcelles de validation | _main.utf8</title>
  <meta name="description" content="République Togolaise —<br />
Système Nationale de Surveillance des Forêts</div>" />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="2.4 Parcelles de validation | _main.utf8" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://ogardi.github.io/NERF-Togo" />
  <meta property="og:image" content="https://ogardi.github.io/NERF-Togoimages/NERF-Togo.png" />
  
  <meta name="github-repo" content="ogardi/NERF-Togo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2.4 Parcelles de validation | _main.utf8" />
  
  
  <meta name="twitter:image" content="https://ogardi.github.io/NERF-Togoimages/NERF-Togo.png" />

<meta name="author" content="Oliver Gardi, Fifonsi Dangbo, Sophie Dzigbod, Ditorgue Bakabima" />


<meta name="date" content="2020-05-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="02_training-plots.html"/>
<link rel="next" href="04_collecte-donnees.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://github.com/ogardi/NERF-Togo"><b>SNSF Togo</b><br>v 1.0 / en développement</a></li>
<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Préface</a></li>
<li class="chapter" data-level="1" data-path="00_introduction.html"><a href="00_introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="01_arrangements.html"><a href="01_arrangements.html"><i class="fa fa-check"></i><b>1.1</b> Arrangements institutionelles</a></li>
<li class="chapter" data-level="1.2" data-path="02_organisation.html"><a href="02_organisation.html"><i class="fa fa-check"></i><b>1.2</b> Pour commencer</a><ul>
<li class="chapter" data-level="1.2.1" data-path="02_organisation.html"><a href="02_organisation.html#logiciel-et-serveur"><i class="fa fa-check"></i><b>1.2.1</b> Logiciel et serveur</a></li>
<li class="chapter" data-level="1.2.2" data-path="02_organisation.html"><a href="02_organisation.html#structure-du-repertoire"><i class="fa fa-check"></i><b>1.2.2</b> Structure du répértoire</a></li>
<li class="chapter" data-level="1.2.3" data-path="02_organisation.html"><a href="02_organisation.html#creation-dun-nouveau-projet"><i class="fa fa-check"></i><b>1.2.3</b> Création d’un nouveau projet</a></li>
<li class="chapter" data-level="1.2.4" data-path="02_organisation.html"><a href="02_organisation.html#NRF-set-up.R"><i class="fa fa-check"></i><b>1.2.4</b> Définition des variables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="00_STSS.html"><a href="00_STSS.html"><i class="fa fa-check"></i><b>2</b> Système de Surveillance Terrestre</a><ul>
<li class="chapter" data-level="2.1" data-path="01_Landsat.html"><a href="01_Landsat.html"><i class="fa fa-check"></i><b>2.1</b> Données de base</a><ul>
<li class="chapter" data-level="2.1.1" data-path="01_Landsat.html"><a href="01_Landsat.html#SSTS-Landsat"><i class="fa fa-check"></i><b>2.1.1</b> Images Landsat</a></li>
<li class="chapter" data-level="2.1.2" data-path="02_SRTM.html"><a href="02_SRTM.html"><i class="fa fa-check"></i><b>2.1.2</b> SRTM</a></li>
<li class="chapter" data-level="2.1.3" data-path="03_Worldclim.html"><a href="03_Worldclim.html"><i class="fa fa-check"></i><b>2.1.3</b> WorldClim</a></li>
<li class="chapter" data-level="2.1.4" data-path="04_SoilGrids.html"><a href="04_SoilGrids.html"><i class="fa fa-check"></i><b>2.1.4</b> SoilGrids</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="01_sampling-grid.html"><a href="01_sampling-grid.html"><i class="fa fa-check"></i><b>2.2</b> Réseau d’échantillonnage</a></li>
<li class="chapter" data-level="2.3" data-path="02_training-plots.html"><a href="02_training-plots.html"><i class="fa fa-check"></i><b>2.3</b> Parcelles d’entraînement</a><ul>
<li class="chapter" data-level="2.3.1" data-path="02_training-plots.html"><a href="02_training-plots.html#echantillonnage"><i class="fa fa-check"></i><b>2.3.1</b> Échantillonnage</a></li>
<li class="chapter" data-level="2.3.2" data-path="02_training-plots.html"><a href="02_training-plots.html#SSTS-couverture-houppiers"><i class="fa fa-check"></i><b>2.3.2</b> Couverture des houppiers</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="03_validation-plots.html"><a href="03_validation-plots.html"><i class="fa fa-check"></i><b>2.4</b> Parcelles de validation</a><ul>
<li class="chapter" data-level="2.4.1" data-path="03_validation-plots.html"><a href="03_validation-plots.html#echantillonnage-1"><i class="fa fa-check"></i><b>2.4.1</b> Échantillonnage</a></li>
<li class="chapter" data-level="2.4.2" data-path="03_validation-plots.html"><a href="03_validation-plots.html#SSTS-occupation-terres"><i class="fa fa-check"></i><b>2.4.2</b> Occupation des terres</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="04_collecte-donnees.html"><a href="04_collecte-donnees.html"><i class="fa fa-check"></i><b>2.5</b> Collecte des données QGIS</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="00_IFN.html"><a href="00_IFN.html"><i class="fa fa-check"></i><b>3</b> Inventaire Forestier National</a><ul>
<li class="chapter" data-level="3.1" data-path="01_IFN-1.html"><a href="01_IFN-1.html"><i class="fa fa-check"></i><b>3.1</b> IFN-1 (2015/16)</a><ul>
<li class="chapter" data-level="3.1.1" data-path="01_IFN-1.html"><a href="01_IFN-1.html#methode"><i class="fa fa-check"></i><b>3.1.1</b> <span>Méthode</span></a></li>
<li class="chapter" data-level="3.1.2" data-path="01_IFN-1.html"><a href="01_IFN-1.html#donnees"><i class="fa fa-check"></i><b>3.1.2</b> Données</a></li>
<li class="chapter" data-level="3.1.3" data-path="01_IFN-1.html"><a href="01_IFN-1.html#resultats"><i class="fa fa-check"></i><b>3.1.3</b> <span>Résultats</span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="00_NERF-MRV.html"><a href="00_NERF-MRV.html"><i class="fa fa-check"></i><b>4</b> Analyses NRF/MRV</a><ul>
<li class="chapter" data-level="4.1" data-path="00_analyse-FCC.html"><a href="00_analyse-FCC.html"><i class="fa fa-check"></i><b>4.1</b> Analyse surfaces forestiers</a><ul>
<li class="chapter" data-level="4.1.1" data-path="01_create-FC-maps.html"><a href="01_create-FC-maps.html"><i class="fa fa-check"></i><b>4.1.1</b> Production des cartes Forêt/Non-Forêt</a></li>
<li class="chapter" data-level="4.1.2" data-path="02_clean-FC-maps.html"><a href="02_clean-FC-maps.html"><i class="fa fa-check"></i><b>4.1.2</b> Nettoyage des cartes brutes</a></li>
<li class="chapter" data-level="4.1.3" data-path="03_validate-FC-maps.html"><a href="03_validate-FC-maps.html"><i class="fa fa-check"></i><b>4.1.3</b> Validation des cartes</a></li>
<li class="chapter" data-level="4.1.4" data-path="04_FC-maps-accuracy.html"><a href="04_FC-maps-accuracy.html"><i class="fa fa-check"></i><b>4.1.4</b> Analyse de la précision</a></li>
<li class="chapter" data-level="4.1.5" data-path="05_analyse-FC-maps.html"><a href="05_analyse-FC-maps.html"><i class="fa fa-check"></i><b>4.1.5</b> Analyse des cartes</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="00_analyse-AGB.html"><a href="00_analyse-AGB.html"><i class="fa fa-check"></i><b>4.2</b> Analyse biomasse aérienne</a><ul>
<li class="chapter" data-level="4.2.1" data-path="01_compile-IFN.html"><a href="01_compile-IFN.html"><i class="fa fa-check"></i><b>4.2.1</b> Analyse des données IFN</a></li>
<li class="chapter" data-level="4.2.2" data-path="02_create-AGB-maps.html"><a href="02_create-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.2</b> Calibration et prédiction</a></li>
<li class="chapter" data-level="4.2.3" data-path="03_clean-AGB-maps.html"><a href="03_clean-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.3</b> Nettoyage des cartes brutes</a></li>
<li class="chapter" data-level="4.2.4" data-path="04_analyze-AGB-maps.html"><a href="04_analyze-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.4</b> Production des résultats</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown">Fièrement publié avec bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><div class="line-block">République Togolaise —<br />
Système Nationale de Surveillance des Forêts</div></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="SSTS-validation-plots" class="section level2">
<h2><span class="header-section-number">2.4</span> Parcelles de validation</h2>
<div id="echantillonnage-1" class="section level3">
<h3><span class="header-section-number">2.4.1</span> Échantillonnage</h3>
<p>La sélection des parcelles de validation est basée sur les cartes forêt/non-forêt, notamment leurs transitions entre les années 1987 – 2003 – 2015 – 2018. Tout d’abord les transitions sont déterminées pour chaque point du réseau d’échantillonnage. Ensuite un échantillon aléatoire stratifié est tirré avec une répartition de l’échantillon aux strates (transitions) qui est la valeur moyenne d’une répartition proportionnelle à la taille des strates et d’une répartion égale.</p>
</div>
<div id="SSTS-occupation-terres" class="section level3">
<h3><span class="header-section-number">2.4.2</span> Occupation des terres</h3>
<p>L’occupation des terres et le changement de l’occupation des terres est <strong>déterminé sur base des images Landsat</strong>. Trois différentes catégories sont distingués:</p>
<ul>
<li>forêt (couverture houppier ≥ 30%)</li>
<li>terre boisée (couverture houppier entre 10% et 30%)</li>
<li>non-forêt (couverture houppier &lt; 10%)</li>
</ul>
<p><strong>La couverture des houppiers est utilisé pour détérminer l’occupation des terres sur l’image Landsat de la date correspondate.</strong> À partir de cette référence, l’occupation des terres est détérminé pour les autres dates de référence 1987 – 2003 – 2015 – 2018. La figure suivante illustre la procédure:</p>
<p><img src="images/SSTS-land-cover.png" /></p>
<div id="sstscreate-val-plots.r" class="section level4 unnumbered">
<h4><em>SSTS/create-val-plots.R</em></h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">##########################################################################</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co"># NERF_Togo/FCC/5_create-val-points.R: validate clean forest cover maps</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co"># ------------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co"># Bern University of Applied Sciences</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co"># Oliver Gardi, &lt;oliver.gardi@bfh.ch&gt;</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co"># 20 May 2019</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co"># merge the 1987, 2003, 2015 and 2018 maps</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">maps.p192 &lt;-<span class="st"> </span><span class="kw">do.call</span>(stack, <span class="kw">lapply</span>(<span class="kw">dir</span>(<span class="kw">paste0</span>(OUTPUT.DIR, <span class="st">&quot;/2_forest-maps/TGO/2_raw-maps/p192&quot;</span>), <span class="dt">pattern=</span><span class="st">&quot;</span><span class="ch">\\</span><span class="st">.tif&quot;</span>, <span class="dt">full.names=</span><span class="ot">TRUE</span>)[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">12</span>)], raster))</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">maps.p193 &lt;-<span class="st"> </span><span class="kw">do.call</span>(stack, <span class="kw">lapply</span>(<span class="kw">dir</span>(<span class="kw">paste0</span>(OUTPUT.DIR, <span class="st">&quot;/2_forest-maps/TGO/2_raw-maps/p193&quot;</span>), <span class="dt">pattern=</span><span class="st">&quot;</span><span class="ch">\\</span><span class="st">.tif&quot;</span>, <span class="dt">full.names=</span><span class="ot">TRUE</span>)[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">6</span>,<span class="dv">11</span>,<span class="dv">13</span>)], raster))</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">maps.p194 &lt;-<span class="st"> </span><span class="kw">do.call</span>(stack, <span class="kw">lapply</span>(<span class="kw">dir</span>(<span class="kw">paste0</span>(OUTPUT.DIR, <span class="st">&quot;/2_forest-maps/TGO/2_raw-maps/p194&quot;</span>), <span class="dt">pattern=</span><span class="st">&quot;</span><span class="ch">\\</span><span class="st">.tif&quot;</span>, <span class="dt">full.names=</span><span class="ot">TRUE</span>)[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">12</span>)], raster))</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">maps &lt;-<span class="st"> </span><span class="kw">merge</span>(maps.p193, maps.p194, maps.p192)</a>
<a class="sourceLine" id="cb12-14" data-line-number="14"></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="kw">writeRaster</span>(maps, <span class="dt">filename=</span><span class="kw">paste0</span>(VALIDTN.DIR, <span class="st">&quot;/1_val4k-s16trans/TGO.tif&quot;</span>), <span class="dt">bylayer=</span><span class="ot">TRUE</span>, <span class="dt">suffix=</span><span class="kw">paste0</span>(<span class="kw">c</span>(<span class="dv">1987</span>, <span class="dv">2003</span>, <span class="dv">2015</span>, <span class="dv">2018</span>), <span class="st">&quot;_FC30r&quot;</span>))</a>
<a class="sourceLine" id="cb12-16" data-line-number="16"></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co"># maps &lt;- stack(dir(MAPS.DIR, pattern=paste0(&quot;.*c&quot;, MAPS.SUFFIX, &quot;[.]tif$&quot;), full.names=TRUE))[[c(1,4,12,14)]]</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18">change.map &lt;-<span class="st"> </span>maps[[<span class="dv">1</span>]] <span class="op">+</span><span class="st"> </span>maps[[<span class="dv">2</span>]]<span class="op">*</span><span class="dv">10</span> <span class="op">+</span><span class="st"> </span>maps[[<span class="dv">3</span>]]<span class="op">*</span><span class="dv">100</span> <span class="op">+</span><span class="st"> </span>maps[[<span class="dv">4</span>]]<span class="op">*</span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co"># Allocation of validation points</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="co"># ================================</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"></a>
<a class="sourceLine" id="cb12-24" data-line-number="24">n &lt;-<span class="st"> </span><span class="dv">4000</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25">alloc &lt;-<span class="st"> </span><span class="kw">freq</span>(change.map)[<span class="dv">1</span><span class="op">:</span><span class="dv">16</span>,]</a>
<a class="sourceLine" id="cb12-26" data-line-number="26">alloc &lt;-<span class="st"> </span><span class="kw">cbind</span>(alloc, <span class="dt">prop=</span><span class="kw">round</span>(n<span class="op">*</span>alloc[,<span class="st">&quot;count&quot;</span>]<span class="op">/</span><span class="kw">sum</span>(alloc[,<span class="st">&quot;count&quot;</span>])), <span class="dt">equal=</span><span class="kw">round</span>(n<span class="op">/</span><span class="kw">nrow</span>(alloc)))</a>
<a class="sourceLine" id="cb12-27" data-line-number="27">alloc &lt;-<span class="st"> </span><span class="kw">cbind</span>(alloc, <span class="dt">balanced=</span><span class="kw">round</span>((alloc[,<span class="st">&quot;prop&quot;</span>] <span class="op">+</span><span class="st"> </span>alloc[,<span class="st">&quot;equal&quot;</span>])<span class="op">/</span><span class="st"> </span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="kw">sum</span>(alloc[,<span class="st">&quot;balanced&quot;</span>])</a>
<a class="sourceLine" id="cb12-29" data-line-number="29"></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="co"># Read the frame</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32"><span class="co"># ==============</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33">frame.points        &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="kw">paste0</span>(INPUT.DIR, <span class="st">&quot;/SSTS/TGO_frame_480m.shp&quot;</span>))</a>
<a class="sourceLine" id="cb12-34" data-line-number="34"></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="co"># extract forest transitions</span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36">frame.points<span class="op">$</span>trans  &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(change.map, frame.points)</a>
<a class="sourceLine" id="cb12-37" data-line-number="37"></a>
<a class="sourceLine" id="cb12-38" data-line-number="38"><span class="co"># writeOGR(frame.points, dsn=paste0(INPUT.DIR, &quot;/Train-Val/201908&quot;), layer=&quot;TGO_frame_480m&quot;, driver=&quot;ESRI Shapefile&quot;, overwrite=TRUE)</span></a>
<a class="sourceLine" id="cb12-39" data-line-number="39"></a>
<a class="sourceLine" id="cb12-40" data-line-number="40"></a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="co"># merge with training-plots data</span></a>
<a class="sourceLine" id="cb12-42" data-line-number="42">train.plots         &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="kw">paste0</span>(REFMAPS.DIR, <span class="st">&quot;/1_trn10k-s10ndvi/assessed_v1/COV_parcelles.shp&quot;</span>))</a>
<a class="sourceLine" id="cb12-43" data-line-number="43">frame.points        &lt;-<span class="st"> </span><span class="kw">merge</span>(frame.points, train.plots<span class="op">@</span>data[,<span class="kw">c</span>(<span class="st">&quot;PLOTID&quot;</span>, <span class="st">&quot;img_date&quot;</span>, <span class="st">&quot;img_src&quot;</span>, <span class="st">&quot;mod_date&quot;</span>, <span class="st">&quot;author&quot;</span>, <span class="st">&quot;ccov&quot;</span>)], <span class="dt">by=</span><span class="st">&quot;PLOTID&quot;</span>, <span class="dt">all.x=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-44" data-line-number="44"></a>
<a class="sourceLine" id="cb12-45" data-line-number="45"><span class="co"># initiate the sample</span></a>
<a class="sourceLine" id="cb12-46" data-line-number="46">val.points &lt;-<span class="st"> </span>frame.points[<span class="dv">0</span>,]</a>
<a class="sourceLine" id="cb12-47" data-line-number="47"></a>
<a class="sourceLine" id="cb12-48" data-line-number="48"><span class="co"># Initialize random number generator</span></a>
<a class="sourceLine" id="cb12-49" data-line-number="49"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb12-50" data-line-number="50"></a>
<a class="sourceLine" id="cb12-51" data-line-number="51"><span class="co"># for each stratum ...</span></a>
<a class="sourceLine" id="cb12-52" data-line-number="52"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(alloc)) {</a>
<a class="sourceLine" id="cb12-53" data-line-number="53">  </a>
<a class="sourceLine" id="cb12-54" data-line-number="54">  strat.n &lt;-<span class="st">  </span>alloc[i, <span class="st">&quot;balanced&quot;</span>]   <span class="co"># stratum sample size</span></a>
<a class="sourceLine" id="cb12-55" data-line-number="55">  sample.ids &lt;-<span class="st"> </span><span class="ot">NULL</span>                 <span class="co"># vectors with ids to sample</span></a>
<a class="sourceLine" id="cb12-56" data-line-number="56">  </a>
<a class="sourceLine" id="cb12-57" data-line-number="57">  <span class="co"># take as much samples already used as training-points</span></a>
<a class="sourceLine" id="cb12-58" data-line-number="58">  ids.tp &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="op">!</span><span class="kw">is.na</span>(frame.points<span class="op">$</span>trans) <span class="op">&amp;</span><span class="st"> </span>frame.points<span class="op">$</span>trans<span class="op">==</span>alloc[i, <span class="st">&quot;value&quot;</span>] <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(frame.points<span class="op">$</span>ccov))</a>
<a class="sourceLine" id="cb12-59" data-line-number="59">  n.tp   &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">length</span>(ids.tp), strat.n)</a>
<a class="sourceLine" id="cb12-60" data-line-number="60">  <span class="cf">if</span> (n.tp <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) sample.ids &lt;-<span class="st"> </span><span class="kw">c</span>(sample.ids, <span class="kw">sample</span>(ids.tp, n.tp))</a>
<a class="sourceLine" id="cb12-61" data-line-number="61">  </a>
<a class="sourceLine" id="cb12-62" data-line-number="62">  <span class="co"># and complete with other samples from the grid</span></a>
<a class="sourceLine" id="cb12-63" data-line-number="63">  ids.r  &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="op">!</span><span class="kw">is.na</span>(frame.points<span class="op">$</span>trans) <span class="op">&amp;</span><span class="st"> </span>frame.points<span class="op">$</span>trans<span class="op">==</span>alloc[i, <span class="st">&quot;value&quot;</span>] <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(frame.points<span class="op">$</span>ccov))</a>
<a class="sourceLine" id="cb12-64" data-line-number="64">  n.r    &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">length</span>(ids.r), strat.n <span class="op">-</span><span class="st"> </span>n.tp)</a>
<a class="sourceLine" id="cb12-65" data-line-number="65">  <span class="cf">if</span> (n.r <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) sample.ids &lt;-<span class="st"> </span><span class="kw">c</span>(sample.ids, <span class="kw">sample</span>(ids.r, n.r)) </a>
<a class="sourceLine" id="cb12-66" data-line-number="66">  </a>
<a class="sourceLine" id="cb12-67" data-line-number="67">  val.points &lt;-<span class="st"> </span><span class="kw">rbind</span>(val.points, frame.points[sample.ids, ])</a>
<a class="sourceLine" id="cb12-68" data-line-number="68">}</a>
<a class="sourceLine" id="cb12-69" data-line-number="69"></a>
<a class="sourceLine" id="cb12-70" data-line-number="70"><span class="co"># shuffle the data</span></a>
<a class="sourceLine" id="cb12-71" data-line-number="71">val.points &lt;-<span class="st"> </span>val.points[<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(val.points)), ]</a>
<a class="sourceLine" id="cb12-72" data-line-number="72"><span class="co"># add ID</span></a>
<a class="sourceLine" id="cb12-73" data-line-number="73">val.points<span class="op">$</span>SAMPLEID &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;val-&quot;</span>, <span class="kw">str_pad</span>(<span class="dt">string=</span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(val.points), <span class="dt">width =</span> <span class="dv">4</span>, <span class="dt">pad =</span> <span class="st">&quot;0&quot;</span>, <span class="dt">side =</span> <span class="st">&quot;left&quot;</span>))</a>
<a class="sourceLine" id="cb12-74" data-line-number="74"></a>
<a class="sourceLine" id="cb12-75" data-line-number="75"></a>
<a class="sourceLine" id="cb12-76" data-line-number="76"><span class="co"># Convert to plots and add attributes</span></a>
<a class="sourceLine" id="cb12-77" data-line-number="77"><span class="co"># ===================================</span></a>
<a class="sourceLine" id="cb12-78" data-line-number="78"></a>
<a class="sourceLine" id="cb12-79" data-line-number="79">landsat.grid &lt;-<span class="st"> </span><span class="kw">raster</span>(change.map)</a>
<a class="sourceLine" id="cb12-80" data-line-number="80"><span class="kw">values</span>(landsat.grid) &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb12-81" data-line-number="81"></a>
<a class="sourceLine" id="cb12-82" data-line-number="82"><span class="co"># convert to polygons</span></a>
<a class="sourceLine" id="cb12-83" data-line-number="83">val.plots &lt;-<span class="st"> </span><span class="kw">rasterToPolygons</span>(<span class="kw">mask</span>(landsat.grid, val.points))</a>
<a class="sourceLine" id="cb12-84" data-line-number="84"></a>
<a class="sourceLine" id="cb12-85" data-line-number="85"><span class="co"># fetch attributes</span></a>
<a class="sourceLine" id="cb12-86" data-line-number="86">val.plots<span class="op">@</span>data &lt;-<span class="st"> </span><span class="kw">over</span>(val.plots, val.points[, <span class="kw">c</span>(<span class="st">&quot;PLOTID&quot;</span>, <span class="st">&quot;SAMPLEID&quot;</span>, <span class="st">&quot;xcoords&quot;</span>, <span class="st">&quot;ycoords&quot;</span>, <span class="st">&quot;trans&quot;</span>, <span class="st">&quot;ccov&quot;</span>, <span class="st">&quot;img_src&quot;</span>, <span class="st">&quot;img_date&quot;</span>, <span class="st">&quot;author&quot;</span>, <span class="st">&quot;mod_date&quot;</span>)])</a>
<a class="sourceLine" id="cb12-87" data-line-number="87"></a>
<a class="sourceLine" id="cb12-88" data-line-number="88"><span class="co"># add attributes</span></a>
<a class="sourceLine" id="cb12-89" data-line-number="89">val.plots<span class="op">$</span>ccov                          &lt;-<span class="st"> </span><span class="kw">format</span>(<span class="kw">round</span>(<span class="dv">100</span><span class="op">*</span>val.plots<span class="op">$</span>ccov, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb12-90" data-line-number="90">val.plots<span class="op">$</span>ccov[val.plots<span class="op">$</span>ccov <span class="op">==</span><span class="st"> &quot;  NA&quot;</span>]&lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb12-91" data-line-number="91">val.plots<span class="op">$</span>lc_<span class="dv">18</span>   &lt;-<span class="st"> </span>val.plots<span class="op">$</span>lc_<span class="dv">15</span>    &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb12-92" data-line-number="92">val.plots<span class="op">$</span>lc_<span class="dv">03</span>   &lt;-<span class="st"> </span>val.plots<span class="op">$</span>lc_<span class="dv">87</span>    &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb12-93" data-line-number="93"></a>
<a class="sourceLine" id="cb12-94" data-line-number="94"><span class="co"># write plots as Shapefile and KML</span></a>
<a class="sourceLine" id="cb12-95" data-line-number="95"><span class="co"># writeOGR(val.plots, dsn=paste0(INPUT.DIR, &quot;/Train-Val/201908/val9k-s16trans/empty&quot;), layer=&quot;UOT_parcelles&quot;, driver=&quot;ESRI Shapefile&quot;, overwrite=TRUE)</span></a>
<a class="sourceLine" id="cb12-96" data-line-number="96"><span class="co"># writeKML(val.plots, kmlname=&quot;UOT_parcelles&quot;, filename=paste0(INPUT.DIR, &quot;/Train-Val/201908/val9k-s16trans/empty/UOT_parcelles.kml&quot;))</span></a>
<a class="sourceLine" id="cb12-97" data-line-number="97"></a>
<a class="sourceLine" id="cb12-98" data-line-number="98"><span class="kw">writeOGR</span>(val.plots, <span class="dt">dsn=</span><span class="st">&quot;.&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;UOT_parcelles&quot;</span>, <span class="dt">driver=</span><span class="st">&quot;ESRI Shapefile&quot;</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-99" data-line-number="99"><span class="kw">writeKML</span>(val.plots, <span class="dt">kmlname=</span><span class="st">&quot;UOT_parcelles&quot;</span>, <span class="dt">filename=</span><span class="st">&quot;UOT_parcelles.kml&quot;</span>)</a>
<a class="sourceLine" id="cb12-100" data-line-number="100"></a>
<a class="sourceLine" id="cb12-101" data-line-number="101"></a>
<a class="sourceLine" id="cb12-102" data-line-number="102"><span class="co"># Create sample grid</span></a>
<a class="sourceLine" id="cb12-103" data-line-number="103"><span class="co"># ==================</span></a>
<a class="sourceLine" id="cb12-104" data-line-number="104"></a>
<a class="sourceLine" id="cb12-105" data-line-number="105">grid.size &lt;-<span class="st"> </span><span class="dv">7</span></a>
<a class="sourceLine" id="cb12-106" data-line-number="106">res &lt;-<span class="st"> </span><span class="kw">res</span>(landsat.grid)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb12-107" data-line-number="107">offset &lt;-<span class="st"> </span><span class="kw">c</span>(res<span class="op">/</span>grid.size<span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">0</span><span class="op">:</span>(grid.size<span class="dv">-1</span>))<span class="op">*</span>res<span class="op">/</span>grid.size)</a>
<a class="sourceLine" id="cb12-108" data-line-number="108"></a>
<a class="sourceLine" id="cb12-109" data-line-number="109"><span class="co"># split the plots for parallel processing</span></a>
<a class="sourceLine" id="cb12-110" data-line-number="110">subsets &lt;-<span class="st"> </span><span class="kw">split</span>(val.plots, <span class="dt">f=</span><span class="dv">1</span><span class="op">:</span><span class="dv">86</span>)</a>
<a class="sourceLine" id="cb12-111" data-line-number="111"></a>
<a class="sourceLine" id="cb12-112" data-line-number="112">val.grids &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">subset=</span>subsets, <span class="dt">.combine=</span>bind, <span class="dt">.multicombine=</span><span class="ot">TRUE</span>) <span class="op">%dopar%</span><span class="st"> </span>{ </a>
<a class="sourceLine" id="cb12-113" data-line-number="113">  grids &lt;-<span class="st"> </span><span class="kw">SpatialPointsDataFrame</span>(<span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">0</span>, <span class="dt">y =</span> <span class="dv">0</span>), <span class="dt">data=</span><span class="kw">data.frame</span>(<span class="dt">PLOTID =</span> <span class="dv">0</span>, <span class="dt">SAMPLEID =</span> <span class="dv">0</span>, <span class="dt">GRIDPOINT =</span> <span class="dv">0</span>))[<span class="op">-</span><span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb12-114" data-line-number="114">  <span class="cf">for</span>(p <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(subset)) {</a>
<a class="sourceLine" id="cb12-115" data-line-number="115">    plot &lt;-<span class="st"> </span>subset[p,]</a>
<a class="sourceLine" id="cb12-116" data-line-number="116">    ext &lt;-<span class="st"> </span><span class="kw">extent</span>(plot)</a>
<a class="sourceLine" id="cb12-117" data-line-number="117">    grids &lt;-<span class="st"> </span><span class="kw">bind</span>(grids, <span class="kw">SpatialPointsDataFrame</span>(<span class="kw">expand.grid</span>(ext<span class="op">@</span>xmin<span class="op">+</span>offset, ext<span class="op">@</span>ymin<span class="op">+</span>offset), <span class="dt">data=</span><span class="kw">data.frame</span>(<span class="dt">PLOTID =</span> plot<span class="op">$</span>PLOTID, <span class="dt">SAMPLEID =</span> plot<span class="op">$</span>SAMPLEID,<span class="dt">GRIDPOINT =</span> <span class="dv">1</span><span class="op">:</span>grid.size<span class="op">^</span><span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb12-118" data-line-number="118">  }</a>
<a class="sourceLine" id="cb12-119" data-line-number="119">  grids</a>
<a class="sourceLine" id="cb12-120" data-line-number="120">}</a>
<a class="sourceLine" id="cb12-121" data-line-number="121"></a>
<a class="sourceLine" id="cb12-122" data-line-number="122"><span class="kw">proj4string</span>(val.grids) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(val.plots)</a>
<a class="sourceLine" id="cb12-123" data-line-number="123"></a>
<a class="sourceLine" id="cb12-124" data-line-number="124"><span class="co"># merge with already collected tree attributes from train.grid</span></a>
<a class="sourceLine" id="cb12-125" data-line-number="125">train.grids &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="kw">paste0</span>(INPUT.DIR, <span class="st">&quot;/Train-Val/201908/trn10k-s10ndvi/assessed_v1/COV_parcelles_grid.shp&quot;</span>))</a>
<a class="sourceLine" id="cb12-126" data-line-number="126">val.grids &lt;-<span class="st"> </span><span class="kw">merge</span>(val.grids, train.grids<span class="op">@</span>data[, <span class="kw">c</span>(<span class="st">&quot;PLOTID&quot;</span>, <span class="st">&quot;GRIDPOINT&quot;</span>, <span class="st">&quot;tree&quot;</span>)], <span class="dt">all.x=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-127" data-line-number="127"></a>
<a class="sourceLine" id="cb12-128" data-line-number="128"></a>
<a class="sourceLine" id="cb12-129" data-line-number="129"><span class="kw">writeOGR</span>(val.grids, <span class="dt">dsn=</span><span class="st">&quot;.&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;UOT_parcelles_grid&quot;</span>, <span class="dt">driver=</span><span class="st">&quot;ESRI Shapefile&quot;</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-130" data-line-number="130"></a>
<a class="sourceLine" id="cb12-131" data-line-number="131"></a>
<a class="sourceLine" id="cb12-132" data-line-number="132"><span class="co"># Divide into 10 subsets and export</span></a>
<a class="sourceLine" id="cb12-133" data-line-number="133"><span class="co"># =================================</span></a>
<a class="sourceLine" id="cb12-134" data-line-number="134"></a>
<a class="sourceLine" id="cb12-135" data-line-number="135">subsets &lt;-<span class="st"> </span><span class="kw">split</span>(val.plots, <span class="dt">f=</span><span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb12-136" data-line-number="136"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(subsets)) {</a>
<a class="sourceLine" id="cb12-137" data-line-number="137">  <span class="kw">writeOGR</span>(subsets[[i]], <span class="dt">dsn=</span><span class="st">&quot;.&quot;</span>, <span class="dt">layer=</span><span class="kw">paste0</span>(<span class="st">&quot;UOT_parcelles_&quot;</span>, i), <span class="dt">driver=</span><span class="st">&quot;ESRI Shapefile&quot;</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-138" data-line-number="138">  <span class="kw">writeKML</span>(subsets[[i]], <span class="dt">kmlname=</span><span class="kw">paste0</span>(<span class="st">&quot;UOT_parcelles_&quot;</span>, i) , <span class="dt">filename=</span><span class="kw">paste0</span>(<span class="st">&quot;UOT_parcelles_&quot;</span>, i, <span class="st">&quot;.kml&quot;</span>))</a>
<a class="sourceLine" id="cb12-139" data-line-number="139">  subset.grids &lt;-<span class="st"> </span>val.grids[val.grids<span class="op">$</span>PLOTID <span class="op">%in%</span><span class="st"> </span>subsets[[i]]<span class="op">$</span>PLOTID,]</a>
<a class="sourceLine" id="cb12-140" data-line-number="140">  <span class="kw">writeOGR</span>(subset.grids, <span class="dt">dsn=</span><span class="st">&quot;.&quot;</span>, <span class="dt">layer=</span><span class="kw">paste0</span>(<span class="st">&quot;UOT_parcelles_&quot;</span>, i, <span class="st">&quot;_grid&quot;</span>), <span class="dt">driver=</span><span class="st">&quot;ESRI Shapefile&quot;</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-141" data-line-number="141">}</a></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="02_training-plots.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="04_collecte-donnees.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true,
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
