<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4.2.3 Nettoyage des cartes brutes | _main.utf8</title>
  <meta name="description" content="République Togolaise —<br />
Système Nationale de Surveillance des Forêts</div>" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="4.2.3 Nettoyage des cartes brutes | _main.utf8" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://ogardi.github.io/NERF-Togo" />
  <meta property="og:image" content="https://ogardi.github.io/NERF-Togoimages/NERF-Togo.png" />
  
  <meta name="github-repo" content="ogardi/NERF-Togo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4.2.3 Nettoyage des cartes brutes | _main.utf8" />
  
  
  <meta name="twitter:image" content="https://ogardi.github.io/NERF-Togoimages/NERF-Togo.png" />

<meta name="author" content="Oliver Gardi, Fifonsi Dangbo, Sophie Dzigbod, Ditorgue Bakabima" />


<meta name="date" content="2020-03-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="02_create-AGB-maps.html"/>
<link rel="next" href="04_analyze-AGB.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://github.com/ogardi/NERF-Togo"><b>SNSF Togo</b><br>v 1.0 / en développement</a></li>
<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Préface</a></li>
<li class="chapter" data-level="1" data-path="00_introduction.html"><a href="00_introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="01_arrangements.html"><a href="01_arrangements.html"><i class="fa fa-check"></i><b>1.1</b> Arrangements institutionelles</a></li>
<li class="chapter" data-level="1.2" data-path="02_organisation.html"><a href="02_organisation.html"><i class="fa fa-check"></i><b>1.2</b> Organisation du travail</a><ul>
<li class="chapter" data-level="1.2.1" data-path="02_organisation.html"><a href="02_organisation.html#logiciel-et-serveur"><i class="fa fa-check"></i><b>1.2.1</b> Logiciel et serveur</a></li>
<li class="chapter" data-level="1.2.2" data-path="02_organisation.html"><a href="02_organisation.html#structure-du-répértoire"><i class="fa fa-check"></i><b>1.2.2</b> Structure du répértoire</a></li>
<li class="chapter" data-level="1.2.3" data-path="02_organisation.html"><a href="02_organisation.html#création-dun-nouveau-projet"><i class="fa fa-check"></i><b>1.2.3</b> Création d’un nouveau projet</a></li>
<li class="chapter" data-level="1.2.4" data-path="02_organisation.html"><a href="02_organisation.html#NRF-set-up.R"><i class="fa fa-check"></i><b>1.2.4</b> Définition des variables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="00_STSS.html"><a href="00_STSS.html"><i class="fa fa-check"></i><b>2</b> Système de Surveillance Terrestre</a><ul>
<li class="chapter" data-level="2.1" data-path="01_data.html"><a href="01_data.html"><i class="fa fa-check"></i><b>2.1</b> Images satellitaires</a><ul>
<li class="chapter" data-level="2.1.1" data-path="01_data.html"><a href="01_data.html#acquisition-des-images"><i class="fa fa-check"></i><b>2.1.1</b> Acquisition des images</a></li>
<li class="chapter" data-level="2.1.2" data-path="01_data.html"><a href="01_data.html#prétraitement-des-images"><i class="fa fa-check"></i><b>2.1.2</b> Prétraitement des images</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="02_sampling-plan.html"><a href="02_sampling-plan.html"><i class="fa fa-check"></i><b>2.2</b> Réseau d’échantillonnage</a></li>
<li class="chapter" data-level="2.3" data-path="02_sampling-plan.html"><a href="02_sampling-plan.html#attributs-enregistrés"><i class="fa fa-check"></i><b>2.3</b> Attributs enregistrés</a><ul>
<li class="chapter" data-level="2.3.1" data-path="02_sampling-plan.html"><a href="02_sampling-plan.html#SSTS-couverture-houppiers"><i class="fa fa-check"></i><b>2.3.1</b> Couverture des houppiers</a></li>
<li class="chapter" data-level="2.3.2" data-path="02_sampling-plan.html"><a href="02_sampling-plan.html#SSTS-occupation-terres"><i class="fa fa-check"></i><b>2.3.2</b> Occupation des terres</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="02_sampling-plan.html"><a href="02_sampling-plan.html#mise-en-oeuvre-du-ssts"><i class="fa fa-check"></i><b>2.4</b> Mise en oeuvre du SSTS</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="00_IFN.html"><a href="00_IFN.html"><i class="fa fa-check"></i><b>3</b> Inventaire Forestier National</a></li>
<li class="chapter" data-level="4" data-path="00_NERF-MRV.html"><a href="00_NERF-MRV.html"><i class="fa fa-check"></i><b>4</b> Analyses NRF/MRV</a><ul>
<li class="chapter" data-level="4.1" data-path="00_analyse-FCC.html"><a href="00_analyse-FCC.html"><i class="fa fa-check"></i><b>4.1</b> Analyse surfaces forestiers</a><ul>
<li class="chapter" data-level="4.1.1" data-path="01_create-train-points.html"><a href="01_create-train-points.html"><i class="fa fa-check"></i><b>4.1.1</b> Parcelles d’entraînement</a></li>
<li class="chapter" data-level="4.1.2" data-path="02_create-fc-maps.html"><a href="02_create-fc-maps.html"><i class="fa fa-check"></i><b>4.1.2</b> Calibration et classification</a></li>
<li class="chapter" data-level="4.1.3" data-path="03_clean-fc-maps.html"><a href="03_clean-fc-maps.html"><i class="fa fa-check"></i><b>4.1.3</b> Nettoyage des cartes brutes</a></li>
<li class="chapter" data-level="4.1.4" data-path="04_create-val-points.html"><a href="04_create-val-points.html"><i class="fa fa-check"></i><b>4.1.4</b> Parcelles de validation</a></li>
<li class="chapter" data-level="4.1.5" data-path="05_validate-fc-maps.html"><a href="05_validate-fc-maps.html"><i class="fa fa-check"></i><b>4.1.5</b> Validation des cartes</a></li>
<li class="chapter" data-level="4.1.6" data-path="06_fc-maps-accuracy.html"><a href="06_fc-maps-accuracy.html"><i class="fa fa-check"></i><b>4.1.6</b> Analyse de la précision</a></li>
<li class="chapter" data-level="4.1.7" data-path="07_analyse-fc-maps.html"><a href="07_analyse-fc-maps.html"><i class="fa fa-check"></i><b>4.1.7</b> Production des résultats</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="00_analyse-AGB.html"><a href="00_analyse-AGB.html"><i class="fa fa-check"></i><b>4.2</b> Analyse biomasse aérienne</a><ul>
<li class="chapter" data-level="4.2.1" data-path="01_compile-IFN.html"><a href="01_compile-IFN.html"><i class="fa fa-check"></i><b>4.2.1</b> Analyse des données IFN</a></li>
<li class="chapter" data-level="4.2.2" data-path="02_create-AGB-maps.html"><a href="02_create-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.2</b> Calibration et prédiction</a></li>
<li class="chapter" data-level="4.2.3" data-path="03_clean-AGB-maps.html"><a href="03_clean-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.3</b> Nettoyage des cartes brutes</a></li>
<li class="chapter" data-level="4.2.4" data-path="04_analyze-AGB.html"><a href="04_analyze-AGB.html"><i class="fa fa-check"></i><b>4.2.4</b> Production des résultats</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown">Fièrement publié avec bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><div class="line-block">République Togolaise —<br />
Système Nationale de Surveillance des Forêts</div></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="nettoyage-des-cartes-brutes" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Nettoyage des cartes brutes</h3>
<div id="description-11" class="section level4 unnumbered">
<h4>Description</h4>
<p>Description de la méthodologie / script</p>
</div>
<div id="agb4_clean-agb-maps.r" class="section level4 unnumbered">
<h4><em>AGB/4_clean-AGB-maps.R</em></h4>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="co">####################################################################</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="co"># NERF_Togo/AGB/4_clean-agb-maps.R: clean AGB raw maps</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="co"># ------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="co"># Bern University of Applied Sciences</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="co"># Oliver Gardi, &lt;oliver.gardi@bfh.ch&gt;</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="co"># 10 October 2019</span></a>
<a class="sourceLine" id="cb17-7" title="7"></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">### DEFINITIONS ############################################################</span></a>
<a class="sourceLine" id="cb17-9" title="9"></a>
<a class="sourceLine" id="cb17-10" title="10">PERIOD    &lt;-<span class="st"> </span><span class="dv">1985</span><span class="op">:</span><span class="dv">2019</span></a>
<a class="sourceLine" id="cb17-11" title="11"></a>
<a class="sourceLine" id="cb17-12" title="12">path &lt;-<span class="st"> &quot;p193&quot;</span></a>
<a class="sourceLine" id="cb17-13" title="13"></a>
<a class="sourceLine" id="cb17-14" title="14"></a>
<a class="sourceLine" id="cb17-15" title="15"><span class="co"># LOESS smoothing of time series</span></a>
<a class="sourceLine" id="cb17-16" title="16"></a>
<a class="sourceLine" id="cb17-17" title="17">loess.filter &lt;-<span class="st"> </span><span class="cf">function</span> (agb, years, pred, span) {</a>
<a class="sourceLine" id="cb17-18" title="18">  <span class="kw">ifelse</span>( <span class="kw">all</span>(<span class="kw">is.na</span>(agb)), </a>
<a class="sourceLine" id="cb17-19" title="19">          <span class="kw">return</span>(<span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">length</span>(pred))), </a>
<a class="sourceLine" id="cb17-20" title="20">          <span class="kw">return</span>(<span class="kw">predict</span>(<span class="kw">loess</span>(agb <span class="op">~</span><span class="st"> </span>years,</a>
<a class="sourceLine" id="cb17-21" title="21">                               <span class="dt">degree =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb17-22" title="22">                               <span class="dt">span =</span> span), </a>
<a class="sourceLine" id="cb17-23" title="23">                         pred)</a>
<a class="sourceLine" id="cb17-24" title="24">          ))</a>
<a class="sourceLine" id="cb17-25" title="25">}</a>
<a class="sourceLine" id="cb17-26" title="26"></a>
<a class="sourceLine" id="cb17-27" title="27">clean.agb &lt;-<span class="st"> </span><span class="cf">function</span>(path) {</a>
<a class="sourceLine" id="cb17-28" title="28">  </a>
<a class="sourceLine" id="cb17-29" title="29">  <span class="co"># Preparation -------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb17-30" title="30">  </a>
<a class="sourceLine" id="cb17-31" title="31">  maps &lt;-<span class="st"> </span><span class="kw">stack</span>(<span class="kw">dir</span>(<span class="kw">paste0</span>(BIOMASS.DIR, <span class="st">&quot;/3_raw-maps/&quot;</span>, path), <span class="dt">pattern=</span><span class="st">&quot;.*[[:digit:]]{4}</span><span class="ch">\\</span><span class="st">_mr</span><span class="ch">\\</span><span class="st">.tif$&quot;</span>, <span class="dt">full.names=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb17-32" title="32">  map.names &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;r$&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">names</span>(maps))</a>
<a class="sourceLine" id="cb17-33" title="33">  map.cols  &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="kw">paste0</span>(path, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">_&quot;</span>), <span class="st">&quot;X&quot;</span>, <span class="kw">sub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">_[[:alnum:]]+$&quot;</span>, <span class="st">&quot;M&quot;</span>, map.names))</a>
<a class="sourceLine" id="cb17-34" title="34">  map.years &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substr</span>(map.cols, <span class="dv">2</span>, <span class="dv">5</span>))</a>
<a class="sourceLine" id="cb17-35" title="35">  </a>
<a class="sourceLine" id="cb17-36" title="36">  maps.values &lt;-<span class="st"> </span><span class="kw">values</span>(maps)                              <span class="co"># extract vector with cell values (huge matrix, takes some time)</span></a>
<a class="sourceLine" id="cb17-37" title="37">  <span class="kw">colnames</span>(maps.values) &lt;-<span class="st"> </span>map.cols</a>
<a class="sourceLine" id="cb17-38" title="38">  </a>
<a class="sourceLine" id="cb17-39" title="39">  nsubsets &lt;-<span class="st"> </span>numCores <span class="op">-</span><span class="st"> </span><span class="dv">1</span>                                 <span class="co"># define subsets for parallel processing</span></a>
<a class="sourceLine" id="cb17-40" title="40">  subsets  &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">floor</span>((<span class="dv">1</span><span class="op">:</span>nsubsets)<span class="op">*</span>(<span class="kw">nrow</span>(maps.values)<span class="op">/</span>nsubsets)))    </a>
<a class="sourceLine" id="cb17-41" title="41">  </a>
<a class="sourceLine" id="cb17-42" title="42">  </a>
<a class="sourceLine" id="cb17-43" title="43">  </a>
<a class="sourceLine" id="cb17-44" title="44">  <span class="co"># Parallel cleaning of pixel trajectories ###############################</span></a>
<a class="sourceLine" id="cb17-45" title="45">  </a>
<a class="sourceLine" id="cb17-46" title="46">  <span class="kw">registerDoParallel</span>(.env<span class="op">$</span>numCores<span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb17-47" title="47">  loess.dat &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i=</span><span class="dv">1</span><span class="op">:</span>nsubsets, <span class="dt">.combine=</span>rbind) <span class="op">%dopar%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb17-48" title="48">    </a>
<a class="sourceLine" id="cb17-49" title="49">    val &lt;-<span class="st"> </span>maps.values[(subsets[i]<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>subsets[i<span class="op">+</span><span class="dv">1</span>], ]       <span class="co"># get one tile of the matrix</span></a>
<a class="sourceLine" id="cb17-50" title="50">    </a>
<a class="sourceLine" id="cb17-51" title="51">    <span class="kw">t</span>(<span class="kw">apply</span>(val, <span class="dv">1</span>, loess.filter, <span class="dt">years=</span>map.years, <span class="dt">pred=</span>map.years, <span class="dt">span=</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb17-52" title="52">  }</a>
<a class="sourceLine" id="cb17-53" title="53">  </a>
<a class="sourceLine" id="cb17-54" title="54">  </a>
<a class="sourceLine" id="cb17-55" title="55">  maps.loess &lt;-<span class="st"> </span>maps</a>
<a class="sourceLine" id="cb17-56" title="56">  maps.loess[] &lt;-<span class="st"> </span>loess.dat</a>
<a class="sourceLine" id="cb17-57" title="57">  <span class="kw">writeRaster</span>(maps.loess, <span class="kw">paste0</span>(BIOMASS.DIR, <span class="st">&quot;/4_clean-maps/&quot;</span>, path, <span class="st">&quot;_loess.tif&quot;</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-58" title="58">  </a>
<a class="sourceLine" id="cb17-59" title="59">}</a>
<a class="sourceLine" id="cb17-60" title="60">    </a>
<a class="sourceLine" id="cb17-61" title="61">    </a>
<a class="sourceLine" id="cb17-62" title="62">    </a>
<a class="sourceLine" id="cb17-63" title="63"></a>
<a class="sourceLine" id="cb17-64" title="64"></a>
<a class="sourceLine" id="cb17-65" title="65"></a>
<a class="sourceLine" id="cb17-66" title="66"></a>
<a class="sourceLine" id="cb17-67" title="67"></a>
<a class="sourceLine" id="cb17-68" title="68"><span class="co">################################</span></a>
<a class="sourceLine" id="cb17-69" title="69"></a>
<a class="sourceLine" id="cb17-70" title="70">dates &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1987</span>, <span class="dv">1991</span>, <span class="dv">2000</span>, <span class="dv">2003</span>, <span class="dv">2005</span>, <span class="dv">2007</span>, <span class="dv">2008</span>, <span class="dv">2009</span>, <span class="dv">2010</span>, <span class="dv">2012</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2018</span>, <span class="dv">2019</span>)</a>
<a class="sourceLine" id="cb17-71" title="71"></a>
<a class="sourceLine" id="cb17-72" title="72"></a>
<a class="sourceLine" id="cb17-73" title="73"><span class="cf">for</span>(year <span class="cf">in</span> dates) {</a>
<a class="sourceLine" id="cb17-74" title="74">  <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Creating AGB map&quot;</span>, year, <span class="st">&quot;...&quot;</span>))</a>
<a class="sourceLine" id="cb17-75" title="75">  image &lt;-<span class="st"> </span><span class="kw">dir</span>(<span class="dt">path=</span><span class="st">&quot;../results/images/&quot;</span>, <span class="dt">pattern=</span><span class="kw">paste0</span>(<span class="st">&quot;^&quot;</span>, year, <span class="st">&quot;.*_L2.tif$&quot;</span>), <span class="dt">full.names=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-76" title="76">  base  &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;../results/carbone/AGB_&quot;</span>, year, <span class="st">&quot;_2015&quot;</span>)</a>
<a class="sourceLine" id="cb17-77" title="77">  biomass.map       &lt;-<span class="st"> </span><span class="kw">create.biomass.map</span>(<span class="dt">ref =</span>      <span class="kw">raster</span>(<span class="st">&quot;../results/carbone/AGB_2015_REF_corr.tif&quot;</span>), </a>
<a class="sourceLine" id="cb17-78" title="78">                                          <span class="dt">x =</span>        <span class="kw">brick</span>(image))</a>
<a class="sourceLine" id="cb17-79" title="79">  <span class="kw">writeRaster</span>(biomass.map<span class="op">$</span>map,            <span class="dt">filename =</span> <span class="kw">paste0</span>(base, <span class="st">&quot;.tif&quot;</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-80" title="80">  <span class="kw">writeRaster</span>(biomass.map<span class="op">$</span>map.bias.corr,  <span class="dt">filename =</span> <span class="kw">paste0</span>(base, <span class="st">&quot;_corr.tif&quot;</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-81" title="81">  <span class="kw">sink</span>(                                       <span class="dt">file =</span> <span class="kw">paste0</span>(base, <span class="st">&quot;_models.txt&quot;</span>))</a>
<a class="sourceLine" id="cb17-82" title="82">  <span class="kw">print</span>(biomass.map<span class="op">$</span>rf); <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb17-83" title="83">  <span class="kw">print</span>(<span class="kw">importance</span>(biomass.map<span class="op">$</span>rf)); <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb17-84" title="84">  <span class="kw">print</span>(<span class="kw">summary</span>(biomass.map<span class="op">$</span>lm.bias.corr))</a>
<a class="sourceLine" id="cb17-85" title="85">  <span class="kw">sink</span>()</a>
<a class="sourceLine" id="cb17-86" title="86">}</a>
<a class="sourceLine" id="cb17-87" title="87"></a>
<a class="sourceLine" id="cb17-88" title="88"></a>
<a class="sourceLine" id="cb17-89" title="89"></a>
<a class="sourceLine" id="cb17-90" title="90"><span class="co"># Show the effect of bias correction</span></a>
<a class="sourceLine" id="cb17-91" title="91"></a>
<a class="sourceLine" id="cb17-92" title="92"><span class="kw">ggplot</span>(biomass.map<span class="op">$</span>sample.pts<span class="op">@</span>data, <span class="kw">aes</span>(<span class="dt">y=</span>ref.agb, <span class="dt">x=</span>agb)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-93" title="93"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.01</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-94" title="94"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">slope=</span><span class="dv">1</span>, <span class="dt">linetype=</span><span class="dv">3</span>, <span class="dt">alpha=</span><span class="fl">0.9</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-95" title="95"><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> biomass.map<span class="op">$</span>lm.bias.corr<span class="op">$</span>coefficients[<span class="dv">1</span>], <span class="dt">slope =</span> biomass.map<span class="op">$</span>lm.bias.corr<span class="op">$</span>coefficients[<span class="dv">2</span>], <span class="dt">linetype=</span><span class="dv">2</span>, <span class="dt">alpha=</span><span class="fl">0.9</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-96" title="96"><span class="st">  </span><span class="kw">theme_light</span>()</a>
<a class="sourceLine" id="cb17-97" title="97"></a>
<a class="sourceLine" id="cb17-98" title="98"></a>
<a class="sourceLine" id="cb17-99" title="99"></a>
<a class="sourceLine" id="cb17-100" title="100"><span class="co"># load the raw carbon maps and do some analysis</span></a>
<a class="sourceLine" id="cb17-101" title="101"><span class="co"># â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ </span></a>
<a class="sourceLine" id="cb17-102" title="102"></a>
<a class="sourceLine" id="cb17-103" title="103">files &lt;-<span class="st"> </span><span class="kw">dir</span>(<span class="dt">path=</span><span class="st">&quot;../results/carbone&quot;</span>, <span class="dt">pattern=</span><span class="st">&quot;^.*2015.tif$&quot;</span>, <span class="dt">full.names=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-104" title="104">maps &lt;-<span class="st"> </span><span class="kw">stack</span>(files)</a>
<a class="sourceLine" id="cb17-105" title="105"><span class="kw">names</span>(maps) &lt;-<span class="st"> </span>dates</a>
<a class="sourceLine" id="cb17-106" title="106"></a>
<a class="sourceLine" id="cb17-107" title="107">maps.dat &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">na.omit</span>(maps[]))</a>
<a class="sourceLine" id="cb17-108" title="108"></a>
<a class="sourceLine" id="cb17-109" title="109">dens.plot &lt;-<span class="st"> </span>maps.dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(variable, value, X1987, X1991, X2000, X2003, X2008, X2013, X2015, X2018) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-110" title="110"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>value, <span class="dt">color=</span>variable, <span class="dt">linetype=</span>variable)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-111" title="111"><span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-112" title="112"><span class="st">  </span><span class="kw">theme_light</span>() </a>
<a class="sourceLine" id="cb17-113" title="113"></a>
<a class="sourceLine" id="cb17-114" title="114"><span class="kw">print</span>(dens.plot)</a>
<a class="sourceLine" id="cb17-115" title="115"></a>
<a class="sourceLine" id="cb17-116" title="116"><span class="kw">pdf</span>(<span class="st">&quot;../results/carbone/densities_all.pdf&quot;</span>)</a>
<a class="sourceLine" id="cb17-117" title="117"><span class="kw">print</span>(dens.plot)</a>
<a class="sourceLine" id="cb17-118" title="118"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb17-119" title="119"></a>
<a class="sourceLine" id="cb17-120" title="120"></a>
<a class="sourceLine" id="cb17-121" title="121"></a>
<a class="sourceLine" id="cb17-122" title="122"></a>
<a class="sourceLine" id="cb17-123" title="123"></a>
<a class="sourceLine" id="cb17-124" title="124"></a>
<a class="sourceLine" id="cb17-125" title="125"><span class="co"># Validation of loess-smoothed 2015</span></a>
<a class="sourceLine" id="cb17-126" title="126">map<span class="fl">.2015</span> &lt;-<span class="st"> </span><span class="kw">stack</span>(<span class="st">&quot;../results/carbone/level2/AGBmaps_loess.tif&quot;</span>)[[<span class="dv">12</span>]]</a>
<a class="sourceLine" id="cb17-127" title="127">map<span class="fl">.2003</span> &lt;-<span class="st"> </span><span class="kw">stack</span>(<span class="st">&quot;../results/carbone/level2/AGBmaps_loess.tif&quot;</span>)[[<span class="dv">4</span>]]</a>
<a class="sourceLine" id="cb17-128" title="128">plots &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(map<span class="fl">.2015</span>, plots, <span class="dt">sp=</span><span class="ot">TRUE</span>, <span class="dt">fun=</span>mean, <span class="dt">buffer=</span><span class="dv">20</span>, <span class="dt">normalizeWeights=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-129" title="129">plots &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(map<span class="fl">.2003</span>, plots, <span class="dt">sp=</span><span class="ot">TRUE</span>, <span class="dt">fun=</span>mean, <span class="dt">buffer=</span><span class="dv">20</span>, <span class="dt">normalizeWeights=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-130" title="130"><span class="kw">names</span>(plots)</a>
<a class="sourceLine" id="cb17-131" title="131"></a>
<a class="sourceLine" id="cb17-132" title="132">tmp &lt;-<span class="st"> </span>plots<span class="op">@</span>data[,<span class="kw">c</span>(<span class="st">&quot;BaHa&quot;</span>, <span class="st">&quot;AGBmaps_loess.12&quot;</span>, <span class="st">&quot;AGBmaps_loess.4&quot;</span>)]</a>
<a class="sourceLine" id="cb17-133" title="133">tmp<span class="op">$</span>cex &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">+</span><span class="kw">abs</span>(tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.12</span><span class="op">-</span>tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.4</span>)<span class="op">/</span><span class="dv">30</span></a>
<a class="sourceLine" id="cb17-134" title="134">tmp<span class="op">$</span>col[tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.12</span><span class="op">-</span>tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.4</span> <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> &quot;red&quot;</span></a>
<a class="sourceLine" id="cb17-135" title="135">tmp<span class="op">$</span>col[tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.12</span><span class="op">-</span>tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.4</span> <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> &quot;blue&quot;</span></a>
<a class="sourceLine" id="cb17-136" title="136"></a>
<a class="sourceLine" id="cb17-137" title="137"><span class="kw">pdf</span>(<span class="st">&quot;../results/carbone/figures/Validation_LoessMap2015.pdf&quot;</span>)</a>
<a class="sourceLine" id="cb17-138" title="138"><span class="kw">plot</span>(tmp<span class="op">$</span>BaHa, tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.12</span>, <span class="dt">main=</span><span class="st">&quot;AGB Carbon Stocks on Permanent Inventory Plots&quot;</span>,</a>
<a class="sourceLine" id="cb17-139" title="139">     <span class="dt">xlab=</span><span class="st">&quot;National Forest Inventory 2015 (tC/ha)&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;LOESS-smoothed Carbon Map 2015&quot;</span>)</a>
<a class="sourceLine" id="cb17-140" title="140"><span class="kw">points</span>(tmp<span class="op">$</span>BaHa[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>], tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.12</span>[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>], <span class="dt">cex=</span>tmp<span class="op">$</span>cex[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>], <span class="dt">col=</span>tmp<span class="op">$</span>col[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>])</a>
<a class="sourceLine" id="cb17-141" title="141"><span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb17-142" title="142"><span class="kw">abline</span>(<span class="dv">0</span>,<span class="fl">0.5</span>, <span class="dt">lty=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb17-143" title="143"><span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span><span class="op">/</span><span class="fl">0.5</span>, <span class="dt">lty=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb17-144" title="144"><span class="kw">legend</span>(<span class="st">&quot;bottomright&quot;</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">pch=</span><span class="dv">1</span>, <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;Loss of &gt;= 20 tC since 2003&quot;</span>, <span class="st">&quot;Gain of &gt;= 20 tC since 2003&quot;</span>))</a>
<a class="sourceLine" id="cb17-145" title="145"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb17-146" title="146"></a>
<a class="sourceLine" id="cb17-147" title="147"><span class="kw">pdf</span>(<span class="st">&quot;../results/carbone/figures/Validation_LoessMap2015_Residuals.pdf&quot;</span>)</a>
<a class="sourceLine" id="cb17-148" title="148"><span class="kw">plot</span>(tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.12</span><span class="op">-</span>tmp<span class="op">$</span>BaHa<span class="op">~</span>tmp<span class="op">$</span>BaHa, <span class="dt">main=</span><span class="st">&quot;AGB Carbon Stocks on Permanent Inventory Plots&quot;</span>,</a>
<a class="sourceLine" id="cb17-149" title="149">     <span class="dt">xlab=</span><span class="st">&quot;National Forest Inventory 2015 (tC/ha)&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Residuals of LOESS-smoothed Carbon Map 2015&quot;</span>)</a>
<a class="sourceLine" id="cb17-150" title="150"><span class="kw">points</span>(tmp<span class="op">$</span>BaHa[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>], tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.12</span>[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>]<span class="op">-</span>tmp<span class="op">$</span>BaHa[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>], <span class="dt">cex=</span>tmp<span class="op">$</span>cex[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>], <span class="dt">col=</span>tmp<span class="op">$</span>col[tmp<span class="op">$</span>cex <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.7</span>])</a>
<a class="sourceLine" id="cb17-151" title="151">bias.corr &lt;-<span class="st"> </span><span class="kw">lm</span>(tmp<span class="op">$</span>AGBmaps_loess<span class="fl">.12</span><span class="op">-</span>tmp<span class="op">$</span>BaHa<span class="op">~</span>tmp<span class="op">$</span>BaHa)</a>
<a class="sourceLine" id="cb17-152" title="152"><span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb17-153" title="153"><span class="kw">abline</span>(bias.corr, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb17-154" title="154"><span class="kw">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">pch=</span><span class="dv">1</span>, <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;Loss of &gt;= 20 tC since 2003&quot;</span>, <span class="st">&quot;Gain of &gt;= 20 tC since 2003&quot;</span>))</a>
<a class="sourceLine" id="cb17-155" title="155"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb17-156" title="156"></a>
<a class="sourceLine" id="cb17-157" title="157"></a>
<a class="sourceLine" id="cb17-158" title="158"></a>
<a class="sourceLine" id="cb17-159" title="159"></a>
<a class="sourceLine" id="cb17-160" title="160"><span class="co"># Load the cleaned maps and create tables</span></a>
<a class="sourceLine" id="cb17-161" title="161"><span class="co"># =======================================</span></a>
<a class="sourceLine" id="cb17-162" title="162"></a>
<a class="sourceLine" id="cb17-163" title="163">biomass.tabs &lt;-<span class="st"> </span><span class="cf">function</span>(map, <span class="dt">aoi=</span><span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb17-164" title="164">  </a>
<a class="sourceLine" id="cb17-165" title="165">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(aoi)) map &lt;-<span class="st"> </span><span class="kw">crop</span>(map, aoi)</a>
<a class="sourceLine" id="cb17-166" title="166">  </a>
<a class="sourceLine" id="cb17-167" title="167">  agb.dat        &lt;-<span class="st"> </span>map[]</a>
<a class="sourceLine" id="cb17-168" title="168">  agb.change.dat &lt;-<span class="st"> </span>agb.dat[,<span class="dv">2</span><span class="op">:</span><span class="kw">ncol</span>(agb.dat)] <span class="op">-</span><span class="st"> </span>agb.dat[,<span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(agb.dat)<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb17-169" title="169">  agb.loss.dat   &lt;-<span class="st"> </span>agb.change.dat; agb.loss.dat[agb.loss.dat <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb17-170" title="170">  agb.gain.dat   &lt;-<span class="st"> </span>agb.change.dat; agb.gain.dat[agb.gain.dat <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb17-171" title="171">  </a>
<a class="sourceLine" id="cb17-172" title="172">  dates &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substr</span>(<span class="kw">names</span>(map), <span class="dv">2</span>, <span class="dv">5</span>))</a>
<a class="sourceLine" id="cb17-173" title="173">  </a>
<a class="sourceLine" id="cb17-174" title="174">  agb.tab &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">year      =</span> dates, </a>
<a class="sourceLine" id="cb17-175" title="175">                        <span class="dt">total.agb =</span> <span class="kw">colSums</span>(agb.dat, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="dv">30</span><span class="op">^</span><span class="dv">2</span><span class="op">/</span><span class="dv">10000</span>, </a>
<a class="sourceLine" id="cb17-176" title="176">                        <span class="dt">period    =</span> <span class="kw">c</span>(<span class="ot">NA</span>, dates[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>dates[<span class="op">-</span><span class="kw">length</span>(dates)]), </a>
<a class="sourceLine" id="cb17-177" title="177">                        <span class="dt">center    =</span> <span class="kw">c</span>(<span class="ot">NA</span>, (dates[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>dates[<span class="op">-</span><span class="kw">length</span>(dates)])<span class="op">/</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb17-178" title="178">  </a>
<a class="sourceLine" id="cb17-179" title="179">  agb.tab<span class="op">$</span>loss.t.yr              &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>, <span class="kw">colSums</span>(agb.loss.dat, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="dv">30</span><span class="op">^</span><span class="dv">2</span><span class="op">/</span><span class="dv">10000</span>)<span class="op">/</span>agb.tab<span class="op">$</span>period</a>
<a class="sourceLine" id="cb17-180" title="180">  agb.tab<span class="op">$</span>gain.t.yr              &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>, <span class="kw">colSums</span>(agb.gain.dat, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="dv">30</span><span class="op">^</span><span class="dv">2</span><span class="op">/</span><span class="dv">10000</span>)<span class="op">/</span>agb.tab<span class="op">$</span>period</a>
<a class="sourceLine" id="cb17-181" title="181">  agb.tab<span class="op">$</span>netchange.t.yr         &lt;-<span class="st"> </span>agb.tab<span class="op">$</span>loss.t.yr <span class="op">+</span><span class="st"> </span>agb.tab<span class="op">$</span>gain.t.yr </a>
<a class="sourceLine" id="cb17-182" title="182">  </a>
<a class="sourceLine" id="cb17-183" title="183">  agb.tab<span class="op">$</span>loss.pc.yr             &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>, <span class="dv">1</span><span class="op">/</span>agb.tab<span class="op">$</span>period[<span class="dv">2</span><span class="op">:</span>(<span class="kw">nrow</span>(agb.tab))] <span class="op">*</span><span class="st"> </span><span class="kw">log</span>((agb.tab<span class="op">$</span>total.agb[<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(agb.tab)<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>agb.tab<span class="op">$</span>period[<span class="dv">2</span><span class="op">:</span>(<span class="kw">nrow</span>(agb.tab))] <span class="op">*</span><span class="st"> </span>agb.tab<span class="op">$</span>loss.t.yr[<span class="dv">2</span><span class="op">:</span>(<span class="kw">nrow</span>(agb.tab))]) <span class="op">/</span><span class="st"> </span>agb.tab<span class="op">$</span>total.agb[<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(agb.tab)<span class="op">-</span><span class="dv">1</span>])), <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb17-184" title="184">  agb.tab<span class="op">$</span>gain.pc.yr             &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>, <span class="dv">1</span><span class="op">/</span>agb.tab<span class="op">$</span>period[<span class="dv">2</span><span class="op">:</span>(<span class="kw">nrow</span>(agb.tab))] <span class="op">*</span><span class="st"> </span><span class="kw">log</span>((agb.tab<span class="op">$</span>total.agb[<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(agb.tab)<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>agb.tab<span class="op">$</span>period[<span class="dv">2</span><span class="op">:</span>(<span class="kw">nrow</span>(agb.tab))] <span class="op">*</span><span class="st"> </span>agb.tab<span class="op">$</span>gain.t.yr[<span class="dv">2</span><span class="op">:</span>(<span class="kw">nrow</span>(agb.tab))]) <span class="op">/</span><span class="st"> </span>agb.tab<span class="op">$</span>total.agb[<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(agb.tab)<span class="op">-</span><span class="dv">1</span>])), <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb17-185" title="185">  agb.tab<span class="op">$</span>netchange.pc.yr        &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>, <span class="dv">1</span><span class="op">/</span>agb.tab<span class="op">$</span>period[<span class="dv">2</span><span class="op">:</span>(<span class="kw">nrow</span>(agb.tab))] <span class="op">*</span><span class="st"> </span><span class="kw">log</span>( agb.tab<span class="op">$</span>total.agb[<span class="dv">2</span><span class="op">:</span><span class="kw">nrow</span>(agb.tab)]                                                                               <span class="op">/</span><span class="st"> </span>agb.tab<span class="op">$</span>total.agb[<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(agb.tab)<span class="op">-</span><span class="dv">1</span>])), <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb17-186" title="186">  </a>
<a class="sourceLine" id="cb17-187" title="187">  <span class="kw">return</span>(agb.tab)</a>
<a class="sourceLine" id="cb17-188" title="188">}</a>
<a class="sourceLine" id="cb17-189" title="189"></a>
<a class="sourceLine" id="cb17-190" title="190"></a>
<a class="sourceLine" id="cb17-191" title="191"></a>
<a class="sourceLine" id="cb17-192" title="192">plot.biomass &lt;-<span class="st"> </span><span class="cf">function</span>(fc, zone, <span class="dt">filename=</span><span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb17-193" title="193">  </a>
<a class="sourceLine" id="cb17-194" title="194">  <span class="cf">if</span>(zone<span class="op">==</span><span class="st">&quot;Zone IV&quot;</span>) {</a>
<a class="sourceLine" id="cb17-195" title="195">    title    &lt;-<span class="st"> &quot;Net and Gross Changes in Forest Biomass 1987 - 2019 in Ecological Zone IV&quot;</span></a>
<a class="sourceLine" id="cb17-196" title="196">    ylim     &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">750000</span>, <span class="dv">750000</span>)</a>
<a class="sourceLine" id="cb17-197" title="197">    ybreaks  &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">750000</span>, <span class="dv">750000</span>, <span class="dv">100000</span>)</a>
<a class="sourceLine" id="cb17-198" title="198">    ymbreaks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">750000</span>, <span class="dv">750000</span>, <span class="dv">50000</span>)</a>
<a class="sourceLine" id="cb17-199" title="199">  } </a>
<a class="sourceLine" id="cb17-200" title="200">  </a>
<a class="sourceLine" id="cb17-201" title="201">  <span class="cf">if</span> (zone<span class="op">==</span><span class="st">&quot;AOI.1&quot;</span>) {</a>
<a class="sourceLine" id="cb17-202" title="202">    title    &lt;-<span class="st"> &quot;Net and Gross Changes in Forest Biomass 1987 - 2019 in Plaine de LitimÃ© (AOI.1)&quot;</span></a>
<a class="sourceLine" id="cb17-203" title="203">    ylim     &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">18000</span>, <span class="dv">15000</span>)</a>
<a class="sourceLine" id="cb17-204" title="204">    ybreaks  &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">18000</span>, <span class="dv">15000</span>, <span class="dv">2000</span>)</a>
<a class="sourceLine" id="cb17-205" title="205">    ymbreaks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">18000</span>, <span class="dv">15000</span>, <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb17-206" title="206">  } </a>
<a class="sourceLine" id="cb17-207" title="207">  </a>
<a class="sourceLine" id="cb17-208" title="208">  <span class="cf">if</span> (zone<span class="op">==</span><span class="st">&quot;AOI.2&quot;</span>) {</a>
<a class="sourceLine" id="cb17-209" title="209">    title    &lt;-<span class="st"> &quot;Net and Gross Changes in Forest Biomass 1987 - 2019 in KpÃ©lÃ© (AOI.2)&quot;</span></a>
<a class="sourceLine" id="cb17-210" title="210">    ylim     &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">18000</span>, <span class="dv">15000</span>)</a>
<a class="sourceLine" id="cb17-211" title="211">    ybreaks  &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">18000</span>, <span class="dv">15000</span>, <span class="dv">2000</span>)</a>
<a class="sourceLine" id="cb17-212" title="212">    ymbreaks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">18000</span>, <span class="dv">15000</span>, <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb17-213" title="213">  } </a>
<a class="sourceLine" id="cb17-214" title="214">  </a>
<a class="sourceLine" id="cb17-215" title="215">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(filename)) <span class="kw">pdf</span>(filename)</a>
<a class="sourceLine" id="cb17-216" title="216">  </a>
<a class="sourceLine" id="cb17-217" title="217">  fc<span class="op">$</span>netloss.t.yr &lt;-<span class="st"> </span>fc<span class="op">$</span>netchange.t.yr </a>
<a class="sourceLine" id="cb17-218" title="218">  fc<span class="op">$</span>netloss.t.yr[fc<span class="op">$</span>netloss.t.yr <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb17-219" title="219">  fc<span class="op">$</span>netgain.t.yr &lt;-<span class="st"> </span>fc<span class="op">$</span>netchange.t.yr </a>
<a class="sourceLine" id="cb17-220" title="220">  fc<span class="op">$</span>netgain.t.yr[fc<span class="op">$</span>netgain.t.yr <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb17-221" title="221">  </a>
<a class="sourceLine" id="cb17-222" title="222">  <span class="kw">print</span>(</a>
<a class="sourceLine" id="cb17-223" title="223">    fc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(variable, value, loss.t.yr, gain.t.yr, netloss.t.yr, netgain.t.yr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-224" title="224"><span class="st">      </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y=</span>value, <span class="dt">x =</span> center, <span class="dt">width=</span>period<span class="fl">-0.7</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-225" title="225"><span class="st">      </span><span class="kw">geom_bar</span>(<span class="dt">data=</span>. <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(variable <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;loss.t.yr&quot;</span>, <span class="st">&quot;gain.t.yr&quot;</span>)), <span class="kw">aes</span>(<span class="dt">fill=</span>variable, <span class="dt">alpha=</span><span class="fl">0.9</span>), <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="dt">show.legend=</span><span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-226" title="226"><span class="st">      </span><span class="kw">guides</span>(<span class="dt">alpha =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-227" title="227"><span class="st">      </span><span class="kw">geom_bar</span>(<span class="dt">data=</span>. <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(variable <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;netloss.t.yr&quot;</span>, <span class="st">&quot;netgain.t.yr&quot;</span>)), <span class="kw">aes</span>(<span class="dt">fill=</span>variable), <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-228" title="228"><span class="st">      </span><span class="kw">scale_fill_manual</span>(<span class="dt">name =</span> <span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="st">&quot;gain.t.yr&quot;</span>, <span class="st">&quot;loss.t.yr&quot;</span>), <span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;#00BFC4&quot;</span>, <span class="st">&quot;#F8766D&quot;</span>, <span class="st">&quot;#00BFC4&quot;</span>, <span class="st">&quot;#F8766D&quot;</span>), <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">&quot;Biomass gain    &quot;</span>, <span class="st">&quot;Biomass loss    &quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-229" title="229"><span class="st">      </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Tonnes AGB per Year&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(title) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-230" title="230"><span class="st">      </span><span class="kw">scale_x_continuous</span>(<span class="dt">minor_breaks =</span> <span class="ot">NULL</span>, <span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">1987</span>, <span class="dv">2000</span>, <span class="dv">2005</span>, <span class="dv">2010</span>, <span class="dv">2015</span>, <span class="dv">2019</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-231" title="231"><span class="st">      </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks=</span>ybreaks, <span class="dt">minor_breaks =</span> ymbreaks) <span class="op">+</span><span class="st"> </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim=</span>ylim) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-232" title="232"><span class="st">      </span><span class="kw">theme_light</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="dt">legend.box =</span> <span class="st">&quot;horizontal&quot;</span>, <span class="dt">legend.justification=</span><span class="kw">c</span>(<span class="op">-</span><span class="fl">0.2</span>,<span class="fl">1.2</span>))</a>
<a class="sourceLine" id="cb17-233" title="233">  )</a>
<a class="sourceLine" id="cb17-234" title="234">  </a>
<a class="sourceLine" id="cb17-235" title="235">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(filename)) <span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb17-236" title="236">}</a>
<a class="sourceLine" id="cb17-237" title="237"></a>
<a class="sourceLine" id="cb17-238" title="238"></a>
<a class="sourceLine" id="cb17-239" title="239">maps &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="st">&quot;../results/carbone/level2/AGBmaps_loess.tif&quot;</span>)</a>
<a class="sourceLine" id="cb17-240" title="240"><span class="kw">names</span>(maps) &lt;-<span class="st"> </span>dates</a>
<a class="sourceLine" id="cb17-241" title="241"></a>
<a class="sourceLine" id="cb17-242" title="242">maps.dat &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">na.omit</span>(maps[]))</a>
<a class="sourceLine" id="cb17-243" title="243"></a>
<a class="sourceLine" id="cb17-244" title="244">dens.plot &lt;-<span class="st"> </span>maps.dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(variable, value, X1991, X2000, X2005, X2010, X2015, X2018) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-245" title="245"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>value, <span class="dt">color=</span>variable, <span class="dt">linetype=</span>variable)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-246" title="246"><span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-247" title="247"><span class="st">  </span><span class="kw">theme_light</span>() </a>
<a class="sourceLine" id="cb17-248" title="248"></a>
<a class="sourceLine" id="cb17-249" title="249"><span class="kw">print</span>(dens.plot)</a>
<a class="sourceLine" id="cb17-250" title="250"></a>
<a class="sourceLine" id="cb17-251" title="251"><span class="kw">pdf</span>(<span class="st">&quot;../results/carbone/figures/densities.pdf&quot;</span>)</a>
<a class="sourceLine" id="cb17-252" title="252"><span class="kw">print</span>(dens.plot)</a>
<a class="sourceLine" id="cb17-253" title="253"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb17-254" title="254"></a>
<a class="sourceLine" id="cb17-255" title="255">res.all      &lt;-<span class="st"> </span><span class="kw">biomass.tabs</span>(<span class="dt">map=</span>maps)</a>
<a class="sourceLine" id="cb17-256" title="256">res          &lt;-<span class="st"> </span><span class="kw">biomass.tabs</span>(<span class="dt">map=</span>maps[[<span class="kw">c</span>(<span class="st">&quot;X1991&quot;</span>, <span class="st">&quot;X2000&quot;</span>, <span class="st">&quot;X2005&quot;</span>, <span class="st">&quot;X2010&quot;</span>, <span class="st">&quot;X2015&quot;</span>, <span class="st">&quot;X2018&quot;</span>)]])</a>
<a class="sourceLine" id="cb17-257" title="257">res.aoi1.all &lt;-<span class="st"> </span><span class="kw">biomass.tabs</span>(<span class="dt">map=</span>maps, AOI<span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb17-258" title="258">res.aoi1     &lt;-<span class="st"> </span><span class="kw">biomass.tabs</span>(<span class="dt">map=</span>maps[[<span class="kw">c</span>(<span class="st">&quot;X1991&quot;</span>, <span class="st">&quot;X2000&quot;</span>, <span class="st">&quot;X2005&quot;</span>, <span class="st">&quot;X2010&quot;</span>, <span class="st">&quot;X2015&quot;</span>, <span class="st">&quot;X2018&quot;</span>)]], AOI<span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb17-259" title="259">res.aoi2.all &lt;-<span class="st"> </span><span class="kw">biomass.tabs</span>(<span class="dt">map=</span>maps, AOI<span class="fl">.2</span>)</a>
<a class="sourceLine" id="cb17-260" title="260">res.aoi2     &lt;-<span class="st"> </span><span class="kw">biomass.tabs</span>(<span class="dt">map=</span>maps[[<span class="kw">c</span>(<span class="st">&quot;X1991&quot;</span>, <span class="st">&quot;X2000&quot;</span>, <span class="st">&quot;X2005&quot;</span>, <span class="st">&quot;X2010&quot;</span>, <span class="st">&quot;X2015&quot;</span>, <span class="st">&quot;X2018&quot;</span>)]], AOI<span class="fl">.2</span>)</a>
<a class="sourceLine" id="cb17-261" title="261"></a>
<a class="sourceLine" id="cb17-262" title="262">res.tmp          &lt;-<span class="st"> </span><span class="kw">biomass.tabs</span>(<span class="dt">map=</span>maps[[<span class="kw">c</span>(<span class="st">&quot;X1991&quot;</span>, <span class="st">&quot;X2003&quot;</span>, <span class="st">&quot;X2018&quot;</span>)]])</a>
<a class="sourceLine" id="cb17-263" title="263"></a>
<a class="sourceLine" id="cb17-264" title="264"><span class="kw">plot.biomass</span>(res,      <span class="st">&quot;Zone IV&quot;</span>, <span class="st">&quot;../results/carbone/figures/biomass.pdf&quot;</span>)</a>
<a class="sourceLine" id="cb17-265" title="265"><span class="kw">plot.biomass</span>(res.aoi1, <span class="st">&quot;AOI.1&quot;</span>,    <span class="st">&quot;../results/carbone/figures/biomass_aoi1.pdf&quot;</span>)</a>
<a class="sourceLine" id="cb17-266" title="266"><span class="kw">plot.biomass</span>(res.aoi2, <span class="st">&quot;AOI.2&quot;</span>,    <span class="st">&quot;../results/carbone/figures/biomass_aoi2.pdf&quot;</span>)</a>
<a class="sourceLine" id="cb17-267" title="267"></a>
<a class="sourceLine" id="cb17-268" title="268"></a>
<a class="sourceLine" id="cb17-269" title="269"><span class="kw">write.xlsx</span>(<span class="kw">list</span>(<span class="st">&quot;Total&quot;</span> =<span class="st"> </span>res,</a>
<a class="sourceLine" id="cb17-270" title="270">                <span class="st">&quot;AOI.1&quot;</span> =<span class="st"> </span>res.aoi1,</a>
<a class="sourceLine" id="cb17-271" title="271">                <span class="st">&quot;AOI.2&quot;</span> =<span class="st"> </span>res.aoi2),</a>
<a class="sourceLine" id="cb17-272" title="272">           <span class="dt">file =</span> <span class="st">&quot;../results/carbone/figures/biomass-change.xlsx&quot;</span>)</a>
<a class="sourceLine" id="cb17-273" title="273"></a>
<a class="sourceLine" id="cb17-274" title="274"></a>
<a class="sourceLine" id="cb17-275" title="275"></a>
<a class="sourceLine" id="cb17-276" title="276"></a>
<a class="sourceLine" id="cb17-277" title="277">Y.diff &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;../results/carbone/AGB_2018_2015_corr.tif&quot;</span>) <span class="op">-</span><span class="st"> </span>Y.corr</a>
<a class="sourceLine" id="cb17-278" title="278">Y.gain &lt;-<span class="st"> </span>Y.diff; Y.gain[Y.gain<span class="op">&lt;=</span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb17-279" title="279">Y.loss &lt;-<span class="st"> </span>Y.diff; Y.loss[Y.loss<span class="op">&gt;=</span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb17-280" title="280">Y.diff &lt;-<span class="st"> </span><span class="kw">writeRaster</span>(<span class="kw">round</span>(Y.diff), <span class="st">&quot;../results/carbone/AGB_2018_1991_diff.tif&quot;</span>, <span class="dt">datatype=</span><span class="st">&quot;INT2S&quot;</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-281" title="281"></a>
<a class="sourceLine" id="cb17-282" title="282"><span class="op">-</span><span class="kw">sum</span>(Y.loss[], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="kw">sum</span>(<span class="kw">raster</span>(<span class="st">&quot;../results/carbone/AGB_2003_2015_corr.tif&quot;</span>)[], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="dv">15</span></a>
<a class="sourceLine" id="cb17-283" title="283"><span class="kw">sum</span>(Y.gain[], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="kw">sum</span>(<span class="kw">raster</span>(<span class="st">&quot;../results/carbone/AGB_2003_2015_corr.tif&quot;</span>)[], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">/</span><span class="dv">15</span></a>
<a class="sourceLine" id="cb17-284" title="284"></a>
<a class="sourceLine" id="cb17-285" title="285"></a>
<a class="sourceLine" id="cb17-286" title="286">dat.c &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">X1991=</span><span class="kw">raster</span>(<span class="st">&quot;../results/carbone/AGB_1991_2015_corr.tif&quot;</span>)[],</a>
<a class="sourceLine" id="cb17-287" title="287">                    <span class="dt">X2003=</span><span class="kw">raster</span>(<span class="st">&quot;../results/carbone/AGB_2003_2015_corr.tif&quot;</span>)[],</a>
<a class="sourceLine" id="cb17-288" title="288">                    <span class="dt">X2018=</span><span class="kw">raster</span>(<span class="st">&quot;../results/carbone/AGB_2018_2015_corr.tif&quot;</span>)[])</a>
<a class="sourceLine" id="cb17-289" title="289"></a>
<a class="sourceLine" id="cb17-290" title="290">dat.c &lt;-<span class="st"> </span><span class="kw">na.omit</span>(dat.c)</a>
<a class="sourceLine" id="cb17-291" title="291"></a>
<a class="sourceLine" id="cb17-292" title="292">dat.c <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(variable, value, X1991<span class="op">:</span>X2018) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-293" title="293"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y=</span>value, <span class="dt">x=</span>variable, <span class="dt">color=</span>variable)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-294" title="294"><span class="st">  </span><span class="kw">geom_boxplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-295" title="295"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-296" title="296"><span class="st">  </span><span class="kw">theme_light</span>() </a>
<a class="sourceLine" id="cb17-297" title="297"></a>
<a class="sourceLine" id="cb17-298" title="298"><span class="kw">pdf</span>(<span class="st">&quot;../results/carbone/densities_91-03-18.pdf&quot;</span>)</a>
<a class="sourceLine" id="cb17-299" title="299"></a>
<a class="sourceLine" id="cb17-300" title="300">dat.c <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(variable, value, X1991<span class="op">:</span>X2018) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-301" title="301"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>value, <span class="dt">color=</span>variable)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-302" title="302"><span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-303" title="303"><span class="st">  </span><span class="kw">theme_light</span>() </a>
<a class="sourceLine" id="cb17-304" title="304"></a>
<a class="sourceLine" id="cb17-305" title="305"><span class="kw">dev.off</span>()</a>
<a class="sourceLine" id="cb17-306" title="306"></a>
<a class="sourceLine" id="cb17-307" title="307"></a>
<a class="sourceLine" id="cb17-308" title="308"></a>
<a class="sourceLine" id="cb17-309" title="309"></a>
<a class="sourceLine" id="cb17-310" title="310"></a>
<a class="sourceLine" id="cb17-311" title="311"><span class="co"># verify the map</span></a>
<a class="sourceLine" id="cb17-312" title="312"></a>
<a class="sourceLine" id="cb17-313" title="313">val.points &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(Y.corr, dat.placette, <span class="dt">sp=</span><span class="ot">TRUE</span>, <span class="dt">fun=</span>mean, <span class="dt">buffer=</span><span class="dv">20</span>, <span class="dt">normalizeWeights=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-314" title="314">val.points &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(Y.<span class="fl">2003.</span>corr, val.points, <span class="dt">sp=</span><span class="ot">TRUE</span>, <span class="dt">fun=</span>mean, <span class="dt">buffer=</span><span class="dv">20</span>, <span class="dt">normalizeWeights=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-315" title="315">val.points &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">extract</span>(Y<span class="fl">.2015</span>, val.points, <span class="dt">sp=</span><span class="ot">TRUE</span>, <span class="dt">fun=</span>mean, <span class="dt">buffer=</span><span class="dv">20</span>, <span class="dt">normalizeWeights=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-316" title="316"><span class="kw">plot</span>(val.points<span class="op">$</span>BaHa, val.points<span class="op">$</span>AGB_<span class="dv">2015</span>_<span class="dv">2003</span>_corr)</a>
<a class="sourceLine" id="cb17-317" title="317"><span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb17-318" title="318">mod &lt;-<span class="st"> </span><span class="kw">lm</span>(AGB_<span class="dv">2015</span>_<span class="dv">2003</span>_corr <span class="op">~</span><span class="st"> </span>BaHa, <span class="dt">data=</span>val.points)</a>
<a class="sourceLine" id="cb17-319" title="319"><span class="kw">abline</span>(mod, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb17-320" title="320"></a>
<a class="sourceLine" id="cb17-321" title="321"></a>
<a class="sourceLine" id="cb17-322" title="322"></a>
<a class="sourceLine" id="cb17-323" title="323"></a>
<a class="sourceLine" id="cb17-324" title="324"><span class="co">############ compare 2015 carbon map with the forest change map #######################</span></a>
<a class="sourceLine" id="cb17-325" title="325"></a>
<a class="sourceLine" id="cb17-326" title="326">map.carb &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;../results/carbone/AGB_2015_REF.tif&quot;</span>)</a>
<a class="sourceLine" id="cb17-327" title="327">map.gain &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;../results/fcc/3_alldates-direct2003/level3/forest-gain.tif&quot;</span>)</a>
<a class="sourceLine" id="cb17-328" title="328">map.loss &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;../results/fcc/3_alldates-direct2003/level3/forest-loss.tif&quot;</span>)</a>
<a class="sourceLine" id="cb17-329" title="329"></a>
<a class="sourceLine" id="cb17-330" title="330">map.loss.a2015 &lt;-<span class="st"> </span>map.loss; map.loss.a2015[map.loss.a2015<span class="op">&lt;</span><span class="dv">2015</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb17-331" title="331">map.carb.loss.a2015 &lt;-<span class="st"> </span><span class="kw">mask</span>(map.carb, map.loss.a2015)</a>
<a class="sourceLine" id="cb17-332" title="332"><span class="kw">hist</span>(map.carb.loss.a2015[]); <span class="kw">summary</span>(map.carb.loss.a2015[]); <span class="kw">sum</span>(map.carb.loss.a2015[], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">*</span>(<span class="dv">30</span><span class="op">*</span><span class="dv">30</span><span class="op">/</span><span class="dv">10000</span>)</a>
<a class="sourceLine" id="cb17-333" title="333"></a>
<a class="sourceLine" id="cb17-334" title="334">map.gain.b2015 &lt;-<span class="st"> </span>map.gain; map.gain.b2015[map.gain.b2015<span class="op">&gt;=</span><span class="dv">2015</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb17-335" title="335">map.gain.b2015[] &lt;-<span class="st"> </span><span class="dv">2015</span> <span class="op">-</span><span class="st"> </span>map.gain.b2015[]</a>
<a class="sourceLine" id="cb17-336" title="336">map.carb.gain.b2015 &lt;-<span class="st"> </span><span class="kw">mask</span>(map.carb, map.gain.b2015)</a>
<a class="sourceLine" id="cb17-337" title="337"><span class="kw">hist</span>(map.carb.gain.b2015[]); <span class="kw">summary</span>(map.carb.gain.b2015[]); <span class="kw">sum</span>(map.carb.gain.b2015[], <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">*</span>(<span class="dv">30</span><span class="op">*</span><span class="dv">30</span><span class="op">/</span><span class="dv">10000</span>)</a>
<a class="sourceLine" id="cb17-338" title="338"></a>
<a class="sourceLine" id="cb17-339" title="339"><span class="kw">boxplot</span>(map.carb.gain.b2015[] <span class="op">~</span><span class="st"> </span>map.gain.b2015[])</a>
<a class="sourceLine" id="cb17-340" title="340"></a>
<a class="sourceLine" id="cb17-341" title="341">map.carb.loss.a2015<span class="fl">.2</span> &lt;-<span class="st"> </span><span class="kw">mask</span>(Y.loss, map.loss.a2015)</a>
<a class="sourceLine" id="cb17-342" title="342"></a>
<a class="sourceLine" id="cb17-343" title="343"></a>
<a class="sourceLine" id="cb17-344" title="344"></a>
<a class="sourceLine" id="cb17-345" title="345"></a>
<a class="sourceLine" id="cb17-346" title="346"></a>
<a class="sourceLine" id="cb17-347" title="347"></a>
<a class="sourceLine" id="cb17-348" title="348"><span class="co"># ######### Try with linear regression ############</span></a>
<a class="sourceLine" id="cb17-349" title="349"><span class="co"># X$evi &lt;- evi(nir=X$NIR, r=X$R, b=X$B)</span></a>
<a class="sourceLine" id="cb17-350" title="350"><span class="co"># X$ndvi &lt;- nd(X$NIR, X$R)</span></a>
<a class="sourceLine" id="cb17-351" title="351"><span class="co"># X$ndmi &lt;- nd(X$NIR, X$SWIR1)</span></a>
<a class="sourceLine" id="cb17-352" title="352"><span class="co"># X$nbr &lt;- nd(X$NIR, X$SWIR2)</span></a>
<a class="sourceLine" id="cb17-353" title="353"><span class="co"># cor(-X$SWIR1[], Y.2015[], use=&quot;pairwise.complete.obs&quot;)</span></a>
<a class="sourceLine" id="cb17-354" title="354"><span class="co"># s &lt;- sample(1:ncell(Y.2015), 10000)</span></a>
<a class="sourceLine" id="cb17-355" title="355"><span class="co"># plot(log(Y.2015[s]) ~ log(X$SWIR1[s]))</span></a>
<a class="sourceLine" id="cb17-356" title="356"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-357" title="357"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-358" title="358"><span class="co"># val.points &lt;- raster::extract(X, val.points, sp=TRUE, fun=mean, buffer=20, normalizeWeights=TRUE)</span></a>
<a class="sourceLine" id="cb17-359" title="359"><span class="co"># plot(log(val.points$BaHa) ~ log(val.points$SWIR1))</span></a>
<a class="sourceLine" id="cb17-360" title="360"><span class="co"># val.points$BaHa.log &lt;- log(val.points$BaHa)</span></a>
<a class="sourceLine" id="cb17-361" title="361"><span class="co"># val.points$SWIR1.log &lt;- log(val.points$SWIR1)</span></a>
<a class="sourceLine" id="cb17-362" title="362"><span class="co"># lm.swir &lt;- lm(BaHa.log ~ SWIR1.log, data=val.points@data)</span></a>
<a class="sourceLine" id="cb17-363" title="363"><span class="co"># abline(lm.swir)</span></a>
<a class="sourceLine" id="cb17-364" title="364"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-365" title="365"><span class="co"># plot(val.points$BaHa ~ val.points$SWIR1)</span></a>
<a class="sourceLine" id="cb17-366" title="366"><span class="co"># lines(seq(1000, 2500, 50), exp(lm.swir$coeff[1] + lm.swir$coeff[2]*log(seq(1000, 2500, 50))), lty=4)</span></a>
<a class="sourceLine" id="cb17-367" title="367"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-368" title="368"><span class="co"># Y.2015.swir &lt;- exp(lm.swir$coeff[1] + lm.swir$coeff[2]*log(X$SWIR1))</span></a>
<a class="sourceLine" id="cb17-369" title="369"><span class="co"># val.points &lt;- raster::extract(Y.2015.swir, val.points, sp=TRUE, fun=mean, buffer=20, normalizeWeights=TRUE)</span></a>
<a class="sourceLine" id="cb17-370" title="370"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-371" title="371"><span class="co"># plot(val.points$BaHa, val.points@data[,25])</span></a>
<a class="sourceLine" id="cb17-372" title="372"><span class="co"># abline(0,1)</span></a>
<a class="sourceLine" id="cb17-373" title="373"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-374" title="374"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-375" title="375"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-376" title="376"><span class="co"># Y.2015.log &lt;- log(Y.2015)</span></a>
<a class="sourceLine" id="cb17-377" title="377"><span class="co"># SWIR1.log &lt;- log(X$SWIR1)</span></a>
<a class="sourceLine" id="cb17-378" title="378"><span class="co"># lm.swir.map &lt;- lm(Y.2015.log[] ~ SWIR1.log[])</span></a>
<a class="sourceLine" id="cb17-379" title="379"><span class="co"># abline(lm.swir.map, lty=2)</span></a>
<a class="sourceLine" id="cb17-380" title="380"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-381" title="381"><span class="co"># plot(Y.2015[s] ~ X$SWIR1[s])</span></a>
<a class="sourceLine" id="cb17-382" title="382"><span class="co"># lines(seq(1000, 4000, 50), exp(lm.swir.map$coeff[1] + lm.swir.map$coeff[2]*log(seq(1000, 4000, 50))), lty=4, col=&quot;red&quot;)</span></a>
<a class="sourceLine" id="cb17-383" title="383"><span class="co"># Y.2015.swir &lt;- exp(lm.swir.map$coeff[1] + lm.swir.map$coeff[2]*log(X$SWIR1))</span></a>
<a class="sourceLine" id="cb17-384" title="384"><span class="co"># Y.2015.swir &lt;- writeRaster(Y.2015.swir, &quot;../results/carbone/AGB_2015_SWIR1.tif&quot;)</span></a>
<a class="sourceLine" id="cb17-385" title="385"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-386" title="386"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-387" title="387"><span class="co"># Y &lt;- Y.2015.swir</span></a>
<a class="sourceLine" id="cb17-388" title="388"><span class="co"># X &lt;- stack(&quot;../results/images/20030127_L7_B123457_L2.tif&quot;)</span></a>
<a class="sourceLine" id="cb17-389" title="389"><span class="co"># names(X) &lt;- c(&quot;B&quot;, &quot;G&quot;, &quot;R&quot;, &quot;NIR&quot;, &quot;SWIR1&quot;, &quot;SWIR2&quot;)</span></a>
<a class="sourceLine" id="cb17-390" title="390"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-391" title="391"><span class="co"># Y.log &lt;- log(Y)</span></a>
<a class="sourceLine" id="cb17-392" title="392"><span class="co"># SWIR.log &lt;- log(X$SWIR1)</span></a>
<a class="sourceLine" id="cb17-393" title="393"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-394" title="394"><span class="co"># lm.swir &lt;- lm(Y.log[] ~ SWIR.log[])</span></a>
<a class="sourceLine" id="cb17-395" title="395"><span class="co"># Y.swir &lt;- exp(lm.swir$coeff[1] + lm.swir$coeff[2]*SWIR.log)</span></a>
<a class="sourceLine" id="cb17-396" title="396"><span class="co"># Y.swir &lt;- writeRaster(Y.swir, &quot;../results/carbone/AGB_2003_SWIR1.tif&quot;)</span></a>
<a class="sourceLine" id="cb17-397" title="397"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-398" title="398"><span class="co"># Y.diff &lt;- Y.2015.swir - Y.swir</span></a>
<a class="sourceLine" id="cb17-399" title="399"><span class="co"># Y.diff &lt;- writeRaster(Y.diff, &quot;../results/carbone/AGB_diff_SWIR1.tif&quot;)</span></a>
<a class="sourceLine" id="cb17-400" title="400"></a>
<a class="sourceLine" id="cb17-401" title="401"></a>
<a class="sourceLine" id="cb17-402" title="402"></a>
<a class="sourceLine" id="cb17-403" title="403"></a>
<a class="sourceLine" id="cb17-404" title="404"></a>
<a class="sourceLine" id="cb17-405" title="405"></a>
<a class="sourceLine" id="cb17-406" title="406"></a>
<a class="sourceLine" id="cb17-407" title="407"></a>
<a class="sourceLine" id="cb17-408" title="408"></a>
<a class="sourceLine" id="cb17-409" title="409"><span class="kw">ggplot</span>(plots<span class="op">@</span>data[], <span class="kw">aes</span>(<span class="dt">x=</span>cov18, <span class="dt">y=</span>BaHa)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-410" title="410"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">colour=</span>OccSol),               <span class="co"># colour depends on cond2</span></a>
<a class="sourceLine" id="cb17-411" title="411">             <span class="dt">size=</span><span class="dv">3</span>)    <span class="op">+</span></a>
<a class="sourceLine" id="cb17-412" title="412"><span class="st">  </span><span class="kw">facet_wrap</span>( <span class="op">~</span><span class="st"> </span>OccSol)</a></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="02_create-AGB-maps.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="04_analyze-AGB.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true,
"info": true
});
});
</script>

</body>

</html>
