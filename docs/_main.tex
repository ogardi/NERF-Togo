\PassOptionsToPackage{unicode=true}{hyperref} % options for packages loaded elsewhere
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[a4paper, notitlepage, 12pt, krantz2]{krantz}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provides euro and other symbols
\else % if luatex or xelatex
  \usepackage{unicode-math}
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage[]{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\usepackage{hyperref}
\hypersetup{
            pdfauthor={Oliver Gardi, Fifonsi Dangbo, Sophie Dzigbod, Ditorgue Bakabima},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
% Fix footnotes in tables (requires footnote package)
\IfFileExists{footnote.sty}{\usepackage{footnote}\makesavenoteenv{longtable}}{}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

% set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\usepackage{booktabs}
\usepackage{longtable}
% \usepackage{Alegreya}
% \usepackage[T1]{fontenc}
\usepackage[bf,singlelinecheck=off]{caption}

% \setmainfont[UprightFeatures={SmallCapsFont=AlegreyaSC-Regular}]{Alegreya Sans}

\DeclareUnicodeCharacter{2265}{>=}
\DeclareUnicodeCharacter{2264}{=<}
\DeclareUnicodeCharacter{251C}{|-}
\DeclareUnicodeCharacter{2500}{--}
\DeclareUnicodeCharacter{2514}{|\_}

\usepackage{framed,color}
\definecolor{shadecolor}{RGB}{248,248,248}

\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.8}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\floatpagefraction}{0.75}

% \renewenvironment{quote}{\begin{VF}}{\end{VF}}
% \let\oldhref\href
% \renewcommand{\href}[2]{#2\footnote{\url{#1}}}

\ifxetex
  \usepackage{letltxmacro}
  \setlength{\XeTeXLinkMargin}{1pt}
  \LetLtxMacro\SavedIncludeGraphics\includegraphics
  \def\includegraphics#1#{% #1 catches optional stuff (star/opt. arg.)
    \IncludeGraphicsAux{#1}%
  }%
  \newcommand*{\IncludeGraphicsAux}[2]{%
    \XeTeXLinkBox{%
      \SavedIncludeGraphics#1{#2}%
    }%
  }%
\fi

\makeatletter
\newenvironment{kframe}{%
\medskip{}
\setlength{\fboxsep}{.8em}
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\makeatletter
\@ifundefined{Shaded}{
}{\renewenvironment{Shaded}{\begin{kframe}}{\end{kframe}}}
\makeatother

\newenvironment{rmdblock}[1]
  {
  \begin{itemize}
  \renewcommand{\labelitemi}{
    \raisebox{-.7\height}[0pt][0pt]{
      {\setkeys{Gin}{width=3em,keepaspectratio}\includegraphics{images/icons/#1}}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{kframe}
  \item
  }
  {
  \end{kframe}
  \end{itemize}
  }
\newenvironment{rmdtodo}
  {\begin{rmdblock}{todo}}
  {\end{rmdblock}}
\newenvironment{rmdnote}
  {\begin{rmdblock}{note}}
  {\end{rmdblock}}
\newenvironment{rmdcaution}
  {\begin{rmdblock}{caution}}
  {\end{rmdblock}}
\newenvironment{rmdimportant}
  {\begin{rmdblock}{important}}
  {\end{rmdblock}}
\newenvironment{rmdtip}
  {\begin{rmdblock}{tip}}
  {\end{rmdblock}}
\newenvironment{rmdwarning}
  {\begin{rmdblock}{warning}}
  {\end{rmdblock}}

\usepackage{makeidx}
\makeindex

\urlstyle{tt}

\usepackage{amsthm}
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother

\frontmatter
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{colortbl}
\usepackage{pdflscape}
\usepackage{tabu}
\usepackage{threeparttable}
\usepackage{threeparttablex}
\usepackage[normalem]{ulem}
\usepackage{makecell}
\usepackage{xcolor}
\usepackage[]{natbib}
\bibliographystyle{plainnat}

\title{République Togolaise ---\\
Système Nationale de Surveillance des Forêts}
\providecommand{\subtitle}[1]{}
\subtitle{Manuel de référence}
\author{Oliver Gardi, Fifonsi Dangbo, Sophie Dzigbod, Ditorgue Bakabima}
\date{Version NRF v1.1 / 2020-06-11}

\begin{document}
\maketitle

%\cleardoublepage\newpage\thispagestyle{empty}\null
%\cleardoublepage\newpage\thispagestyle{empty}\null
%\cleardoublepage\newpage
\thispagestyle{empty}
%\begin{center}
%\includegraphics{images/dedication.pdf}
%\end{center}

\setlength{\abovedisplayskip}{-5pt}
\setlength{\abovedisplayshortskip}{-5pt}

\includegraphics{images/NERF-Togo.png}

\hypertarget{preface}{%
\section*{Préface}\label{preface}}


Ce manuel de référence à comme objectif de décrire le fonctionnement du \textbf{Système National de Surveillance des Forêts au Togo (SNSF)}. Les éléments traités sont les arrangements instutitionelles, l'implémentation de l'Inventaires Forestier National (IFN) et de Système Surveillance Terrestres par Satellite (SSTS) et l'approche technique pour en sortir les informations nécessaires pour le Niveau de Référence pour les Forêts du Togo (NRF) ainsi que pour le Monitoring, Reporting et Verification (MRV) dans le cadre de l'engagement du Togo pour le REDD+.

La partie \protect\hyperlink{NRF-MRV}{Analyses NRF/MRV} décrit en détail les outils utilisés pour établir et le \textbf{Niveau de Référence pour les Forêts du Togo 1.0}, soumis au sécrétariat CCNUCC en Janvier 2020 et pour mettre à jour les analyses dans le cadre d'une surveillance de la biomasse forestier continue dans le cadre du Monitoring, Reporting et Verification pour la REDD+. Les résultats de ces analyses sont publiés ailleurs (liens sur les rapports sur le site CCNUCC et géoportail).

En cas de questions, veuillez contacter la \href{http://www.reddtogo.tg/index.php/contacts}{Coordination nationale REDD+ du Togo}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

L'objectif du Système National de Surveillance des Forêts (SNSF) est d'évaluer régulièrement \textbf{l'état des forêts togolaises et leur évolution}. Dans le \href{http://faolex.fao.org/docs/pdf/tog85011.pdf}{code forestier du Togo}, la forêt est définie comme:

\begin{quote}
un espace occupant une superficie de plus de 0,5 hectare avec des arbres atteignant une hauteur supérieure à 5 mètres et un couvert arboré de plus de 10 pour cent, ou avec des arbres capables d'atteindre ces seuils in situ.
\end{quote}

Pour l'évaluation du développement des zones forestières, le SNSF distingue entre \textbf{terres forestières} avec un couvert des houppiers ≥ 30\% et les \textbf{terres boisées} avec un couvert des houppiers entre 10\% -- 30\%.

\begin{rmdtodo}
Actuellement, sur base des images Landsat, le SNSF enregistre que
l'évolution des terres forestiers avec une couverture des houppiers ≥
30\%. Des données satellitaires de plus haute resolution seront
nécessaires pour évaluer également les terres boisées.
\end{rmdtodo}

Le SNSF combine les données recueillies sur le terrain avec les données des images satellites pour fournir des informations sur lévolution du l'ensemble des forêts dans le pays. Comme illustré dans l'image au-dessous et décrit dans les sections suivantes, \textbf{le SNSF consiste de trois pilliers principaux:}

\begin{itemize}
\item
  Le \protect\hyperlink{IFN}{\textbf{Inventaire Forestier National (IFN)}} recueille des informations détaillées sur l'état des forêts sur un nombre limité de placettes d'échantillonnage permanentes sur le terrain.
\item
  Au moyen du \protect\hyperlink{SSTS}{\textbf{Système de Surveillance Terrestre par Satellite (SSTS)}}, des informations sur la couverture et l'utilisation des sols sont recueillies sur un grand nombre de parcelles d'échantillonnage à partir d'images satellites. Avec l'aide du SSTS, les informations sur l'IFN peuvent être extrapolées à l'ensemble du pays.
\item
  Le \protect\hyperlink{NRF-MRV}{\textbf{Niveau de Référence des Forêts (NRF) ainsi que le Monitoring, Reporting et Vérification (MRV)}} des changements dans le réservoirs carbone forestiersest une applications du SNSF pour informer la communauté internationale sur l'engagement du Togo dans le cadre du mécanisme REDD+. Dans ce cadre, les données de la IFN sont utilisées pour déterminer le stockage du carbone dans la biomasse des arbres, tandis que les données de la SSTS sont utilisées pour déterminer le changement de la superficie forestière. Ensemble, cela se traduit par les pertes de carbone dues à la déforestation et la séquestration du carbone provenant du reboisement.
\end{itemize}

\includegraphics{images/SNSF-Schema.png}

\begin{rmdtodo}
\textbf{En future, d'autres sources de données pourraient être intégrées
au SNSF}, telles que

\begin{itemize}
\tightlist
\item
  le carbone organique du sol (prévu à rélever dans l'IFN-2)
\item
  feux de brousse (base de données SANGE)
\item
  dégradation des forêts (utilisation des images de haute résolution
  Sentinel-2)
\item
  droits fonciers
\item
  plantations
\item
  exploitation du bois
\item
  \ldots{}
\end{itemize}

Pour l'avenir, il est également prévu d'impliquer la population locale
dans la surveillance des forêts, par exemple en signalant les activités
irrégulières à l'aide d'une application pour smartphone.
\end{rmdtodo}

\hypertarget{arrangements-institutionelles}{%
\subsection{Arrangements institutionelles}\label{arrangements-institutionelles}}

L'arrangement institutionnel propose pour le système national de suivi des forêts se presente comme ci-dessous.

\includegraphics{images/cardre_institutionnel_SNSF.png}

\begin{itemize}
\item
  \textbf{Coordination:}

  \begin{itemize}
  \item
    Le Ministère de l'Environnement, du Developpement Durable et de la Protection de la Nature (MEDDPN) à travers la \textbf{Direction de l'Environnement (DE)} est chargée de la \textbf{soumission des rapports} (Communication Nationale et Rapports Biennaux) à la Convention Cadre des Nations Unies sur le Changement Climatique (CCNUCC).
  \item
    La \textbf{Cellule MRV} de la Coordination nationale REDD+ située a l'ODEF est responsable de la \textbf{coordination} de toutes les institutions et organisations impliquées dans l'alimentation du système SNSF. Cette cellule est l'entité clé chargée de faciliter et de soutenir les communications sur NRF/NERF du Togo.
  \item
    Le \textbf{Groupe de travail NERF/MRV et l'équipe nationale de suivi des forêts} sont chargés du travail et des \textbf{décisions et choix} techniques sur les données, résultats et méthodologie adoptés pour le NRF/MRV. C'est la cheville ouvrière de la cellule MRV. Elles sont constituées des cadres des institutions qui interviennent dans le système national de suivi des forêts (SNSF).
  \item
    La \textbf{Direction de l'Environnement (DE)} se charge des \textbf{inventaires de gaz à effet de serre (I-GES)} de tous les secteurs mais assure la cohérence des données d'I-GES du secteur agriculture, foresterie et autres affectations des terres (AFAT) avec les rapports qui seront soumis à la CCNUCC. La DE se chargera d'assurer la cohérence entre la méthodologie utilisée dans le cadre du NRF avec les données d'I-GES du secteur AFAT.
  \end{itemize}
\item
  \textbf{Données d'activités:}

  \begin{itemize}
  \item
    \textbf{L'Unité de gestion de bases de données cartographiques (UGBDC)} de la Direction des études et de la planification (DEP), chargée de la gestion de la cartographie des domaines forestiers du Togo ainsi que la \textbf{Division cartographie et Télédétection (DCT)} de l'Officie de développement et d'exploitation des forêts (ODEF) chargée de la cartographie des forêts classées et plantations étatique se chargeront de produire les \textbf{données d'activités à travers le système de suivi des terres par satellite (SSTS)}.
  \item
    L'\textbf{Agence nationale de gestion de l'environnement (ANGE)} est chargée de fournir les \textbf{données sur les feux de végétation}.
  \end{itemize}
\item
  \textbf{Facteurs d'émission:}

  \begin{itemize}
  \tightlist
  \item
    La \textbf{cellule de gestion de la base des données des ressources forestières et des résultats de l'inventaire forestier national (CBDR-IFN)} de la Direction des ressources forestières (DRF) et la \textbf{Division cartographie et télédétection (DCT)} de l'ODEF sont chargé de produire les facteurs d'émission à travers les \textbf{inventaires forestier nationaux et les inventaires des plantations}.
  \end{itemize}
\item
  \textbf{Données complémentaires:}

  \begin{itemize}
  \item
    la \textbf{Direction générale de l'énergie du ministère des mines et énergie DGE/MME} se chargera de fournir les données sur la \textbf{consommation en bois énergie}.
  \item
    la \textbf{Direction de la Statistique agricole de l'Informatique et de la Documentation (DCID) et l'Institut Togolais de Recherche Agronomique (ITRA)} produiront des \textbf{données sur l'agriculture (superficie emblavées et le cheptel)}.
  \item
    les \textbf{données de recherche des universités du Togo} alimenteront le mécanisme MRV ainsi que le NRF.
  \item
    L'\textbf{Institut national de la statistique et des études économiques et démographiques (INSEED)} donnera des compléments d'informations sur \textbf{la démographie et autres}.
  \end{itemize}
\item
  \textbf{Contrôle de qualité / validation interne:}

  \begin{itemize}
  \tightlist
  \item
    L'assurance qualité et le contrôle qualité se fera à travers l'évaluation indépendante interne du \textbf{Laboratoire de biologie et écologie végétale (LBEV)} et le \textbf{Laboratoire de recherche forestière (LRF) de l'université de Lomé (LBEV/UL)} ainsi que la \textbf{Direction générale de la cartographie (DGC)}. Les laboratoires universitaires LRF et LBEV évalueront les méthodes et nouveaux données au fur et à mesure qu'ils seront générés.
  \end{itemize}
\end{itemize}

\hypertarget{SNSF-organisation}{%
\subsection{Pour commencer}\label{SNSF-organisation}}

\hypertarget{travailler-avec-le-snsf}{%
\subsubsection{Travailler avec le SNSF}\label{travailler-avec-le-snsf}}

\hypertarget{installation-r-et-rstudio}{%
\paragraph{Installation R et RStudio}\label{installation-r-et-rstudio}}

\textbf{Le traitement des données au sein du SNSF est principalement basé sur les scripts R (\emph{R Project for Statistical Computing}).} Pour pouvoir travailler avec ces scripts, vous devez disposer d'une installation de \href{https://cloud.r-project.org/}{R}. En outre, l'installation des paquets suivants est nécessaire dans R :

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"sp"}\NormalTok{, }\StringTok{"rgdal"}\NormalTok{, }\StringTok{"raster"}\NormalTok{, }\StringTok{"randomForest"}\NormalTok{, }\StringTok{"caret"}\NormalTok{, }\StringTok{"openxlsx"}\NormalTok{, }
                 \StringTok{"dplyr"}\NormalTok{, }\StringTok{"tidyr"}\NormalTok{, }\StringTok{"ggplot2"}\NormalTok{, }\StringTok{"foreach"}\NormalTok{, }\StringTok{"doParallel"}\NormalTok{, }\StringTok{"knitr"}\NormalTok{, }
                 \StringTok{"rmarkdown"}\NormalTok{, }\StringTok{"tinytex"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Les scripts R dépendent des fois des \href{https://gdal.org/programs/index.html\#raster-programs}{outils GDAL} disponible dans l'environnement. Sur les systèmes Linux, ceux-ci peuvent être installés en utilisant `apt-get install python-gdal'.

Comme interface utilisateur graphique pour R, nous recommandons l'installation de \href{https://rstudio.com/products/rstudio/download/}{RStudio}.

\hypertarget{se-connecter-avec-github}{%
\paragraph{Se connecter avec GitHub}\label{se-connecter-avec-github}}

\textbf{Le code SNSF-Togo se trouve sur un dépôt du code GitHub} (\url{https://github.com/ogardi/SNSF-Togo}). Pour copier le code sur votre ordinateur, vous pouvez dans RStudio créer un nouveau projet à partir d'un dépôt Git comme illustré dans la figure ci-dessous.

\includegraphics{images/RStudio_new-project.png}

\textbf{Git vous permet de vous synchroniser avec le dépôt sur GitHub.} En appuyant sur le bouton ``Pull'' (point 1. dans la figure ci-dessous), vous mettez à jour votre code local avec le dépôt du code sur GitHub.

\includegraphics{images/RStudio_git-tools.png}

\textbf{Pour modifier vous-même le code sur GitHub, vous devez disposer d'un compte GitHub et d'une autorisation du \href{mailto:oliver.gardi@bfh.ch}{gestionnaire du dépôt}.} La procédure à suivre pour apporter des modifications au code est la suivante.

\textbf{Avant faire des modifications dans le code:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  synchroniser avec le dépôt sur GitHub en utilisant le bouton ``Pull'' (tirer)
\end{enumerate}

\textbf{De temps en temps, pendant le travail:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  confirmer les modifications apportées au code en appuyant sur le bouton ``Commit''. Une nouvelle fenêtre s'ouvrira.
\item
  sélectionner les fichiers à confirmer (CTRL-A) et les marquer (ESPACE)
\item
  joindre un message (ce qui a été modifié)
\item
  confirmer les modifications apportées au code en appuyant sur le bouton ``Commit'' (confirmer)
\item
  synchroniser de nouveau avec GitHub (et résoudre les éventuels conflits)
\item
  télécharger les modifications sur GitHub en utilisant le bouton ``Push'' (pousser)
\end{enumerate}

\hypertarget{travailler-sur-la-documentation}{%
\paragraph{Travailler sur la documentation}\label{travailler-sur-la-documentation}}

\textbf{Ce manuel de référence fait également partie du dépôt du code sur GitHub.} Cela signifie que pour réviser la documentation, vous devez procéder comme décrit ci-dessus.

La documentation a été créée dans \href{https://fr.wikipedia.org/wiki/Markdown}{Markdown}, une syntaxe simple pour la structuration et le formatage des documents. Ces documents Markdown sont ensuite traduits en HTML par le paquet R \texttt{knitr} pour générer un site web.

\includegraphics{images/RStudio_markdown.png}

Le répertoire \texttt{04\_Manuel} contient les documents Markdown (fichiers .Rmd), le répertoire \texttt{docs} contient le site web résultant (fichiers .html).

\textbf{Dans RStudio, le site web peut être généré en utilisant le bouton ``Build Book''.} Pour ce faire, il faut d'abord spécifier le répertoire dans lequel se trouvent les fichiers Markdown dans les configurations, comme indiqué dans la figure ci-dessous.

\includegraphics{images/RStudio_build-tools.png}

\hypertarget{structure-du-repertoire}{%
\subsubsection{Structure du répértoire}\label{structure-du-repertoire}}

Les outils R dépendent d'une certaine structure des fichiers. Le répértoire de base \texttt{SNSF\_Togo} est structuré comme suivant:

\begin{verbatim}
SNSF_Togo
=========
├── data                                # Données de base externes ####################
    ├── GADM                              # :: frontières administratives
    ├── Landsat                           # :: images satellitaires
    ├── SRTM                              # :: données topographiques
    └── Worldclim                         # :: données climatiques
    
└── SNSF_v1.0_20200106                  # Répértoire SNSF v1.0 ########################
    ├── .Rprofile                         #:: Script R de initialisation
    
    ├── 01_SSTS                           # SYSTÈME DE SURVEILLANCE TERRESTRE =========
        ├── 01_data                         #:: images et autres données pré-traités --
        └── 02_BdD                          #:: base de données SSTS ------------------
        
    ├── 02_IFN                            # INVENTAIRE FORESTIER NATIONAL =============
        └── 01_IFN-1                        #:: données d'inventaire IFN-1 ------------
    
    ├── 03_NRF-MRV                        # NIVEAU DE REFERENCE / MRV  ================
        ├── 01_MCF                          #:: Modification Couvert Forestier --------
        ├── 02_AGB                          #:: cartographie biomasse -----------------
        └── 03_report                       #:: rapport NRF/MRV -----------------------
        
    ├── 04_Manuel                         # CETTE DOCUMENTATION DU SNSF =============
    └── docs                              #:: site web manuel de référence
    
    
└── SNSF_v1.x                           # Répértoire SNSF version actualisé ###########
    ├── ...
    └── ...
    
\end{verbatim}

La structure du répertoire est définit dans le script R \protect\hyperlink{NRF-set-up.R}{.Rprofile} et peut être ajousté.

C'est seulement les répétoires \texttt{src} et \texttt{manual} qui sont mis à diposition dans le dépôt \href{https://github.com/ogardi/NERF-Togo}{GitHub}. Les autres répétoires et données doivent être installés manuellement.

\hypertarget{creation-dun-nouveau-projet}{%
\subsubsection{Création d'un nouveau projet}\label{creation-dun-nouveau-projet}}

Pour la création d'un nouveau projet avec le code le plus actuel, on clone le dépôt du projet sur GitHub par la commande \texttt{git\ clone\ -\/-single-branch\ https://github.com/ogardi/NERF-Togo.git\ NOM-REPERTOIRE}. L'installation d'une version spécifique peut être fait avec \texttt{git\ clone\ -b\ VERSION\ -\/-single-branch\ https://github.com/ogardi/NERF-Togo.git\ NOM-REPERTOIRE}.

En travaillant avec RStudio, le plus facile est de créer directement un projet RStudio au départ due dépôt GitHub (\texttt{File\ \textgreater{}\ New\ Project\ ...\ \textgreater{}\ Version\ Control\ \textgreater{}\ Git}) avec les mêmes paramètre que l'installation directe en haut.

Dans une prochaine étape, les données doivent être rendues disponibles, soit par une nouvelle acquisition, soit par une copie des répertoires existants.

\begin{itemize}
\tightlist
\item
  S'il n'est pas encore disponible, le répertoire \texttt{../data/} doit être créé et les données de base correspondantes doivent être fournies.
\item
  Dans le répertoire \texttt{./01\_SSTS/02\_BdD/}, le réseau d'échantillonnage ainsi que les données d'entraînement et de validation doivent être stockées.
\item
  En outre, les données d'inventaire doivent être stockées dans le répertoire \texttt{./02\_IFN/}.
\end{itemize}

\hypertarget{NRF-set-up.R}{%
\subsubsection{Définition des variables}\label{NRF-set-up.R}}

Le traitement des images ainsi que les différentes analyses se font via des R-Scripts. Les variables et les fonctions utilisées dans les différents scripts sont définit dans le fichier \texttt{.Rprofile}, qui est automatiquement chargé au démarrage de R. Si le processus de chargement a réussi, vous pouvez voir un message de bienvenue suivant sur la console R.

Si aucun message n'apparaît, assurez-vous que a) R est lancé dans le répertoire et b) qu'aucun message d'erreur ne se produit. Les messages d'erreur possibles sont des paquets manquants (les paquets correspondants doivent être installés en premier) ou le fait de ne pas trouver les limites administratives de GADM dans \texttt{../data/GADM} (doivent également être installés en premier).

Si nécessaire les variables sont ajustées et R est redémarré. Notamment les informations sur la période analysée \texttt{YEARS.ALL} et les années à prendre en compte pour les différentes évaluations \texttt{YEARS.JNT}, \texttt{YEARS.VAL} et \texttt{YEARS.REF}.

\hypertarget{script-r-.rprofile}{%
\paragraph{\texorpdfstring{Script R: \texttt{.Rprofile}}{Script R: .Rprofile}}\label{script-r-.rprofile}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{.Rprofile}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# .Rprofile: Préparer l'environnement (libraries, variables)}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}


\CommentTok{# Charger libraries  ==========================================================}
\KeywordTok{library}\NormalTok{(}\StringTok{"sp"}\NormalTok{)           }\CommentTok{# Classes et méthodes pour les données spatiales}
\KeywordTok{library}\NormalTok{(}\StringTok{"rgdal"}\NormalTok{)        }\CommentTok{# Geospatial Data Abstraction Library}
\KeywordTok{library}\NormalTok{(}\StringTok{"raster"}\NormalTok{)       }\CommentTok{# Analyse et modélisation des données géographiques}
\KeywordTok{library}\NormalTok{(}\StringTok{"randomForest"}\NormalTok{) }\CommentTok{# Algorithme de classification et régression}
\KeywordTok{library}\NormalTok{(}\StringTok{"caret"}\NormalTok{)        }\CommentTok{# Outils pour classification et régression}
\KeywordTok{library}\NormalTok{(}\StringTok{"openxlsx"}\NormalTok{)     }\CommentTok{# Lire et écrire des fichiers Excel (xlsx)}
\KeywordTok{library}\NormalTok{(}\StringTok{"dplyr"}\NormalTok{)        }\CommentTok{# Fonctions pour manipuler des données}
\KeywordTok{library}\NormalTok{(}\StringTok{"tidyr"}\NormalTok{)        }\CommentTok{# Fonctions pour reorganiser des données}
\KeywordTok{library}\NormalTok{(}\StringTok{"ggplot2"}\NormalTok{)      }\CommentTok{# Production des figures}
\KeywordTok{library}\NormalTok{(}\StringTok{"RColorBrewer"}\NormalTok{) }\CommentTok{# palettes de couleurs}
\KeywordTok{library}\NormalTok{(}\StringTok{"foreach"}\NormalTok{)      }\CommentTok{# Faire des calcules en parallèle ...}
\KeywordTok{library}\NormalTok{(}\StringTok{"doParallel"}\NormalTok{)   }\CommentTok{# ... sur plusieurs processeurs}
\KeywordTok{library}\NormalTok{(}\StringTok{"knitr"}\NormalTok{)        }\CommentTok{# pour la documentation html}


\CommentTok{# Créer un environnement caché  ===============================================}
\NormalTok{.snsf =}\StringTok{ }\KeywordTok{new.env}\NormalTok{()}

\CommentTok{# Années / Périodes -----------------------------}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{YEARS.ALL <-}\StringTok{   }\DecValTok{1985}\OperatorTok{:}\DecValTok{2019}                                  \CommentTok{# - tous}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{YEARS.JNT <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1987}\NormalTok{, }\DecValTok{2003}\NormalTok{, }\DecValTok{2005}\NormalTok{, }\DecValTok{2007}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2017}\NormalTok{, }\DecValTok{2018}\NormalTok{)  }\CommentTok{# - conjointes}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{YEARS.REF <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1987}\NormalTok{, }\DecValTok{2003}\NormalTok{,             }\DecValTok{2015}\NormalTok{,       }\DecValTok{2018}\NormalTok{)  }\CommentTok{# - référence}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{YEARS.NRF <-}\StringTok{ }\KeywordTok{c}\NormalTok{(      }\DecValTok{2003}\NormalTok{,             }\DecValTok{2015}\NormalTok{,       }\DecValTok{2018}\NormalTok{)  }\CommentTok{# - NRF}

\CommentTok{# Répertoires -----------------------------------}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.RAW.DAT   <-}\StringTok{ "../data"}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.SST       <-}\StringTok{ "./01_SSTS"}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.SST.DAT   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.SST, }\StringTok{"/01_data"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.SST.DAT.LST   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.SST.DAT, }\StringTok{"/Landsat"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.SST.DAT.WC2   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.SST.DAT, }\StringTok{"/Worldclim"}\NormalTok{)}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.SST.BDD   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.SST, }\StringTok{"/02_BdD"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.SST.BDD.GRD   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.SST.BDD, }\StringTok{"/01_reseau-SSTS"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.SST.BDD.TPS   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.SST.BDD, }\StringTok{"/02_train-plots"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.SST.BDD.VPS   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.SST.BDD, }\StringTok{"/03_val-plots"}\NormalTok{)}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.IFN       <-}\StringTok{ "./02_IFN"}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.IFN.DAT   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.IFN, }\StringTok{"/01_field-data"}\NormalTok{)}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV       <-}\StringTok{ "./03_NRF-MRV"}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.MRV, }\StringTok{"/01_MCF"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF.REF   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF, }\StringTok{"/01_ref-maps"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF.RAW   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF, }\StringTok{"/02_raw-maps"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF.CLN   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF, }\StringTok{"/03_cln-maps"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF.VAL   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.MCF, }\StringTok{"/04_validation"}\NormalTok{)}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.AGB   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.MRV, }\StringTok{"/02_AGB"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.AGB.REF   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.AGB, }\StringTok{"/01_ref-maps"}\NormalTok{)}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.AGB.RES   <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.MRV.AGB, }\StringTok{"/02_results"}\NormalTok{)}

\CommentTok{# Système de référence des coordonnées ----------}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{UTM}\FloatTok{.30}\NormalTok{ <-}\StringTok{ }\KeywordTok{crs}\NormalTok{(}\StringTok{"+proj=utm +zone=30 +datum=WGS84}
\StringTok{                     +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"}\NormalTok{)}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{UTM}\FloatTok{.31}\NormalTok{ <-}\StringTok{ }\KeywordTok{crs}\NormalTok{(}\StringTok{"+proj=utm +zone=31 +datum=WGS84 }
\StringTok{                     +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"}\NormalTok{)}

\CommentTok{# Domaine d'intérêt  ----------------------------}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{TGO     <-}\StringTok{ }\KeywordTok{spTransform}\NormalTok{(}
                   \KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.RAW.DAT, }\StringTok{"/GADM/gadm36_TGO_0.shp"}\NormalTok{)),}
\NormalTok{                     .snsf}\OperatorTok{$}\NormalTok{UTM}\FloatTok{.31}
\NormalTok{                 )}

\NormalTok{snsf}\OperatorTok{$}\NormalTok{TGO.REG     <-}\StringTok{ }\KeywordTok{spTransform}\NormalTok{(}
                      \KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(.snsf}\OperatorTok{$}\NormalTok{DIR.RAW.DAT, }\StringTok{"/GADM/gadm36_TGO_1.shp"}\NormalTok{)),}
\NormalTok{                        .snsf}\OperatorTok{$}\NormalTok{UTM}\FloatTok{.31}
\NormalTok{                    )}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{TGO.EXT <-}\StringTok{ }\KeywordTok{extent}\NormalTok{(}\DecValTok{151155}\NormalTok{, }\DecValTok{373005}\NormalTok{, }\DecValTok{670665}\NormalTok{, }\DecValTok{1238175}\NormalTok{)  }\CommentTok{# xmin, xmax, ymin, ymax}

\CommentTok{# Noms des couches de données -------------------}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{SST.LSBANDS     <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"B"}\NormalTok{, }\StringTok{"G"}\NormalTok{, }\StringTok{"R"}\NormalTok{, }\StringTok{"NIR"}\NormalTok{, }\StringTok{"SWIR1"}\NormalTok{, }\StringTok{"SWIR2"}\NormalTok{, }
                           \StringTok{"evi"}\NormalTok{, }\StringTok{"msavi"}\NormalTok{, }\StringTok{"nbr"}\NormalTok{, }\StringTok{"nbr2"}\NormalTok{, }\StringTok{"ndmi"}\NormalTok{, }\StringTok{"ndvi"}\NormalTok{, }\StringTok{"savi"}\NormalTok{)}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{SST.BIOCLIM     <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"BIO"}\NormalTok{, }\DecValTok{1}\OperatorTok{:}\DecValTok{19}\NormalTok{)}

\CommentTok{# Codes pour les classes ------------------------}

\NormalTok{.snsf}\OperatorTok{$}\NormalTok{NONFOR <-}\StringTok{ }\DecValTok{0}   \CommentTok{# non-forêt}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{PREGEN <-}\StringTok{ }\DecValTok{1}   \CommentTok{# régénération potentielle}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{REGEN  <-}\StringTok{ }\DecValTok{2}   \CommentTok{# régénération}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{FOREST <-}\StringTok{ }\DecValTok{3}   \CommentTok{# forêt / forêt initiale}

\CommentTok{# Divers ----------------------------------------}

\CommentTok{# Processeurs disponibles pour le calcul parallèle}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{CORES <-}\StringTok{ }\KeywordTok{detectCores}\NormalTok{()}

\CommentTok{# Semence pour le générateur de nombres aléatoires}
\NormalTok{.snsf}\OperatorTok{$}\NormalTok{RSEED <-}\StringTok{ }\DecValTok{20191114}

\CommentTok{# Attacher l'environnement}
\KeywordTok{attach}\NormalTok{(.snsf)}


\CommentTok{# Message de bienvenue  =======================================================}

\KeywordTok{message}\NormalTok{(}\StringTok{"}
\StringTok{=> chargé librairies et variables définit en .Rprofile}

\StringTok{.oPYo. o    o .oPYo.  ooooo   ooooo                      }
\StringTok{8      8b   8 8       8         8                        }
\StringTok{`Yooo. 8`b  8 `Yooo. o8oo       8   .oPYo. .oPYo. .oPYo. }
\StringTok{    `8 8 `b 8     `8  8         8   8    8 8    8 8    8 }
\StringTok{     8 8  `b8      8  8         8   8    8 8    8 8    8 }
\StringTok{`YooP' 8   `8 `YooP'  8         8   `YooP' `YooP8 `YooP' }
\StringTok{:.....:..:::..:.....::..::::::::..:::.....::....8 :.....:}
\StringTok{:::::::::::::::::::::::::::::::::::::::::::::ooP'.:::::::}
\StringTok{:::::::::::::::::::::::::::::::::::::::::::::...:::::::::}
\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
\KeywordTok{date}\NormalTok{(),}
\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{SSTS}{%
\section{Système de Surveillance Terrestre}\label{SSTS}}

Le Système de Surveillance Terrestre par Satellite (SSTS) consiste d'une base de données spatiales (images satellitaires, modèle numérique du terrain, données climatiques) d'un réseau de parcelles d'échantillonnage, dont la \textbf{couverture des houppiers et l'utilisation des terres} sont régulièrement enregistrées par photo-interprètes sur base des images satellitaires. Pour le moment, les attributs enregistrés dans le SSTS sont :

\begin{itemize}
\tightlist
\item
  \protect\hyperlink{SSTS-couverture-houppiers}{Couverture des houppiers}
\item
  \protect\hyperlink{SSTS-occupation-terres}{Occupation des terres}
\end{itemize}

Les répertoires et les fichiers sont structurés comme suit:

\begin{verbatim}
01_SSTS                           # SYSTÈME DE SURVEILLANCE TERRESTRE =========
├── 01_data                         #:: images et autres données pré-traités --
    └── ...
            
├── 02_BdD                          #:: base de données SSTS ------------------
    ├── _src                         #:: scripts R
        ├── _create-grid.R             # [R] création réseau SSTS
        ├── _create-train-plots.R      # [R] création parcelles d'entraînement
        └── _create-val-plots.R        # [R] création parcelles de validation
    ├── 01_reseau-SSTS               #:: réseau de parcelles SSTS
    ├── 02_train-plots               #:: parcelles d'entraînement
    └── 03_val-plots                 #:: parcelles de validation
\end{verbatim}

\begin{rmdtodo}
Actuellement, les données de base ainsi que les données générées par les
photo-interprètes sont stockées dans des fichiers (tif pour les rasters
et shp pour les données vecteurs). Il est prévu de gérer ces données
SSTS dans une base de données géographiques (PostGIS) à l'avenir. Cette
base de données est actuellement installé sur un serveur central au
ministère de l'Environnement et des Forêts (MERF).
\end{rmdtodo}

\hypertarget{SSTS-BdD}{%
\subsection{Données de base}\label{SSTS-BdD}}

\hypertarget{SSTS-Landsat}{%
\subsubsection{Images Landsat}\label{SSTS-Landsat}}

Actuellement, l'analyse de l'évolution du couvert forestier est principalement basée sur les \textbf{images satellitaires Landsat}, qui sont disponibles gratuitement dans les archives de l'USGS. Les missions Landsat-4 à Landsat-8 produisent des images de résolution spatiale et radiométrique comparable depuis les années 1980. Les images brutes sont corrigées géométriquement et radiométriquement par l'USGS (\href{https://www.usgs.gov/land-resources/nli/landsat/landsat-surface-reflectance}{USGS Collection 1 Level-2 Surface Reflection Product}).

La résolution spatiale des images est de \textbf{30 mètres}. Les bandes spectrales utilisées sont \textbf{B, G, R, NIR, SWIR-1 et SWIR-2} (voir les désignations des bandes dans la figure ci-dessous).

\includegraphics{images/Acq-band-designations.png}

Le territoire du Togo est couvert par un total de 9 images Landsat (scènes WRS 2). Les zones couvertes par les différentes scènes sont indiquées dans la figure ci-dessous.

\includegraphics{images/Acq-scenes-Togo.png}

Les images Landsat utilisées pour l'évaluation du couvert forestier ont été prises idéalement à la \textbf{fin de la saison sèche, c'est-à-dire de (Nov), Déc, Jan, (Fév)} et sont disponibles en \textbf{bonne qualité} (sans nuages ou seulement légèrement couvertes par des nuages et des ombres) \textbf{pour la même date sur l'ensemble du chemin WRS 2} respectif. Pour les années de référence, là ou on aimerait des cartes qui couvrent l'ensemble du territoire du Togo, des images correspondantes sont nécessaires pour tous les trois chemins WRS 2.

Le tableau ci-dessous présente les images satellites utilisées pour l'analyse du couvert forestier au Togo. Les \textbf{années de référence} utilisées pour le NRF et les images correspondantes sont indiquées en caractères gras. Ce n'est que pour l'année 1991 que les images de différentes dates d'enregistrement ont été combinées pour le chemin WRS 193. L7* marque les images Landsat-7 avec des lacunes dans les données (SLC-off). La colonne \textbf{GoogleEarth} montre la répartition des dates des images de très haute résolution disponibles sur \href{https://www.google.com/maps/place/Togo/@6.8865979,0.6126023,1079m/data=!3m1!1e3!4m5!3m4!1s0x1023e1c113185419:0xfaae5b301ad19360!8m2!3d8.619543!4d0.824782}{GoogleEarth}. Seules les images de référence GoogleEarth de 2017 -- 2018 ont été utilisées pour la calibration de la carte forêt/non-forêt 2018.

\begin{longtable}[]{@{}rrrrr@{}}
\toprule
\begin{minipage}[b]{0.07\columnwidth}\raggedleft
\strut
\end{minipage} & \begin{minipage}[b]{0.20\columnwidth}\raggedleft
WRS 192\textsuperscript{054,055,056}\strut
\end{minipage} & \begin{minipage}[b]{0.20\columnwidth}\raggedleft
WRS 193\textsuperscript{052,053,054,055}\strut
\end{minipage} & \begin{minipage}[b]{0.20\columnwidth}\raggedleft
WRS 194\textsuperscript{052,053}\strut
\end{minipage} & \begin{minipage}[b]{0.18\columnwidth}\raggedleft
GoogleEarth\textsuperscript{Référence}\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2019\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L8 / 23.12.18\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L8 / 16.02.19\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L8 / 22.01.19\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\textbf{++}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
\textbf{2018}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L8 / 05.01.18}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L8 / 12.01.18}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L8 / 18.12.17}\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\textbf{+++++++}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2017\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L8 / 19.02.17\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L8 / 25.01.17\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L8 / 31.12.16\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\textbf{+++}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2016\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(+)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
\textbf{2015}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L8 / 13.01.15}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L8 / 04.01.15}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L8 / 27.01.15}\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(+)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2014\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(++)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2013\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 31.01.13\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 23.02.13\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(+)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2012\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 11.01.12\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(++)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2011\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 10.01.11\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(+)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2010\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 21.01.10\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(+)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2009\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 27.01.09\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2008\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2007\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 30.12.06\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 22.01.07\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L5 / 05.01.07\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2006\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2005\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 24.12.04\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 17.02.05\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7* / 22.12.04\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2004\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
\textbf{2003}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L7 / 04.01.03}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L7 / 26.12.02}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L7 / 17.12.02}\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(.)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2002\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2001\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7 / 13.12.00\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
(.)\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
2000\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7 / 04.02.00\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L7 / 26.01.00\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
1997\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L5 / 10.02.97\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
1991\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L4 / 03.01.91\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L4 / 10.01.91 \& L5 / 28.11.89\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\ldots{}\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
\textbf{1987}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L5 / 31.12.86}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L5 / 23.01.87}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
\textbf{L5 / 29.12.86}\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedleft
1986\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L5 / 13.01.86\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L5 / 06.03.85\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedleft
L5 / 11.01.86\strut
\end{minipage} & \begin{minipage}[t]{0.18\columnwidth}\raggedleft
\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{acquisition-des-images}{%
\paragraph{Acquisition des images}\label{acquisition-des-images}}

Ouvrir le site \href{https://earthexplorer.usgs.gov}{USGS Earthexplorer}. Dans la fenêtre \texttt{Search\ Criteria} il faut selectionner la période pour laquelle on cherche des images (Nov - Jan). Dans la fenêtre \texttt{Data\ Sets}, les produits Landsat Level-2 (Surface Reflectance) sont séléctionnés. Dans la fenêtre \texttt{Additional\ Criteria} il faut choisir les scènes (chemin 192: 054-056 / chemin 193: 052-055 / chemin 194: 052-053).

\includegraphics{images/Acq-EE.png}

Parmi les images disponibles, on sélectionne celles qui sont disponibles à la même date et en bonne qualité pour l'ensemble du chemin WRS.
On copie les identifier des images à télécharger dans un fichier txt.

Ensuite on ouvre le site \href{https://espa.cr.usgs.gov/ordering/new/}{USGS ESPA} pour commander les images choisi. On charge le fichier txt avec les identifier des images et on commande les bandes \texttt{Surface\ Reflectance} et les indices spéctrales (voir image au-dessous). Pour commander des images, il faut qu'on a un compte USGS.

\includegraphics{images/Acq-ESPA.png}

Une fois on est notifié par eMail que les images sont prêts, on les téléchargent manuellement ou tous ensemble avec le \href{https://github.com/USGS-EROS/espa-bulk-downloader}{USGS bulkdownloader} et la commande \texttt{download\_espa\_order.py\ -u\ {[}nom\ d\textquotesingle{}utilisateur{]}\ -o\ ALL\ -d\ {[}répértoire{]}}. On dézip les images et les rangent dans le répétoire \texttt{data/Landsat} sous la scène et l'année correspondante. Pour des images de l'hiver 2019/20, l'année correspondante est 2020.

\hypertarget{pretraitement-des-images}{%
\paragraph{Prétraitement des images}\label{pretraitement-des-images}}

Le premier traitement est la préparation des images Landsat et autres variables utilisés pour modéliser la surface forestier ou la biomasse aérienne comme les données topographique et climatiques. L'objectif est qu'on prépare avec les données brutes un jeu de données raster complet sur le même extent (territoir du Togo) et avec la même résolution spatiale de 30 mètres (résolution de base des images Landsat).

On ouvre le script \texttt{1\_prepare-images.R} et on modifie la liste des images Landsat à utiliser (\texttt{in.image.list}), par exemple par ajouter les nouveaux image à considérer dans les analyses:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p192}\FloatTok{.2019}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/192_054/2019/LC081920542018122301T1-SC20190405164258/"}\NormalTok{),}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/192_055/2019/LC081920552018122301T1-SC20190405163359/"}\NormalTok{),}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/192_056/2019/LC081920562018122301T1-SC20190405163342/"}\NormalTok{))}
\NormalTok{...}
\NormalTok{p193}\FloatTok{.2019}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/193_052/2019/LC081930522019021601T1-SC20190405183839/"}\NormalTok{),}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/193_053/2019/LC081930532019021601T1-SC20190405181518/"}\NormalTok{),}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/193_054/2019/LC081930542019021601T1-SC20190405183609/"}\NormalTok{),}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/193_055/2019/LC081930552019021601T1-SC20190405181507/"}\NormalTok{))}
\NormalTok{...}
\NormalTok{p194}\FloatTok{.2019}\NormalTok{ =}\StringTok{ }\KeywordTok{list}\NormalTok{(}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/194_052/2019/LC081940522019012201T1-SC20190405172019/"}\NormalTok{),}
  \KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/Landsat/194_053/2019/LC081940532019012201T1-SC20190405172055/"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Outre la définition des images à traiter, le script définit une fonction \texttt{prepare.image} pour stacker les différentes bandes des images Landsat, pour les fusioner, masquer et couper les images Landsat chemin par chemin (WRS2 paths 192, 193 et 194 pour Togo). Par défaut, les images qui ont déjà été traité (\texttt{filename} existe déjà) ne sont plus traité (\texttt{overwrite=FALSE}).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{prepare.image}\NormalTok{(in.image.dirs, }\DataTypeTok{ext=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{filename=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{log=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Dans la deuxième partie du script, là où c'est noté \texttt{\#\ DO\ THE\ WORK\ -\/-\/-\/-\/-\/-\/-\/-\/-}, on lance le traitement des images. Avec le code \texttt{foreach(...)\ \%dopar\%\ \{\ ...\ \}} on lance le traitement de chaque chemin pour chaque année sur des différents processeurs au parallèle. À la fin du script on

\begin{itemize}
\tightlist
\item
  transforme les images du chemin 194 du système de coordonnées UTM 30 vers UTM 31
\item
  produit des thumbnails des images Landsat
\end{itemize}

Les images prétraités sont sauveguarder dans le répétoire \texttt{input/1\_images} du projet, ensemble avec des Thumbnails des chemins. Dans une prochaîne étape, les images sont néttoyées de l'eau, nuages et ombres en utilisant les bandes Landsat de qualité des pixels.

\hypertarget{example}{%
\subparagraph{Example}\label{example}}
\addcontentsline{toc}{subparagraph}{Example}

\includegraphics[width=0.33\linewidth]{images/p194_2019}
\includegraphics[width=0.33\linewidth]{images/p193_2019}
\includegraphics[width=0.33\linewidth]{images/p192_2019}
\textbf{Images Landsat de l'année 2019:} chemin p194 composé de 2 scénes du 22.01.2019 / p193 avec 4 scènes du 16.02.2019 / p192 avec 3 scènes du 23.12.2018

\hypertarget{script-r-01_ssts01_data_srcprep-landsat.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-Landsat.R}}{Script R: 01\_SSTS/01\_data/\_src/prep-Landsat.R}}\label{script-r-01_ssts01_data_srcprep-landsat.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-Landsat.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# prep-Landsat.R: lire, nettoyer et empiler des images Landsat}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}
\NormalTok{IN.DIR  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.RAW.DAT, }\StringTok{"/Landsat"}\NormalTok{)}

\NormalTok{OUT.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.SST.DAT, }\StringTok{"/Landsat"}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(OUT.DIR)) }\KeywordTok{dir.create}\NormalTok{(OUT.DIR)}

\NormalTok{WRS     <-}\StringTok{ }\KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/WRS2/WRS2_descending.shp"}\NormalTok{))    }\CommentTok{# Scènes WRS}

\CommentTok{# Masques de nuages et d'eau pour Landsat 4-7 et Landsat 8   ------------------}
\CommentTok{# voir les guides des produits de réflexion de surface Landsat 4-7 et Landsat 8}
\CommentTok{# https://www.usgs.gov/land-resources/nli/landsat/landsat-surface-reflectance}

\NormalTok{QA.WATER <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}
  \DecValTok{68}\NormalTok{, }\DecValTok{132}\NormalTok{,                      }\CommentTok{# Landsat 4-7}
  \DecValTok{324}\NormalTok{, }\DecValTok{388}\NormalTok{, }\DecValTok{836}\NormalTok{, }\DecValTok{900}\NormalTok{, }\DecValTok{1348}      \CommentTok{# Landsat 8}
\NormalTok{)}

\NormalTok{QA.SHADOW <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}
  \DecValTok{72}\NormalTok{, }\DecValTok{136}\NormalTok{,}
  \DecValTok{328}\NormalTok{, }\DecValTok{392}\NormalTok{, }\DecValTok{840}\NormalTok{, }\DecValTok{904}\NormalTok{, }\DecValTok{1350}
\NormalTok{)}

\NormalTok{QA.ICE <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}
  \DecValTok{80}\NormalTok{, }\DecValTok{112}\NormalTok{, }\DecValTok{144}\NormalTok{, }\DecValTok{176}\NormalTok{,}
  \DecValTok{336}\NormalTok{, }\DecValTok{368}\NormalTok{, }\DecValTok{400}\NormalTok{, }\DecValTok{432}\NormalTok{, }\DecValTok{848}\NormalTok{, }\DecValTok{880}\NormalTok{, }\DecValTok{912}\NormalTok{, }\DecValTok{944}\NormalTok{, }\DecValTok{1352}
\NormalTok{)}

\NormalTok{QA.CLOUD <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}
  \DecValTok{96}\NormalTok{, }\DecValTok{112}\NormalTok{, }\DecValTok{160}\NormalTok{, }\DecValTok{176}\NormalTok{, }\DecValTok{224}\NormalTok{,}
  \DecValTok{352}\NormalTok{, }\DecValTok{368}\NormalTok{, }\DecValTok{416}\NormalTok{, }\DecValTok{432}\NormalTok{, }\DecValTok{480}\NormalTok{, }\DecValTok{864}\NormalTok{, }\DecValTok{880}\NormalTok{, }\DecValTok{928}\NormalTok{, }\DecValTok{944}\NormalTok{, }\DecValTok{992}
\NormalTok{)}

\CommentTok{# Liste des images à préparer et à fusionner ==================================}

\NormalTok{in.image.list <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}

  \CommentTok{# Chemin WRS p192 -----------------------------}

  \DataTypeTok{p192.1986 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/1986/LT051920541986011301T1-SC20190405164223/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/1986/LT051920551986011301T1-SC20190405164227/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/1986/LT051920561986011301T1-SC20190405164153/"}\NormalTok{)),}

  \DataTypeTok{p192.1987 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/1987/LT051920541986123101T1-SC20190405164150/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/1987/LT051920551986123101T1-SC20190405163521/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/1987/LT051920561986123101T1-SC20190405164444/"}\NormalTok{)),}

  \DataTypeTok{p192.1991 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/1991/LT041920541991010301T1-SC20190405164201/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/1991/LT041920551991010301T1-SC20190405165911/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/1991/LT041920561991010301T1-SC20190405163911/"}\NormalTok{)),}

  \DataTypeTok{p192.2001 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2001/LE071920542000121301T1-SC20190405165521/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2001/LE071920552000121301T1-SC20190405165645/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2001/LE071920562000121301T1-SC20190405164029/"}\NormalTok{)),}

  \DataTypeTok{p192.2003 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2003/LE071920542003010401T1-SC20190520111322/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2003/LE071920552003010401T1-SC20190520100402/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2003/LE071920562003010401T1-SC20190520100206/"}\NormalTok{)),}

  \DataTypeTok{p192.2005 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2005/LE071920542004122401T1-SC20190405165520/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2005/LE071920552004122401T1-SC20190405164050/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2005/LE071920562004122401T1-SC20190405164030/"}\NormalTok{)),}

  \DataTypeTok{p192.2007 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2007/LE071920542006123001T1-SC20190406034211/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2007/LE071920552006123001T1-SC20190406034231/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2007/LE071920562006123001T1-SC20190406034202/"}\NormalTok{)),}

  \DataTypeTok{p192.2011 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2011/LE071920542011011001T1-SC20190406034214/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2011/LE071920552011011001T1-SC20190406034114/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2011/LE071920562011011001T1-SC20190406034155/"}\NormalTok{)),}

  \DataTypeTok{p192.2013 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2013/LE071920542013013101T1-SC20190406034224/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2013/LE071920552013013101T1-SC20190406034046/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2013/LE071920562013013101T1-SC20190406034057/"}\NormalTok{)),}

  \DataTypeTok{p192.2015 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2015/LC081920542015011301T1-SC20190405163446/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2015/LC081920552015011301T1-SC20190405163723/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2015/LC081920562015011301T1-SC20190405164231/"}\NormalTok{)),}

  \DataTypeTok{p192.2017 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2017/LC081920542017021901T1-SC20190405163339/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2017/LC081920552017021901T1-SC20190405163342/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2017/LC081920562017021901T1-SC20190405163222/"}\NormalTok{)),}

  \DataTypeTok{p192.2018 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2018/LC081920542018010501T1-SC20190405164304/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2018/LC081920552018010501T1-SC20190405163402/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2018/LC081920562018010501T1-SC20190405163250/"}\NormalTok{)),}

  \DataTypeTok{p192.2019 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_054/2019/LC081920542018122301T1-SC20190405164258/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_055/2019/LC081920552018122301T1-SC20190405163359/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/192_056/2019/LC081920562018122301T1-SC20190405163342/"}\NormalTok{)),}

  \CommentTok{# Chemin WRS p193 -----------------------------}

  \DataTypeTok{p193.1985 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/1985/LT051930521985030601T1-SC20190520100259/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/1985/LT051930531985030601T1-SC20190520100324/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/1985/LT051930541985030601T1-SC20190520100340/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/1985/LT051930551985030601T1-SC20190520100140/"}\NormalTok{)),}

  \DataTypeTok{p193.1987 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/1987/LT051930521987012301T1-SC20190405182322/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/1987/LT051930531987012301T1-SC20190405182335/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/1987/LT051930541987012301T1-SC20190405182331/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/1987/LT051930551987012301T1-SC20190405182328/"}\NormalTok{)),}

  \CommentTok{# Attention: là nous avons des images avec des dates différentes !}
  \DataTypeTok{p193.1990.1 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/1990/LT051930521989112801T1-SC20190520100201/"}\NormalTok{),}
                     \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/1990/LT051930531989112801T1-SC20190520100233/"}\NormalTok{)),}
  \DataTypeTok{p193.1990.2 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/1991/LT041930541991011001T1-SC20190402043117/"}\NormalTok{),}
                     \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/1991/LT041930551991011001T1-SC20190402042453/"}\NormalTok{)),}

  \DataTypeTok{p193.2000 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2000/LE071930522000020401T1-SC20190520100729/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2000/LE071930532000020401T1-SC20190520100345/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2000/LE071930542000020401T1-SC20190402045232/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2000/LE071930552000020401T1-SC20190402043121/"}\NormalTok{)),}

  \DataTypeTok{p193.2003 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2003/LE071930522002122601T1-SC20190405182352/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2003/LE071930532002122601T1-SC20190405182309/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2003/LE071930542002122601T1-SC20190405182226/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2003/LE071930552002122601T1-SC20190405190255/"}\NormalTok{)),}

  \DataTypeTok{p193.2005 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2005/LE071930522005021701T1-SC20190405190117/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2005/LE071930532005021701T1-SC20190405190003/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2005/LE071930542005021701T1-SC20190405182210/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2005/LE071930552005021701T1-SC20190405190021/"}\NormalTok{)),}

  \DataTypeTok{p193.2007 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2007/LE071930522007012201T1-SC20190405182221/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2007/LE071930532007012201T1-SC20190405182607/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2007/LE071930542007012201T1-SC20190405182139/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2007/LE071930552007012201T1-SC20190405182418/"}\NormalTok{)),}

  \DataTypeTok{p193.2009 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2009/LE071930522009012701T1-SC20190405182143/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2009/LE071930532009012701T1-SC20190405182301/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2009/LE071930542009012701T1-SC20190405182103/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2009/LE071930552009012701T1-SC20190405182754/"}\NormalTok{)),}

  \DataTypeTok{p193.2013 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2013/LE071930522013022301T1-SC20190405182200/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2013/LE071930532013022301T1-SC20190405182213/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2013/LE071930542013022301T1-SC20190405182152/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2013/LE071930552013022301T1-SC20190405182331/"}\NormalTok{)),}

  \DataTypeTok{p193.2015 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2015/LC081930522015010401T1-SC20190405181512/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2015/LC081930532015010401T1-SC20190405181751/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2015/LC081930542015010401T1-SC20190402042510/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2015/LC081930552015010401T1-SC20190402042446/"}\NormalTok{)),}

  \DataTypeTok{p193.2017 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2017/LC081930522017012501T1-SC20190405181511/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2017/LC081930532017012501T1-SC20190405181440/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2017/LC081930542017012501T1-SC20190405181458/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2017/LC081930552017012501T1-SC20190405181444/"}\NormalTok{)),}

  \DataTypeTok{p193.2018 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2018/LC081930522018011201T1-SC20190405181524/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2018/LC081930532018011201T1-SC20190405181459/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2018/LC081930542018011201T1-SC20190405181510/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2018/LC081930552018011201T1-SC20190405181442/"}\NormalTok{)),}

  \DataTypeTok{p193.2019 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_052/2019/LC081930522019021601T1-SC20190405183839/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_053/2019/LC081930532019021601T1-SC20190405181518/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_054/2019/LC081930542019021601T1-SC20190405183609/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/193_055/2019/LC081930552019021601T1-SC20190405181507/"}\NormalTok{)),}

  \CommentTok{# Chemin WRS p194 -----------------------------}

  \DataTypeTok{p194.1986 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/1986/LT051940521986011101T1-SC20190405172804/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/1986/LT051940531986011101T1-SC20190405172758/"}\NormalTok{)),}

  \DataTypeTok{p194.1987 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/1987/LT051940521986122901T1-SC20190405172903/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/1987/LT051940531986122901T1-SC20190405174433/"}\NormalTok{)),}

  \DataTypeTok{p194.1997 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/1997/LT051940521997021001T1-SC20190405181746/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/1997/LT051940531997021001T1-SC20190405173130/"}\NormalTok{)),}

  \DataTypeTok{p194.2000 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2000/LE071940522000012601T1-SC20190405172721/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2000/LE071940532000012601T1-SC20190405172733/"}\NormalTok{)),}

  \DataTypeTok{p194.2003 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2003/LE071940522002121701T1-SC20190405172823/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2003/LE071940532002121701T1-SC20190405172739/"}\NormalTok{)),}

  \DataTypeTok{p194.2005 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2005/LE071940522004122201T1-SC20190405172700/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2005/LE071940532004122201T1-SC20190405172612/"}\NormalTok{)),}

  \DataTypeTok{p194.2007 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2007/LT051940522007010501T1-SC20190405172919/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2007/LT051940532007010501T1-SC20190405172216/"}\NormalTok{)),}

  \DataTypeTok{p194.2010 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2010/LE071940522010012101T1-SC20190405172745/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2010/LE071940532010012101T1-SC20190405173304/"}\NormalTok{)),}
  
  \DataTypeTok{p194.2012 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2012/LE071940522012011101T1-SC20190405173146/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2012/LE071940532012011101T1-SC20190405172236/"}\NormalTok{)),}

  \DataTypeTok{p194.2015 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2015/LC081940522015012701T1-SC20190405172055/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2015/LC081940532015012701T1-SC20190405172042/"}\NormalTok{)),}

  \DataTypeTok{p194.2017 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2017/LC081940522016123101T1-SC20190405172058/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2017/LC081940532016123101T1-SC20190405172040/"}\NormalTok{)),}

  \DataTypeTok{p194.2018 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2018/LC081940522017121801T1-SC20190405172038/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2018/LC081940532017121801T1-SC20190405174114/"}\NormalTok{)),}

  \DataTypeTok{p194.2019 =} \KeywordTok{list}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_052/2019/LC081940522019012201T1-SC20190405172019/"}\NormalTok{),}
                   \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/194_053/2019/LC081940532019012201T1-SC20190405172055/"}\NormalTok{))}

\NormalTok{)}

\CommentTok{# Fonction pour traiter et fusionner un ensemble d'images Landsat =============}
\CommentTok{#}
\CommentTok{# @param in.image.dirs liste des répertoires des images à traiter}
\CommentTok{# @param ext           l'étendue dà utiliser pour le recadrage des images}
\CommentTok{# @param filename      nom de fichier pour la sauvegarde de l'image traitée}
\CommentTok{# @param overwrite     retraiter et écraser des images déjà existantes}
\CommentTok{# @param log           écrire les informations sur le processus dans un fichier}
\CommentTok{#}
\CommentTok{# @return              objet raster de l'image traitée (invisible)}
\CommentTok{#}
\NormalTok{prepare.landsat <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(in.image.dirs, }
                            \DataTypeTok{ext=}\OtherTok{NULL}\NormalTok{, }
                            \DataTypeTok{filename=}\OtherTok{NULL}\NormalTok{, }
                            \DataTypeTok{overwrite=}\OtherTok{FALSE}\NormalTok{, }
                            \DataTypeTok{log=}\OtherTok{TRUE}\NormalTok{) \{}
  
  \CommentTok{# Charger le fichier, si le fichier existe et overwrite==FALSE}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename) }\OperatorTok{&&}\StringTok{ }\KeywordTok{file.exists}\NormalTok{(filename) }\OperatorTok{&&}\StringTok{ }\NormalTok{overwrite}\OperatorTok{==}\OtherTok{FALSE}\NormalTok{) \{}
    \KeywordTok{message}\NormalTok{(}\StringTok{"- loading from file "}\NormalTok{, filename)}
\NormalTok{    out.image <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(filename)}
    
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    
    \CommentTok{# Ouvrir le fichier journal si un nom de fichier et log==true}
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename) }\OperatorTok{&}\StringTok{ }\NormalTok{log}\OperatorTok{==}\OtherTok{TRUE}\NormalTok{) \{}
      \KeywordTok{dir.create}\NormalTok{(}\KeywordTok{dirname}\NormalTok{(filename), }\DataTypeTok{recursive =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{showWarnings =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{      logfile <-}\StringTok{ }\KeywordTok{file}\NormalTok{(}\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.[[:alnum:]]+$"}\NormalTok{, }\StringTok{".log"}\NormalTok{, filename), }\DataTypeTok{open=}\StringTok{"wt"}\NormalTok{)}
      \KeywordTok{sink}\NormalTok{(logfile, }\DataTypeTok{type=}\StringTok{"output"}\NormalTok{)}
      \KeywordTok{sink}\NormalTok{(logfile, }\DataTypeTok{type=}\StringTok{"message"}\NormalTok{)}
      \KeywordTok{message}\NormalTok{(}\KeywordTok{date}\NormalTok{())}
\NormalTok{    \}}
    
    \CommentTok{# Listes vides pour les images et des bandes de qualité}
\NormalTok{    images <-}\StringTok{ }\KeywordTok{list}\NormalTok{()}
\NormalTok{    qas <-}\StringTok{ }\KeywordTok{list}\NormalTok{()}
    
    \CommentTok{# Pour chaque image ... }
    \ControlFlowTok{for}\NormalTok{(image.dir }\ControlFlowTok{in}\NormalTok{ in.image.dirs) \{}
      
\NormalTok{      image.sensor <-}\StringTok{ }\KeywordTok{substr}\NormalTok{(}\KeywordTok{basename}\NormalTok{(image.dir), }\DecValTok{0}\NormalTok{,}\DecValTok{4}\NormalTok{) }
      \ControlFlowTok{if}\NormalTok{(image.sensor}\OperatorTok{==}\StringTok{"LC08"}\NormalTok{) \{}
\NormalTok{        regexp <-}\StringTok{ "^.*_(pixel_qa|band2|band3|band4|band5|band6|band7|evi|msavi|nbr|nbr2|ndmi|ndvi|savi).tif$"}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        regexp <-}\StringTok{ "^.*_(pixel_qa|band1|band2|band3|band4|band5|band7|evi|msavi|nbr|nbr2|ndmi|ndvi|savi).tif$"}
\NormalTok{      \}}
\NormalTok{      image <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(}\KeywordTok{grep}\NormalTok{(regexp, }\KeywordTok{dir}\NormalTok{(image.dir, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{), }\DataTypeTok{value=}\OtherTok{TRUE}\NormalTok{))}
\NormalTok{      image.name   <-}\StringTok{ }\KeywordTok{substr}\NormalTok{(}\KeywordTok{names}\NormalTok{(image)[}\DecValTok{1}\NormalTok{], }\DecValTok{1}\NormalTok{, }\DecValTok{40}\NormalTok{)}
\NormalTok{      image.scene  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\KeywordTok{substr}\NormalTok{(image.name, }\DecValTok{11}\NormalTok{, }\DecValTok{13}\NormalTok{), }\StringTok{"_"}\NormalTok{, }\KeywordTok{substr}\NormalTok{(image.name, }\DecValTok{14}\NormalTok{, }\DecValTok{16}\NormalTok{))}
\NormalTok{      image.date   <-}\StringTok{ }\KeywordTok{substr}\NormalTok{(image.name, }\DecValTok{18}\NormalTok{, }\DecValTok{21}\NormalTok{)}
\NormalTok{      image.path   <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{substr}\NormalTok{(image.scene, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{))}
\NormalTok{      image.row    <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{substr}\NormalTok{(image.scene, }\DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{))}
      
      \CommentTok{# ... renommer les couches de l'image}
      \KeywordTok{names}\NormalTok{(image) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"qa"}\NormalTok{, SST.LSBANDS)}
      
      \KeywordTok{message}\NormalTok{(}\StringTok{"- "}\NormalTok{, image.name, }\StringTok{": "}\NormalTok{, }\DataTypeTok{appendLF =} \OtherTok{FALSE}\NormalTok{)}
      
      \CommentTok{# ... recadrer l'image avec l'étendue (le cas échéant)}
      \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(ext)) \{}
        \KeywordTok{message}\NormalTok{(}\StringTok{"crop ext ... "}\NormalTok{, }\DataTypeTok{appendLF =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{        image <-}\StringTok{ }\KeywordTok{crop}\NormalTok{(image, ext)}
\NormalTok{      \}}
      
      \CommentTok{# ... recadrer et masquer avec WRS}
      \KeywordTok{message}\NormalTok{(}\StringTok{"crop/mask WRS2 ... "}\NormalTok{, }\DataTypeTok{appendLF =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{      wrs <-}\StringTok{ }\KeywordTok{spTransform}\NormalTok{(WRS[WRS}\OperatorTok{$}\NormalTok{PATH}\OperatorTok{==}\NormalTok{image.path }\OperatorTok{&}\StringTok{ }\NormalTok{WRS}\OperatorTok{$}\NormalTok{ROW}\OperatorTok{==}\NormalTok{image.row, ], }\DataTypeTok{CRS=}\KeywordTok{crs}\NormalTok{(image))}
\NormalTok{      image <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(image, wrs), wrs)}
      
      \CommentTok{# ... extraire la bande de qualité}
\NormalTok{      qa <-}\StringTok{ }\NormalTok{image[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{      image <-}\StringTok{ }\KeywordTok{dropLayer}\NormalTok{(image, }\DecValTok{1}\NormalTok{)}
      
      \CommentTok{# ... supprimer les valeurs de réflectance non valides}
      \KeywordTok{message}\NormalTok{(}\StringTok{"clean sr ... "}\NormalTok{, }\DataTypeTok{appendLF =} \OtherTok{FALSE}\NormalTok{)}
      \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\DecValTok{6}\NormalTok{) \{}
\NormalTok{        image[[i]] <-}\StringTok{ }\KeywordTok{reclassify}\NormalTok{(image[[i]], }\KeywordTok{cbind}\NormalTok{(}\OperatorTok{-}\OtherTok{Inf}\NormalTok{, }\DecValTok{0}\NormalTok{, }\OtherTok{NA}\NormalTok{), }\DataTypeTok{right=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{        image[[i]] <-}\StringTok{ }\KeywordTok{reclassify}\NormalTok{(image[[i]], }\KeywordTok{cbind}\NormalTok{(}\DecValTok{10000}\NormalTok{, }\OtherTok{Inf}\NormalTok{, }\OtherTok{NA}\NormalTok{), }\DataTypeTok{right=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{      \}}
      
      \CommentTok{# ... supprimer les valeurs d'indices non valides}
      \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{7}\OperatorTok{:}\DecValTok{13}\NormalTok{) \{}
\NormalTok{        image[[i]] <-}\StringTok{ }\KeywordTok{reclassify}\NormalTok{(image[[i]], }\KeywordTok{cbind}\NormalTok{(}\OperatorTok{-}\OtherTok{Inf}\NormalTok{, }\DecValTok{-10000}\NormalTok{, }\OtherTok{NA}\NormalTok{), }\DataTypeTok{right=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{        image[[i]] <-}\StringTok{ }\KeywordTok{reclassify}\NormalTok{(image[[i]], }\KeywordTok{cbind}\NormalTok{(}\DecValTok{10000}\NormalTok{, }\OtherTok{Inf}\NormalTok{, }\OtherTok{NA}\NormalTok{), }\DataTypeTok{right=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{      \}}

      \CommentTok{# ... mettre l'ensemble de la pile à NA là où une seule couche est NA}
\NormalTok{      m <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(image)}
\NormalTok{      image <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(image, m)}
      
      \CommentTok{# ... ajouter l'image et la bande de qualité aux listes correspondantes}
\NormalTok{      images[[}\KeywordTok{length}\NormalTok{(images)}\OperatorTok{+}\DecValTok{1}\NormalTok{]] <-}\StringTok{ }\NormalTok{image}
\NormalTok{      qas[[}\KeywordTok{length}\NormalTok{(qas)}\OperatorTok{+}\DecValTok{1}\NormalTok{]] <-}\StringTok{ }\NormalTok{qa}
\NormalTok{    \}}
    
    \CommentTok{# Fusionner les images (scènes) dans les listes}
    \KeywordTok{message}\NormalTok{(}\StringTok{"- merging scenes ... "}\NormalTok{, }\DataTypeTok{appendLF =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{    out.image <-}\StringTok{ }\KeywordTok{do.call}\NormalTok{(merge, images)}
\NormalTok{    out.qa <-}\StringTok{ }\KeywordTok{do.call}\NormalTok{(merge, qas)}
    
    \CommentTok{# Sauvegarder l'image fusionné dans un fichier}
    \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename) }\OperatorTok{&&}\StringTok{ }\NormalTok{(}\OperatorTok{!}\KeywordTok{file.exists}\NormalTok{(filename) }\OperatorTok{||}\StringTok{ }\NormalTok{overwrite }\OperatorTok{==}\StringTok{ }\OtherTok{TRUE}\NormalTok{)) \{}
      \KeywordTok{message}\NormalTok{(}\StringTok{"writing to file "}\NormalTok{, filename, }\StringTok{" ... "}\NormalTok{, }\DataTypeTok{appendLF =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{      out.image <-}\StringTok{ }\KeywordTok{writeRaster}\NormalTok{(out.image, }
                               \DataTypeTok{filename =}\NormalTok{ filename, }
                               \DataTypeTok{overwrite =}\NormalTok{ overwrite, }
                               \DataTypeTok{datatype=}\StringTok{"INT2S"}\NormalTok{, }
                               \DataTypeTok{options=}\KeywordTok{c}\NormalTok{(}\StringTok{"COMPRESS=NONE"}\NormalTok{))}
      \KeywordTok{names}\NormalTok{(out.image) <-}\StringTok{ }\NormalTok{SST.LSBANDS}
\NormalTok{      out.qa <-}\StringTok{ }\KeywordTok{writeRaster}\NormalTok{(out.qa, }
                            \DataTypeTok{filename =} \KeywordTok{sub}\NormalTok{(}\StringTok{"[.]tif$"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"_qa"}\NormalTok{, image.sensor, }\StringTok{".tif"}\NormalTok{), filename), }
                            \DataTypeTok{overwrite =}\NormalTok{ overwrite, }
                            \DataTypeTok{datatype=}\StringTok{"INT2S"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{  \}}
  
  \KeywordTok{message}\NormalTok{(}\StringTok{"done"}\NormalTok{)}
  \KeywordTok{print}\NormalTok{(out.image)}
  
  \CommentTok{# Fermer le fichier journal}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename) }\OperatorTok{&}\StringTok{ }\NormalTok{log}\OperatorTok{==}\OtherTok{TRUE}\NormalTok{) \{}
    \KeywordTok{sink}\NormalTok{(}\DataTypeTok{type=}\StringTok{"output"}\NormalTok{)}
    \KeywordTok{sink}\NormalTok{(}\DataTypeTok{type=}\StringTok{"message"}\NormalTok{)}
\NormalTok{  \}}
  
  \CommentTok{# Retourner l'image de manière invisible}
  \KeywordTok{invisible}\NormalTok{(out.image)}
  
\NormalTok{\}}


\CommentTok{# COMMENCER LE TRAITEMENT #####################################################}
\CommentTok{# Attention, peut facilement remplir le répertoire tmp ! }
\CommentTok{# Peut-être seulement traiter une partie des images et ensuite redémarrer R}

\CommentTok{# Étendue du Togo + 5km de tampon en UTM 30 pour le chemin p194}
\NormalTok{TGO.EXT}\FloatTok{.30}\NormalTok{ <-}\StringTok{ }\KeywordTok{extent}\NormalTok{(}\KeywordTok{spTransform}\NormalTok{(TGO, UTM}\FloatTok{.30}\NormalTok{)) }\OperatorTok{+}\StringTok{ }\DecValTok{10000}

\CommentTok{# Pour chaque ensembles d'images (année/chemin), en parallèle, ...}
\KeywordTok{registerDoParallel}\NormalTok{(CORES}\DecValTok{-1}\NormalTok{)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{i=}\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(in.image.list)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{ }
  
  \CommentTok{# ... extraire la liste des images à traiter}
\NormalTok{  in.image.dirs <-}\StringTok{ }\NormalTok{in.image.list[[i]]}
  
\NormalTok{  name <-}\StringTok{ }\KeywordTok{unlist}\NormalTok{(}\KeywordTok{strsplit}\NormalTok{(}\KeywordTok{names}\NormalTok{(in.image.list[i]), }\StringTok{"[.]"}\NormalTok{))}
\NormalTok{  path <-}\StringTok{ }\NormalTok{name[}\DecValTok{1}\NormalTok{]   }\CommentTok{# p.ex. "p192"}
\NormalTok{  year <-}\StringTok{ }\NormalTok{name[}\DecValTok{2}\NormalTok{]   }\CommentTok{# p.ex. "1986"}
\NormalTok{  tile <-}\StringTok{ }\NormalTok{name[}\DecValTok{3}\NormalTok{]   }\CommentTok{# p.ex. "NA" (ou 1,2, ...)}
  
  \CommentTok{# ... étendue UTM 30 pour chemin p194 et UTM 31 pour les autres}
  \ControlFlowTok{if}\NormalTok{(path }\OperatorTok{==}\StringTok{ "p194"}\NormalTok{) tmp.ext <-}\StringTok{ }\NormalTok{TGO.EXT}\FloatTok{.30} \ControlFlowTok{else}\NormalTok{ tmp.ext <-}\StringTok{ }\NormalTok{TGO.EXT}
  
  \CommentTok{# ... répertoire pour sauvegarder l'image}
\NormalTok{  out.image.dir <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/"}\NormalTok{, path)}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(out.image.dir)) }\KeywordTok{dir.create}\NormalTok{(out.image.dir)}
  
  \CommentTok{# ... nom du fichier}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(tile)) \{}
\NormalTok{    filename <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(out.image.dir, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"_"}\NormalTok{, year, }\StringTok{".tif"}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    filename <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(out.image.dir, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"_"}\NormalTok{, year, }\StringTok{"_"}\NormalTok{, tile, }\StringTok{".tif"}\NormalTok{)}
\NormalTok{  \}}
  
  \CommentTok{# ... et faire le travail}
  \KeywordTok{message}\NormalTok{(}\StringTok{"Processing "}\NormalTok{, path, }\StringTok{"_"}\NormalTok{, year)}
  \KeywordTok{prepare.landsat}\NormalTok{(in.image.dirs, }
                  \DataTypeTok{ext =}\NormalTok{ tmp.ext, }
                  \DataTypeTok{filename =}\NormalTok{ filename, }
                  \DataTypeTok{overwrite=}\OtherTok{FALSE}\NormalTok{, }
                  \DataTypeTok{log=}\OtherTok{TRUE}\NormalTok{)}
  
\NormalTok{\}}

\CommentTok{# Supprimer les fichiers temporaires dans le répertoir tmp}
\NormalTok{tmp_dir <-}\StringTok{ }\KeywordTok{tempdir}\NormalTok{()}
\NormalTok{files <-}\StringTok{ }\KeywordTok{list.files}\NormalTok{(tmp_dir, }\DataTypeTok{full.names =}\NormalTok{ T, }\DataTypeTok{recursive=}\NormalTok{T)}
\KeywordTok{file.remove}\NormalTok{(files)}

\CommentTok{# Fusionner les fichiers journaux }
\ControlFlowTok{for}\NormalTok{(dir }\ControlFlowTok{in} \KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR), }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{)) \{}
\NormalTok{  path <-}\StringTok{ }\KeywordTok{basename}\NormalTok{(dir)}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"tail -n +1 "}\NormalTok{, dir, }\StringTok{"/*.log > "}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, path, }\StringTok{".tmp"}\NormalTok{))}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"rm "}\NormalTok{, dir, }\StringTok{"/*.log"}\NormalTok{))}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"mv "}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, path, }\StringTok{".tmp "}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, path, }\StringTok{".log"}\NormalTok{))}
\NormalTok{\}}


\CommentTok{# Reprojection des images p194 de UTM 30 à UTM 31 =============================}
\NormalTok{p194.dir  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/p194"}\NormalTok{)}

\CommentTok{# Pour chaque image p194, en parallèle, ...}
\KeywordTok{registerDoParallel}\NormalTok{(CORES}\DecValTok{-1}\NormalTok{)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{image=}\KeywordTok{dir}\NormalTok{(p194.dir, }\DataTypeTok{pattern=}\StringTok{".*[.]tif$"}\NormalTok{)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
  
\NormalTok{  image  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(p194.dir,  }\StringTok{"/"}\NormalTok{, image)}
\NormalTok{  image.utm30 <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\StringTok{"[.]tif$"}\NormalTok{, }\StringTok{"utm30.tif"}\NormalTok{, image)}
  \KeywordTok{file.rename}\NormalTok{(image, image.utm30)}
  
  \CommentTok{# ... transformer l'image en utilisant l'outil externe "gdalwarp"}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdalwarp"}\NormalTok{,}
\NormalTok{               image.utm30,}
               \StringTok{"-t_srs '+proj=utm +zone=31 +datum=WGS84'"}\NormalTok{,}
               \StringTok{"-tr 30 30"}\NormalTok{,}
               \StringTok{"-te 147255 1017495 222165 1238265"}\NormalTok{,}
\NormalTok{               image,}
               \StringTok{"-ot 'Int16'"}\NormalTok{,}
               \StringTok{"-overwrite"}\NormalTok{))}
  
  \CommentTok{# ... supprimer l'image UTM 30}
  \KeywordTok{file.remove}\NormalTok{(image.utm30)}
\NormalTok{\}}


\CommentTok{# Masquer images avec bande de qualité (nuages/ombres) ========================}
\KeywordTok{registerDoParallel}\NormalTok{(CORES}\DecValTok{-1}\NormalTok{)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{file=}\KeywordTok{dir}\NormalTok{(OUT.DIR, }\DataTypeTok{pattern=}\StringTok{".*}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_[[:digit:]]+}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif$"}\NormalTok{, }\DataTypeTok{full.names =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
\NormalTok{  qa    <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{dir}\NormalTok{(}\KeywordTok{dirname}\NormalTok{(file), }\DataTypeTok{pattern=}\KeywordTok{gsub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_"}\NormalTok{, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_"}\NormalTok{, }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif"}\NormalTok{, }\StringTok{"_qa*"}\NormalTok{, }\KeywordTok{basename}\NormalTok{(file))), }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{))}
\NormalTok{  image <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{brick}\NormalTok{(file), qa }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(QA.CLOUD, QA.SHADOW, QA.WATER, QA.ICE), }\DataTypeTok{maskvalue=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{writeRaster}\NormalTok{(image, }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif"}\NormalTok{, }\StringTok{"_m.tif"}\NormalTok{, file), }\DataTypeTok{overwrite =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{datatype=}\StringTok{"INT2S"}\NormalTok{, }\DataTypeTok{options=}\KeywordTok{c}\NormalTok{(}\StringTok{"COMPRESS=NONE"}\NormalTok{))}
\NormalTok{\}}


\CommentTok{# Créer des vignettes de chaque image =========================================}
\KeywordTok{registerDoParallel}\NormalTok{(CORES}\DecValTok{-1}\NormalTok{)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{filename=}\KeywordTok{dir}\NormalTok{(OUT.DIR, }\DataTypeTok{pattern=}\StringTok{"p19.*[.]tif$"}\NormalTok{, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
\NormalTok{  image <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(filename)}
  \KeywordTok{jpeg}\NormalTok{(}\KeywordTok{sub}\NormalTok{(}\StringTok{"[.]tif$"}\NormalTok{, }\StringTok{".jpeg"}\NormalTok{, filename), }\DataTypeTok{width=}\DecValTok{1350}\NormalTok{, }\DataTypeTok{height=}\DecValTok{3000}\NormalTok{)}
  \KeywordTok{par}\NormalTok{(}\DataTypeTok{plt=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{))}
  \KeywordTok{plot}\NormalTok{(}\KeywordTok{spTransform}\NormalTok{(TGO, UTM}\FloatTok{.31}\NormalTok{))}
  \KeywordTok{plotRGB}\NormalTok{(image, }\DataTypeTok{r=}\DecValTok{6}\NormalTok{, }\DataTypeTok{g=}\DecValTok{5}\NormalTok{, }\DataTypeTok{b=}\DecValTok{3}\NormalTok{, }\DataTypeTok{stretch=}\StringTok{"lin"}\NormalTok{, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{plot}\NormalTok{(}\KeywordTok{mask}\NormalTok{(image[[}\DecValTok{1}\NormalTok{]], }\KeywordTok{spTransform}\NormalTok{(TGO, UTM}\FloatTok{.31}\NormalTok{), }\DataTypeTok{inverse=}\OtherTok{TRUE}\NormalTok{), }\DataTypeTok{col=}\StringTok{"#FFFFFF66"}\NormalTok{, }\DataTypeTok{legend=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{plot}\NormalTok{(}\KeywordTok{spTransform}\NormalTok{(TGO, UTM}\FloatTok{.31}\NormalTok{), }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{lwd=}\DecValTok{3}\NormalTok{)}
  \KeywordTok{dev.off}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{SSTS-Worldclim}{%
\subsubsection{WorldClim}\label{SSTS-Worldclim}}

Les variables climatiques ont une grande influence sur les caractéristiques des forêts. Ils sont donc importants pour l'évaluation des surfaces forestières et de la biomasse sur la base d'images satellitaires. Les données climatiques de WorldClim version 2 ont servi comme base. \textbf{La température annuelle moyenne (BIO1), la saisonnalité de la température (BIO4), la précipitation annuelle (BIO12) et la saisonnalité de la précipitation (BIO15) étant identifiées comme les variables WorldClim les plus importantes pour l'évaluation des forêts.}

\hypertarget{acquisition-des-donnees}{%
\paragraph{Acquisition des données}\label{acquisition-des-donnees}}

Des données climatiques historiques (1970 -- 2020) avec une résolution de 30 arcsecondes (environ 1 km\textsuperscript{2} sur l'équateur) disponible à \href{https://www.worldclim.org/data/worldclim21.html}{WorldClim version 2} ont été utilisées.

Pour l'analyse, des \textbf{variables climatiques mensuelles} ont été utilisées :

\begin{itemize}
\tightlist
\item
  \textbf{prec}: Précipitations pour les mois de janvier à décembre (mm)
\item
  \textbf{tmax}: Température maximale pour les mois de janvier à décembre (ºC)
\item
  \textbf{tavg}: Température moyenne pour les mois de janvier à décembre (ºC)
\item
  \textbf{tmin}: Température minimale pour les mois de janvier à décembre (ºC)
\end{itemize}

Et également les \textbf{variables bioclimatiques} qui en découlent :

\begin{itemize}
\tightlist
\item
  \textbf{BIO1}: Température moyenne annuelle
\item
  \textbf{BIO2}: Fourchette diurne moyenne (moyenne des températures mensuelles (max temp - min temp))
\item
  \textbf{BIO3}: Isothermie (BIO2/BIO7) (×100)
\item
  \textbf{BIO4}: Saisonnalité de la température (écart-type ×100)
\item
  \textbf{BIO5}: Température maximale du mois le plus chaud
\item
  \textbf{BIO6}: Température minimale du mois le plus froid
\item
  \textbf{BIO7}: Gamme de température annuelle (BIO5-BIO6)
\item
  \textbf{BIO8}: Température moyenne du trimestre le plus humide
\item
  \textbf{BIO9}: Température moyenne du trimestre le plus sec
\item
  \textbf{BIO10}: Température moyenne du trimestre le plus chaud
\item
  \textbf{BIO11}: Température moyenne du trimestre le plus froid
\item
  \textbf{BIO12}: Précipitation annuelle
\item
  \textbf{BIO13}: Précipitation du mois le plus humide
\item
  \textbf{BIO14}: Précipitation du mois le plus sec
\item
  \textbf{BIO15}: Saisonalité de la précipitation (Coefficient de variation)
\item
  \textbf{BIO16}: Précipitation du trimestre le plus humide
\item
  \textbf{BIO17}: Précipitation du trimestre le plus sec
\item
  \textbf{BIO18}: Précipitation du trimestre le plus chaud
\item
  \textbf{BIO19}: Précipitation du trimestre le plus froid
\end{itemize}

\hypertarget{pretraitement-des-donnees}{%
\paragraph{Prétraitement des données}\label{pretraitement-des-donnees}}

Les données sont lues et reprojetées sur le raster des images Landsat (UTM 31, résolution de 30 mètres) et coupées à la taille.

\hypertarget{example-1}{%
\subparagraph{Example}\label{example-1}}
\addcontentsline{toc}{subparagraph}{Example}

\includegraphics[width=0.25\linewidth]{images/wc2.0_30s_bio_Togo-01} \includegraphics[width=0.25\linewidth]{images/wc2.0_30s_bio_Togo-04} \includegraphics[width=0.25\linewidth]{images/wc2.0_30s_bio_Togo-12} \includegraphics[width=0.25\linewidth]{images/wc2.0_30s_bio_Togo-15}
\textbf{Données bioclimatiques WorldClim version 2:} température annuelle moyenne (BIO1) / saisonalité de la température (BIO4) / précipitation annuelle (BIO12) / saisonalité de la précipitation (BIO15)

\hypertarget{script-r-01_ssts01_data_srcprep-worldclim.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-Worldclim.R}}{Script R: 01\_SSTS/01\_data/\_src/prep-Worldclim.R}}\label{script-r-01_ssts01_data_srcprep-worldclim.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-Worldclim.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# prep-Worldclim.R: lire et reprojeter les données de WorldClim}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}

\NormalTok{IN.DIR  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.RAW.DAT, }\StringTok{"/Worldclim"}\NormalTok{)}
\NormalTok{OUT.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.SST.DAT, }\StringTok{"/Worldclim"}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(OUT.DIR)) }\KeywordTok{dir.create}\NormalTok{(OUT.DIR)}


\CommentTok{# Reprojection images WorldClim vers Landsat (résolution 30m, UTM 31, ...) ====}

\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{file=}\KeywordTok{dir}\NormalTok{(IN.DIR, }\DataTypeTok{pattern=}\StringTok{".*Togo[.]tif$"}\NormalTok{)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdalwarp"}\NormalTok{,}
               \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/"}\NormalTok{, file),}
               \StringTok{"-t_srs '+proj=utm +zone=31 +datum=WGS84'"}\NormalTok{,}
               \StringTok{"-tr 30 30"}\NormalTok{,}
               \KeywordTok{paste}\NormalTok{(}\StringTok{"-te"}\NormalTok{, TGO.EXT}\OperatorTok{@}\NormalTok{xmin, TGO.EXT}\OperatorTok{@}\NormalTok{ymin, TGO.EXT}\OperatorTok{@}\NormalTok{xmax, TGO.EXT}\OperatorTok{@}\NormalTok{ymax),}
               \KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/"}\NormalTok{, file),}
               \StringTok{"-dstnodata -3.4e+38"}\NormalTok{,}
               \StringTok{"-co COMPRESS='LZW'"}\NormalTok{,}
               \StringTok{"-co INTERLEAVE='BAND'"}\NormalTok{,}
               \StringTok{"-overwrite"}\NormalTok{))}
  
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdalinfo -stats"}\NormalTok{,}
               \KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/"}\NormalTok{, file)))}
\NormalTok{\}}

\CommentTok{# Créer des vignettes pour les donées WorldClim ===============================}

\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{file=}\KeywordTok{dir}\NormalTok{(OUT.DIR, }\DataTypeTok{pattern=}\StringTok{".*[.]tif$"}\NormalTok{)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
\NormalTok{  image <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/"}\NormalTok{, file))}
\NormalTok{  type <-}\StringTok{ }\KeywordTok{unlist}\NormalTok{(}\KeywordTok{strsplit}\NormalTok{(file, }\StringTok{"_"}\NormalTok{))[}\DecValTok{3}\NormalTok{]}
  \ControlFlowTok{if}\NormalTok{      (type }\OperatorTok{==}\StringTok{ "prec"}\NormalTok{) \{ zlim <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{320}\NormalTok{);     col <-}\StringTok{ }\KeywordTok{rev}\NormalTok{(}\KeywordTok{topo.colors}\NormalTok{(}\DecValTok{255}\NormalTok{)) \}}
  \ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (type }\OperatorTok{==}\StringTok{ "tmin"}\NormalTok{) \{ zlim <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\FloatTok{14.0}\NormalTok{,}\FloatTok{27.8}\NormalTok{); col <-}\StringTok{ }\KeywordTok{rev}\NormalTok{(}\KeywordTok{heat.colors}\NormalTok{(}\DecValTok{255}\NormalTok{)) \}}
  \ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (type }\OperatorTok{==}\StringTok{ "tmax"}\NormalTok{) \{ zlim <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\FloatTok{24.9}\NormalTok{,}\FloatTok{37.5}\NormalTok{); col <-}\StringTok{ }\KeywordTok{rev}\NormalTok{(}\KeywordTok{heat.colors}\NormalTok{(}\DecValTok{255}\NormalTok{)) \}}
  \ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (type }\OperatorTok{==}\StringTok{ "tavg"}\NormalTok{) \{ zlim <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\FloatTok{19.7}\NormalTok{,}\FloatTok{32.7}\NormalTok{); col <-}\StringTok{ }\KeywordTok{rev}\NormalTok{(}\KeywordTok{heat.colors}\NormalTok{(}\DecValTok{255}\NormalTok{)) \}}
  \ControlFlowTok{else}\NormalTok{                     \{ zlim <-}\StringTok{ }\OtherTok{NA}\NormalTok{;           col <-}\StringTok{ }\KeywordTok{rev}\NormalTok{(}\KeywordTok{cm.colors}\NormalTok{(}\DecValTok{255}\NormalTok{)) \}}
  \KeywordTok{foreach}\NormalTok{(}\DataTypeTok{i=}\DecValTok{1}\OperatorTok{:}\KeywordTok{nlayers}\NormalTok{(image)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
    \KeywordTok{jpeg}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/"}\NormalTok{, }\KeywordTok{sub}\NormalTok{(}\StringTok{"[.]tif$"}\NormalTok{, }\StringTok{""}\NormalTok{, file), }\StringTok{"-"}\NormalTok{, }\KeywordTok{str_pad}\NormalTok{(i, }\DecValTok{2}\NormalTok{, }\StringTok{"left"}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{".jpeg"}\NormalTok{), }
         \DataTypeTok{width=}\DecValTok{1350}\NormalTok{, }\DataTypeTok{height=}\DecValTok{3000}\NormalTok{)}
    \KeywordTok{plot}\NormalTok{(image[[i]], }\DataTypeTok{col=}\NormalTok{col, }\DataTypeTok{zlim=}\NormalTok{zlim)}
    \KeywordTok{plot}\NormalTok{(}\KeywordTok{mask}\NormalTok{(image[[i]], TGO, }\DataTypeTok{inverse=}\OtherTok{TRUE}\NormalTok{), }\DataTypeTok{col=}\StringTok{"#FFFFFF66"}\NormalTok{, }\DataTypeTok{legend=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{)}
    \KeywordTok{plot}\NormalTok{(TGO, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{lwd=}\DecValTok{3}\NormalTok{)}
    \KeywordTok{dev.off}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{srtm}{%
\subsubsection{SRTM}\label{srtm}}

Les variables topographiques telles que \textbf{l'élévation, la pente et l'aspect ne sont actuellement utilisées ni pour l'évaluation des forestières ni pour l'évaluation de la biomasse}, car il a été constaté que ces variables ont peu d'influence sur le pouvoir explicatif des modèles de classification ou de régression. Néanmoins, les données sont conservées et disponibles pour autres analyses.

\hypertarget{acquisition-des-donnees-1}{%
\paragraph{Acquisition des données}\label{acquisition-des-donnees-1}}

Les données topographiques du SRTM ont été obtenues à partir de deux sources:

\begin{itemize}
\item
  \textbf{Les données originales avec une résolution spatiale de 1 seconde d'arc} (environ 30 mètres sur l'équateur) ont été obtenues du jeu de données \texttt{SRTM\ 1\ Arc-Second\ Global} disponible sur \href{https://earthexplorer.usgs.gov/}{USGS Earthexplorer}. Ces données à haute résolution ont des fois des lacunes (manque des données).
\item
  \textbf{Les données SRTM ajustées avec une résolution de 3 secondes d'arc} ont été obtenues à partir de \href{http://srtm.csi.cgiar.org/srtmdata/}{CGIAR SRTM 90m Digital Elevation Database v4.1} pour combler les lacunes des données à haute résolution.
\end{itemize}

\hypertarget{pretraitement-des-donnees-1}{%
\paragraph{Prétraitement des données}\label{pretraitement-des-donnees-1}}

Les données de 1 seconde d'arc sont lues et les lacunes éventuelles sont comblées avec les données ajustées de 3 secondes d'arc. Enfin, les données sont reprojetées sur le raster des images Landsat (UTM 31, résolution de 30 mètres) et coupées à la taille.

\includegraphics{images/SRTM-1arcsec.jpeg}

\hypertarget{script-r-01_ssts01_data_srcprep-srtm.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-SRTM.R}}{Script R: 01\_SSTS/01\_data/\_src/prep-SRTM.R}}\label{script-r-01_ssts01_data_srcprep-srtm.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-SRTM.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# prep-SRTM.R: lire, nettoyer et empiler des données topographiques SRTM}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}
\NormalTok{IN.DIR  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.RAW.DAT, }\StringTok{"/SRTM"}\NormalTok{)}
\NormalTok{OUT.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.SST.DAT, }\StringTok{"/SRTM"}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(OUT.DIR)) }\KeywordTok{dir.create}\NormalTok{(OUT.DIR)}


\CommentTok{# Préparation du modèle numérique d'élévation SRTM ============================}

\CommentTok{# Lire 90m SRTM MNE sans vides (source: http://srtm.csi.cgiar.org/srtmdata/),}
\NormalTok{dem}\FloatTok{.90}\NormalTok{ <-}\StringTok{ }\KeywordTok{do.call}\NormalTok{(merge, }\KeywordTok{lapply}\NormalTok{(}\KeywordTok{as.list}\NormalTok{(}\KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/3arcsecond"}\NormalTok{), }
                                            \DataTypeTok{pattern=}\StringTok{".*[.]tif$"}\NormalTok{, }
                                            \DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{)), raster))}


\CommentTok{# Lire 30m SRTM MNE (source: USGS Earthexplorer) et remplir vides avec 90m SRTM }
\NormalTok{dem}\FloatTok{.30}\NormalTok{ <-}\StringTok{ }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{tile=}\KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/1arcsecond"}\NormalTok{), }\DataTypeTok{pattern=}\StringTok{".*[.]tif$"}\NormalTok{, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{),}
                  \DataTypeTok{.combine=}\NormalTok{merge, }\DataTypeTok{.multicombine=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
\NormalTok{                    dem.}\FloatTok{30.}\NormalTok{t <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(tile)}
\NormalTok{                    dem.}\FloatTok{90.}\NormalTok{t <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\KeywordTok{projectRaster}\NormalTok{(dem}\FloatTok{.90}\NormalTok{, dem.}\FloatTok{30.}\NormalTok{t))}
                    \KeywordTok{merge}\NormalTok{(dem.}\FloatTok{30.}\NormalTok{t, dem.}\FloatTok{90.}\NormalTok{t)}
\NormalTok{                  \}}

\CommentTok{# Reprojection d'images MNE vers Landsat (résolution 30m, UTM 31, ...) }
\KeywordTok{writeRaster}\NormalTok{(dem}\FloatTok{.30}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/SRTM-1arcsec_raw.tif"}\NormalTok{), }
            \DataTypeTok{datatype=}\StringTok{"INT2S"}\NormalTok{, }
            \DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdalwarp"}\NormalTok{,}
             \KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/SRTM-1arcsec_raw.tif"}\NormalTok{),}
             \StringTok{"-t_srs '+proj=utm +zone=31 +datum=WGS84'"}\NormalTok{,}
             \StringTok{"-tr 30 30"}\NormalTok{,}
             \KeywordTok{paste}\NormalTok{(}\StringTok{"-te"}\NormalTok{, TGO.EXT}\OperatorTok{@}\NormalTok{xmin, TGO.EXT}\OperatorTok{@}\NormalTok{ymin, TGO.EXT}\OperatorTok{@}\NormalTok{xmax, TGO.EXT}\OperatorTok{@}\NormalTok{ymax),}
             \KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/SRTM-1arcsec.tif"}\NormalTok{),}
             \StringTok{"-ot 'Int16'"}\NormalTok{,}
             \StringTok{"-co COMPRESS='LZW'"}\NormalTok{,}
             \StringTok{"-co INTERLEAVE='BAND'"}\NormalTok{,}
             \StringTok{"-overwrite"}\NormalTok{))}
\KeywordTok{file.remove}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/SRTM-1arcsec_raw.tif"}\NormalTok{))}

\CommentTok{# Calculer les statistiques GDAL (min, max, ...)}
\KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdalinfo -stats"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/SRTM-1arcsec.tif"}\NormalTok{)))}


\CommentTok{# Créer une vignettes du MNE ==================================================}
\NormalTok{dem <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/SRTM-1arcsec.tif"}\NormalTok{))}
\KeywordTok{jpeg}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/SRTM-1arcsec.jpeg"}\NormalTok{), }\DataTypeTok{width=}\DecValTok{1350}\NormalTok{, }\DataTypeTok{height=}\DecValTok{3000}\NormalTok{)}
\KeywordTok{par}\NormalTok{(}\DataTypeTok{plt=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(dem)}
\KeywordTok{plot}\NormalTok{(}\KeywordTok{mask}\NormalTok{(dem, TGO, }\DataTypeTok{inverse=}\OtherTok{TRUE}\NormalTok{), }\DataTypeTok{col=}\StringTok{"#FFFFFF66"}\NormalTok{, }\DataTypeTok{legend=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{plot}\NormalTok{(TGO, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{lwd=}\DecValTok{3}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{soilgrids}{%
\subsubsection{SoilGrids}\label{soilgrids}}

\textbf{Les données SoilGrids sur le type de sol et le carbone du sol n'ont pas encore été incluses dans les analyses} de la surface forestière et des modifications du stockage du carbone dues au changement d'utilisation des terres. Ils sont disponibles pour des analyses complémentaires.

\hypertarget{acquisition-des-donnees-2}{%
\paragraph{Acquisition des données}\label{acquisition-des-donnees-2}}

Les données sur les sols proviennent des \href{https://files.isric.org/soilgrids/data/recent/}{archives SoilGrids} (documentation \href{https://www.isric.org/explore/soilgrids/faq-soilgrids-2017}{SoilGrids 2017})

\hypertarget{pretraitement-des-donnees-2}{%
\paragraph{Prétraitement des données}\label{pretraitement-des-donnees-2}}

Les données sont lues et reprojetées sur le raster des images Landsat (UTM 31, résolution de 30 mètres) et coupées à la taille.

\hypertarget{example-2}{%
\subparagraph{Example}\label{example-2}}
\addcontentsline{toc}{subparagraph}{Example}

\textbf{Données pédologiques SoilGrids:} Typologie des sols WRB à gauche, Carbone du sol à 30 cm de profondeur (tC/ha) à droite

\includegraphics[width=0.5\linewidth]{images/TAXNWRB_250m_ll} \includegraphics[width=0.5\linewidth]{images/OCSTHA_M_30cm_250m_ll}

\hypertarget{script-r-01_ssts01_data_srcprep-soilgrids.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-SoilGrids.R}}{Script R: 01\_SSTS/01\_data/\_src/prep-SoilGrids.R}}\label{script-r-01_ssts01_data_srcprep-soilgrids.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-SoilGrids.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# prep-SoilGrids.R: lire et reprojeter des données SoilGrids}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Source des données: https://files.isric.org/soilgrids/data/recent/}
\CommentTok{# Documentation: https://www.isric.org/explore/soilgrids/faq-soilgrids-2017}

\CommentTok{# Définitions des variables ===================================================}

\NormalTok{IN.DIR  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.RAW.DAT, }\StringTok{"/SoilGrids"}\NormalTok{)}
\NormalTok{OUT.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.SST.DAT, }\StringTok{"/SoilGrids"}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(OUT.DIR)) }\KeywordTok{dir.create}\NormalTok{(OUT.DIR)}

\CommentTok{# Reprojection oilGrids vers Landsat (résolution 30m, UTM 31, ...) ============}

\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{file=}\KeywordTok{dir}\NormalTok{(IN.DIR, }\DataTypeTok{pattern=}\StringTok{".*[.]tif$"}\NormalTok{)) }\OperatorTok{%do%}\StringTok{ }\NormalTok{\{}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdalwarp"}\NormalTok{,}
               \KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/"}\NormalTok{, file),}
               \StringTok{"-t_srs '+proj=utm +zone=31 +datum=WGS84'"}\NormalTok{,}
               \StringTok{"-tr 30 30"}\NormalTok{,}
               \KeywordTok{paste}\NormalTok{(}\StringTok{"-te"}\NormalTok{, TGO.EXT}\OperatorTok{@}\NormalTok{xmin, TGO.EXT}\OperatorTok{@}\NormalTok{ymin, TGO.EXT}\OperatorTok{@}\NormalTok{xmax, TGO.EXT}\OperatorTok{@}\NormalTok{ymax),}
               \KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/"}\NormalTok{, file),}
               \StringTok{"-dstnodata -3.4e+38"}\NormalTok{,}
               \StringTok{"-co COMPRESS='LZW'"}\NormalTok{,}
               \StringTok{"-co INTERLEAVE='BAND'"}\NormalTok{,}
               \StringTok{"-overwrite"}\NormalTok{))}
  
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdalinfo -stats"}\NormalTok{,}
               \KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/"}\NormalTok{, file)))}
\NormalTok{\}}


\CommentTok{# Créer des vignettes pour les donées SoilGrids ===============================}

\CommentTok{# Types de sol WRB ------------------------------}
\KeywordTok{jpeg}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/TAXNWRB_250m_ll.jpeg"}\NormalTok{), }\DataTypeTok{width=}\DecValTok{675}\NormalTok{, }\DataTypeTok{height=}\DecValTok{1200}\NormalTok{)}
\NormalTok{soil.types <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/TAXNWRB_250m_ll.tif"}\NormalTok{))}
\NormalTok{soil.types <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(soil.types)}
\NormalTok{cats <-}\StringTok{ }\KeywordTok{levels}\NormalTok{(soil.types)[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{attr <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/TAXNWRB_250m_ll.tif.csv"}\NormalTok{))}
\NormalTok{attr <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(cats, attr[,}\KeywordTok{c}\NormalTok{(}\StringTok{"Number"}\NormalTok{, }\StringTok{"Group"}\NormalTok{, }\StringTok{"WRB_group"}\NormalTok{, }\StringTok{"R"}\NormalTok{, }\StringTok{"G"}\NormalTok{, }\StringTok{"B"}\NormalTok{)], }
              \DataTypeTok{by.x =} \StringTok{"ID"}\NormalTok{, }\DataTypeTok{by.y =} \StringTok{"Number"}\NormalTok{)}
\NormalTok{cats[[}\StringTok{"Soil Type"}\NormalTok{]] <-}\StringTok{ }\NormalTok{attr}\OperatorTok{$}\NormalTok{Group}
\KeywordTok{levels}\NormalTok{(soil.types) <-}\StringTok{ }\NormalTok{cats}
\KeywordTok{levelplot}\NormalTok{(soil.types, }
          \DataTypeTok{col.regions=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"#"}\NormalTok{, }\KeywordTok{as.hexmode}\NormalTok{(tmp}\OperatorTok{$}\NormalTok{R),}\KeywordTok{as.hexmode}\NormalTok{(tmp}\OperatorTok{$}\NormalTok{G),}\KeywordTok{as.hexmode}\NormalTok{(tmp}\OperatorTok{$}\NormalTok{B)), }
          \DataTypeTok{xlab=}\StringTok{""}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{""}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{levelplot}\NormalTok{(}\KeywordTok{mask}\NormalTok{(soil.types, TGO, }\DataTypeTok{inverse=}\OtherTok{TRUE}\NormalTok{), }\DataTypeTok{col.regions=}\StringTok{"#FFFFFF66"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{layer}\NormalTok{(}\KeywordTok{sp.polygons}\NormalTok{(TGO, }\DataTypeTok{lwd=}\DecValTok{3}\NormalTok{))}
\KeywordTok{dev.off}\NormalTok{()}

\CommentTok{# Réservoire carbone à 30 cm --------------------}
\KeywordTok{jpeg}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/OCSTHA_M_30cm_250m_ll.jpeg"}\NormalTok{), }\DataTypeTok{width=}\DecValTok{675}\NormalTok{, }\DataTypeTok{height=}\DecValTok{1200}\NormalTok{)}
\NormalTok{image <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/OCSTHA_M_30cm_250m_ll.tif"}\NormalTok{))}
\NormalTok{raster}\OperatorTok{::}\KeywordTok{plot}\NormalTok{(image, }\DataTypeTok{zlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{,}\DecValTok{100}\NormalTok{))}
\NormalTok{raster}\OperatorTok{::}\KeywordTok{plot}\NormalTok{(}\KeywordTok{mask}\NormalTok{(image, TGO, }\DataTypeTok{inverse=}\OtherTok{TRUE}\NormalTok{), }\DataTypeTok{col=}\StringTok{"#FFFFFF66"}\NormalTok{, }\DataTypeTok{legend=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{sp}\OperatorTok{::}\KeywordTok{plot}\NormalTok{(TGO, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{lwd=}\DecValTok{3}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}


\CommentTok{# Tableau des surfaces des catégories de sol selon GIEC  ======================}
\NormalTok{tmp <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(}\KeywordTok{mask}\NormalTok{(soil.types, TGO)[]) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{)}
\NormalTok{tmp <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(tmp, attr, }\DataTypeTok{by.x=}\StringTok{"Var1"}\NormalTok{, }\DataTypeTok{by.y=}\StringTok{"ID"}\NormalTok{)}
\NormalTok{tmp}\OperatorTok{$}\NormalTok{IPCC <-}\StringTok{ }\OtherTok{NA}
\NormalTok{tmp}\OperatorTok{$}\NormalTok{IPCC[tmp}\OperatorTok{$}\NormalTok{WRB_group }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Leptosols"}\NormalTok{,}\StringTok{"Vertisols"}\NormalTok{,}\StringTok{"Kastanozems"}\NormalTok{,}\StringTok{"Chernozems"}\NormalTok{,}
                              \StringTok{"Phaeozems"}\NormalTok{,}\StringTok{"Luvisols"}\NormalTok{,}\StringTok{"Alisols"}\NormalTok{,}\StringTok{"Albeluvisols"}\NormalTok{,}
                              \StringTok{"Solonetz"}\NormalTok{,}\StringTok{"Calcisols"}\NormalTok{,}\StringTok{"Gypsisols"}\NormalTok{,}\StringTok{"Umbrisols"}\NormalTok{,}
                              \StringTok{"Cambisols"}\NormalTok{,}\StringTok{"Regosols"}\NormalTok{)] <-}\StringTok{ "HAC"}
\NormalTok{tmp}\OperatorTok{$}\NormalTok{IPCC[tmp}\OperatorTok{$}\NormalTok{WRB_group }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Acrisols"}\NormalTok{,}\StringTok{"Lixisols"}\NormalTok{,}\StringTok{"Nitisols"}\NormalTok{,}\StringTok{"Ferralsols"}\NormalTok{,}
                              \StringTok{"Durisols"}\NormalTok{)] <-}\StringTok{ "LAC"}
\NormalTok{tmp}\OperatorTok{$}\NormalTok{IPCC[tmp}\OperatorTok{$}\NormalTok{WRB_group }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Arenosols"}\NormalTok{)] <-}\StringTok{ "SAN"}
\NormalTok{tmp}\OperatorTok{$}\NormalTok{IPCC[tmp}\OperatorTok{$}\NormalTok{WRB_group }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Podzols"}\NormalTok{)] <-}\StringTok{ "POD"}
\NormalTok{tmp}\OperatorTok{$}\NormalTok{IPCC[tmp}\OperatorTok{$}\NormalTok{WRB_group }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Andosols"}\NormalTok{)] <-}\StringTok{ "VOL"}
\NormalTok{tmp}\OperatorTok{$}\NormalTok{IPCC[tmp}\OperatorTok{$}\NormalTok{WRB_group }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Gleysols"}\NormalTok{)] <-}\StringTok{ "WET"}
\NormalTok{tmp}\OperatorTok{$}\NormalTok{IPCC[}\KeywordTok{is.na}\NormalTok{(tmp}\OperatorTok{$}\NormalTok{WRB_group)] <-}\StringTok{ "Other"}
\end{Highlighting}
\end{Shaded}

\hypertarget{proredd}{%
\subsubsection{ProREDD}\label{proredd}}

Dans le cadre du premier inventaire forestier national de 2015/16, le projet GIZ ``ProREDD'' a réalisé une \textbf{carte d'occupation des sols à partir d'images RapidEye des années 2013/14} (\href{../01_SSTS/01_data/ProREDD/docs/Carte-RapidEye_final-report_2016.pdf}{Rapport méthodes et résultats}).

La carte n'est pas utilisée pour l'analyse de l'évolution des surfaces forestières dans le cadre du NRF-MRV REDD+, mais elle est disponible comme carte comparative et pour d'autres analyses.

\hypertarget{acquisition-des-donnees-3}{%
\paragraph{Acquisition des données}\label{acquisition-des-donnees-3}}

Les cartes pour les différentes régions ont été fournies par L'Unité de gestion de bases de données cartographiques (UGBDC) de la Direction des études et de la planification (DEP) le ministère sous forme de Shapefiles.

\hypertarget{pretraitement-des-donnees-3}{%
\paragraph{Prétraitement des données}\label{pretraitement-des-donnees-3}}

Les shapefiles sont lus et convertis avec l'outil ``grid\_gridding'' de \href{http://www.saga-gis.org/en/index.html}{SAGA GIS} en données raster avec résolution originale des images RapidEye de 5 mètres, puis reprojetés sur le raster Landsat de 30 mètres.

\hypertarget{example-3}{%
\subparagraph{Example}\label{example-3}}
\addcontentsline{toc}{subparagraph}{Example}

\includegraphics{images/SSTS-ProREDD.png}

\hypertarget{script-r-01_ssts01_data_srcprep-proredd.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-ProREDD.R}}{Script R: 01\_SSTS/01\_data/\_src/prep-ProREDD.R}}\label{script-r-01_ssts01_data_srcprep-proredd.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{01\_SSTS/01\_data/\_src/prep-ProREDD.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# prep-ProREDD.R: rasterizer la carte d'occupation des terres RapidEye}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}

\NormalTok{IN.DIR  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.RAW.DAT, }\StringTok{"/RapidEye/shapefiles"}\NormalTok{)}
\NormalTok{OUT.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.SST.DAT, }\StringTok{"/ProREDD"}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(OUT.DIR)) }\KeywordTok{dir.create}\NormalTok{(OUT.DIR)}

\CommentTok{# Rasterizer Shapefiles avec l'outil grid_gridding de SAGA ====================}

\NormalTok{files <-}\StringTok{ }\KeywordTok{dir}\NormalTok{(IN.DIR, }\DataTypeTok{pattern=}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.shp$"}\NormalTok{, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{registerDoParallel}\NormalTok{(CORES }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{file=}\NormalTok{files) }\OperatorTok{%dopar%}\NormalTok{\{}
\NormalTok{  out.file <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\StringTok{"shp$"}\NormalTok{, }\StringTok{"sdat"}\NormalTok{, file)}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"saga_cmd grid_gridding }\CharTok{\textbackslash{}"}\StringTok{Shapes to Grid}\CharTok{\textbackslash{}"}\StringTok{ "}\NormalTok{,}
                \StringTok{"-TARGET_DEFINITION 0 -INPUT }\CharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, file, }\StringTok{"}\CharTok{\textbackslash{}"}\StringTok{ "}\NormalTok{,}
                \StringTok{"-FIELD }\CharTok{\textbackslash{}"}\StringTok{code}\CharTok{\textbackslash{}"}\StringTok{ -OUTPUT 2 -MULTIPLE 0 -LINE_TYPE 0 "}\NormalTok{,}
                \StringTok{"-POLY_TYPE 0 -GRID_TYPE 2 -TARGET_USER_SIZE 30.0 "}\NormalTok{,}
                \StringTok{"-TARGET_USER_FITS 0 -GRID }\CharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, out.file, }\StringTok{"}\CharTok{\textbackslash{}"}\StringTok{"}\NormalTok{))}
\NormalTok{\}}

\CommentTok{# Lire et fusionner les différentes scènes raster}
\NormalTok{scenes <-}\StringTok{ }\KeywordTok{lapply}\NormalTok{(}\KeywordTok{dir}\NormalTok{(IN.DIR, }\DataTypeTok{pattern=}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.sdat$"}\NormalTok{, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{), raster)}
\NormalTok{scenes[}\StringTok{"tolerance"}\NormalTok{] <-}\StringTok{ }\FloatTok{0.4}
\NormalTok{RE <-}\StringTok{ }\KeywordTok{do.call}\NormalTok{(merge, scenes)}

\CommentTok{# À reviser: Reprojection sur l'image Landsat}
\NormalTok{AGB <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\StringTok{"../output/3_forest-biomass/2_ref-maps/TGO_2015_AGB.tif"}\NormalTok{)}
\NormalTok{RE_resampled <-}\StringTok{ }\KeywordTok{resample}\NormalTok{(RE, AGB, }\DataTypeTok{method=}\StringTok{"ngb"}\NormalTok{)}
\KeywordTok{writeRaster}\NormalTok{(RE_resampled, }\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/TGO_30m.tif"}\NormalTok{), }\DataTypeTok{datatype=}\StringTok{"INT2S"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{SSTS-collecte}{%
\subsection{Collecte des données}\label{SSTS-collecte}}

\hypertarget{reseau-dechantillonnage}{%
\subsubsection{Réseau d'échantillonnage}\label{reseau-dechantillonnage}}

Les parcelles d'échantillonage couvrent une surface de 30 x 30 mètres et \textbf{correspondent en taille, forme et position aux pixels des images Landsat}. Les parcelles d'échantillonnage sont régulièrement réparties sur le territoire du Togo, sur une grille d'une taille de maille de 480 mètres (tous les 16 pixels Landsat) ou 4,3 parcelles d'échantillonnage par km\textsuperscript{2}. Sur l'ensemble du territoire togolais, cela donne un réseau de 250 000 parcelles.

Si nécessaire pour autres utilisation, la taille de maille de 480 mètres permet d'enlargir la maille à 679 ou 960 mètres. D'autre part, il est également possible de comprimer la maille à 340, 240, 170, 120, 85, \ldots{} mètres.

\includegraphics{images/SSTS-sampling-grid.png}

La grille d'échantillonnage est basée sur l'étendue du Togo (alignée avec la grille Landsat) et la taille du maillage. Les points d'échantillonnage résultants sont attribués avec les coordonnées x et y et l'ID correspondant. La grille de points résultante est enregistrée sous forme de shapefile (\href{..//01_SSTS/02_BdD/01_reseau-SSTS/TGO_frame_480.zip}{télécharger archive ZIP}).

\hypertarget{script-r-01_ssts02_bdd_srccreate-grid.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{01\_SSTS/02\_BdD/\_src/create-grid.R}}{Script R: 01\_SSTS/02\_BdD/\_src/create-grid.R}}\label{script-r-01_ssts02_bdd_srccreate-grid.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{01\_SSTS/02\_BdD/\_src/create-grid.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# create-grid.R: créer une grille de points d'observation SSTS}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}

\NormalTok{OUT.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.SST.BDD, }\StringTok{"/01_reseau-SSTS"}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(OUT.DIR)) }\KeywordTok{dir.create}\NormalTok{(OUT.DIR)}

\NormalTok{RES <-}\StringTok{ }\DecValTok{480}   \CommentTok{# Résolution de la grille (mètres)}

\CommentTok{# Grille d'observation ========================================================}

\CommentTok{# Coordonnées min/max en ligne avec images Landsat}
\NormalTok{x.min <-}\StringTok{ }\NormalTok{RES }\OperatorTok{*}\StringTok{ }\KeywordTok{extent}\NormalTok{(TGO)}\OperatorTok{@}\NormalTok{xmin }\OperatorTok{%/%}\StringTok{ }\NormalTok{RES}
\NormalTok{x.max <-}\StringTok{ }\NormalTok{RES }\OperatorTok{*}\StringTok{ }\KeywordTok{extent}\NormalTok{(TGO)}\OperatorTok{@}\NormalTok{xmax }\OperatorTok{%/%}\StringTok{ }\NormalTok{RES}
\NormalTok{y.min <-}\StringTok{ }\NormalTok{RES }\OperatorTok{*}\StringTok{ }\KeywordTok{extent}\NormalTok{(TGO)}\OperatorTok{@}\NormalTok{ymin }\OperatorTok{%/%}\StringTok{ }\NormalTok{RES}
\NormalTok{y.max <-}\StringTok{ }\NormalTok{RES }\OperatorTok{*}\StringTok{ }\KeywordTok{extent}\NormalTok{(TGO)}\OperatorTok{@}\NormalTok{ymax }\OperatorTok{%/%}\StringTok{ }\NormalTok{RES}

\CommentTok{# Creation de la grille}
\NormalTok{frame.points <-}\StringTok{ }\KeywordTok{SpatialPoints}\NormalTok{(}\KeywordTok{expand.grid}\NormalTok{(}\KeywordTok{seq}\NormalTok{(x.min, x.max, }\DataTypeTok{by=}\NormalTok{RES), }
                                          \KeywordTok{seq}\NormalTok{(y.min, y.max, }\DataTypeTok{by=}\NormalTok{RES)), }
                              \DataTypeTok{proj4string=}\NormalTok{UTM}\FloatTok{.31}\NormalTok{)[TGO]}

\CommentTok{# Ajouter attribues PLOTID, xcoords et ycoords}
\NormalTok{frame.points}\OperatorTok{$}\NormalTok{xcoords <-}\StringTok{ }\NormalTok{frame.points}\OperatorTok{@}\NormalTok{coords[,}\DecValTok{1}\NormalTok{]}
\NormalTok{frame.points}\OperatorTok{$}\NormalTok{ycoords <-}\StringTok{ }\NormalTok{frame.points}\OperatorTok{@}\NormalTok{coords[,}\DecValTok{2}\NormalTok{]}
\NormalTok{frame.points}\OperatorTok{$}\NormalTok{PLOTID  <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\KeywordTok{str_pad}\NormalTok{(frame.points}\OperatorTok{@}\NormalTok{xcoords, }\DecValTok{7}\NormalTok{, }\StringTok{"left"}\NormalTok{, }\StringTok{"0"}\NormalTok{), }\StringTok{"_"}\NormalTok{, }
                               \KeywordTok{str_pad}\NormalTok{(frame.points}\OperatorTok{@}\NormalTok{ycoords, }\DecValTok{7}\NormalTok{, }\StringTok{"left"}\NormalTok{, }\StringTok{"0"}\NormalTok{))}

\CommentTok{# Sauveguarder comme fichier Shapefile}
\KeywordTok{writeOGR}\NormalTok{(frame.points, }\DataTypeTok{dsn=}\NormalTok{OUT.DIR, }\DataTypeTok{layer=}\StringTok{"TGO_frame_480m"}\NormalTok{, }
         \DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{SSTS-training-plots}{%
\subsubsection{Parcelles d'entraînement}\label{SSTS-training-plots}}

\hypertarget{echantillonnage}{%
\paragraph{Échantillonnage}\label{echantillonnage}}

Les parcelles d'entraînement sont sélectionnées de manière à couvrir la plus large gamme possible de couverture végétale sur l'ensemble du territoire du Togo. À cette fin, le \textbf{NDVI comme indicateur du couvert végétal} est attribué à tout les points du réseau d'échantillonnage et stratifiées en 10 classes NDVI. Un échantillon aléatoire spatialement équilibré de 1 500 échantillons est ensuite tiré de chaque strate NDVI (generalized random tesselation).

\hypertarget{SSTS-couverture-houppiers}{%
\paragraph{Couverture des houppiers}\label{SSTS-couverture-houppiers}}

Pour détérminer la couverture des houppiers une \textbf{grille de 7 x 7 points} est définit à l'intérieur de chaque parcelles d'échantillonage. Pour chaque point de ce grille, les photo-interprètes détérminent sur base des images de très haute résolution disponible en GoogleEarth, si \textbf{le point touche l'houppier d'un arbre ou non}. La couverture des houppiers est en suite détérminé par le nombre des points qui tombent sur un arbre par rapport au nombre total des points (n = 49).

\includegraphics{images/SSTS-tree-cover.png}

L'attribution est fait par les photo-interprètes en QGIS, avec l'image GoogleEarth comme carte de base. La source et la date d'acquistion de l'image GoogleEarth utilisé est également enregistré. Elle est obtenu par GoogleEarth Pro (plugin QGIS \href{https://plugins.qgis.org/plugins/send2google_earth/}{\texttt{send2google\_earth}}).

\hypertarget{script-r-01_ssts02_bdd_srccreate-train-plots.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{01\_SSTS/02\_BdD/\_src/create-train-plots.R}}{Script R: 01\_SSTS/02\_BdD/\_src/create-train-plots.R}}\label{script-r-01_ssts02_bdd_srccreate-train-plots.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{01\_SSTS/02\_BdD/\_src/create-train-plots.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# create-train-plots.R: Créer un ensemble de parcelles d'entraînement}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Préparation des variables ===================================================}

\NormalTok{OUT.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.SST.BDD, }\StringTok{"/02_train-plots/empty"}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(OUT.DIR)) }\KeywordTok{dir.create}\NormalTok{(OUT.DIR, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# Charger la grille d'échantillonnage du SSTS}
\NormalTok{frame.points <-}\StringTok{ }\KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.SST.BDD, }\StringTok{"/01_reseau-SSTS/TGO_frame_480m.shp"}\NormalTok{))}

\CommentTok{# Charger NDVI 2018 masquée (sans nuages, ombre, ...)}
\NormalTok{ndvi.band <-}\StringTok{ }\KeywordTok{which}\NormalTok{(SST.LSBANDS }\OperatorTok{==}\StringTok{ "ndvi"}\NormalTok{)}
\NormalTok{ndvi <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(}\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.SST.DAT, }\StringTok{"/Landsat/p192/p192_2018_m.tif"}\NormalTok{), }\DataTypeTok{band=}\NormalTok{ndvi.band), }
              \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.SST.DAT, }\StringTok{"/Landsat/p193/p193_2018_m.tif"}\NormalTok{), }\DataTypeTok{band=}\NormalTok{ndvi.band),}
              \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.SST.DAT, }\StringTok{"/Landsat/p194/p194_2018_m.tif"}\NormalTok{), }\DataTypeTok{band=}\NormalTok{ndvi.band))}
  
\CommentTok{# Extraire le NDVI pour chaque parcelle et le découper en 10 strates}
\NormalTok{frame.points}\OperatorTok{$}\NormalTok{ndvi   <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(ndvi, frame.points)}
\NormalTok{frame.points}\OperatorTok{$}\NormalTok{ndvi_c <-}\StringTok{ }\KeywordTok{cut}\NormalTok{(frame.points}\OperatorTok{$}\NormalTok{ndvi, }\DecValTok{10}\NormalTok{, }\DataTypeTok{labels=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"s"}\NormalTok{, }\DecValTok{0}\OperatorTok{:}\DecValTok{9}\NormalTok{))}


\CommentTok{# Echantillonnage des parcelles d'entraînement ================================}

\CommentTok{# Initialiser le générateur de nombres aléatoires}
\KeywordTok{set.seed}\NormalTok{(RSEED)}

\CommentTok{# Définition d'échantillonnage (1500 échantillons par strate NDVI s0 - s9)}
\NormalTok{Dsgn.grt <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\StringTok{"s0"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s1"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s2"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s3"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s4"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s5"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s6"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s7"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s8"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{),}
                 \StringTok{"s9"}\NormalTok{=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{panel=}\KeywordTok{c}\NormalTok{(}\DataTypeTok{PanelOne=}\DecValTok{1500}\NormalTok{), }\DataTypeTok{seltype=}\StringTok{"Equal"}\NormalTok{)}
\NormalTok{)}

\CommentTok{# Échantillonnage spatialement équilibrée (Generalized Random Tesselation)}
\NormalTok{train.points <-}\StringTok{ }\KeywordTok{grts}\NormalTok{(}\DataTypeTok{sp.object=}\NormalTok{frame.points,  }\CommentTok{# grille d'échantillonnage}
                     \DataTypeTok{src.frame=}\StringTok{"sp.object"}\NormalTok{,   }\CommentTok{# type de grille (objet spatiale)}
                     \DataTypeTok{design=}\NormalTok{Dsgn.grt,         }\CommentTok{# définition d'échantillonnage}
                     \DataTypeTok{stratum=}\StringTok{"ndvi_c"}\NormalTok{,        }\CommentTok{# colonne avec strate}
                     \DataTypeTok{type.frame=}\StringTok{"finite"}\NormalTok{,     }\CommentTok{# type d'échantillonnage}
                     \DataTypeTok{DesignID=}\StringTok{"train"}         \CommentTok{# préfixe pour chaque point}
\NormalTok{)}

\CommentTok{# Appliquer le système de référence des coordonnées }
\KeywordTok{proj4string}\NormalTok{(train.points) <-}\StringTok{ }\KeywordTok{proj4string}\NormalTok{(frame.points)}

\CommentTok{# Mélanger les points d'entraînement et ajouter un identifiant}
\NormalTok{train.points <-}\StringTok{ }\NormalTok{train.points[}\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(train.points)), ]}
\NormalTok{train.points}\OperatorTok{$}\NormalTok{SAMPLEID <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"trn-"}\NormalTok{, }\KeywordTok{str_pad}\NormalTok{(}\DataTypeTok{string=}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(train.points), }
                                                \DataTypeTok{width =} \DecValTok{4}\NormalTok{, }
                                                \DataTypeTok{pad =} \StringTok{"0"}\NormalTok{, }
                                                \DataTypeTok{side =} \StringTok{"left"}\NormalTok{))}


\CommentTok{# Conversion des points en parcelles et ajouter des attributs =================}

\CommentTok{# Grille Landsat}
\NormalTok{landsat.grid <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(ndvi)}
\KeywordTok{values}\NormalTok{(landsat.grid) <-}\StringTok{ }\DecValTok{1}

\CommentTok{# Selectionner les pixels Landsat correspondantes et convertir en polygone}
\NormalTok{train.plots <-}\StringTok{ }\KeywordTok{rasterToPolygons}\NormalTok{(}\KeywordTok{mask}\NormalTok{(landsat.grid, train.points))}

\CommentTok{# Extraire les attributs des points d'entraînement ...}
\NormalTok{train.plots}\OperatorTok{@}\NormalTok{data <-}\StringTok{ }\KeywordTok{over}\NormalTok{(train.plots, }
\NormalTok{                         train.points[, }\KeywordTok{c}\NormalTok{(}\StringTok{"PLOTID"}\NormalTok{, }\StringTok{"SAMPLEID"}\NormalTok{, }
                                          \StringTok{"xcoords"}\NormalTok{, }\StringTok{"ycoords"}\NormalTok{, }
                                          \StringTok{"ndvi"}\NormalTok{, }\StringTok{"stratum"}\NormalTok{)])}

\CommentTok{# ... et compléter avec autres attributs}
\NormalTok{train.plots}\OperatorTok{$}\NormalTok{ccov                            <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\OtherTok{NA}\NormalTok{)  }\CommentTok{# couverture houppiers}
\NormalTok{train.plots}\OperatorTok{$}\NormalTok{img_src <-}\StringTok{ }\NormalTok{train.plots}\OperatorTok{$}\NormalTok{img_date <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\OtherTok{NA}\NormalTok{)  }\CommentTok{# source et date d'image }
\NormalTok{train.plots}\OperatorTok{$}\NormalTok{author  <-}\StringTok{ }\NormalTok{train.plots}\OperatorTok{$}\NormalTok{mod_date <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\OtherTok{NA}\NormalTok{)  }\CommentTok{# auteur et date}

\CommentTok{# Sauvegarder parcelles sous format Shapefile et KML}
\KeywordTok{writeOGR}\NormalTok{(train.plots, }\DataTypeTok{dsn=}\NormalTok{OUT.DIR, }\DataTypeTok{layer=}\StringTok{"COV_parcelles"}\NormalTok{, }\DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{writeKML}\NormalTok{(train.plots, }\DataTypeTok{kmlname=}\StringTok{"COV_parcelles"}\NormalTok{, }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/COV_parcelles.kml"}\NormalTok{))}


\CommentTok{# Créer une grille d'échantillon 7x7 dans chaque parcelle =====================}

\CommentTok{# Détérminer la grille}
\NormalTok{grid.size <-}\StringTok{ }\DecValTok{7}
\NormalTok{res <-}\StringTok{ }\KeywordTok{res}\NormalTok{(landsat.grid)[}\DecValTok{1}\NormalTok{]}
\NormalTok{offset <-}\StringTok{ }\KeywordTok{c}\NormalTok{(res}\OperatorTok{/}\NormalTok{grid.size}\OperatorTok{/}\DecValTok{2} \OperatorTok{+}\StringTok{ }\NormalTok{(}\DecValTok{0}\OperatorTok{:}\NormalTok{(grid.size}\DecValTok{-1}\NormalTok{))}\OperatorTok{*}\NormalTok{res}\OperatorTok{/}\NormalTok{grid.size)}

\CommentTok{# Diviser les parcelles pour un traitement parallèle}
\NormalTok{subsets <-}\StringTok{ }\KeywordTok{split}\NormalTok{(train.plots, }\DataTypeTok{f=}\DecValTok{1}\OperatorTok{:}\NormalTok{(CORES}\DecValTok{-1}\NormalTok{))}
\KeywordTok{registerDoParallel}\NormalTok{(CORES}\DecValTok{-1}\NormalTok{)}
\NormalTok{train.grids <-}\StringTok{ }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{subset=}\NormalTok{subsets, }\DataTypeTok{.combine=}\NormalTok{rbind, }\DataTypeTok{.multicombine=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{ }
  \CommentTok{# Créer un couche de points vides ...}
\NormalTok{  grids <-}\StringTok{ }\KeywordTok{SpatialPointsDataFrame}\NormalTok{(}\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{x =} \DecValTok{0}\NormalTok{, }\DataTypeTok{y =} \DecValTok{0}\NormalTok{), }
                                  \DataTypeTok{data=}\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{PLOTID =} \DecValTok{0}\NormalTok{, }
                                                  \DataTypeTok{SAMPLEID =} \DecValTok{0}\NormalTok{, }
                                                  \DataTypeTok{GRIDPOINT =} \DecValTok{0}\NormalTok{))[}\OperatorTok{-}\DecValTok{1}\NormalTok{,]}
  \CommentTok{# ... et ajoute la grille d'échantillon pour chaque parcelle}
  \ControlFlowTok{for}\NormalTok{(p }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(subset)) \{}
\NormalTok{    plot <-}\StringTok{ }\NormalTok{subset[p,]}
\NormalTok{    ext <-}\StringTok{ }\KeywordTok{extent}\NormalTok{(plot)}
\NormalTok{    grids <-}\StringTok{ }\KeywordTok{bind}\NormalTok{(grids, }\KeywordTok{SpatialPointsDataFrame}\NormalTok{(}\KeywordTok{expand.grid}\NormalTok{(ext}\OperatorTok{@}\NormalTok{xmin}\OperatorTok{+}\NormalTok{offset, ext}\OperatorTok{@}\NormalTok{ymin}\OperatorTok{+}\NormalTok{offset), }
                                                \DataTypeTok{data=}\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{PLOTID =}\NormalTok{ plot}\OperatorTok{$}\NormalTok{PLOTID, }
                                                                \DataTypeTok{SAMPLEID =}\NormalTok{ plot}\OperatorTok{$}\NormalTok{SAMPLEID, }
                                                                \DataTypeTok{GRIDPOINT =} \DecValTok{1}\OperatorTok{:}\NormalTok{grid.size}\OperatorTok{^}\DecValTok{2}\NormalTok{)))}
\NormalTok{  \}}
\NormalTok{  grids}
\NormalTok{\}}

\CommentTok{# Appliquer le système de référence des coordonnées}
\KeywordTok{proj4string}\NormalTok{(train.grids) <-}\StringTok{ }\KeywordTok{proj4string}\NormalTok{(train.plots)}

\CommentTok{# Ajouter un attribut "arbre" (1: oui, 0: non)}
\NormalTok{train.grids}\OperatorTok{$}\NormalTok{tree <-}\StringTok{ }\KeywordTok{as.integer}\NormalTok{(}\OtherTok{NA}\NormalTok{)}

\CommentTok{# Sauveguarder les grille d'échantillon sous format Shapefile}
\KeywordTok{writeOGR}\NormalTok{(train.grids, }\DataTypeTok{dsn=}\NormalTok{OUT.DIR, }\DataTypeTok{layer=}\StringTok{"COV_parcelles_grid"}\NormalTok{, }
         \DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}


\CommentTok{# Diviser parcelles et grilles d'échantillon en 10 sous-ensembles =============}
\CommentTok{# pour le traitement par différents photo-interprètes}

\NormalTok{subsets <-}\StringTok{ }\KeywordTok{split}\NormalTok{(train.plots, }\DataTypeTok{f=}\DecValTok{1}\OperatorTok{:}\DecValTok{10}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(subsets)) \{}
  \CommentTok{# Sauvegarder parcelles sous format Shapefile et KML}
  \KeywordTok{writeOGR}\NormalTok{(subsets[[i]], }\DataTypeTok{dsn=}\NormalTok{OUT.DIR, }\DataTypeTok{layer=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"COV_parcelles_"}\NormalTok{, i), }
           \DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{writeKML}\NormalTok{(subsets[[i]], }\DataTypeTok{kmlname=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"COV_parcelles_"}\NormalTok{, i) , }
           \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(OUT.DIR, }\StringTok{"/COV_parcelles_"}\NormalTok{, i, }\StringTok{".kml"}\NormalTok{))}
  \CommentTok{# Sauvegarder les grilles correspondantes sous format Shapefile}
\NormalTok{  subset.grids <-}\StringTok{ }\NormalTok{train.grids[train.grids}\OperatorTok{$}\NormalTok{PLOTID }\OperatorTok{%in%}\StringTok{ }\NormalTok{subsets[[i]]}\OperatorTok{$}\NormalTok{PLOTID,]}
  \KeywordTok{writeOGR}\NormalTok{(subset.grids, }\DataTypeTok{dsn=}\NormalTok{OUT.DIR, }\DataTypeTok{layer=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"COV_parcelles_"}\NormalTok{, i, }\StringTok{"_grid"}\NormalTok{), }
           \DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{SSTS-validation-plots}{%
\subsubsection{Parcelles de validation}\label{SSTS-validation-plots}}

\hypertarget{echantillonnage-1}{%
\paragraph{Échantillonnage}\label{echantillonnage-1}}

La sélection des parcelles de validation est basée sur les cartes forêt/non-forêt, notamment leurs transitions entre les années 1987 -- 2003 -- 2015 -- 2018. Tout d'abord les transitions sont déterminées pour chaque point du réseau d'échantillonnage. Ensuite un échantillon aléatoire stratifié est tirré avec une répartition de l'échantillon aux strates (transitions) qui est la valeur moyenne d'une répartition proportionnelle à la taille des strates et d'une répartion égale.

\hypertarget{SSTS-occupation-terres}{%
\paragraph{Occupation des terres}\label{SSTS-occupation-terres}}

L'occupation des terres et le changement de l'occupation des terres est \textbf{déterminé sur base des images Landsat}. Trois différentes catégories sont distingués:

\begin{itemize}
\tightlist
\item
  forêt (couverture houppier ≥ 30\%)
\item
  terre boisée (couverture houppier entre 10\% et 30\%)
\item
  non-forêt (couverture houppier \textless{} 10\%)
\end{itemize}

\textbf{La couverture des houppiers est utilisé pour détérminer l'occupation des terres sur l'image Landsat de la date correspondate.} À partir de cette référence, l'occupation des terres est détérminé pour les autres dates de référence 1987 -- 2003 -- 2015 -- 2018. La figure suivante illustre la procédure:

\includegraphics{images/SSTS-land-cover.png}

\hypertarget{script-r-01_ssts02_bdd_srccreate-val-plots.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{01\_SSTS/02\_BdD/\_src/create-val-plots.R}}{Script R: 01\_SSTS/02\_BdD/\_src/create-val-plots.R}}\label{script-r-01_ssts02_bdd_srccreate-val-plots.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{01\_SSTS/02\_BdD/\_src/create-val-plots.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# create-val-points.R: Créer un ensemble de parcelles de validation}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Préparation des variables ===================================================}

\NormalTok{OUT.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.SST.BDD, }\StringTok{"/03_val-plots/empty"}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(OUT.DIR)) }\KeywordTok{dir.create}\NormalTok{(OUT.DIR, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{)}

\NormalTok{IN.DIR <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(DIR.MRV.MCF, }\StringTok{"/2_raw-maps/FC30/TGO"}\NormalTok{)}

\CommentTok{# Fusionner les cartes des années de référence (1987, 2003, 2015 et 2018)}
\NormalTok{maps <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(}\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/TGO_1987_F30r.tif"}\NormalTok{)),}
              \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/TGO_2003_F30r.tif"}\NormalTok{)),}
              \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/TGO_2015_F30r.tif"}\NormalTok{)),}
              \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IN.DIR, }\StringTok{"/TGO_2018_F30r.tif"}\NormalTok{)))}

\CommentTok{# Créer carte des changements (p.ex. FFFN pour déforestation entre 2015 et 2018)}
\NormalTok{change.map <-}\StringTok{ }\NormalTok{maps[[}\DecValTok{1}\NormalTok{]] }\OperatorTok{+}\StringTok{ }\NormalTok{maps[[}\DecValTok{2}\NormalTok{]]}\OperatorTok{*}\DecValTok{10} \OperatorTok{+}\StringTok{ }\NormalTok{maps[[}\DecValTok{3}\NormalTok{]]}\OperatorTok{*}\DecValTok{100} \OperatorTok{+}\StringTok{ }\NormalTok{maps[[}\DecValTok{4}\NormalTok{]]}\OperatorTok{*}\DecValTok{1000}

\CommentTok{# Charger la grille d'échantillonnage du SSTS}
\NormalTok{frame.points <-}\StringTok{ }\KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.SST.BDD, }\StringTok{"/01_reseau-SSTS/TGO_frame_480m.shp"}\NormalTok{))}

\CommentTok{# Extraire la transition pour chaque parcelle}
\NormalTok{frame.points}\OperatorTok{$}\NormalTok{trans  <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(change.map, frame.points)}


\CommentTok{# Allocation des points de validation =========================================}

\NormalTok{n <-}\StringTok{ }\DecValTok{4000}                              \CommentTok{# la taille de l'échantillon   }
\NormalTok{alloc <-}\StringTok{ }\KeywordTok{freq}\NormalTok{(change.map)[}\DecValTok{1}\OperatorTok{:}\DecValTok{16}\NormalTok{,]       }\CommentTok{# fréquence des transitions (p. ex FFFN)}

\CommentTok{# Allocation proportionelle et égale}
\NormalTok{alloc <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(alloc, }
               \DataTypeTok{prop=}\KeywordTok{round}\NormalTok{(n}\OperatorTok{*}\NormalTok{alloc[,}\StringTok{"count"}\NormalTok{]}\OperatorTok{/}\KeywordTok{sum}\NormalTok{(alloc[,}\StringTok{"count"}\NormalTok{])),    }
               \DataTypeTok{equal=}\KeywordTok{round}\NormalTok{(n}\OperatorTok{/}\KeywordTok{nrow}\NormalTok{(alloc))) }

\CommentTok{# Allocation balancée (moyenne entre proportionelle et égale)}
\NormalTok{alloc <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(alloc, }
               \DataTypeTok{balanced=}\KeywordTok{round}\NormalTok{((alloc[,}\StringTok{"prop"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\NormalTok{alloc[,}\StringTok{"equal"}\NormalTok{])}\OperatorTok{/}\StringTok{ }\DecValTok{2}\NormalTok{))}


\CommentTok{# Echantillonnage des parcelles de validation ================================}

\CommentTok{# Ajoute les attributs des parcelles d'entraînement}
\NormalTok{train.plots         <-}\StringTok{ }\KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.SST.BDD, }\StringTok{"/02_train-plots/assessed/COV_parcelles.shp"}\NormalTok{))}
\NormalTok{frame.points        <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(frame.points, }
\NormalTok{                             train.plots}\OperatorTok{@}\NormalTok{data[,}\KeywordTok{c}\NormalTok{(}\StringTok{"PLOTID"}\NormalTok{, }\StringTok{"img_date"}\NormalTok{, }\StringTok{"img_src"}\NormalTok{, }\StringTok{"mod_date"}\NormalTok{, }\StringTok{"author"}\NormalTok{, }\StringTok{"ccov"}\NormalTok{)], }
                             \DataTypeTok{by=}\StringTok{"PLOTID"}\NormalTok{, }\DataTypeTok{all.x=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# Créer une couche de points vide}
\NormalTok{val.points <-}\StringTok{ }\NormalTok{frame.points[}\DecValTok{0}\NormalTok{,]}

\CommentTok{# Initialiser le générateur de nombres aléatoires}
\KeywordTok{set.seed}\NormalTok{(RSEED)}

\CommentTok{# Pour chaque transition ...}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(alloc)) \{}
  
\NormalTok{  strat.n <-}\StringTok{  }\NormalTok{alloc[i, }\StringTok{"balanced"}\NormalTok{]   }\CommentTok{# nombre d'échantillons à tirer}
\NormalTok{  sample.ids <-}\StringTok{ }\OtherTok{NULL}                 \CommentTok{# vecteur pour les ID à échantillonner}
  
  \CommentTok{# Tout d'abord, prend les parcelles avec ...}
\NormalTok{  ids.tp <-}\StringTok{ }\KeywordTok{which}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(frame.points}\OperatorTok{$}\NormalTok{trans)               }
                  \OperatorTok{&}\StringTok{ }\NormalTok{frame.points}\OperatorTok{$}\NormalTok{trans}\OperatorTok{==}\NormalTok{alloc[i, }\StringTok{"value"}\NormalTok{]  }
                  \OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(frame.points}\OperatorTok{$}\NormalTok{ccov))    }\CommentTok{# couverture houppier connue}
\NormalTok{  n.tp   <-}\StringTok{ }\KeywordTok{min}\NormalTok{(}\KeywordTok{length}\NormalTok{(ids.tp), strat.n)}
  \ControlFlowTok{if}\NormalTok{ (n.tp }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{) sample.ids <-}\StringTok{ }\KeywordTok{c}\NormalTok{(sample.ids, }\KeywordTok{sample}\NormalTok{(ids.tp, n.tp))}
  
  \CommentTok{# ... et completer avec autres échantillons de la grille avec }
\NormalTok{  ids.r  <-}\StringTok{ }\KeywordTok{which}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(frame.points}\OperatorTok{$}\NormalTok{trans) }\OperatorTok{&}\StringTok{ }
\StringTok{                    }\NormalTok{frame.points}\OperatorTok{$}\NormalTok{trans}\OperatorTok{==}\NormalTok{alloc[i, }\StringTok{"value"}\NormalTok{] }\OperatorTok{&}\StringTok{ }
\StringTok{                    }\KeywordTok{is.na}\NormalTok{(frame.points}\OperatorTok{$}\NormalTok{ccov))     }\CommentTok{# couverture houppier inconnue}
\NormalTok{  n.r    <-}\StringTok{ }\KeywordTok{min}\NormalTok{(}\KeywordTok{length}\NormalTok{(ids.r), strat.n }\OperatorTok{-}\StringTok{ }\NormalTok{n.tp)}
  \ControlFlowTok{if}\NormalTok{ (n.r }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{) sample.ids <-}\StringTok{ }\KeywordTok{c}\NormalTok{(sample.ids, }\KeywordTok{sample}\NormalTok{(ids.r, n.r)) }\CommentTok{# aléatoirement}
  
  \CommentTok{# Ajouter aux points de validation}
\NormalTok{  val.points <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(val.points, frame.points[sample.ids, ])}
\NormalTok{\}}

\CommentTok{# Mélanger les points de validation et ajouter un identifiant}
\NormalTok{val.points <-}\StringTok{ }\NormalTok{val.points[}\KeywordTok{sample}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(val.points)), ]}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{SAMPLEID <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"val-"}\NormalTok{, }\KeywordTok{str_pad}\NormalTok{(}\DataTypeTok{string=}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(val.points), }
                                              \DataTypeTok{width =} \DecValTok{4}\NormalTok{, }
                                              \DataTypeTok{pad =} \StringTok{"0"}\NormalTok{, }
                                              \DataTypeTok{side =} \StringTok{"left"}\NormalTok{))}


\CommentTok{# Conversion des points en parcelles et ajouter des attributs =================}

\CommentTok{# Grille Landsat}
\NormalTok{landsat.grid <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(change.map)}
\KeywordTok{values}\NormalTok{(landsat.grid) <-}\StringTok{ }\DecValTok{1}

\CommentTok{# Selectionner les pixels Landsat correspondantes et convertir en polygone}
\NormalTok{val.plots <-}\StringTok{ }\KeywordTok{rasterToPolygons}\NormalTok{(}\KeywordTok{mask}\NormalTok{(landsat.grid, val.points))}

\CommentTok{# Extraire les attributs des points d'entraînement ...}
\NormalTok{val.plots}\OperatorTok{@}\NormalTok{data <-}\StringTok{ }\KeywordTok{over}\NormalTok{(val.plots, val.points[, }\KeywordTok{c}\NormalTok{(}\StringTok{"PLOTID"}\NormalTok{, }\StringTok{"SAMPLEID"}\NormalTok{, }
                                                 \StringTok{"xcoords"}\NormalTok{, }\StringTok{"ycoords"}\NormalTok{, }
                                                 \StringTok{"trans"}\NormalTok{, }\StringTok{"ccov"}\NormalTok{, }
                                                 \StringTok{"img_src"}\NormalTok{, }\StringTok{"img_date"}\NormalTok{, }
                                                 \StringTok{"author"}\NormalTok{, }\StringTok{"mod_date"}\NormalTok{)])}

\CommentTok{# ... convertir couverture des houppiers disponibles en %, les autres NA}
\NormalTok{val.plots}\OperatorTok{$}\NormalTok{ccov  <-}\StringTok{ }\KeywordTok{format}\NormalTok{(}\KeywordTok{round}\NormalTok{(}\DecValTok{100}\OperatorTok{*}\NormalTok{val.plots}\OperatorTok{$}\NormalTok{ccov, }\DecValTok{1}\NormalTok{)) }
\NormalTok{val.plots}\OperatorTok{$}\NormalTok{ccov[val.plots}\OperatorTok{$}\NormalTok{ccov }\OperatorTok{==}\StringTok{ "  NA"}\NormalTok{]<-}\StringTok{ }\OtherTok{NA}

\CommentTok{# ... et compléter avec attributs occupation des terre 1987, 2003, 2015 et 2018}
\NormalTok{val.plots}\OperatorTok{$}\NormalTok{lc_}\DecValTok{18}\NormalTok{   <-}\StringTok{ }\NormalTok{val.plots}\OperatorTok{$}\NormalTok{lc_}\DecValTok{15}\NormalTok{    <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\OtherTok{NA}\NormalTok{)}
\NormalTok{val.plots}\OperatorTok{$}\NormalTok{lc_}\DecValTok{03}\NormalTok{   <-}\StringTok{ }\NormalTok{val.plots}\OperatorTok{$}\NormalTok{lc_}\DecValTok{87}\NormalTok{    <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\OtherTok{NA}\NormalTok{)}

\CommentTok{# Sauvegarder parcelles sous format Shapefile et KML}
\KeywordTok{writeOGR}\NormalTok{(val.plots, }\DataTypeTok{dsn=}\StringTok{"."}\NormalTok{, }\DataTypeTok{layer=}\StringTok{"UOT_parcelles"}\NormalTok{, }\DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{writeKML}\NormalTok{(val.plots, }\DataTypeTok{kmlname=}\StringTok{"UOT_parcelles"}\NormalTok{, }\DataTypeTok{filename=}\StringTok{"UOT_parcelles.kml"}\NormalTok{)}


\CommentTok{# Créer une grille d'échantillon 7x7 dans chaque parcelle =====================}

\CommentTok{# Détérminer la grille}
\NormalTok{grid.size <-}\StringTok{ }\DecValTok{7}
\NormalTok{res <-}\StringTok{ }\KeywordTok{res}\NormalTok{(landsat.grid)[}\DecValTok{1}\NormalTok{]}
\NormalTok{offset <-}\StringTok{ }\KeywordTok{c}\NormalTok{(res}\OperatorTok{/}\NormalTok{grid.size}\OperatorTok{/}\DecValTok{2} \OperatorTok{+}\StringTok{ }\NormalTok{(}\DecValTok{0}\OperatorTok{:}\NormalTok{(grid.size}\DecValTok{-1}\NormalTok{))}\OperatorTok{*}\NormalTok{res}\OperatorTok{/}\NormalTok{grid.size)}

\CommentTok{# Diviser les parcelles pour un traitement parallèle}
\NormalTok{subsets <-}\StringTok{ }\KeywordTok{split}\NormalTok{(val.plots, }\DataTypeTok{f=}\DecValTok{1}\OperatorTok{:}\DecValTok{86}\NormalTok{)}
\KeywordTok{registerDoParallel}\NormalTok{(CORES}\DecValTok{-1}\NormalTok{)}
\NormalTok{val.grids <-}\StringTok{ }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{subset=}\NormalTok{subsets, }\DataTypeTok{.combine=}\NormalTok{bind, }\DataTypeTok{.multicombine=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{ }
  \CommentTok{# Créer un couche de points vides ...}
\NormalTok{  grids <-}\StringTok{ }\KeywordTok{SpatialPointsDataFrame}\NormalTok{(}\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{x =} \DecValTok{0}\NormalTok{, }\DataTypeTok{y =} \DecValTok{0}\NormalTok{), }
                                  \DataTypeTok{data=}\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{PLOTID =} \DecValTok{0}\NormalTok{, }
                                                  \DataTypeTok{SAMPLEID =} \DecValTok{0}\NormalTok{, }
                                                  \DataTypeTok{GRIDPOINT =} \DecValTok{0}\NormalTok{))[}\OperatorTok{-}\DecValTok{1}\NormalTok{,]}
  \CommentTok{# ... et ajoute la grille d'échantillon pour chaque parcelle}
  \ControlFlowTok{for}\NormalTok{(p }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(subset)) \{}
\NormalTok{    plot <-}\StringTok{ }\NormalTok{subset[p,]}
\NormalTok{    ext <-}\StringTok{ }\KeywordTok{extent}\NormalTok{(plot)}
\NormalTok{    grids <-}\StringTok{ }\KeywordTok{bind}\NormalTok{(grids, }\KeywordTok{SpatialPointsDataFrame}\NormalTok{(}\KeywordTok{expand.grid}\NormalTok{(ext}\OperatorTok{@}\NormalTok{xmin}\OperatorTok{+}\NormalTok{offset, ext}\OperatorTok{@}\NormalTok{ymin}\OperatorTok{+}\NormalTok{offset), }
                                                \DataTypeTok{data=}\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{PLOTID =}\NormalTok{ plot}\OperatorTok{$}\NormalTok{PLOTID, }
                                                                \DataTypeTok{SAMPLEID =}\NormalTok{ plot}\OperatorTok{$}\NormalTok{SAMPLEID,}
                                                                \DataTypeTok{GRIDPOINT =} \DecValTok{1}\OperatorTok{:}\NormalTok{grid.size}\OperatorTok{^}\DecValTok{2}\NormalTok{)))}
\NormalTok{  \}}
\NormalTok{  grids}
\NormalTok{\}}

\CommentTok{# Appliquer le système de référence des coordonnées}
\KeywordTok{proj4string}\NormalTok{(val.grids) <-}\StringTok{ }\KeywordTok{proj4string}\NormalTok{(val.plots)}

\CommentTok{# fusionner avec les attributs (arbre, oui ou non?) déjà collectés }
\NormalTok{train.grids <-}\StringTok{ }\KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.SST.BDD, }\StringTok{"/02_train-plots/assessed/COV_parcelles_grid.shp"}\NormalTok{))}
\NormalTok{val.grids <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(val.grids, }
\NormalTok{                   train.grids}\OperatorTok{@}\NormalTok{data[, }\KeywordTok{c}\NormalTok{(}\StringTok{"PLOTID"}\NormalTok{, }\StringTok{"GRIDPOINT"}\NormalTok{, }\StringTok{"tree"}\NormalTok{)], }
                   \DataTypeTok{all.x=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# Sauveguarder les grille d'échantillon sous format Shapefile}
\KeywordTok{writeOGR}\NormalTok{(val.grids, }\DataTypeTok{dsn=}\NormalTok{OUT.DIR, }\DataTypeTok{layer=}\StringTok{"UOT_parcelles_grid"}\NormalTok{, }\DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}


\CommentTok{# Diviser parcelles et grilles d'échantillon en 10 sous-ensembles =============}
\CommentTok{# pour le traitement par différents photo-interprètes}

\NormalTok{subsets <-}\StringTok{ }\KeywordTok{split}\NormalTok{(val.plots, }\DataTypeTok{f=}\DecValTok{1}\OperatorTok{:}\DecValTok{10}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(subsets)) \{}
  \CommentTok{# Sauvegarder parcelles sous format Shapefile et KML}
  \KeywordTok{writeOGR}\NormalTok{(subsets[[i]], }\DataTypeTok{dsn=}\NormalTok{OUT.DIR, }\DataTypeTok{layer=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"UOT_parcelles_"}\NormalTok{, i), }
           \DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{writeKML}\NormalTok{(subsets[[i]], }\DataTypeTok{kmlname=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"UOT_parcelles_"}\NormalTok{, i) , }
           \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"UOT_parcelles_"}\NormalTok{, i, }\StringTok{".kml"}\NormalTok{))}
  \CommentTok{# Sauvegarder les grilles correspondantes sous format Shapefile}
\NormalTok{  subset.grids <-}\StringTok{ }\NormalTok{val.grids[val.grids}\OperatorTok{$}\NormalTok{PLOTID }\OperatorTok{%in%}\StringTok{ }\NormalTok{subsets[[i]]}\OperatorTok{$}\NormalTok{PLOTID,]}
  \KeywordTok{writeOGR}\NormalTok{(subset.grids, }\DataTypeTok{dsn=}\NormalTok{OUT.DIR, }\DataTypeTok{layer=}\KeywordTok{paste0}\NormalTok{(}\StringTok{"UOT_parcelles_"}\NormalTok{, i, }\StringTok{"_grid"}\NormalTok{), }
           \DataTypeTok{driver=}\StringTok{"ESRI Shapefile"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{outil-qgis}{%
\subsubsection{Outil QGIS}\label{outil-qgis}}

Actuellement, les parcelles d'échantillonnage du SSTS ainsi que la grille de points pour déterminer la couverture des houppiers sont stockées sous forme des fichiers Shapefile. L'acquisition des attributs est effectuée par les photo-interprètes à l'aide d'un formulaire défini dans un projet QGIS.

\includegraphics{images/SSTS-qgis-form.png}

Un SSTS basé sur des fichiers limite la complexité de la structure des données (par exemple, l'enregistrement récurrent des mêmes parcelles sur des images de différentes années) ainsi que le travail parallèle de différents photo-interprètes sur les mêmes données. Actuellement, des travaux sont en cours pour transférer le SSTS vers une base de données géographiques (PostGIS) sur un serveur central au Ministère de l'Environnement et des Ressources Forestières (MERF) et pour définir un formulaire QGIS qui permet à plusieurs personnes de travailler simultanément sur les données.

\hypertarget{IFN}{%
\section{Inventaire Forestier National}\label{IFN}}

L'inventaire forestier national, combine les données collectées directement sur le terrain avec des références forestières provenant de différentes sources. Le seul ensemble de données collectées est actuellement le premier IFN-1 national inverntaire forestier qui a été réalisé par le GIZ en 2015/16. Il est utilisé dans le cadre du NRF-MRV pour déterminer les facteurs d'émission de la biomasse des arbres.

\begin{rmdtodo}
Un deuxième inverntaire forestier national (IFN-2) sur base des
parcelles permanentes installées par IFN-1 est en cours de
planification. Ce deuxième inventaire sera realise par la direction de
l'environnment du Mininstère de l'environnment, du developpement durable
et de la protection de la nature.

En outre, d'autres ensembles de données seront intégrés dans la base de
données au cours des prochaines années:

\begin{itemize}
\tightlist
\item
  inventaires réalisés par les universités du Togo et autres acteurs
\item
  inventaire des plantations de l'ODEF
\item
  données sur les feux de végétation de l'ANGE
\item
  données sur l'agriculture (superficie emblavées et le cheptel) de DCID
  et ITRA
\item
  données démographiques de INSEED
\item
  \ldots{}
\end{itemize}
\end{rmdtodo}

Les données et les documents des enquêtes respectives sont structurés comme suit:

\begin{verbatim}
02_IFN                            # INVENTAIRE FORESTIER NATIONAL =============
├── 01_IFN-1                        # Premier IFN 2015/16 ---------------------
    ├── 01_data                       # données brutes      
    ├── 02_aux                        # données auxiliaires, scripts, analyses
    └── 03_reports                    # rapports (méthode, résultats, ...)
└── ...                             # Autres données (IFN-2, Plantations, Feu)
\end{verbatim}

\hypertarget{IFN-1}{%
\subsection{IFN-1 (2015/16)}\label{IFN-1}}

Le premier inventaire forestier national a ete realisé par la GIZ et le MERF en 2015/16.

\hypertarget{methode}{%
\subsubsection{\texorpdfstring{\href{../02_IFN/01_IFN-1/03_docs/IFN-1_Togo_MERF_Methode_Draft.pdf}{Méthode}}{Méthode}}\label{methode}}

L'inventaire IFN-1 a installé xx parcelles permanentes au Togo. Les parcelles ont été installée \ldots{}

\hypertarget{donnees}{%
\subsubsection{Données}\label{donnees}}

\hypertarget{resultats}{%
\subsubsection{\texorpdfstring{\href{../02_IFN/01_IFN-1/03_docs/IFN-1_Togo_MERF_Rapport_Finale.pdf}{Résultats}}{Résultats}}\label{resultats}}

Les résultats \ldots{}

\hypertarget{NRF-MRV}{%
\section{Analyses NRF/MRV}\label{NRF-MRV}}

Le Togo a soumis son premier \textbf{Niveau de Référence pour les Forêts (NRF v1.0)} en Janvier 2020 (\href{https://redd.unfccc.int/submissions.html?country=tgo}{\emph{Soumissions du Togo sur la plateforme web REDD+ de la CCNUCC}}). Il est basé sur l'évolution de la couverture forestier entre 2003 -- 2018 (pertes et gains des terres forestières à une couverture du houppier ≥ 30\%) et le stockage de carbone dans la biomasse aérienne des arbres (incl. bois mort sur pied)

Les données de base qu'on a utilisé pour effectuer ce travail sont:

\begin{itemize}
\tightlist
\item
  \textbf{les images Landsat de l'archive USGS (1985 -- 2019)} et les \textbf{données climatiques WorldClim version 2} pour la la cartographie de l'évolution des surfaces forestiers et la cartographie de la biomasse
\item
  \textbf{les données du SSTS (état 2019)} sur la couverture du houppier et l'utilisation des terres pour la calibration et la validation des cartes sur l'évolution des surfaces forestier
\item
  \textbf{les données dendrométriques du IFN-1 (2015/16)} pour déterminer le stockage de carbone dans la biomasse aérienne par parcelle et la calibration des cartes de la biomasse
\end{itemize}

Ce chapitre décrit \textbf{l'approche méthodologique et les outils techniques} utilisés pour établir ce NRF. C'est un travail en cours. Le même approche sera utilisés a) pour améliorer le NRF avec des nouvelles données et/ou mèthodes et b) pour mettre à jour régulièrement les analyses dans le cadre du Monitoring, reporting et vérification (MRV).

Chaque section commence par une description de la méthodologie utilisée et des références aux points clés dans le script R correspondant, suivie par une présentation exemplaire des résultats de cette étappe et enfin du code R commenté.

\begin{itemize}
\tightlist
\item
  \textbf{Section \ref{SSTS-BdD}} décrit l'acquisition et la préparation des données de télédétection dans le cadre du Système de Surveillance Terrestre par Satellite SSTS (Images Landsat, données WorldClim, \ldots{}).
\item
  \textbf{Section \ref{SSTS-collecte}} décrit la collecte de données d'entraînement et de validation dans le cadre du SSTS.
\item
  \textbf{Section \ref{NRF-analyse-MCF}} décrit les différentes étapes nécessaires pour la cartographie des surfaces forestières et leur évolution: la classification des séries de cartes, leur néttoyage et validation.
\item
  \textbf{Section \ref{NRF-analyse-AGB}} décrit les différentes étapes nécessaires pour la cartographie des la biomasse aérienne: l'évaluation des données de l'IFN, la calibration des cartes de biomasse leur néttoyage et l'analyse de l'évolution de la biomasse dans le temps.
\end{itemize}

\hypertarget{NRF-analyse-MCF}{%
\subsection{Analyse surfaces forestiers}\label{NRF-analyse-MCF}}

L'analyse des surfaces forestiers est fait par une \textbf{classification supervisée}. Les données du SSTS sur la couverture des houppiers (section \ref{SSTS-couverture-houppiers}) est utilisé pour calibrer un modèle de classification \emph{RandomForest} sur base des images satellitaires Landsat et les données climatiques Worldclim v2. Tous les parcelles d'entraînement avec une \textbf{couverture des houppiers ≥ 30\%} sont considérées comme forêt, les autres comme non-forêts.

Le schéma suivant montre les étapes pour la production des cartes forêt/non-forêt sur toute la période 1986 -- 2019:

\includegraphics{images/FCC-Schema.png}

Vue que les données sur la couverture des houppier et seulement disponible pour les années récentes (à cause d'une disponibilité limité des images de très haute résolution), c'est seulement la carte forêt/non-forêt 2018 qui a été produit sur base des parcelles d'entraînement du SSTS. Cette \textbf{carte de référence 2018 est utilisé comme base pour la calibration des modèles de classification pour les autres dates} pour lesquelles des images Landsat sont disponible.

Tout d'abord la carte de référence 2018 est utilisé pour calibrer la classification d'une carte forêt/non-forêt en 2003. C'est cette \textbf{carte de référence 2003 qu'on a utilisé pour calibrer les autres cartes de 1986 -- 2018}. On a choisi de faire la classification de toute la serie des images sur la carte de référence 2003, parce que les images Landsat 2003 sont de très bonne qualité (et donc la carte est probablement aussi de bonne qualité) et parce que l'année 2003 se trouve au milieu de la période analysée. Si on prend directement la carte forêt/non-forêt 2018 comme référence pour la calibration de la série 1986 -- 2018, on observe une généralisation de la surface forestier le plus on s'éloigne de la date 2018, donc un changement de la surface forestier qui est plutôt un artefact de la méthode que une changement d'occupation des terres.

Dans la suite, \textbf{la série des cartes forêts/non-forêts 1986 -- 2018 est nettoyé par une lyssage temporelle}, pixel par pixel, avec un filtre majoritaire (fenêtre coulissante d'une taille de 5). Finalement, une reforestation est seulement constaté si on a observé la forêt pour une période de 10 ans et plus.

\textbf{Les cartes nettoyés de 2003, 2015 et 2018 sont validés avec les données SSTS} sur l'occupation des terres (Section \ref{SSTS-occupation-terres}) et les matrices d'erreurs sont utilisées pour détérminer la précision des cartes individuelles et des différents changements d'occupation des terres, en utilisant la méthode de \href{https://www.sciencedirect.com/science/article/abs/pii/S0034425714000704}{Olofsson et al. (2014)}

\hypertarget{NRF-create-fc-maps}{%
\subsubsection{Production des cartes Forêt/Non-Forêt}\label{NRF-create-fc-maps}}

La \textbf{production de la carte forêt/non-forêt 2018} est basée sur la couverture des houppiers déterminée dans les \protect\hyperlink{SSTS-training-plots}{parcelles d'entraînement}, les \protect\hyperlink{SSTS-Landsat}{images satellitaires Landsat} (bandes et indices \texttt{B,\ G,\ R,\ NIR,\ SWIR1,\ SWIR2,\ nbr,\ ndmi,\ ndvi,\ evi}) et les \protect\hyperlink{SSTS-Worldclim}{données climatiques Worldclim} (\texttt{BIO1,\ BIO4,\ BIO12,\ BIO15}).

Dans une première étape, les variables Landsat et Worldclim sont extraites pour toutes les \textbf{parcelles d'entraînement de la période de référence 1.1.2017 - 31.12.2018} et les parcelles d'entraînement sont classées comme ``forestières'' ou ``non forestières'' en fonction de leur couverture des houppiers (forêt ≥ 30\% de couverture des houppiers). Par la suite, des cartes forêt/non-forêt 2018 sont produites pour chaque chemin WRS. Pour cela, la fonction \texttt{classify.image()} est utilisée, qui crée un modèle de classification en \textbf{utilisant l'algorithme RandomForest} et une carte correspondante. Pour le chemin WRS central p193, l'algorithme de classification est calibré uniquement sur la base des parcelles d'entraînement. Pour les chemins p192 et p194, des données d'entraînement supplémentaires basées sur la carte p193 sont utilisées pour assurer la calibration entre les chemins.

Les cartes de référence générées pour 2018 sont maintenant utilisées pour \textbf{générer les cartes correspondantes pour l'année 2003. Les données d'entraînement sont tirées de la carte de référence 2018, autour de la lisière des forêts.} Pour les chemins p192 et p194, de nouves des données d'entraînement supplémentaires du chemin p193 sont utilisées.

\textbf{Sur la base des cartes forêt/non-forêt de 2003, les cartes de toutes les années avec des images Landsat disponibles sont produites selon la même procédure.} Le calibrage de toute la série sur la base d'une année de référence garantit une différenciation consistante entre les classes forêt et non-forêt. Enfin, les chemins p192, p193 et p194 sont fusionnés pour les années clés 1987, 2003, 2015 et 2018.

\hypertarget{NRF-create-fc-maps-figure}{%
\paragraph{Example}\label{NRF-create-fc-maps-figure}}
\addcontentsline{toc}{paragraph}{Example}

La figure suivante illustre la \textbf{série des 13 cartes forêt/non-forêt brutes} dans une région au sud de Kpalimé. Les pixels en rose vif sont des pixels dont les données sont manquantes (nuages, ombres, L7 SLC-off). Voir \protect\hyperlink{NRF-clean-fc-maps-figure}{série des cartes nettoyées} pour comparaison.

\includegraphics{images/FCC-rawmaps.png}

\hypertarget{script-r-03_nrf-mrv01_mcf_src01_create-fc-maps.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{03\_NRF-MRV/01\_MCF/\_src/01\_create-FC-maps.R}}{Script R: 03\_NRF-MRV/01\_MCF/\_src/01\_create-FC-maps.R}}\label{script-r-03_nrf-mrv01_mcf_src01_create-fc-maps.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{03\_NRF-MRV/01\_MCF/\_src/01\_create-FC-maps.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# 01_create-fc-maps.R: créer des cartes brutes du couvert forestier}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}

\CommentTok{# Seuil de la couverture des houppiers (forêt vs. non-forêt)}
\NormalTok{COV.FC         <-}\StringTok{ }\DecValTok{30}             

\CommentTok{# Nombre de pixels à considerer comme lisière forêt }
\NormalTok{SAMPLE.DIST    <-}\StringTok{ }\DecValTok{1}              

\CommentTok{# Nombre de pixels non-NA (sera déterminé plus tard)}
\NormalTok{N.PIXELS       <-}\StringTok{ }\OtherTok{NA}        

\CommentTok{# Part de pixels à prendre en compte pour la calibration des cartes}
\NormalTok{SAMPLE.RATIO   <-}\StringTok{ }\FloatTok{0.0025}        

\CommentTok{# Part des pixels à prendre des autres chemins (calibration)}
\NormalTok{CAL.RATIO      <-}\StringTok{ }\FloatTok{0.75} 

\CommentTok{# Bandes à utiliser pour la modélisation forêt vs. non-forêt}
\NormalTok{PREDICTORS     <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"B"}\NormalTok{, }\StringTok{"G"}\NormalTok{, }\StringTok{"R"}\NormalTok{, }\StringTok{"NIR"}\NormalTok{, }\StringTok{"SWIR1"}\NormalTok{, }\StringTok{"SWIR2"}\NormalTok{, }
                    \StringTok{"nbr"}\NormalTok{, }\StringTok{"ndmi"}\NormalTok{, }\StringTok{"ndvi"}\NormalTok{, }\StringTok{"evi"}\NormalTok{, }
                    \StringTok{"BIO1"}\NormalTok{, }\StringTok{"BIO4"}\NormalTok{, }\StringTok{"BIO12"}\NormalTok{, }\StringTok{"BIO15"}\NormalTok{) }

\CommentTok{# Répertoires}
\NormalTok{LANDSAT.DIR <-}\StringTok{ }\NormalTok{DIR.SST.DAT.LST}
\NormalTok{WORLDCLIM.DIR <-}\StringTok{ }\NormalTok{DIR.SST.DAT.WC2}
\NormalTok{REF.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.MCF.REF}
\NormalTok{RAW.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.MCF.RAW}
  

\CommentTok{# Définitions des fonctions ===================================================}

\CommentTok{# Charger un image Landsat ----------------------------------------------------}
\CommentTok{#}
\CommentTok{# @param filename  Chemin du fichier landsat}
\CommentTok{#}
\CommentTok{# @return          Image Landsat avec bandes nommées }
\CommentTok{#}

\NormalTok{load.image <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(filename) \{}
\NormalTok{  image <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(LANDSAT.DIR, filename))}
  \KeywordTok{names}\NormalTok{(image) <-}\StringTok{ }\NormalTok{SST.LSBANDS}
  \KeywordTok{return}\NormalTok{(image)}
\NormalTok{\}}

\CommentTok{# Tirer des points d'entraînement d'une carte autour de la lisière forêt ------}
\CommentTok{#}
\CommentTok{# @param map       Carte forêt/non-forêt à échantillonner}
\CommentTok{# @param n         Nombre d'échantillons à tirer}
\CommentTok{#}
\CommentTok{# @return          Points d'échantillon avec aatribut forêt/non-forêt}
\CommentTok{#}

\NormalTok{sample.map <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(map, n) \{}
  
\NormalTok{  tmp.src  <-}\StringTok{ }\KeywordTok{tempfile}\NormalTok{(}\DataTypeTok{pattern =} \StringTok{""}\NormalTok{, }\DataTypeTok{fileext =} \StringTok{".tif"}\NormalTok{)    }\CommentTok{# tmp carte forêt/non-forêt}
\NormalTok{  tmp.dst1 <-}\StringTok{ }\KeywordTok{tempfile}\NormalTok{(}\DataTypeTok{pattern =} \StringTok{""}\NormalTok{, }\DataTypeTok{fileext =} \StringTok{".tif"}\NormalTok{)    }\CommentTok{# tmp lisière à l'extérieur}
\NormalTok{  tmp.dst3 <-}\StringTok{ }\KeywordTok{tempfile}\NormalTok{(}\DataTypeTok{pattern =} \StringTok{""}\NormalTok{, }\DataTypeTok{fileext =} \StringTok{".tif"}\NormalTok{)    }\CommentTok{# tmp lisière à l'intérieur}
  
  \CommentTok{# Écrire la carte sur le disque}
\NormalTok{  map <-}\StringTok{ }\KeywordTok{writeRaster}\NormalTok{(map, tmp.src)                        }
  
  \CommentTok{# Forêt + lisière à l'extérieur de la forêt}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdal_proximity.py"}\NormalTok{, tmp.src, tmp.dst1,    }
               \StringTok{"-values"}\NormalTok{, FOREST, }
               \StringTok{"-use_input_nodata YES"}\NormalTok{, }
               \StringTok{"-maxdist "}\NormalTok{,  SAMPLE.DIST, }
               \StringTok{"-fixed-buf-val"}\NormalTok{, NONFOR))}
\NormalTok{  dst1 <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(tmp.dst1)}
  \KeywordTok{NAvalue}\NormalTok{(dst1) <-}\StringTok{ }\DecValTok{65535}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"     "}\NormalTok{)}
  
  \CommentTok{# Non-forêt + lisière à l'intérieur de la forêt}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"gdal_proximity.py"}\NormalTok{, tmp.src, tmp.dst3,          }
               \StringTok{"-values"}\NormalTok{, NONFOR, }
               \StringTok{"-use_input_nodata YES"}\NormalTok{,}
               \StringTok{"-maxdist "}\NormalTok{,  SAMPLE.DIST, }
               \StringTok{"-fixed-buf-val"}\NormalTok{, FOREST))}
\NormalTok{  dst3 <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(tmp.dst3)}
  \KeywordTok{NAvalue}\NormalTok{(dst3) <-}\StringTok{ }\DecValTok{65535}
  
  \CommentTok{# Masquer la carte avec les lisières}
\NormalTok{  map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(map, dst1)}
\NormalTok{  map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(map, dst3)}
  
  \CommentTok{# Supprimer les fichiers temporaires}
  \KeywordTok{unlink}\NormalTok{(}\KeywordTok{c}\NormalTok{(tmp.src, tmp.dst1, tmp.dst3))                           }
  
  \CommentTok{# Echantillonnage stratifié des lisières forêt et non-forêt}
\NormalTok{  n.classes <-}\StringTok{ }\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(map))}
  \KeywordTok{cat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"    -Sampling map (n="}\NormalTok{, n.classes, }\StringTok{"*"}\NormalTok{, }\KeywordTok{round}\NormalTok{(n}\OperatorTok{/}\NormalTok{n.classes), }\StringTok{") ... "}\NormalTok{))}
\NormalTok{  sample.pts <-}\StringTok{ }\KeywordTok{sampleStratified}\NormalTok{(map, }\KeywordTok{round}\NormalTok{(n}\OperatorTok{/}\NormalTok{n.classes), }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{]}
  \KeywordTok{names}\NormalTok{(sample.pts) <-}\StringTok{ "CLASS"}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"done}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \KeywordTok{return}\NormalTok{(sample.pts)}
\NormalTok{\}}

\CommentTok{# Classification d'une image -------------------------------------------}
\CommentTok{#}
\CommentTok{# @param image      Image Landsat à classifier      }
\CommentTok{# @param filename   Nom de fichier pour la sauvegarde de la carte}
\CommentTok{# @param bioclim    Raster des variables bioclimatiques à utiliser}
\CommentTok{# @param train.pts  Points d'entraînement}
\CommentTok{# @param ref.map    Carte de référence}
\CommentTok{# @param n.ref.map  Nombre de points à échantilloner}
\CommentTok{# @param cal.map    Carte de calibration (autre chemin WRS)}
\CommentTok{# @param n.cal.map  Nombre de points à échantilloner}
\CommentTok{# @param mask       Masque à utiliser pour ref.map et cal.map}
\CommentTok{# @param preds      Variables à utiliser pour le modèle}
\CommentTok{# @param type       Modèle de classification ou de regression}
\CommentTok{# @param crossval   Faire validation croisée (3 * 10-fold)}
\CommentTok{# @param prob       Produire également carte de probabilité}
\CommentTok{# @param n.cores    Nombre de processeurs à utiliser pour prédiction}
\CommentTok{#}
\CommentTok{# @return           List avec les éléments }
\CommentTok{#                   - model, }
\CommentTok{#                   - carte forêt/non-forêt}
\CommentTok{#                   - carte des probabilités (si disponible)}
\CommentTok{#}

\NormalTok{classify.image <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(image, filename, }\DataTypeTok{bioclim=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{train.pts=}\OtherTok{NULL}\NormalTok{, }
                           \DataTypeTok{ref.map=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{n.ref.map=}\OtherTok{NULL}\NormalTok{, }
                           \DataTypeTok{cal.map=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{n.cal.map=}\OtherTok{NULL}\NormalTok{, }
                           \DataTypeTok{mask=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{preds=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{type=}\StringTok{"classification"}\NormalTok{, }
                           \DataTypeTok{crossval=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{prob=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{n.cores=}\DecValTok{8}\NormalTok{) \{}
  
  \CommentTok{# Ouvrir le fichier journal}
\NormalTok{  txtfile <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\KeywordTok{sub}\NormalTok{(}\StringTok{"[.]tif$"}\NormalTok{, }\StringTok{""}\NormalTok{, filename), }\StringTok{".txt"}\NormalTok{)}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"-- Image classification: "}\NormalTok{, }\KeywordTok{basename}\NormalTok{(filename), }\StringTok{"/"}\NormalTok{, }
      \KeywordTok{date}\NormalTok{(), }\StringTok{" --}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile)}
  
  \CommentTok{# Charger des points d'entraînement ---------------------}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(train.pts)) \{}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"    -Loading training points ... "}\NormalTok{)}
\NormalTok{    train.pts <-}\StringTok{ }\NormalTok{train.pts[,}\DecValTok{1}\NormalTok{]      }\CommentTok{# utiliser que la première colonne ...}
    \KeywordTok{names}\NormalTok{(train.pts) <-}\StringTok{ "CLASS"}     \CommentTok{# ... et nommer "CLASS"}
    \KeywordTok{set_ReplCRS_warn}\NormalTok{(}\OtherTok{FALSE}\NormalTok{)}
    \KeywordTok{proj4string}\NormalTok{(train.pts) <-}\StringTok{ }\KeywordTok{proj4string}\NormalTok{(image)  }\CommentTok{# Système de coordonnées CRS}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"done}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"Training points:"}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(train.pts), }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  
  \CommentTok{# Ajouter des points d'une carte de référence -----------}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(ref.map)) \{}
    \KeywordTok{cat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"    -Masking / buffering reference map ... }\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
    \CommentTok{# ... couper/masquer avec l'image}
\NormalTok{    ref.map  <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(ref.map, image[[}\DecValTok{1}\NormalTok{]]), }\KeywordTok{crop}\NormalTok{(image[[}\DecValTok{1}\NormalTok{]], ref.map)) }
    \CommentTok{# ... et masque additionelle (si disponible)}
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(mask)) ref.map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(ref.map, mask)             }
    \CommentTok{# Découper la carte de calibration (si disponible)}
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(cal.map)) \{}
\NormalTok{      tmp <-}\StringTok{ }\KeywordTok{extend}\NormalTok{(}\KeywordTok{crop}\NormalTok{(cal.map, ref.map), ref.map)}
\NormalTok{      ref.map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(ref.map, tmp, }\DataTypeTok{inverse=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{    \}}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"    "}\NormalTok{)}
    \CommentTok{# Tirer des points d'échantillon ...}
\NormalTok{    ref.pts <-}\StringTok{ }\KeywordTok{sample.map}\NormalTok{(ref.map, n.ref.map)}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"Ref-map points: "}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(ref.pts), }\StringTok{"/"}\NormalTok{, ref.map}\OperatorTok{@}\NormalTok{file}\OperatorTok{@}\NormalTok{name, }\StringTok{"/"}\NormalTok{, }
\NormalTok{        SAMPLE.DIST, }\StringTok{"px}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
    \CommentTok{# ... et ajouter aux points d'entraînement}
    \ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(train.pts)) \{}
\NormalTok{      train.pts <-}\StringTok{ }\NormalTok{ref.pts                                          }
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      train.pts <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(train.pts, ref.pts)}
\NormalTok{    \}}
\NormalTok{  \}}
  
  \CommentTok{# Ajouter des points d'une carte de calibration ---------}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(cal.map)) \{}
    \KeywordTok{cat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"    -Masking / buffering calibration map ... }\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
    \CommentTok{# ... couper/masquer avec l'image}
\NormalTok{    cal.map  <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(cal.map, image[[}\DecValTok{1}\NormalTok{]]), }\KeywordTok{crop}\NormalTok{(image[[}\DecValTok{1}\NormalTok{]], cal.map)) }
    \CommentTok{# ... et masque additionelle (si disponible)}
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(mask)) cal.map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(cal.map, mask)                     }
    \KeywordTok{cat}\NormalTok{(}\StringTok{"    "}\NormalTok{)}
    \CommentTok{# Tirer des points d'échantillon ...}
\NormalTok{    cal.pts <-}\StringTok{ }\KeywordTok{sample.map}\NormalTok{(cal.map, n.cal.map)}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"Cal-map points: "}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(cal.pts), }\StringTok{"from"}\NormalTok{, cal.map}\OperatorTok{@}\NormalTok{file}\OperatorTok{@}\NormalTok{name, }\StringTok{"/"}\NormalTok{, }
\NormalTok{        SAMPLE.DIST, }\StringTok{"px}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
    \CommentTok{# ... et ajouter aux points d'entraînement}
    \ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(train.pts)) \{}
\NormalTok{      train.pts <-}\StringTok{ }\NormalTok{cal.pts                                      }
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      train.pts <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(train.pts, cal.pts)}
\NormalTok{    \}}
\NormalTok{  \}}
  \CommentTok{# Nombre total des points d'entraînement}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"Total points:   "}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(train.pts), }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
  
  \CommentTok{# Extraire les variables correspondantes ----------------}
  \CommentTok{# Utiliser toutes les variables si non-spécifiées dans les paramètres}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(preds)) \{}
\NormalTok{    preds <-}\StringTok{ }\KeywordTok{names}\NormalTok{(image)}
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(bioclim)) preds <-}\StringTok{ }\KeywordTok{c}\NormalTok{(preds, }\KeywordTok{names}\NormalTok{(bioclim))}
\NormalTok{  \}}
  \CommentTok{# Extraire les variables Landsat ...}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"    -Extracting pixel values for bands:"}\NormalTok{, preds, }\StringTok{"... "}\NormalTok{)}
\NormalTok{  train.pts <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(image, train.pts, }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)}
  \CommentTok{# ... et Bioclim}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(bioclim)) train.pts <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(bioclim, train.pts, }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)}
  \CommentTok{# Ignorer des lignes avec NAs}
\NormalTok{  train.dat <-}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(train.pts}\OperatorTok{@}\NormalTok{data)[, }\KeywordTok{c}\NormalTok{(}\StringTok{"CLASS"}\NormalTok{, preds)]}
  
  \CommentTok{# Calibration du modèle Random Forest -------------------}
  \CommentTok{# Variable catégorielle -> mode de classification, autrement -> régression}
  \ControlFlowTok{if}\NormalTok{(type}\OperatorTok{==}\StringTok{"classification"}\NormalTok{) train.dat[,}\DecValTok{1}\NormalTok{] <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(train.dat[,}\DecValTok{1}\NormalTok{])}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"done}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"    -Calibrating RandomForest ... "}\NormalTok{)}
  \KeywordTok{sink}\NormalTok{(txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
  \CommentTok{# Utiliser caret::train pour validation croisée (a besoin de beaucoup de temps)}
  \ControlFlowTok{if}\NormalTok{(crossval) \{}
\NormalTok{    map.model.cv <-}\StringTok{ }\KeywordTok{train}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ train.dat[,}\DecValTok{1}\NormalTok{], }
                          \DataTypeTok{x =}\NormalTok{ train.dat[,}\OperatorTok{-}\DecValTok{1}\NormalTok{],}
                          \DataTypeTok{method =} \StringTok{"rf"}\NormalTok{,              }\CommentTok{# RandomForest}
                          \DataTypeTok{importance =} \OtherTok{TRUE}\NormalTok{,}
                          \DataTypeTok{trControl =} \KeywordTok{trainControl}\NormalTok{(}
                            \DataTypeTok{method =} \StringTok{"repeatedcv"}\NormalTok{,}
                            \DataTypeTok{number =} \DecValTok{10}\NormalTok{,              }\CommentTok{# k-fold}
                            \DataTypeTok{repeats =} \DecValTok{3}\NormalTok{))             }\CommentTok{# répétitions}
    \KeywordTok{print}\NormalTok{(map.model.cv)}
\NormalTok{    map.model <-}\StringTok{ }\NormalTok{map.model.cv}\OperatorTok{$}\NormalTok{finalModel}
    \KeywordTok{print}\NormalTok{(map.model)}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \KeywordTok{print}\NormalTok{(}\KeywordTok{varImp}\NormalTok{(map.model, }\DataTypeTok{scale=}\OtherTok{FALSE}\NormalTok{))}
  \CommentTok{# autrement randomForest directement}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    map.model <-}\StringTok{ }\KeywordTok{randomForest}\NormalTok{(}\DataTypeTok{y=}\NormalTok{train.dat[,}\DecValTok{1}\NormalTok{], }\DataTypeTok{x=}\NormalTok{train.dat[,}\OperatorTok{-}\DecValTok{1}\NormalTok{], }\DataTypeTok{importance=}\OtherTok{TRUE}\NormalTok{) }\CommentTok{# , do.trace=100)}
    \CommentTok{#}
    \CommentTok{# Parallélisation de RandomForest : cpossible, mais confusion, err.rate, mse et rsq seront NULL}
    \CommentTok{# https://stackoverflow.com/questions/14106010/parallel-execution-of-random-forest-in-r}
    \CommentTok{# map.model <- foreach(ntree=rep(100, 5), .combine=randomForest::combine, .multicombine=TRUE, .packages='randomForest') %dopar% \{}
    \CommentTok{#                 randomForest(x=ref.pts[,!(names(ref.pts) == "CLASS")], y=ref.pts$CLASS, importance=TRUE, ntree=ntree)}
    \CommentTok{#  }
    \KeywordTok{print}\NormalTok{(map.model)}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \KeywordTok{print}\NormalTok{(}\KeywordTok{varImp}\NormalTok{(map.model))}
\NormalTok{  \}}
  \KeywordTok{sink}\NormalTok{()}
  \CommentTok{# Mesures des erreurs}
  \ControlFlowTok{if}\NormalTok{(type}\OperatorTok{==}\StringTok{"treecover"}\NormalTok{) \{}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"R2:"}\NormalTok{, }\KeywordTok{round}\NormalTok{(map.model}\OperatorTok{$}\NormalTok{rsq[}\DecValTok{500}\NormalTok{], }\DecValTok{2}\NormalTok{), }\StringTok{"RMSE:"}\NormalTok{, }\KeywordTok{round}\NormalTok{(}\KeywordTok{sqrt}\NormalTok{(map.model}\OperatorTok{$}\NormalTok{mse[}\DecValTok{500}\NormalTok{]), }\DecValTok{2}\NormalTok{), }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"OOB error rate:"}\NormalTok{, }\KeywordTok{round}\NormalTok{(map.model}\OperatorTok{$}\NormalTok{err.rate[}\DecValTok{500}\NormalTok{,}\DecValTok{1}\NormalTok{], }\DecValTok{2}\NormalTok{), }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
  
  \CommentTok{# Classification de la carte forêt/non-forêt ------------}
  \KeywordTok{dir.create}\NormalTok{(}\KeywordTok{dirname}\NormalTok{(filename), }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{showWarnings=}\OtherTok{FALSE}\NormalTok{)}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"    -Creating map ... "}\NormalTok{)}
  \CommentTok{# empiler les couches Landsat et bioclim}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(bioclim)) image <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(image, }\KeywordTok{crop}\NormalTok{(bioclim, image))}
  \CommentTok{# classifier l'image sur différents procésseurs en parallèle}
  \KeywordTok{beginCluster}\NormalTok{(}\DataTypeTok{n=}\NormalTok{n.cores)}
\NormalTok{  map <-}\StringTok{ }\KeywordTok{clusterR}\NormalTok{(image, predict, }\DataTypeTok{args=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{model=}\NormalTok{map.model))}
  \KeywordTok{endCluster}\NormalTok{()}
  \CommentTok{# sauvegarder la carte}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"writing map ... "}\NormalTok{)}
  \CommentTok{# convertir en %, si c'est une carte couverture houppier}
  \ControlFlowTok{if}\NormalTok{(type}\OperatorTok{==}\StringTok{"treecover"}\NormalTok{) map <-}\StringTok{ }\KeywordTok{floor}\NormalTok{(map}\OperatorTok{*}\DecValTok{100}\NormalTok{) }
\NormalTok{  map <-}\StringTok{ }\KeywordTok{writeRaster}\NormalTok{(map, }\DataTypeTok{filename=}\NormalTok{filename, }\DataTypeTok{format=}\StringTok{"GTiff"}\NormalTok{, }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"done}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  
  \CommentTok{# Calculer une carte de probabilité ---------------------}
  \ControlFlowTok{if}\NormalTok{(prob}\OperatorTok{==}\OtherTok{TRUE}\NormalTok{) \{}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"    -Creating probability map ... "}\NormalTok{)}
    \KeywordTok{beginCluster}\NormalTok{(}\DataTypeTok{n=}\NormalTok{n.cores)}
\NormalTok{    prob.map <-}\StringTok{ }\KeywordTok{clusterR}\NormalTok{(image, predict, }\DataTypeTok{args=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{model=}\NormalTok{map.model, }\DataTypeTok{type=}\StringTok{"prob"}\NormalTok{))}
    \KeywordTok{endCluster}\NormalTok{()}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"writing map ... "}\NormalTok{)}
    \KeywordTok{writeRaster}\NormalTok{(prob.map, }\DataTypeTok{filename=}\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif"}\NormalTok{, }\StringTok{"_prob.tif"}\NormalTok{, filename), }\DataTypeTok{format=}\StringTok{"GTiff"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"done}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    prob.map <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{  \}}
  
  \KeywordTok{cat}\NormalTok{(}\StringTok{"-- Done: "}\NormalTok{, }\KeywordTok{basename}\NormalTok{(filename), }\StringTok{"/"}\NormalTok{, }\KeywordTok{date}\NormalTok{(), }\StringTok{" --}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
  
  \KeywordTok{invisible}\NormalTok{(}\KeywordTok{list}\NormalTok{(}
    \StringTok{"model"}\NormalTok{  =}\StringTok{ }\NormalTok{map.model,}
    \StringTok{"map"}\NormalTok{    =}\StringTok{ }\NormalTok{map,}
    \StringTok{"prob"}\NormalTok{   =}\StringTok{ }\NormalTok{prob.map}
\NormalTok{  ))}
\NormalTok{\}}


\CommentTok{# COMMENCER LE TRAITEMENT #####################################################}

\CommentTok{# Charger images 2018 ---------------------------------------------------------}
\NormalTok{ref.p192 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(LANDSAT.DIR, }\StringTok{"/p192/p192_2018_m.tif"}\NormalTok{))}
\NormalTok{ref.p193 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(LANDSAT.DIR, }\StringTok{"/p193/p193_2018_m.tif"}\NormalTok{))}
\NormalTok{ref.p194 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(LANDSAT.DIR, }\StringTok{"/p194/p194_2018_m.tif"}\NormalTok{))}
\KeywordTok{names}\NormalTok{(ref.p192) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(ref.p193) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(ref.p194) <-}\StringTok{ }\NormalTok{SST.LSBANDS}
\NormalTok{ref.images <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{p192=}\NormalTok{ref.p192, }\DataTypeTok{p193=}\NormalTok{ref.p193, }\DataTypeTok{p194=}\NormalTok{ref.p194)}

\CommentTok{# Détérminer le nombre de pixels non-NA}
\NormalTok{N.PIXELS <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{p192 =} \KeywordTok{ncell}\NormalTok{(ref.p192[[}\StringTok{"B"}\NormalTok{]]) }\OperatorTok{-}\StringTok{ }\KeywordTok{summary}\NormalTok{(ref.p192)[}\StringTok{"NA's"}\NormalTok{,}\StringTok{"B"}\NormalTok{],}
                 \DataTypeTok{p193 =} \KeywordTok{ncell}\NormalTok{(ref.p193[[}\StringTok{"B"}\NormalTok{]]) }\OperatorTok{-}\StringTok{ }\KeywordTok{summary}\NormalTok{(ref.p193)[}\StringTok{"NA's"}\NormalTok{,}\StringTok{"B"}\NormalTok{],}
                 \DataTypeTok{p194 =} \KeywordTok{ncell}\NormalTok{(ref.p194[[}\StringTok{"B"}\NormalTok{]]) }\OperatorTok{-}\StringTok{ }\KeywordTok{summary}\NormalTok{(ref.p194)[}\StringTok{"NA's"}\NormalTok{,}\StringTok{"B"}\NormalTok{])}

\CommentTok{# Charger variables bioclim}
\NormalTok{bioclim.p192 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(WORLDCLIM.DIR, }\StringTok{"/p192/p192_bioclim.tif"}\NormalTok{))}
\NormalTok{bioclim.p193 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(WORLDCLIM.DIR, }\StringTok{"/p193/p193_bioclim.tif"}\NormalTok{))}
\NormalTok{bioclim.p194 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(WORLDCLIM.DIR, }\StringTok{"/p194/p194_bioclim.tif"}\NormalTok{))}
\KeywordTok{names}\NormalTok{(bioclim.p192) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(bioclim.p193) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(bioclim.p194) <-}\StringTok{ }\NormalTok{SST.BIOCLIM}
\NormalTok{bioclim <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{p192=}\NormalTok{bioclim.p192, }\DataTypeTok{p193=}\NormalTok{bioclim.p193, }\DataTypeTok{p194=}\NormalTok{bioclim.p194)}


\CommentTok{# Charger points d'entraînement -----------------------------------------------}
\NormalTok{train.plots <-}\StringTok{ }\KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.SST.BDD.TPS, }\StringTok{"/COV_parcelles.shp"}\NormalTok{))}
\NormalTok{train.plots <-}\StringTok{ }\NormalTok{train.plots[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(train.plots}\OperatorTok{$}\NormalTok{ccov),  }\CommentTok{# couverture des houppiers!}
                           \KeywordTok{c}\NormalTok{(}\StringTok{"PLOTID"}\NormalTok{, }\StringTok{"ccov"}\NormalTok{, }\StringTok{"img_date"}\NormalTok{, }\StringTok{"author"}\NormalTok{)]}

\CommentTok{# Convertir les polygones des parcelles en points spatiaux (centroïdes)}
\NormalTok{train.points <-}\StringTok{ }\KeywordTok{SpatialPointsDataFrame}\NormalTok{(}\KeywordTok{gCentroid}\NormalTok{(train.plots, }\DataTypeTok{byid=}\OtherTok{TRUE}\NormalTok{),  }
                                       \KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{author=}\NormalTok{train.plots}\OperatorTok{$}\NormalTok{author, }
                                                  \DataTypeTok{ccov=}\NormalTok{train.plots}\OperatorTok{$}\NormalTok{ccov, }
                                                  \DataTypeTok{img_date=}\KeywordTok{as.Date}\NormalTok{(train.plots}\OperatorTok{$}\NormalTok{img_date)))}

\CommentTok{# Pour la calibration de l'image 2018, sélectionner uniquement les points }
\CommentTok{# d'entraînement dont la date de l'image GoogleEarth est entre le 1.1.2017 et le 31.12.2019}
\NormalTok{train.points <-}\StringTok{ }\NormalTok{train.points[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(train.points}\OperatorTok{$}\NormalTok{img_date) }\OperatorTok{&}\StringTok{ }
\StringTok{                             }\NormalTok{train.points}\OperatorTok{$}\NormalTok{img_date }\OperatorTok{>}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\StringTok{"2017-01-01"}\NormalTok{) }\OperatorTok{&}\StringTok{ }
\StringTok{                             }\NormalTok{train.points}\OperatorTok{$}\NormalTok{img_date }\OperatorTok{<=}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\StringTok{"2019-12-31"}\NormalTok{), ]}

\CommentTok{# Illustrer la répartition des observations }
\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/training-pts_2018.pdf"}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(train.points)}
\KeywordTok{dev.off}\NormalTok{()}

\CommentTok{# Extraire les valeurs d'image pour les points d'entraînement (en parallèle)}
\KeywordTok{registerDoParallel}\NormalTok{(CORES)}
\NormalTok{train.points <-}\StringTok{ }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{i=}\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(ref.images), }\DataTypeTok{.combine=}\NormalTok{rbind) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
\NormalTok{  pts <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(ref.images[[i]], train.points, }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  pts <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(bioclim[[i]], pts, }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  pts}\OperatorTok{$}\NormalTok{image <-}\StringTok{ }\KeywordTok{names}\NormalTok{(ref.images[i])}
\NormalTok{  pts[, }\KeywordTok{c}\NormalTok{(}\StringTok{"author"}\NormalTok{, }\StringTok{"image"}\NormalTok{, }\StringTok{"ccov"}\NormalTok{, SSTS.BANDS, SSTS.BIOCLIM)]}
\NormalTok{\}}

\CommentTok{# Supprimer les lignes avec des NA}
\NormalTok{train.points <-}\StringTok{ }\NormalTok{train.points[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(train.points}\OperatorTok{@}\NormalTok{data[,}\OperatorTok{-}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{2}\NormalTok{)])), ]}

\CommentTok{# Réorganiser le tableau des attributs (F10: forêt/non-forêt à 10% / F30: à 30%)}
\NormalTok{train.points}\OperatorTok{@}\NormalTok{data <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(train.points}\OperatorTok{@}\NormalTok{data[,}\KeywordTok{c}\NormalTok{(}\StringTok{"image"}\NormalTok{, }\StringTok{"ccov"}\NormalTok{)],}
                           \DataTypeTok{F10=}\KeywordTok{cut}\NormalTok{(train.points}\OperatorTok{$}\NormalTok{ccov, }
                                   \DataTypeTok{breaks=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.0}\NormalTok{,}\FloatTok{0.1}\NormalTok{,}\FloatTok{1.0}\NormalTok{), }\DataTypeTok{labels=}\KeywordTok{c}\NormalTok{(NONFOR, FOREST), }
                                   \DataTypeTok{right=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{include.lowest=}\OtherTok{TRUE}\NormalTok{), }
                           \DataTypeTok{F30=}\KeywordTok{cut}\NormalTok{(train.points}\OperatorTok{$}\NormalTok{ccov, }
                                   \DataTypeTok{breaks=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.0}\NormalTok{,}\FloatTok{0.3}\NormalTok{,}\FloatTok{1.0}\NormalTok{), }\DataTypeTok{labels=}\KeywordTok{c}\NormalTok{(NONFOR, FOREST), }
                                   \DataTypeTok{right=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{include.lowest=}\OtherTok{TRUE}\NormalTok{), }
\NormalTok{                           train.points}\OperatorTok{@}\NormalTok{data[,}\KeywordTok{c}\NormalTok{(SSTS.LSBANDS, SSTS.BIOCLIM)])}


\CommentTok{# Séléction des variables explicatives ----------------------------------------}

\NormalTok{cov.varsel <-}\StringTok{ }\KeywordTok{rfe}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ train.points}\OperatorTok{@}\NormalTok{data[train.points}\OperatorTok{$}\NormalTok{image}\OperatorTok{==}\StringTok{"p193"}\NormalTok{, }\StringTok{"ccov"}\NormalTok{],}
                  \DataTypeTok{x =}\NormalTok{ train.points}\OperatorTok{@}\NormalTok{data[train.points}\OperatorTok{$}\NormalTok{image}\OperatorTok{==}\StringTok{"p193"}\NormalTok{, PREDICTORS],}
                  \DataTypeTok{sizes =} \KeywordTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{10}\NormalTok{),}
                  \DataTypeTok{rfeControl =} \KeywordTok{rfeControl}\NormalTok{(}
                    \DataTypeTok{functions =}\NormalTok{ rfFuncs,      }\CommentTok{# utiliser RandomForest}
                    \DataTypeTok{method  =} \StringTok{"repeatedcv"}\NormalTok{,   }\CommentTok{# validation croisée}
                    \DataTypeTok{number  =} \DecValTok{10}\NormalTok{,             }\CommentTok{# 10-fold}
                    \DataTypeTok{repeats =} \DecValTok{3}\NormalTok{))             }\CommentTok{# 3 répétitions}
\KeywordTok{print}\NormalTok{(cov.varsel)}
\KeywordTok{predictors}\NormalTok{(cov.varsel)}
\KeywordTok{plot}\NormalTok{(cov.varsel, }\DataTypeTok{type=}\KeywordTok{c}\NormalTok{(}\StringTok{"g"}\NormalTok{, }\StringTok{"o"}\NormalTok{))}


\CommentTok{# Carte de la couverture des houppiers pour 2018 (}\AlertTok{TODO}\CommentTok{) -----------------------}

\KeywordTok{set.seed}\NormalTok{(RSEED)}
\NormalTok{p193.}\FloatTok{2018.}\NormalTok{cov <-}\StringTok{ }\KeywordTok{classify.image}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p193/p193_2018_m.tif"}\NormalTok{), }
                                \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p193"}\NormalTok{]],}
                                \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2018_COV_R.tif"}\NormalTok{),}
                                \DataTypeTok{train.pts =}\NormalTok{ train.points[train.points}\OperatorTok{$}\NormalTok{image }\OperatorTok{==}\StringTok{ "p193"}\NormalTok{, }\StringTok{"ccov"}\NormalTok{],}
                                \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                                \DataTypeTok{type      =} \StringTok{"treecover"}\NormalTok{,}
                                \DataTypeTok{crossval  =} \OtherTok{TRUE}\NormalTok{,}
                                \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{)}

\CommentTok{# observé vs. prédit}
\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2018_COV_R.pdf"}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(p193.}\FloatTok{2018.}\NormalTok{cov[[}\StringTok{"model"}\NormalTok{]]}\OperatorTok{$}\NormalTok{y, p193.}\FloatTok{2018.}\NormalTok{cov[[}\StringTok{"model"}\NormalTok{]]}\OperatorTok{$}\NormalTok{predicted, }\DataTypeTok{xlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\DataTypeTok{ylim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }
     \DataTypeTok{main=}\StringTok{"Couverture houppier p193"}\NormalTok{, }\DataTypeTok{xlab=}\StringTok{"Observation"}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Prédiction"}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}

\CommentTok{# Cartes de référence du couvert forestier 2018 -------------------------------}

\CommentTok{# Chemin WRS p193}
\KeywordTok{set.seed}\NormalTok{(RSEED)}
\KeywordTok{classify.image}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p193/p193_2018_m.tif"}\NormalTok{), }
               \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p193"}\NormalTok{]],}
               \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193_2018_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{),}
               \DataTypeTok{train.pts =}\NormalTok{ train.points[train.points}\OperatorTok{$}\NormalTok{image }\OperatorTok{==}\StringTok{ "p193"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"F"}\NormalTok{, COV.FC)],}
               \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
               \DataTypeTok{prob      =} \OtherTok{TRUE}\NormalTok{,}
               \DataTypeTok{crossval  =} \OtherTok{TRUE}\NormalTok{,}
               \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{)  }

\CommentTok{# Chemins WRS p192 and p194, utilisant p193 pour calibration}
\KeywordTok{set.seed}\NormalTok{(RSEED)}
\KeywordTok{registerDoParallel}\NormalTok{(CORES)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{path=}\KeywordTok{c}\NormalTok{(}\StringTok{"p192"}\NormalTok{, }\StringTok{"p194"}\NormalTok{)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{   }\CommentTok{# traitement en parallèle}
\NormalTok{  train.pts <-}\StringTok{ }\NormalTok{train.points[train.points}\OperatorTok{$}\NormalTok{image }\OperatorTok{==}\StringTok{ }\NormalTok{path, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"F"}\NormalTok{, COV.FC)]}
  \KeywordTok{classify.image}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"/"}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"_2018_m.tif"}\NormalTok{)), }
                 \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[path]],}
                 \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"_2018_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{),}
                 \DataTypeTok{train.pts =}\NormalTok{ train.pts,}
                 \CommentTok{# calibration avec carte p193 ...}
                 \DataTypeTok{cal.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193_2018_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{)),}
                 \DataTypeTok{n.cal.map =} \KeywordTok{max}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(train.pts)}\OperatorTok{/}\NormalTok{CAL.RATIO),  }\CommentTok{# ... avec au moin 2000 points}
                 \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                 \DataTypeTok{mask      =}\NormalTok{ TGO,}
                 \DataTypeTok{prob      =} \OtherTok{TRUE}\NormalTok{,}
                 \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{)}
\NormalTok{\}}

\CommentTok{# Cartes de référence du couvert forestier 2003 -----------------------------------------}

\CommentTok{# Chemin WRS p193}
\KeywordTok{set.seed}\NormalTok{(RSEED)}
\KeywordTok{classify.image}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p193/p193_2003_m.tif"}\NormalTok{), }
               \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p193"}\NormalTok{]],}
               \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193_2003_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{),}
               \CommentTok{# sur base de la carte de référence 2018}
               \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193_2018_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{)),}
               \DataTypeTok{n.ref.map =} \DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p193"}\NormalTok{]],}
               \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
               \DataTypeTok{mask      =}\NormalTok{ TGO,}
               \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{)}

\CommentTok{# Chemins WRS p192 and p194, utilisant p193 pour calibration}
\KeywordTok{set.seed}\NormalTok{(RSEED)}
\KeywordTok{registerDoParallel}\NormalTok{(CORES)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{path=}\KeywordTok{c}\NormalTok{(}\StringTok{"p192"}\NormalTok{, }\StringTok{"p194"}\NormalTok{)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{   }\CommentTok{# traitement en parallèle}
  \KeywordTok{classify.image}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"/"}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"_2003_m.tif"}\NormalTok{)), }
                 \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[path]],}
                 \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"_2003_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{),}
                 \CommentTok{# sur base de la carte de référence 2018 ...}
                 \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"_2018_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{)),}
                 \DataTypeTok{n.ref.map =} \DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{CAL.RATIO) }\OperatorTok{*}\StringTok{ }\NormalTok{SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[path]],}
                 \CommentTok{# ... et calibration avec carte p193 ...}
                 \DataTypeTok{cal.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193_2003_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{)),}
                 \DataTypeTok{n.cal.map =} \DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{CAL.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[path]],}
                 \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                 \DataTypeTok{mask      =}\NormalTok{ TGO,}
                 \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{)}
\NormalTok{\}}


\CommentTok{# Cartes du couvert forestier brutes pour toutes les dates --------------------}

\CommentTok{# Chemin WRS p193}
\KeywordTok{set.seed}\NormalTok{(RSEED)}
\KeywordTok{registerDoParallel}\NormalTok{(CORES)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{file=}\KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(LANDSAT.DIR, }\StringTok{"/p193"}\NormalTok{), }\DataTypeTok{pattern=}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_[[:digit:]]+}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_m}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif"}\NormalTok{)) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
  \KeywordTok{classify.image}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"/p193/"}\NormalTok{, file)), }
                 \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p193"}\NormalTok{]],}
                 \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193/"}\NormalTok{, }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_m}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif$"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{), file)),}
                 \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193_2003_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{)),}
                 \DataTypeTok{n.ref.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p193"}\NormalTok{]],}
                 \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                 \DataTypeTok{mask      =}\NormalTok{ TGO,}
                 \DataTypeTok{n.cores   =} \DecValTok{6}\NormalTok{)}
\NormalTok{\}}

\CommentTok{# fusionner les deux tuiles p193_1990}
\KeywordTok{merge}\NormalTok{(}\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193/p193_1990_1_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{)), }
      \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193/p193_1990_2_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{)),}
      \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193/p193_1990_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{), }
      \DataTypeTok{format=}\StringTok{"GTiff"}\NormalTok{, }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# Chemins WRS p192 and p194, utilisant ...}
\KeywordTok{set.seed}\NormalTok{(RSEED)}
\KeywordTok{registerDoParallel}\NormalTok{(CORES)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{file=}\KeywordTok{c}\NormalTok{(}\KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(LANDSAT.DIR, }\StringTok{"/p192"}\NormalTok{), }\DataTypeTok{pattern=}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_[[:digit:]]+}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_m}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif"}\NormalTok{),}
               \KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(LANDSAT.DIR, }\StringTok{"/p194"}\NormalTok{), }\DataTypeTok{pattern=}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_[[:digit:]]+}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_m}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif"}\NormalTok{))) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{ }
\NormalTok{  path <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_.*"}\NormalTok{, }\StringTok{""}\NormalTok{, file)}
  \CommentTok{# ... carte p193 pour la calibration (s'il existe, pour la même année)}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{file.exists}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193/"}\NormalTok{, }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_m}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif$"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{), }\KeywordTok{sub}\NormalTok{(path, }\StringTok{"p193"}\NormalTok{, file))))) \{}
\NormalTok{    cal.map   <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193/"}\NormalTok{, }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_m}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif$"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{), }\KeywordTok{sub}\NormalTok{(path, }\StringTok{"p193"}\NormalTok{, file))))}
\NormalTok{    n.cal.map <-}\StringTok{ }\NormalTok{CAL.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[path]]}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    cal.map <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{    n.cal.map <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{  \}}
  \KeywordTok{classify.image}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"/"}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, file)), }
                 \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[path]],}
                 \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_m}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif$"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{), file)),}
                 \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"_2003_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{)),}
                 \DataTypeTok{n.ref.map =}\NormalTok{ (}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{CAL.RATIO) }\OperatorTok{*}\StringTok{ }\NormalTok{SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[path]],}
                 \DataTypeTok{cal.map   =}\NormalTok{ cal.map,}
                 \DataTypeTok{n.cal.map =}\NormalTok{ n.cal.map,}
                 \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                 \DataTypeTok{mask      =}\NormalTok{ TGO,}
                 \DataTypeTok{n.cores   =} \DecValTok{6}\NormalTok{)}
\NormalTok{\} }


\CommentTok{# Fusionner les cartes des chemins p192, p193 et p194 pour dates clés ... -----}

\ControlFlowTok{for}\NormalTok{(year }\ControlFlowTok{in}\NormalTok{ YEARS.REF) \{}
  \KeywordTok{merge}\NormalTok{(}\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193/p193_"}\NormalTok{, year, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{)),TGO), TGO),}
        \KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p192/p192_"}\NormalTok{, year, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{)),TGO), TGO),}
        \KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p194/p194_"}\NormalTok{, year, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{)),TGO), TGO),}
        \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO/TGO_"}\NormalTok{, year, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{), }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}        }

\CommentTok{# ... et le cartes de référence 2018 et 2003}
\ControlFlowTok{for}\NormalTok{(map }\ControlFlowTok{in} \KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"2018_FC"}\NormalTok{, COV.FC, }\StringTok{"_R"}\NormalTok{), }
             \KeywordTok{paste0}\NormalTok{(}\StringTok{"2018_FC"}\NormalTok{, COV.FC, }\StringTok{"_R_prob"}\NormalTok{),}
             \KeywordTok{paste0}\NormalTok{(}\StringTok{"2003_FC"}\NormalTok{, COV.FC, }\StringTok{"_R"}\NormalTok{))) \{}
  \KeywordTok{merge}\NormalTok{(}\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193_"}\NormalTok{, map, }\StringTok{".tif"}\NormalTok{)),TGO), TGO),}
        \KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p192_"}\NormalTok{, map, }\StringTok{".tif"}\NormalTok{)),TGO), TGO),}
        \KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p194_"}\NormalTok{, map, }\StringTok{".tif"}\NormalTok{)),TGO), TGO),}
        \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO_"}\NormalTok{, map, }\StringTok{".tif"}\NormalTok{), }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{NRF-clean-fc-maps}{%
\subsubsection{Nettoyage des cartes brutes}\label{NRF-clean-fc-maps}}

Les series temporelles des cartes forêt/non-forêt brutes sont \textbf{lissées et filtrées pixel par pixel} pour les raisons suivantes:

\begin{itemize}
\tightlist
\item
  Remplissage des \textbf{données manquantes} (nuages, ombres, L7 SLC-off),
\item
  Lissage des \textbf{bruits} (pixels qui changent entre forêt et non-forêt plusieurs fois)
\item
  Filtrer la \textbf{régénération temporaire par les fourrés}, observée sur les jachères.
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  La première étappe, est la \textbf{remplissage des données manquantes}: les données manquantes entre deux observations de forêt deviennent forêt, celles entre deux observations de non-forêt deviennent non-forêt.
\end{enumerate}

\includegraphics{images/FCC-clean-1.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Ensuite, une \textbf{fenêtre coulissante de taille 5} est appliquée, c'est-à-dire qu'une observation est attribuée à la classe qui est observé le plus fréquemment dans la fenêtre qui inclu les deux observations précédentes et les deux suivantes. Pour l'évaluation de la deuxième et de l'avant-dernière observation, une fenêtre coulissante de taille 3 est appliquée. \textbf{La première et la dernière observation ne sont pas ajustées, il faut les ignorer dans la suite.} Les observations manquantes sont remplis dans la mesure possible. Toute la procédure est répétée jusqu'à ce qu'il n'y a plus de changements.
\end{enumerate}

\includegraphics{images/FCC-clean-2.png}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Les années manquantes sont ajoutées pour créer une série annuelle. Les observations manquantes sont remplacées par la classe de l'observation précédente. Lorsque les observations initiales sont manquantes, elles sont remplacées par la classe de l'observation suivante. \textbf{Dans les situations de régénération (forêt suit non-forêt), les 9 premières années sont marquées comme ``reboisement potentiel''. Si la forêt disparaît à nouveau après moins de 10 ans, les observations sont remplacées par la classe non-forêt. Si la régénération reste, elle est considérée comme un reboisement après 10 ans.}
\end{enumerate}

\includegraphics{images/FCC-clean-3.png}

Après la nettoyage des séries temporelles pixel par pixel, \textbf{une nettoyage spatiale} est réalisé pour éliminer les surfaces forestières \textless{} 0,5 hectares. Pour cela, une carte est créée de tous les pixels qui étaient une fois observées comme forêt sur toute la série des cartes. Sur cette carte, toutes les surfaces forestières ayant moins de 6 pixels liés (soit moins de 0,54 hectares) sont éliminées. Ce masque forestier est ensuite appliqué à toutes les cartes forêt/non-forêt de la série. Cela signifie que \textbf{seuls les pixels forestier qui ont fait partie d'une surface forestière ≥ 0,54 hectares dans la série des cartes sont retenus comme forêt.}

\hypertarget{NRF-clean-fc-maps-figure}{%
\paragraph{Example}\label{NRF-clean-fc-maps-figure}}
\addcontentsline{toc}{paragraph}{Example}

La figure suivante montre les \textbf{cartes forêt/non-forêt après la nettoyage temporelle et spatiale} pour une région au sud de Kpalimé (voir \protect\hyperlink{NRF-create-fc-maps-figure}{série des cartes brutes} pour comparaison).

\includegraphics{images/FCC-clnmaps.png}

\hypertarget{script-r-03_nrf-mrv01_mcf_src02_clean-fc-maps.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{03\_NRF-MRV/01\_MCF/\_src/02\_clean-fc-maps.R}}{Script R: 03\_NRF-MRV/01\_MCF/\_src/02\_clean-fc-maps.R}}\label{script-r-03_nrf-mrv01_mcf_src02_clean-fc-maps.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{03\_NRF-MRV/01\_MCF/\_src/02\_clean-fc-maps.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# 02_clean-fc-maps.R: nettoyage des cartes brutes du couvert forestier}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}


\CommentTok{# Définitions des variables ===================================================}

\NormalTok{COV.FC         <-}\StringTok{ }\DecValTok{30}

\NormalTok{RAW.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.MCF.RAW}
\NormalTok{CLN.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.MCF.CLN}

\CommentTok{# Définitions des fonctions ===================================================}

\CommentTok{# Nettoyage temporel d'une série d'images -------------------------------------}
\CommentTok{#}
\CommentTok{# @param path  Chemin WRS}
\CommentTok{#}
\CommentTok{# @return       -- }
\CommentTok{#}

\NormalTok{clean.temporal <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(path) \{}

  \CommentTok{# Préparation des images --------------------------------}
  
  \CommentTok{# Charger les cartes brutes}
\NormalTok{  maps <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(}\KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/"}\NormalTok{, path), }
                    \DataTypeTok{pattern=}\StringTok{".*[[:digit:]]\{4\}}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_F.*}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif$"}\NormalTok{, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{))}
\NormalTok{  map.names <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\StringTok{"r$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(maps))}
  \CommentTok{# Noms de cartes à utiliser dans les colonnes de la matrice}
\NormalTok{  map.cols  <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(path, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_"}\NormalTok{), }\StringTok{"X"}\NormalTok{, }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_[[:alnum:]]+$"}\NormalTok{, }\StringTok{"M"}\NormalTok{, map.names))}
  \CommentTok{# Names à utiliser pour les années sans carte}
\NormalTok{  no.map.cols <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"X"}\NormalTok{, YEARS.ALL[}\OperatorTok{!}\NormalTok{YEARS.ALL }\OperatorTok{%in%}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"[[:alpha:]]"}\NormalTok{, }\StringTok{""}\NormalTok{, map.cols)], }\StringTok{"_"}\NormalTok{)}
  \CommentTok{# Joindre et ordonner les noms de colonnes}
\NormalTok{  col.order <-}\StringTok{ }\KeywordTok{c}\NormalTok{(map.cols, no.map.cols)[}\KeywordTok{order}\NormalTok{(}\KeywordTok{c}\NormalTok{(map.cols, no.map.cols))]}
  \CommentTok{# Convertir les cartes en matrice (une carte par colonne, prend du temps)}
\NormalTok{  maps.values <-}\StringTok{ }\KeywordTok{values}\NormalTok{(maps)                           }
  \KeywordTok{colnames}\NormalTok{(maps.values) <-}\StringTok{ }\NormalTok{map.cols}
  
  \CommentTok{# Nettoyage parallèle des trajectoires des pixels -------}
  
  \CommentTok{# Définir des sous-ensembles des pixels (lignes) pour le traitement parallèle}
\NormalTok{  nsubsets <-}\StringTok{ }\NormalTok{CORES               }
\NormalTok{  subsets  <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{floor}\NormalTok{((}\DecValTok{1}\OperatorTok{:}\NormalTok{nsubsets)}\OperatorTok{*}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(maps.values)}\OperatorTok{/}\NormalTok{nsubsets)))    }
  \CommentTok{# Traitement en parallèle}
  \KeywordTok{registerDoParallel}\NormalTok{(CORES)}
\NormalTok{  maps.values.clean <-}\StringTok{ }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{i=}\DecValTok{1}\OperatorTok{:}\NormalTok{nsubsets, }\DataTypeTok{.combine=}\NormalTok{rbind) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
    
    \CommentTok{# 0. obtenir un sous-ensemble à partir de maps.values}
\NormalTok{    val <-}\StringTok{ }\NormalTok{maps.values[(subsets[i]}\OperatorTok{+}\DecValTok{1}\NormalTok{)}\OperatorTok{:}\NormalTok{subsets[i}\OperatorTok{+}\DecValTok{1}\NormalTok{], ]     }
    \CommentTok{# mettre tout en NA qui n'est pas de la forêt ou non-forêt}
\NormalTok{    val[}\OperatorTok{!}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(val) }\OperatorTok{|}\StringTok{ }\NormalTok{val }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(FOREST,NONFOR))] <-}\StringTok{ }\OtherTok{NA}    
    
    \CommentTok{# 1. Supprimer les NA isolées ----}
\NormalTok{    str   <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(val, }\DecValTok{1}\NormalTok{, paste, }\DataTypeTok{collapse=}\StringTok{""}\NormalTok{)  }\CommentTok{# convertir en chaînes de caractères}
\NormalTok{    str.c <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"NA"}\NormalTok{, }\StringTok{"9"}\NormalTok{, str)               }\CommentTok{# remplacer NA avec 9}
    \CommentTok{# Nettoyer jusqu'à la convergence}
    \ControlFlowTok{while}\NormalTok{(}\OperatorTok{!}\KeywordTok{identical}\NormalTok{(str, str.c)) \{             }
\NormalTok{      str <-}\StringTok{ }\NormalTok{str.c}
      \CommentTok{# Mettre NA dans la classe correspondante (forêt ou non-forêt)}
\NormalTok{      str.c <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"^(.*"}\NormalTok{, NONFOR, }\StringTok{")9(9*"}\NormalTok{, NONFOR, }\StringTok{".*)$"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, NONFOR, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{), str.c) }
\NormalTok{      str.c <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"^(.*"}\NormalTok{, FOREST, }\StringTok{")9(9*"}\NormalTok{, FOREST, }\StringTok{".*)$"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, FOREST, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{), str.c)                 }
\NormalTok{    \}                                                       }
    \CommentTok{# Reconvertir en matrice numérique}
\NormalTok{    val <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{strsplit}\NormalTok{(str.c, }\StringTok{""}\NormalTok{))), }\DataTypeTok{ncol=}\KeywordTok{ncol}\NormalTok{(val), }\DataTypeTok{byrow=}\OtherTok{TRUE}\NormalTok{)   }
\NormalTok{    val[val}\OperatorTok{==}\DecValTok{9}\NormalTok{] <-}\StringTok{ }\OtherTok{NA}                           \CommentTok{# remplacer les 9 avec NA}
    \KeywordTok{colnames}\NormalTok{(val) <-}\StringTok{ }\NormalTok{map.cols}
    
    \CommentTok{# 2. nettoyer les trajectoires avec fenêtre coulissante ----}
\NormalTok{    val.c   <-}\StringTok{ }\NormalTok{val}
\NormalTok{    val.o <-}\StringTok{ }\NormalTok{val[] <-}\StringTok{ }\DecValTok{0}
\NormalTok{    iter    <-}\StringTok{ }\DecValTok{0}   
    \CommentTok{# Nettoyer jusqu'à la convergence}
    \ControlFlowTok{while}\NormalTok{(}\OperatorTok{!}\KeywordTok{identical}\NormalTok{(val, val.c) }\OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{identical}\NormalTok{(val.o, val.c)) \{   }
\NormalTok{      iter <-}\StringTok{ }\NormalTok{iter}\OperatorTok{+}\DecValTok{1}
      \KeywordTok{message}\NormalTok{(}\StringTok{"    -Clean modal: iteration "}\NormalTok{, iter, }\StringTok{" ... "}\NormalTok{, }\DataTypeTok{appendLF =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{      val.o <-}\StringTok{ }\NormalTok{val  }\CommentTok{# valeurs actuelles -> anciennes valeurs}
\NormalTok{      val <-}\StringTok{ }\NormalTok{val.c  }\CommentTok{# valeurs nettoyées -> valuers actuelles}
      \CommentTok{# 3ème - 3ème l'année dernière : fenêtre modale taille 5 }
      \ControlFlowTok{for}\NormalTok{(l }\ControlFlowTok{in} \DecValTok{3}\OperatorTok{:}\NormalTok{(}\KeywordTok{ncol}\NormalTok{(val)}\OperatorTok{-}\DecValTok{2}\NormalTok{)) \{                             }
\NormalTok{        val.c[,l] <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(val[,(l}\DecValTok{-2}\NormalTok{)}\OperatorTok{:}\NormalTok{(l}\OperatorTok{+}\DecValTok{2}\NormalTok{)], }\DecValTok{1}\NormalTok{, modal, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{ties=}\StringTok{'NA'}\NormalTok{)}
\NormalTok{      \}}
      \CommentTok{# 2e et 2e l'année dernière : fenêtre modale taille 3 }
      \ControlFlowTok{for}\NormalTok{(l }\ControlFlowTok{in} \KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(val)}\OperatorTok{-}\DecValTok{1}\NormalTok{)) \{                           }
\NormalTok{        val.c[,l] <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(val.c[,(l}\DecValTok{-1}\NormalTok{)}\OperatorTok{:}\NormalTok{(l}\OperatorTok{+}\DecValTok{1}\NormalTok{)], }\DecValTok{1}\NormalTok{, modal, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{ties=}\StringTok{'NA'}\NormalTok{)}
\NormalTok{      \}}
      \KeywordTok{message}\NormalTok{(}\StringTok{"done"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    val <-}\StringTok{ }\NormalTok{val.c    }\CommentTok{# valeurs nettoyées -> valuers actuelles}
    
    \CommentTok{# 3. nettoyage final regexp ----}
    \CommentTok{# ajouter des années sans observation (cartes)}
\NormalTok{    val   <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(val, }\KeywordTok{matrix}\NormalTok{(}\DataTypeTok{nrow=}\KeywordTok{nrow}\NormalTok{(val),                            }
                               \DataTypeTok{ncol=}\KeywordTok{length}\NormalTok{(no.map.cols), }\DataTypeTok{dimnames=}\KeywordTok{list}\NormalTok{(}\OtherTok{NULL}\NormalTok{, no.map.cols)))}
    \CommentTok{# ordonner correctement }
\NormalTok{    val   <-}\StringTok{ }\NormalTok{val[, col.order]                                        }
\NormalTok{    str   <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(val, }\DecValTok{1}\NormalTok{, paste, }\DataTypeTok{collapse=}\StringTok{""}\NormalTok{)           }\CommentTok{# convertir en chaînes de caractères}
\NormalTok{    str.c <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"NA"}\NormalTok{, }\StringTok{"9"}\NormalTok{, str)                        }\CommentTok{# remplacer NA avec 9}
    \CommentTok{# Nettoyer jusqu'à la convergence}
    \ControlFlowTok{while}\NormalTok{(}\OperatorTok{!}\KeywordTok{identical}\NormalTok{(str, str.c)) \{                     }
\NormalTok{      str <-}\StringTok{ }\NormalTok{str.c}
      \CommentTok{# 3.1 remplacer NA par la classe précédente}
\NormalTok{      str.c <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(NONFOR, }\StringTok{"9"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(NONFOR, NONFOR), str.c)                   }
\NormalTok{      str.c <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(FOREST, }\StringTok{"9"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(FOREST, FOREST), str.c)                }
\NormalTok{    \}}
\NormalTok{    str <-}\StringTok{ ""}
    \CommentTok{# Nettoyer jusqu'à la convergence}
    \ControlFlowTok{while}\NormalTok{(}\OperatorTok{!}\KeywordTok{identical}\NormalTok{(str, str.c)) \{                         }
\NormalTok{      str <-}\StringTok{ }\NormalTok{str.c}
      \CommentTok{# 3.2 remplacer NA par la classe suivante}
\NormalTok{      str.c <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"9"}\NormalTok{, NONFOR), }\KeywordTok{paste0}\NormalTok{(NONFOR, NONFOR), str.c)                   }
\NormalTok{      str.c <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"9"}\NormalTok{, FOREST), }\KeywordTok{paste0}\NormalTok{(FOREST, FOREST), str.c)                }
\NormalTok{    \}}
\NormalTok{    str <-}\StringTok{ ""}
    \CommentTok{# Nettoyer jusqu'à la convergence}
    \ControlFlowTok{while}\NormalTok{(}\OperatorTok{!}\KeywordTok{identical}\NormalTok{(str, str.c)) \{}
\NormalTok{      str <-}\StringTok{ }\NormalTok{str.c}
      \CommentTok{# 3.3 suppression des 1 isolés jusqu'à une longueur de 10 (régénération qui est à nouveau perdue)}
\NormalTok{      str.c <-}\KeywordTok{gsub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"^(.*"}\NormalTok{, NONFOR, }\StringTok{")"}\NormalTok{, FOREST, }\StringTok{"("}\NormalTok{, FOREST, }\StringTok{"\{0,9\}"}\NormalTok{, NONFOR, }\StringTok{".*)$"}\NormalTok{), }
                   \KeywordTok{paste0}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, NONFOR, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{), str.c) }
\NormalTok{    \}}
\NormalTok{    str <-}\StringTok{ ""}
    \CommentTok{# Nettoyer jusqu'à la convergence}
    \ControlFlowTok{while}\NormalTok{(}\OperatorTok{!}\KeywordTok{identical}\NormalTok{(str, str.c)) \{}
\NormalTok{      str <-}\StringTok{ }\NormalTok{str.c}
      \CommentTok{# 3.4 considérer la régénération seulement comme une forêt à partir de 10 ans }
      \CommentTok{# avant qu'elle ne soit considérée comme une régénération potentielle PREGEN}
\NormalTok{      str.c <-}\KeywordTok{gsub}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"^(.*"}\NormalTok{,NONFOREST,PREGEN, }\StringTok{"\{0,8\})"}\NormalTok{, FOREST, }\StringTok{"(.*)$"}\NormalTok{), }
                   \KeywordTok{paste0}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, PREGEN, }\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{), str.c)}
\NormalTok{    \}}
\NormalTok{    str <-}\StringTok{ ""}
    \CommentTok{# Reconvertir en matrice numérique}
\NormalTok{    val <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{strsplit}\NormalTok{(str.c, }\StringTok{""}\NormalTok{))), }\DataTypeTok{ncol=}\KeywordTok{ncol}\NormalTok{(val), }\DataTypeTok{byrow=}\OtherTok{TRUE}\NormalTok{) }
\NormalTok{    val[val}\OperatorTok{==}\DecValTok{9}\NormalTok{] <-}\StringTok{ }\OtherTok{NA}                           \CommentTok{# remplacer les 9 avec NA}
    \KeywordTok{colnames}\NormalTok{(val) <-}\StringTok{ }\NormalTok{col.order}
\NormalTok{    val[,}\KeywordTok{grepl}\NormalTok{(}\StringTok{"M$"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(val))]            }\CommentTok{# et extraire les données pour les années des cartes}
\NormalTok{  \}}
  
  \CommentTok{# Sauvegarder le résultat -------------------------------}
  \KeywordTok{values}\NormalTok{(maps) <-}\StringTok{ }\NormalTok{maps.values.clean}
  \CommentTok{# supprimer la première et la dernière carte "non nettoyée"}
  \KeywordTok{writeRaster}\NormalTok{(}\KeywordTok{dropLayer}\NormalTok{(maps, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\KeywordTok{nlayers}\NormalTok{(maps))), }
              \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, map.names[}\DecValTok{2}\OperatorTok{:}\NormalTok{(}\KeywordTok{nlayers}\NormalTok{(maps)}\OperatorTok{-}\DecValTok{1}\NormalTok{)], }\StringTok{"c.tif"}\NormalTok{), }
              \DataTypeTok{bylayer=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{format=}\StringTok{"GTiff"}\NormalTok{, }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
  
  \CommentTok{# écrire des trajectoires dans un fichier texte}
\NormalTok{  maps.strings <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(maps.values.clean, }\DecValTok{1}\NormalTok{, paste, }\DataTypeTok{collapse=}\StringTok{""}\NormalTok{)}
  \KeywordTok{sink}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/"}\NormalTok{, path, }\StringTok{"/Trajectories.txt"}\NormalTok{))}
  \KeywordTok{print}\NormalTok{(}\KeywordTok{table}\NormalTok{(maps.strings))}
  \KeywordTok{sink}\NormalTok{()}

\NormalTok{\}}


\CommentTok{# Nettoyage spatiale d'une série d'images -------------------------------------}
\CommentTok{#}
\CommentTok{# @description Supprimer les pixels de forêt/déforestion/régénération qui n'ont }
\CommentTok{#              JAMAIS fait partie de "forêt > 0,5 ha" depuis 2003}
\CommentTok{#}
\CommentTok{# @param maps           Série des cartes}
\CommentTok{# @param exclude        Cartes à ignorer}
\CommentTok{# @param size           Nombre minimal de pixels connectés}
\CommentTok{# @param connectedness  Nombre de pixels qui comptent comme connectés}
\CommentTok{#}
\CommentTok{# @return       -- }
\CommentTok{#}

\CommentTok{# }
\NormalTok{clean.spatial.forest <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(maps, }\DataTypeTok{exclude =} \OtherTok{NULL}\NormalTok{, }\DataTypeTok{size=}\DecValTok{6}\NormalTok{, }\DataTypeTok{connectedness=}\DecValTok{8}\NormalTok{)\{}
  
\NormalTok{  tmp1 <-}\StringTok{ }\KeywordTok{tempfile}\NormalTok{(}\DataTypeTok{pattern =} \StringTok{""}\NormalTok{, }\DataTypeTok{fileext =} \StringTok{".tif"}\NormalTok{)}
\NormalTok{  tmp2 <-}\StringTok{ }\KeywordTok{tempfile}\NormalTok{(}\DataTypeTok{pattern =} \StringTok{""}\NormalTok{, }\DataTypeTok{fileext =} \StringTok{".tif"}\NormalTok{)}
  
\NormalTok{  fcc.map <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(maps[[}\OperatorTok{-}\NormalTok{exclude]][], }\DecValTok{1}\NormalTok{, paste, }\DataTypeTok{collapse=}\StringTok{""}\NormalTok{)}
\NormalTok{  onceforest.map <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(maps)}
\NormalTok{  onceforest.map[] <-}\StringTok{ }\OtherTok{NA} 
  
  \CommentTok{# créer une carte "forêt une fois"}
\NormalTok{  onceforest.map[}\KeywordTok{grepl}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"^"}\NormalTok{, NONFOR, }\StringTok{"*$"}\NormalTok{),    fcc.map)] <-}\StringTok{ }\NormalTok{NONFOR}
\NormalTok{  onceforest.map[}\KeywordTok{grepl}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"^.*"}\NormalTok{, FOREST, }\StringTok{".*$"}\NormalTok{), fcc.map)] <-}\StringTok{ }\NormalTok{FOREST}
\NormalTok{  onceforest.map[}\KeywordTok{grepl}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"^.*"}\NormalTok{, PREGEN, }\StringTok{".*$"}\NormalTok{), fcc.map)] <-}\StringTok{ }\NormalTok{FOREST}
  \KeywordTok{writeRaster}\NormalTok{(onceforest.map, tmp1)}
  
  \CommentTok{# supprimer les parcelles de forêt isolées < xy ha}
  \KeywordTok{system}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"gdal_sieve.py -st "}\NormalTok{, size, }\StringTok{" -"}\NormalTok{, connectedness, }\StringTok{" -nomask "}\NormalTok{, tmp1, }\StringTok{" "}\NormalTok{, tmp2))}
\NormalTok{  onceforest.map.clean <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(tmp2)}
\NormalTok{  onceforest.map.clean[onceforest.map.clean }\OperatorTok{==}\StringTok{ }\DecValTok{-2147483648}\NormalTok{] <-}\StringTok{ }\OtherTok{NA}
                                                        
  \CommentTok{# masquer les cartes avec cette carte forestière nettoyée}
\NormalTok{  maps.clean <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(maps, onceforest.map.clean, }\DataTypeTok{maskvalue=}\NormalTok{NONFOR, }\DataTypeTok{updatevalue=}\NormalTok{NONFOR)}
  \KeywordTok{writeRaster}\NormalTok{(maps.clean, }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO/"}\NormalTok{, }\KeywordTok{names}\NormalTok{(maps.clean), }\StringTok{"f.tif"}\NormalTok{), }
              \DataTypeTok{bylayer=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{format=}\StringTok{"GTiff"}\NormalTok{, }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
  
\NormalTok{\}}


\CommentTok{# COMMENCER LE TRAITEMENT #####################################################}

\CommentTok{# changer l'étendue de p192_2019 à l'étendue des autres images p192 -----------}
\CommentTok{# }\AlertTok{TODO}\CommentTok{ : à faire déjà dans 01_SSTS/01_data/_src/prep-Landsat.R}
\KeywordTok{extend}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p192/p192_2019_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{)), }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p192/p192_2018_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{)), }
       \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p192/p192_2019_F"}\NormalTok{, COV.FC, }\StringTok{"rt.tif"}\NormalTok{), }\DataTypeTok{format=}\StringTok{"GTiff"}\NormalTok{, }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{)}
\KeywordTok{file.rename}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p192/p192_2019_F"}\NormalTok{, COV.FC, }\StringTok{"rt.tif"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p192/p192_2019_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{))}

\CommentTok{# Nettoyage temporel des chemins ----------------------------------------------}
\ControlFlowTok{for}\NormalTok{(path }\ControlFlowTok{in} \KeywordTok{c}\NormalTok{(}\StringTok{"p192"}\NormalTok{, }\StringTok{"p193"}\NormalTok{, }\StringTok{"p194"}\NormalTok{)) \{}
  \KeywordTok{clean.temporal}\NormalTok{(path)}
\NormalTok{\} }

\CommentTok{# Fusionner les cartes p192, p193 et p194 pour les dates conjointes -----------}
\ControlFlowTok{for}\NormalTok{(year }\ControlFlowTok{in}\NormalTok{ YEARS.JNT) \{}
  \KeywordTok{merge}\NormalTok{(}\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p193/p193_"}\NormalTok{, year, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"c.tif"}\NormalTok{)), TGO), TGO),}
        \KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p192/p192_"}\NormalTok{, year, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"c.tif"}\NormalTok{)), TGO), TGO),}
        \KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/p194/p194_"}\NormalTok{, year, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"c.tif"}\NormalTok{)), TGO), TGO),}
        \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO/TGO_"}\NormalTok{, year, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"c.tif"}\NormalTok{), }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}

\CommentTok{# Spatial cleaning of results (only from 2003 onwards) -----------------------------------}
\CommentTok{# exclure la première couche (1987) pour la création du masque forêt/non-forêt  }
\KeywordTok{clean.spatial.forest}\NormalTok{(}\DataTypeTok{maps =} \KeywordTok{stack}\NormalTok{(}\KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO"}\NormalTok{), }\DataTypeTok{pattern =} \StringTok{"c}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif"}\NormalTok{, }\DataTypeTok{full.names =} \OtherTok{TRUE}\NormalTok{)),}
                     \DataTypeTok{exclude =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{), }\DataTypeTok{size =} \DecValTok{6}\NormalTok{, }\DataTypeTok{connectedness =} \DecValTok{8}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\hypertarget{validation-des-cartes}{%
\subsubsection{Validation des cartes}\label{validation-des-cartes}}

La validation des cartes forêt/non-forêt se fait à l'aide de \protect\hyperlink{SSTS-validation-plots}{parcelles de validation} sur lesquelles \textbf{l'occupation du sol (forêt/terre boisée/non-forêt) a été déterminée par des photo-interprètes sur la base d'images Landsat pour les années 1987, 2003, 2015 et 2018.} Pour ces parcelles, dans un premier temps, les classes correspondantes sont lues à partir des cartes. Ensuite, des matrices d'erreur sont générées, celles de la classification forêt/non-forestière pour les différentes années, ainsi que celles de l'évolution de la couverture terrestre sur différentes périodes. Ces matrices d'erreurs constituent la base de \protect\hyperlink{FCC-map-precision}{l'analyse de la précision des cartes}.

\hypertarget{example-4}{%
\paragraph{Example}\label{example-4}}
\addcontentsline{toc}{paragraph}{Example}

Le tableau suivant montre la \textbf{matrice d'erreur des transitions de l'occupation du sol 2003 -- 2018}. Dans les colonnes sont les classes attribuées par les photo-interprètes, dans les lignes les classes selon les cartes forêt/non-forêt nettoyées.

\begin{longtable}[]{@{}lrrrr@{}}
\toprule
& xFxF & xFxN & xNxF & xNxN\tabularnewline
\midrule
\endhead
\textbf{xFxF} & \textbf{536} & 52 & 80 & 105\tabularnewline
\textbf{xFxN} & 36 & \textbf{80} & 3 & 52\tabularnewline
\textbf{xNxF} & 23 & 0 & \textbf{73} & 29\tabularnewline
\textbf{xNxN} & 35 & 84 & 50 & \textbf{1175}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{mcf03_validate-fc-maps.r}{%
\paragraph{\texorpdfstring{\emph{MCF/03\_validate-fc-maps.R}}{MCF/03\_validate-fc-maps.R}}\label{mcf03_validate-fc-maps.r}}
\addcontentsline{toc}{paragraph}{\emph{MCF/03\_validate-fc-maps.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# 03_validate-fc-maps.R: validation des cartes forêt/non-forêt nettoyées}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}


\CommentTok{# Définitions des variables ===================================================}

\NormalTok{COV.FC         <-}\StringTok{ }\DecValTok{30}

\NormalTok{REF.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.MCF.REF}
\NormalTok{RAW.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.MCF.RAW}
\NormalTok{CLN.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.MCF.CLN}
\NormalTok{VAL.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.MCF.VAL}
\NormalTok{TPS.DIR <-}\StringTok{ }\NormalTok{DIR.SST.BDD.TPS}
\NormalTok{VPS.DIR <-}\StringTok{ }\NormalTok{DIR.SST.BDD.VPS}



\NormalTok{ct <-}\StringTok{ }\KeywordTok{list}\NormalTok{()      }\CommentTok{# liste des matrices d'érreurs (tableaux de confusion)}


\CommentTok{# Préparations ================================================================}


\CommentTok{# Charger cartes et points d'entraînment --------}

\CommentTok{# Cartes brutes et cartes néttoyées}
\NormalTok{maps <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RAW.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO/TGO_"}\NormalTok{, YEARS.REF, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"r.tif"}\NormalTok{),}
                \KeywordTok{paste0}\NormalTok{(CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO/TGO_"}\NormalTok{, YEARS.REF, }\StringTok{"_F"}\NormalTok{, COV.FC, }\StringTok{"c.tif"}\NormalTok{)))}
\KeywordTok{names}\NormalTok{(maps) <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\StringTok{"TGO}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_"}\NormalTok{, }\StringTok{"X"}\NormalTok{, }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_F[[:digit:]]\{2\}"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{names}\NormalTok{(maps)))}

\CommentTok{# Points d'entraînement: Couverture des houppiers ...}
\NormalTok{train.plots <-}\StringTok{ }\KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(TPS.DIR, }\StringTok{"/COV_parcelles.shp"}\NormalTok{))}
\NormalTok{train.points <-}\StringTok{ }\KeywordTok{SpatialPointsDataFrame}\NormalTok{(}\KeywordTok{gCentroid}\NormalTok{(train.plots, }\DataTypeTok{byid=}\OtherTok{TRUE}\NormalTok{),  }\CommentTok{# polygons -> points}
                                       \KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{COV=}\NormalTok{train.plots}\OperatorTok{$}\NormalTok{ccov))   }\CommentTok{# seulement COV}
\CommentTok{# ... et classes forêt/non-forêt dans les cartes 2018}
\NormalTok{train.points <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(maps[[}\KeywordTok{c}\NormalTok{(}\StringTok{"X2018r"}\NormalTok{,}\StringTok{"X2018c"}\NormalTok{)]], train.points, }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# supprimer lignes avec NA}
\NormalTok{train.points <-}\StringTok{ }\NormalTok{train.points[}\KeywordTok{rowSums}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(train.points}\OperatorTok{@}\NormalTok{data)) }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{, ]}


\CommentTok{# charger points de validation ------------------}

\CommentTok{# Points de validation: classes forêt/non-forêt 1987, 2003, 2015, 2018 ...}
\NormalTok{val.plots  <-}\StringTok{ }\KeywordTok{readOGR}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(VPS.DIR, }\StringTok{"/UOT_parcelles.shp"}\NormalTok{))}
\NormalTok{val.points <-}\StringTok{ }\KeywordTok{SpatialPointsDataFrame}\NormalTok{(}\KeywordTok{gCentroid}\NormalTok{(val.plots, }\DataTypeTok{byid=}\OtherTok{TRUE}\NormalTok{), }
                                     \KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{author=}\KeywordTok{sub}\NormalTok{(}\StringTok{"^.*}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{/"}\NormalTok{, }\StringTok{""}\NormalTok{, val.plots}\OperatorTok{$}\NormalTok{author),}
                                                \DataTypeTok{V1987=}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{substr}\NormalTok{(val.plots}\OperatorTok{$}\NormalTok{lc_}\DecValTok{87}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)), }
                                                \DataTypeTok{V2003=}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{substr}\NormalTok{(val.plots}\OperatorTok{$}\NormalTok{lc_}\DecValTok{03}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)), }
                                                \DataTypeTok{V2015=}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{substr}\NormalTok{(val.plots}\OperatorTok{$}\NormalTok{lc_}\DecValTok{15}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)), }
                                                \DataTypeTok{V2018=}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{substr}\NormalTok{(val.plots}\OperatorTok{$}\NormalTok{lc_}\DecValTok{18}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))))}
\CommentTok{# ... et classes correspondantes dans les cartes}
\NormalTok{val.points <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(maps, val.points, }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# supprimer lignes avec NA}
\NormalTok{val.points <-}\StringTok{ }\NormalTok{val.points[}\KeywordTok{rowSums}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(val.points}\OperatorTok{@}\NormalTok{data)) }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{, ]}


\CommentTok{# Ajustements terres boisées (classe 2) ---------}

\ControlFlowTok{if}\NormalTok{(COV.FC }\OperatorTok{==}\StringTok{ }\DecValTok{30}\NormalTok{) \{}
  \CommentTok{# terre boisée -> non-forêt}
\NormalTok{  val.points}\OperatorTok{$}\NormalTok{V1987[val.points}\OperatorTok{$}\NormalTok{V1987 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{NONFOR}
\NormalTok{  val.points}\OperatorTok{$}\NormalTok{V2003[val.points}\OperatorTok{$}\NormalTok{V2003 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{NONFOR}
\NormalTok{  val.points}\OperatorTok{$}\NormalTok{V2015[val.points}\OperatorTok{$}\NormalTok{V2015 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{NONFOR}
\NormalTok{  val.points}\OperatorTok{$}\NormalTok{V2018[val.points}\OperatorTok{$}\NormalTok{V2018 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{NONFOR}
\NormalTok{\}}
\ControlFlowTok{if}\NormalTok{(COV.FC }\OperatorTok{==}\StringTok{ }\DecValTok{10}\NormalTok{) \{}
  \CommentTok{# terre boisée -> forêt}
\NormalTok{  val.points}\OperatorTok{$}\NormalTok{V1987[val.points}\OperatorTok{$}\NormalTok{V1987 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{FOREST}
\NormalTok{  val.points}\OperatorTok{$}\NormalTok{V2003[val.points}\OperatorTok{$}\NormalTok{V2003 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{FOREST}
\NormalTok{  val.points}\OperatorTok{$}\NormalTok{V2015[val.points}\OperatorTok{$}\NormalTok{V2015 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{FOREST}
\NormalTok{  val.points}\OperatorTok{$}\NormalTok{V2018[val.points}\OperatorTok{$}\NormalTok{V2018 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{FOREST}
\NormalTok{\}}

\CommentTok{# Ajustements nuages/ombre (classe 4) -----------}

\NormalTok{val.points}\OperatorTok{$}\NormalTok{V1987r <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V1987c <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V1987; }
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2003r <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2003c <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2003; }
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2015r <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2015c <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2015; }
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2018r <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2018c <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2018; }

\CommentTok{# Prendre la classe dans les carte brutes ...}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V1987r[val.points}\OperatorTok{$}\NormalTok{V1987 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{X1987r[val.points}\OperatorTok{$}\NormalTok{V1987 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2003r[val.points}\OperatorTok{$}\NormalTok{V2003 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2003r[val.points}\OperatorTok{$}\NormalTok{V2003 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2015r[val.points}\OperatorTok{$}\NormalTok{V2015 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2015r[val.points}\OperatorTok{$}\NormalTok{V2015 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2018r[val.points}\OperatorTok{$}\NormalTok{V2018 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2018r[val.points}\OperatorTok{$}\NormalTok{V2018 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)]}

\CommentTok{# ... et les cartes nettoyées}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V1987c[val.points}\OperatorTok{$}\NormalTok{V1987 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{X1987c[val.points}\OperatorTok{$}\NormalTok{V1987 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2003c[val.points}\OperatorTok{$}\NormalTok{V2003 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2003c[val.points}\OperatorTok{$}\NormalTok{V2003 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2015c[val.points}\OperatorTok{$}\NormalTok{V2015 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2015c[val.points}\OperatorTok{$}\NormalTok{V2015 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2018c[val.points}\OperatorTok{$}\NormalTok{V2018 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2018c[val.points}\OperatorTok{$}\NormalTok{V2018 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)]}


\CommentTok{# Ajustements de la régénération potentielle ----}

\CommentTok{# changer "régénération potentielle" à la classe identifiée dans les parcelles de validation}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{X1987c[val.points}\OperatorTok{$}\NormalTok{X1987c }\OperatorTok{==}\StringTok{ }\NormalTok{PREGEN] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V1987c[val.points}\OperatorTok{$}\NormalTok{X1987c }\OperatorTok{==}\StringTok{ }\NormalTok{PREGEN]}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2003c[val.points}\OperatorTok{$}\NormalTok{X2003c }\OperatorTok{==}\StringTok{ }\NormalTok{PREGEN] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2003c[val.points}\OperatorTok{$}\NormalTok{X2003c }\OperatorTok{==}\StringTok{ }\NormalTok{PREGEN] }
\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2015c[val.points}\OperatorTok{$}\NormalTok{X2015c }\OperatorTok{==}\StringTok{ }\NormalTok{PREGEN] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2015c[val.points}\OperatorTok{$}\NormalTok{X2015c }\OperatorTok{==}\StringTok{ }\NormalTok{PREGEN] }
\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2018c[val.points}\OperatorTok{$}\NormalTok{X2018c }\OperatorTok{==}\StringTok{ }\NormalTok{PREGEN] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2018c[val.points}\OperatorTok{$}\NormalTok{X2018c }\OperatorTok{==}\StringTok{ }\NormalTok{PREGEN] }

\CommentTok{# Non-forêt où "régénération potentielle" dans la carte et "terre boisée" dans les parcelles de validation}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{X1987c[val.points}\OperatorTok{$}\NormalTok{X1987c }\OperatorTok{==}\StringTok{ }\NormalTok{NONFOR] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V1987c[val.points}\OperatorTok{$}\NormalTok{X1987c }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{NONFOR}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2003c[val.points}\OperatorTok{$}\NormalTok{X2003c }\OperatorTok{==}\StringTok{ }\NormalTok{NONFOR] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2003c[val.points}\OperatorTok{$}\NormalTok{X2003c }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{NONFOR}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2015c[val.points}\OperatorTok{$}\NormalTok{X2015c }\OperatorTok{==}\StringTok{ }\NormalTok{NONFOR] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2015c[val.points}\OperatorTok{$}\NormalTok{X2015c }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{NONFOR}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{X2018c[val.points}\OperatorTok{$}\NormalTok{X2018c }\OperatorTok{==}\StringTok{ }\NormalTok{NONFOR] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2018c[val.points}\OperatorTok{$}\NormalTok{X2018c }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{NONFOR}


\NormalTok{val.points}\OperatorTok{@}\NormalTok{data <-}\StringTok{ }\KeywordTok{mutate_all}\NormalTok{(val.points}\OperatorTok{@}\NormalTok{data, as.factor)}


\CommentTok{# Matrices d'erreurs ==========================================================}

\CommentTok{# carte 2018 vs. carte référence 2018  ----------}

\NormalTok{ref.map <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO_2018_FC"}\NormalTok{, COV.FC, }\StringTok{"_R.tif"}\NormalTok{))}
\NormalTok{ct[[}\StringTok{"MAP_REF.18r"}\NormalTok{]] <-}\StringTok{ }\KeywordTok{confusionMatrix}\NormalTok{(}\KeywordTok{as.factor}\NormalTok{(maps}\OperatorTok{$}\NormalTok{X2018r[]), }\KeywordTok{as.factor}\NormalTok{(ref.map[]))}

\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(VAL.DIR, }\StringTok{"/FC2018_vs_COV2018_FC"}\NormalTok{, COV.FC, }\StringTok{".pdf"}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(}\KeywordTok{factor}\NormalTok{(train.points}\OperatorTok{$}\NormalTok{X2018r, }\DataTypeTok{labels=}\KeywordTok{c}\NormalTok{(}\StringTok{"Forest"}\NormalTok{, }\StringTok{"Non-Forest"}\NormalTok{)) }\OperatorTok{~}\StringTok{ }\NormalTok{train.points}\OperatorTok{$}\NormalTok{COV, }\DataTypeTok{xlab=}\StringTok{"Tree Cover 2018"}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Forest Cover Map 2018"}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}

\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(VAL.DIR, }\StringTok{"/COV2018_vs_FC2018_FC"}\NormalTok{, COV.FC, }\StringTok{".pdf"}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(train.points}\OperatorTok{$}\NormalTok{COV }\OperatorTok{~}\StringTok{ }\KeywordTok{factor}\NormalTok{(train.points}\OperatorTok{$}\NormalTok{X2018r, }\DataTypeTok{labels=}\KeywordTok{c}\NormalTok{(}\StringTok{"Forest"}\NormalTok{, }\StringTok{"Non-Forest"}\NormalTok{)), }\DataTypeTok{xlab=}\StringTok{"Forest Cover Map 2018"}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Tree Cover 2018"}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}


\CommentTok{# Map validation / confusion matrices ----------------------------------}

\NormalTok{confMat <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(xtrans, vtrans) \{}
\NormalTok{  levels <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(}\KeywordTok{c}\NormalTok{(xtrans, vtrans))}
  \KeywordTok{return}\NormalTok{(}\KeywordTok{confusionMatrix}\NormalTok{(}\KeywordTok{factor}\NormalTok{(xtrans, }\DataTypeTok{levels=}\NormalTok{levels[}\KeywordTok{order}\NormalTok{(levels)]), }\KeywordTok{factor}\NormalTok{(vtrans, }\DataTypeTok{levels=}\NormalTok{levels[}\KeywordTok{order}\NormalTok{(levels)])))}
\NormalTok{\}}

\CommentTok{# val.points.bu <- val.points        # backup}
\NormalTok{val.points <-}\StringTok{ }\NormalTok{val.points[}\OperatorTok{!}\NormalTok{val.points}\OperatorTok{$}\NormalTok{author }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"7_Aklasson_TOLEBA"}\NormalTok{, }\StringTok{"8_Yawo_KONKO"}\NormalTok{, }\StringTok{"2_Mamalnassoh_ABIGUIME"}\NormalTok{), ]}

\CommentTok{# check for authors whose validation points reduce precision}
\CommentTok{# print(confMat(paste0("x", tmp$X2003c, tmp$X2015c, tmp$X2018c), }
\CommentTok{#              paste0("x", tmp$VX2003, tmp$VX2015, tmp$VX2018))$overall)}
\CommentTok{# }
\CommentTok{# for(author in unique(tmp$author)) \{}
\CommentTok{#   print(author)}
\CommentTok{#   print(confMat(paste0("x", tmp$X2003c[tmp$author != author], tmp$X2015c[tmp$author != author], tmp$X2018c[tmp$author != author]), }
\CommentTok{#                 paste0("x", tmp$VX2003[tmp$author != author], tmp$VX2015[tmp$author != author], tmp$VX2018[tmp$author != author]))$overall)}
\CommentTok{# \}}


\ControlFlowTok{for}\NormalTok{(t }\ControlFlowTok{in} \KeywordTok{c}\NormalTok{(}\StringTok{"r"}\NormalTok{, }\StringTok{"c"}\NormalTok{)) \{}
  
  \CommentTok{# confusion matrices for individual dates}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.87"}\NormalTok{, t)]]          <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X1987"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{        ), }\KeywordTok{paste0}\NormalTok{(val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V1987"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{        ))}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.03"}\NormalTok{, t)]]          <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2003"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{        ), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2003"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{        ))}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.15"}\NormalTok{, t)]]          <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2015"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{        ), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2015"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{        ))}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.18"}\NormalTok{, t)]]          <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2018"}\NormalTok{, t)]]), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2018"}\NormalTok{, t)]]))}
  
  \CommentTok{# confusion matrices for 2-date transitions}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.87.03"}\NormalTok{, t)]]       <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X1987"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2003"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{        ), }\KeywordTok{paste0}\NormalTok{(val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V1987"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2003"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{        ))}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.03.15"}\NormalTok{, t)]]       <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2003"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2015"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{        ), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2003"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2015"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{        ))}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.15.18"}\NormalTok{, t)]]       <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2015"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2018"}\NormalTok{, t)]]), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2015"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2018"}\NormalTok{, t)]]))}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.87.18"}\NormalTok{, t)]]       <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X1987"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2018"}\NormalTok{, t)]]), }\KeywordTok{paste0}\NormalTok{(val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V1987"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2018"}\NormalTok{, t)]]))}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.03.18"}\NormalTok{, t)]]       <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2003"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2018"}\NormalTok{, t)]]), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2003"}\NormalTok{, t)]], }\StringTok{"x"}\NormalTok{,         val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2018"}\NormalTok{, t)]]))}
  
  \CommentTok{# confusion matrices for 3-date transition}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.03.15.18"}\NormalTok{, t)]]    <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2003"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2015"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2018"}\NormalTok{, t)]]), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{, val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2003"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2015"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2018"}\NormalTok{, t)]]))}
  
  \CommentTok{# confusion matrices for 4-date transition}
\NormalTok{  ct[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"MAP_VAL.87.03.15.18"}\NormalTok{, t)]] <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X1987"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2003"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2015"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"X2018"}\NormalTok{, t)]]), }\KeywordTok{paste0}\NormalTok{(val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V1987"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2003"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2015"}\NormalTok{, t)]], val.points[[}\KeywordTok{paste0}\NormalTok{(}\StringTok{"V2018"}\NormalTok{, t)]]))}
  
\NormalTok{\}}

\CommentTok{# Validation RapidEye map 2015 --------------------------------}

\NormalTok{rey <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DATA.DIR, }\StringTok{"/RapidEye/TGO_30m.tif"}\NormalTok{))}
\KeywordTok{names}\NormalTok{(rey) <-}\StringTok{ "R2015"}
\NormalTok{val.points <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(rey, val.points, }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)}

\NormalTok{val.points}\OperatorTok{$}\NormalTok{Rr2015 <-}\StringTok{ }\DecValTok{3}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{Rr2015[val.points}\OperatorTok{$}\NormalTok{R2015 }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{11}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{16}\NormalTok{, }\DecValTok{18}\NormalTok{, }\DecValTok{19}\NormalTok{)] <-}\StringTok{ }\DecValTok{1}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{VR2015 <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{V2015}
\NormalTok{val.points}\OperatorTok{$}\NormalTok{VR2015[val.points}\OperatorTok{$}\NormalTok{V2015 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{val.points}\OperatorTok{$}\NormalTok{Rr2015[val.points}\OperatorTok{$}\NormalTok{V2015 }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{]}

\NormalTok{ct[[}\StringTok{"REY_VAL.15"}\NormalTok{]]         <-}\StringTok{ }\KeywordTok{confMat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,        }\StringTok{"x"}\NormalTok{,        val.points}\OperatorTok{$}\NormalTok{Rr2015, }\StringTok{"x"}\NormalTok{       ), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"x"}\NormalTok{,         }\StringTok{"x"}\NormalTok{,         val.points}\OperatorTok{$}\NormalTok{VR2015, }\StringTok{"x"}\NormalTok{        ))}

\CommentTok{# Write confusion tables -------------------------------------}
\KeywordTok{save}\NormalTok{(ct, }\DataTypeTok{file=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"_flex_ConfTab.RData"}\NormalTok{))}

\CommentTok{# write error matrices to Excel File}
\KeywordTok{write.xlsx}\NormalTok{(}\KeywordTok{lapply}\NormalTok{(ct, }\StringTok{"[["}\NormalTok{, }\StringTok{"table"}\NormalTok{),}
           \DataTypeTok{file=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"_flex_ConfTab.xlsx"}\NormalTok{),}
           \DataTypeTok{colnames=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\hypertarget{FCC-map-precision}{%
\subsubsection{Analyse de la précision}\label{FCC-map-precision}}

La précision des cartes est déterminée selon la procédure de \href{https://www.sciencedirect.com/science/article/abs/pii/S0034425714000704}{Olofsson et al. (2014)}. Le script utilisé est basé sur une \href{https://github.com/openforis/accuracy-assessment/blob/master/Rscripts/error_matrix_analysis.R}{implémentation des méthodes dans OpenForis}.

Le calcul de la précision se fait sur la matrice d'erreur d'une part et les surfaces couvertes par les catégories correspondantes d'autre part. Avec les informations sur les surfaces, la matrice d'erreur est extrapolée en une \textbf{matrice d'erreur proportionnelle}, qui indique dans les cellules les proportions de la surface totale. Sur cette base les indices de précision sont calculés: concrètement la précision globale, le Kappa de Cohen, la précision du producteur et la précision de l'utilisateur, y compris la variance et l'intervalle de confiance à 95 \%. D'autre part, la matrice d'erreur proportionnelle est extrapolée à la superficie totale pour obtenir des estimations de superficie des différentes catégories, y compris les erreurs types et les intervalles de confiance.

\hypertarget{example-5}{%
\paragraph{Example}\label{example-5}}
\addcontentsline{toc}{paragraph}{Example}

\textbf{Le nombre de pixels cartographiés et matrice d'erreur des transitions de l'occupation du sol 2003 -- 2018}. Dans les colonnes sont les classes attribuées par les photo-interprètes, dans les lignes les classes selon les cartes forêt/non-forêt nettoyées.

\begin{longtable}[]{@{}lrrrrr@{}}
\toprule
& Pixels & xFxF & xFxN & xNxF & xNxN\tabularnewline
\midrule
\endhead
\textbf{xFxF} & 12 590 594 & \textbf{536} & 52 & 80 & 105\tabularnewline
\textbf{xFxN} & 2 509 971 & 36 & \textbf{80} & 3 & 52\tabularnewline
\textbf{xNxF} & 1 637 331 & 23 & 0 & \textbf{73} & 29\tabularnewline
\textbf{xNxN} & 46 599 650 & 35 & 84 & 50 & \textbf{1175}\tabularnewline
\bottomrule
\end{longtable}

\textbf{La matrice d'erreur proportionelle aux surfaces cartographiées}. La somme de tous les cellules est 1 (100\%).

\begin{longtable}[]{@{}llrrrr@{}}
\toprule
& & xFxF & xFxN & xNxF & xNxN\tabularnewline
\midrule
\endhead
\textbf{xFxF} & ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ & \textbf{0.138} & 0.013 & 0.021 & 0.027\tabularnewline
\textbf{xFxN} & & 0.008 & \textbf{0.019} & 0.001 & 0.012\tabularnewline
\textbf{xNxF} & & 0.005 & 0 & \textbf{0.015} & 0.006\tabularnewline
\textbf{xNxN} & & 0.019 & 0.046 & 0.027 & \textbf{0.643}\tabularnewline
\bottomrule
\end{longtable}

Les \textbf{indices de précision globales} sont:

\begin{itemize}
\item
  Précision globale: 81.5\% (± 1.5\% intervalle de confiance)
\item
  Cohen's Kappa: 59.3\%
\end{itemize}

\textbf{Indices de précision et le surfaces estimées par catégories} (± intervalle de confiance à 95\%)

\begin{longtable}[]{@{}lrrrrrr@{}}
\toprule
\begin{minipage}[b]{0.07\columnwidth}\raggedright
\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\raggedleft
Surface cartes\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\raggedleft
Prop. cartes\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\raggedleft
Proportion ajustée\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\raggedleft
Surface ajustée\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\raggedleft
Précision utilisateur\strut
\end{minipage} & \begin{minipage}[b]{0.15\columnwidth}\raggedleft
Précision producteur\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.07\columnwidth}\raggedright
\textbf{xFxF}\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
1'133'153\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.20\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.17~±~0.01\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
969'621~±~54'104\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
0.69~±~0.03\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
0.81~±~0.03\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedright
\textbf{xFxN}\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
225'897\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.04\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.08~±~0.01\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
444'034~±~60'300\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
0.47~±~0.08\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
0.24~±~0.04\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedright
\textbf{xNxF}\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
147'360\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.03\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.06~±~0.01\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
363'320~±~50'777\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
0.58~±~0.09\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
0.24~±~0.04\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.07\columnwidth}\raggedright
\textbf{xNxN}\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
4'193'969\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.74\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.69~±~0.01\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
3'923'405~±~81'517\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
0.87~±~0.02\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
0.94~±~0.01\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{mcf04_fc-maps-accuracy.r}{%
\paragraph{\texorpdfstring{\emph{MCF/04\_fc-maps-accuracy.R}}{MCF/04\_fc-maps-accuracy.R}}\label{mcf04_fc-maps-accuracy.r}}
\addcontentsline{toc}{paragraph}{\emph{MCF/04\_fc-maps-accuracy.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{##########################################################################}
\CommentTok{# NERF_Togo/FCC/7_fc-maps-accuracy.R: validate clean forest cover maps}
\CommentTok{# ------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 20 May 2019}

\CommentTok{# based on OpenForis implementation of Olofsson et al. (2014), written by}
\CommentTok{# Antonia Ortmann, 20 October, 2014}
\CommentTok{# Source: https://github.com/openforis/accuracy-assessment/blob/master/Rscripts/error_matrix_analysis.R}

\NormalTok{VALSET <-}\StringTok{ "FC30_flex"}

\CommentTok{# Function for estimating accuracies ----------------------------------}
  
\NormalTok{accuracy.estimate <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(areas.map, error.matrix, }\DataTypeTok{filename=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{pixelsize=}\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{) \{}
  
  \CommentTok{# remove "x" from the category }
  \KeywordTok{colnames}\NormalTok{(error.matrix) <-}\StringTok{ }\KeywordTok{rownames}\NormalTok{(error.matrix) <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{""}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(error.matrix))}
  
  \CommentTok{# match category order}
\NormalTok{  maparea         <-}\StringTok{ }\NormalTok{areas.map[}\KeywordTok{match}\NormalTok{(}\KeywordTok{rownames}\NormalTok{(error.matrix), }\KeywordTok{names}\NormalTok{(areas.map))]}
\NormalTok{  ma              <-}\StringTok{ }\NormalTok{error.matrix}
\NormalTok{  dyn             <-}\StringTok{ }\KeywordTok{names}\NormalTok{(maparea)}
  
  \CommentTok{# calculate the area proportions for each map class}
\NormalTok{  aoi <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(maparea)}
\NormalTok{  propmaparea <-}\StringTok{ }\NormalTok{maparea}\OperatorTok{/}\NormalTok{aoi}
  
  \CommentTok{# convert the absolute cross tab into a probability cross tab}
\NormalTok{  ni. <-}\StringTok{ }\KeywordTok{rowSums}\NormalTok{(ma)                  }\CommentTok{# number of reference points per map class}
\NormalTok{  propma <-}\StringTok{  }\KeywordTok{as.matrix}\NormalTok{(ma}\OperatorTok{/}\NormalTok{ni. }\OperatorTok{*}\StringTok{ }\KeywordTok{as.vector}\NormalTok{(propmaparea))}
\NormalTok{  propma[}\KeywordTok{is.nan}\NormalTok{(propma)] <-}\StringTok{ }\DecValTok{0}          \CommentTok{# for classes with ni. = 0}
  
  \CommentTok{# estimate the accuracies now}
\NormalTok{  OA <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\KeywordTok{diag}\NormalTok{(propma))              }\CommentTok{# overall accuracy (Eq. 1 in Olofsson et al. 2014)}
\NormalTok{  pe <-}\StringTok{ }\DecValTok{0}                              \CommentTok{# Agreement by chance ...}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(dyn)) \{}
\NormalTok{    pe <-}\StringTok{ }\NormalTok{pe }\OperatorTok{+}\StringTok{ }\KeywordTok{sum}\NormalTok{(propma[i,]) }\OperatorTok{*}\StringTok{ }\KeywordTok{sum}\NormalTok{(propma[,i])}
\NormalTok{  \}}
\NormalTok{  K  <-}\StringTok{ }\NormalTok{(OA }\OperatorTok{-}\StringTok{ }\NormalTok{pe) }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{pe)           }\CommentTok{# ... for Cohen's Kappa}
\NormalTok{  UA <-}\StringTok{ }\KeywordTok{diag}\NormalTok{(propma) }\OperatorTok{/}\StringTok{ }\KeywordTok{rowSums}\NormalTok{(propma) }\CommentTok{# user's accuracy (Eq. 2 in Olofsson et al. 2014)}
\NormalTok{  PA <-}\StringTok{ }\KeywordTok{diag}\NormalTok{(propma) }\OperatorTok{/}\StringTok{ }\KeywordTok{colSums}\NormalTok{(propma) }\CommentTok{# producer's accuracy (Eq. 3 in Olofsson et al. 2014)}
  
  \CommentTok{# estimate confidence intervals for the accuracies}
\NormalTok{  V_OA <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\KeywordTok{as.vector}\NormalTok{(propmaparea)}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{UA }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{UA) }\OperatorTok{/}\StringTok{ }\NormalTok{(ni. }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{), }\DataTypeTok{na.rm=}\NormalTok{T)  }\CommentTok{# variance of overall accuracy (Eq. 5 in Olofsson et al. 2014)}
\NormalTok{  V_UA <-}\StringTok{ }\NormalTok{UA }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{UA) }\OperatorTok{/}\StringTok{ }\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(ma) }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{) }\CommentTok{# variance of user's accuracy (Eq. 6 in Olofsson et al. 2014)}
  
  \CommentTok{# variance of producer's accuracy (Eq. 7 in Olofsson et al. 2014)}
\NormalTok{  N.j <-}\StringTok{ }\KeywordTok{array}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{dim=}\KeywordTok{length}\NormalTok{(dyn))}
\NormalTok{  aftersumsign <-}\StringTok{ }\KeywordTok{array}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{dim=}\KeywordTok{length}\NormalTok{(dyn))}
  \ControlFlowTok{for}\NormalTok{(cj }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(dyn)) \{}
\NormalTok{    N.j[cj] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(maparea }\OperatorTok{/}\StringTok{ }\NormalTok{ni. }\OperatorTok{*}\StringTok{ }\NormalTok{ma[, cj], }\DataTypeTok{na.rm=}\NormalTok{T)}
\NormalTok{    aftersumsign[cj] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(maparea[}\OperatorTok{-}\NormalTok{cj]}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{ma[}\OperatorTok{-}\NormalTok{cj, cj] }\OperatorTok{/}\StringTok{ }\NormalTok{ni.[}\OperatorTok{-}\NormalTok{cj] }\OperatorTok{*}\StringTok{ }\NormalTok{( }\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{ma[}\OperatorTok{-}\NormalTok{cj, cj] }\OperatorTok{/}\StringTok{ }\NormalTok{ni.[}\OperatorTok{-}\NormalTok{cj]) }\OperatorTok{/}\StringTok{ }\NormalTok{(ni.[}\OperatorTok{-}\NormalTok{cj] }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{), }\DataTypeTok{na.rm =}\NormalTok{ T)}
\NormalTok{  \}}
\NormalTok{  V_PA <-}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{N.j}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{( }
\NormalTok{    maparea}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{PA)}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{UA }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{UA) }\OperatorTok{/}\StringTok{ }\NormalTok{(ni.}\OperatorTok{-}\DecValTok{1}\NormalTok{) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\NormalTok{PA}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{aftersumsign}
\NormalTok{  ) }
\NormalTok{  V_PA[}\KeywordTok{is.nan}\NormalTok{(V_PA)] <-}\StringTok{ }\DecValTok{0}
  
  \CommentTok{# proportional area estimation}
\NormalTok{  propAreaEst <-}\StringTok{ }\KeywordTok{colSums}\NormalTok{(propma)        }\CommentTok{# proportion of area (Eq. 8 in Olofsson et al. 2014)}
\NormalTok{  AreaEst <-}\StringTok{ }\NormalTok{propAreaEst }\OperatorTok{*}\StringTok{ }\KeywordTok{sum}\NormalTok{(maparea) }\CommentTok{# estimated area}
  
  \CommentTok{# standard errors of the area estimation (Eq. 10 in Olofsson et al. 2014)}
\NormalTok{  V_propAreaEst <-}\StringTok{ }\KeywordTok{array}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{dim=}\KeywordTok{length}\NormalTok{(dyn))}
  \ControlFlowTok{for}\NormalTok{ (cj }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(dyn)) \{}
\NormalTok{    V_propAreaEst[cj] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{((}\KeywordTok{as.vector}\NormalTok{(propmaparea) }\OperatorTok{*}\StringTok{ }\NormalTok{propma[, cj] }\OperatorTok{-}\StringTok{ }\NormalTok{propma[, cj] }\OperatorTok{^}\StringTok{ }\DecValTok{2}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{( }\KeywordTok{rowSums}\NormalTok{(ma) }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{))}
\NormalTok{  \}}
\NormalTok{  V_propAreaEst[}\KeywordTok{is.na}\NormalTok{(V_propAreaEst)] <-}\StringTok{ }\DecValTok{0}
  
  \CommentTok{# produce result tables}
  
\NormalTok{  res <-}\StringTok{ }\KeywordTok{list}\NormalTok{()}
\NormalTok{  res}\OperatorTok{$}\NormalTok{PREDICTED_PX      <-}\StringTok{ }\KeywordTok{as.table}\NormalTok{(maparea)}
\NormalTok{  res}\OperatorTok{$}\NormalTok{ERROR_MATRIX      <-}\StringTok{ }\NormalTok{ma}
\NormalTok{  res}\OperatorTok{$}\NormalTok{ERROR_MATRIX_PROP <-}\StringTok{ }\KeywordTok{round}\NormalTok{(propma, }\DecValTok{3}\NormalTok{)}
\NormalTok{  res}\OperatorTok{$}\NormalTok{OVERALL_ACC       <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{accuracy=}\KeywordTok{round}\NormalTok{(}\KeywordTok{c}\NormalTok{(OA, K), }\DecValTok{3}\NormalTok{), }
                                      \DataTypeTok{CI=}\KeywordTok{round}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\FloatTok{1.96} \OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(V_OA), }\OtherTok{NA}\NormalTok{), }\DecValTok{3}\NormalTok{),}
                                      \DataTypeTok{row.names=}\KeywordTok{c}\NormalTok{(}\StringTok{"OA"}\NormalTok{, }\StringTok{"Kappa"}\NormalTok{))}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{maparea=}\KeywordTok{round}\NormalTok{(maparea }\OperatorTok{*}\StringTok{ }\NormalTok{pixelsize, }\DecValTok{3}\NormalTok{)) }\CommentTok{# in ha}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{prop_maparea    <-}\StringTok{ }\KeywordTok{round}\NormalTok{(propmaparea, }\DecValTok{3}\NormalTok{)}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{adj_proparea    <-}\StringTok{ }\KeywordTok{round}\NormalTok{(propAreaEst, }\DecValTok{3}\NormalTok{)}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{CI_adj_proparea <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\FloatTok{1.96} \OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(V_propAreaEst), }\DecValTok{3}\NormalTok{)}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{adj_area        <-}\StringTok{ }\KeywordTok{round}\NormalTok{(propAreaEst }\OperatorTok{*}\StringTok{ }\NormalTok{aoi }\OperatorTok{*}\StringTok{ }\NormalTok{pixelsize, }\DecValTok{3}\NormalTok{) }\CommentTok{# in ha}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{CI_adj_area     <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\FloatTok{1.96} \OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(V_propAreaEst) }\OperatorTok{*}\StringTok{ }\NormalTok{aoi }\OperatorTok{*}\StringTok{ }\NormalTok{pixelsize, }\DecValTok{3}\NormalTok{) }\CommentTok{# in ha}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{UA              <-}\StringTok{ }\KeywordTok{round}\NormalTok{(UA, }\DecValTok{3}\NormalTok{)}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{CI_UA           <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\FloatTok{1.96} \OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(V_UA), }\DecValTok{3}\NormalTok{)}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{PA              <-}\StringTok{ }\KeywordTok{round}\NormalTok{(PA, }\DecValTok{3}\NormalTok{)}
\NormalTok{  res}\OperatorTok{$}\NormalTok{CLASSES_ACC}\OperatorTok{$}\NormalTok{CI_PA           <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\FloatTok{1.96} \OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(V_PA), }\DecValTok{3}\NormalTok{)}
  
  \CommentTok{# write results to Excel File}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename)) \{}
    \KeywordTok{write.xlsx}\NormalTok{(res,}
               \DataTypeTok{file=}\NormalTok{filename,}
               \DataTypeTok{col.names=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{row.names=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  
  \KeywordTok{return}\NormalTok{(res)}
  
\NormalTok{\}}


\CommentTok{# DO THE WORK ----------------------------------}

\CommentTok{# load the error matrices (R object ct)}
\KeywordTok{load}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/ConfTab_"}\NormalTok{, VALSET, }\StringTok{".RData"}\NormalTok{))}

\CommentTok{# load the predictions and convert "potential regeneration (2)" to "non-forest (3)"}
\NormalTok{fc}\FloatTok{.2003}\NormalTok{ <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(FCC.CLN.DIR, }\StringTok{"/FC30/TGO/TGO_2003_F30cf.tif"}\NormalTok{)); fc}\FloatTok{.2003}\NormalTok{[fc}\FloatTok{.2003}\OperatorTok{==}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{3}
\NormalTok{fc}\FloatTok{.2015}\NormalTok{ <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(FCC.CLN.DIR, }\StringTok{"/FC30/TGO/TGO_2015_F30cf.tif"}\NormalTok{)); fc}\FloatTok{.2015}\NormalTok{[fc}\FloatTok{.2015}\OperatorTok{==}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{3}
\NormalTok{fc}\FloatTok{.2018}\NormalTok{ <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(FCC.CLN.DIR, }\StringTok{"/FC30/TGO/TGO_2018_F30cf.tif"}\NormalTok{)); fc}\FloatTok{.2018}\NormalTok{[fc}\FloatTok{.2018}\OperatorTok{==}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{3}

\CommentTok{# create 3-date transition map }
\NormalTok{fcc  <-}\StringTok{  }\DecValTok{100} \OperatorTok{*}\StringTok{ }\NormalTok{fc}\FloatTok{.2003} \OperatorTok{+}\StringTok{ }\DecValTok{10} \OperatorTok{*}\StringTok{ }\NormalTok{fc}\FloatTok{.2015} \OperatorTok{+}\StringTok{ }\DecValTok{1} \OperatorTok{*}\StringTok{ }\NormalTok{fc}\FloatTok{.2018}

\CommentTok{# get pixel counts (takes time) and separate for different dates / transitions}
\NormalTok{freq <-}\StringTok{ }\KeywordTok{table}\NormalTok{(fcc[])}
\NormalTok{tmp <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(freq); }\KeywordTok{names}\NormalTok{(tmp) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(freq); freq <-}\StringTok{ }\NormalTok{tmp}

\NormalTok{freq.}\DecValTok{03}\NormalTok{.}\FloatTok{15.18}\NormalTok{        <-}\StringTok{ }\KeywordTok{c}\NormalTok{(freq[}\StringTok{"111"}\NormalTok{], freq[}\StringTok{"113"}\NormalTok{], freq[}\StringTok{"131"}\NormalTok{], freq[}\StringTok{"133"}\NormalTok{], freq[}\StringTok{"311"}\NormalTok{], freq[}\StringTok{"313"}\NormalTok{], freq[}\StringTok{"331"}\NormalTok{], freq[}\StringTok{"333"}\NormalTok{])}
\KeywordTok{names}\NormalTok{(freq.}\DecValTok{03}\NormalTok{.}\FloatTok{15.18}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"111"}\NormalTok{, }\StringTok{"113"}\NormalTok{, }\StringTok{"131"}\NormalTok{, }\StringTok{"133"}\NormalTok{, }\StringTok{"311"}\NormalTok{, }\StringTok{"313"}\NormalTok{, }\StringTok{"331"}\NormalTok{, }\StringTok{"333"}\NormalTok{); freq.}\DecValTok{03}\NormalTok{.}\FloatTok{15.18}\NormalTok{[}\KeywordTok{is.na}\NormalTok{(freq.}\DecValTok{03}\NormalTok{.}\FloatTok{15.18}\NormalTok{)] <-}\StringTok{ }\DecValTok{0}

\NormalTok{freq.}\FloatTok{03.18}\NormalTok{        <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"111"}\NormalTok{],freq[}\StringTok{"131"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T), }\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"113"}\NormalTok{],freq[}\StringTok{"133"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T),}
                       \KeywordTok{sum}\NormalTok{(freq[}\StringTok{"311"}\NormalTok{],freq[}\StringTok{"331"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T), }\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"313"}\NormalTok{],freq[}\StringTok{"333"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T))}
\KeywordTok{names}\NormalTok{(freq.}\FloatTok{03.18}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"11"}\NormalTok{, }\StringTok{"13"}\NormalTok{, }\StringTok{"31"}\NormalTok{, }\StringTok{"33"}\NormalTok{); freq.}\FloatTok{03.18}\NormalTok{[}\KeywordTok{is.na}\NormalTok{(freq.}\FloatTok{03.18}\NormalTok{)] <-}\StringTok{ }\DecValTok{0}

\NormalTok{freq.}\FloatTok{03.15}\NormalTok{        <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"111"}\NormalTok{],freq[}\StringTok{"113"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T), }\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"131"}\NormalTok{],freq[}\StringTok{"133"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T),}
                       \KeywordTok{sum}\NormalTok{(freq[}\StringTok{"311"}\NormalTok{],freq[}\StringTok{"313"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T), }\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"331"}\NormalTok{],freq[}\StringTok{"333"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T))}
\KeywordTok{names}\NormalTok{(freq.}\FloatTok{03.15}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"11"}\NormalTok{, }\StringTok{"13"}\NormalTok{, }\StringTok{"31"}\NormalTok{, }\StringTok{"33"}\NormalTok{); freq.}\FloatTok{03.15}\NormalTok{[}\KeywordTok{is.na}\NormalTok{(freq.}\FloatTok{03.15}\NormalTok{)] <-}\StringTok{ }\DecValTok{0}

\NormalTok{freq.}\FloatTok{15.18}\NormalTok{        <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"111"}\NormalTok{],freq[}\StringTok{"311"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T), }\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"113"}\NormalTok{],freq[}\StringTok{"313"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T),}
                       \KeywordTok{sum}\NormalTok{(freq[}\StringTok{"131"}\NormalTok{],freq[}\StringTok{"331"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T), }\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"133"}\NormalTok{],freq[}\StringTok{"333"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T))}
\KeywordTok{names}\NormalTok{(freq.}\FloatTok{15.18}\NormalTok{) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"11"}\NormalTok{, }\StringTok{"13"}\NormalTok{, }\StringTok{"31"}\NormalTok{, }\StringTok{"33"}\NormalTok{); freq.}\FloatTok{15.18}\NormalTok{[}\KeywordTok{is.na}\NormalTok{(freq.}\FloatTok{15.18}\NormalTok{)] <-}\StringTok{ }\DecValTok{0}

\NormalTok{freq}\FloatTok{.03}\NormalTok{           <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"111"}\NormalTok{],freq[}\StringTok{"131"}\NormalTok{], freq[}\StringTok{"113"}\NormalTok{],freq[}\StringTok{"133"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T),}
                       \KeywordTok{sum}\NormalTok{(freq[}\StringTok{"311"}\NormalTok{],freq[}\StringTok{"331"}\NormalTok{], freq[}\StringTok{"313"}\NormalTok{],freq[}\StringTok{"333"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T))}
\KeywordTok{names}\NormalTok{(freq}\FloatTok{.03}\NormalTok{)    <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"3"}\NormalTok{); freq}\FloatTok{.03}\NormalTok{[}\KeywordTok{is.na}\NormalTok{(freq}\FloatTok{.03}\NormalTok{)] <-}\StringTok{ }\DecValTok{0}
  
\NormalTok{freq}\FloatTok{.15}\NormalTok{           <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"111"}\NormalTok{],freq[}\StringTok{"311"}\NormalTok{], freq[}\StringTok{"113"}\NormalTok{],freq[}\StringTok{"313"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T),}
                       \KeywordTok{sum}\NormalTok{(freq[}\StringTok{"131"}\NormalTok{],freq[}\StringTok{"331"}\NormalTok{], freq[}\StringTok{"133"}\NormalTok{],freq[}\StringTok{"333"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T))}
\KeywordTok{names}\NormalTok{(freq}\FloatTok{.15}\NormalTok{)    <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"3"}\NormalTok{); freq}\FloatTok{.15}\NormalTok{[}\KeywordTok{is.na}\NormalTok{(freq}\FloatTok{.15}\NormalTok{)] <-}\StringTok{ }\DecValTok{0}

\NormalTok{freq}\FloatTok{.18}\NormalTok{           <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{sum}\NormalTok{(freq[}\StringTok{"111"}\NormalTok{],freq[}\StringTok{"311"}\NormalTok{], freq[}\StringTok{"131"}\NormalTok{],freq[}\StringTok{"331"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T),}
                       \KeywordTok{sum}\NormalTok{(freq[}\StringTok{"113"}\NormalTok{],freq[}\StringTok{"313"}\NormalTok{], freq[}\StringTok{"133"}\NormalTok{],freq[}\StringTok{"333"}\NormalTok{], }\DataTypeTok{na.rm=}\NormalTok{T))}
\KeywordTok{names}\NormalTok{(freq}\FloatTok{.18}\NormalTok{)    <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"3"}\NormalTok{); freq}\FloatTok{.18}\NormalTok{[}\KeywordTok{is.na}\NormalTok{(freq}\FloatTok{.18}\NormalTok{)] <-}\StringTok{ }\DecValTok{0}

\CommentTok{# create accuracy maps ------------------------------------}

\KeywordTok{accuracy.estimate}\NormalTok{(freq}\FloatTok{.18}\NormalTok{, ct}\OperatorTok{$}\NormalTok{MAP_VAL}\FloatTok{.18}\NormalTok{c}\OperatorTok{$}\NormalTok{table , }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/"}\NormalTok{, VALSET, }\StringTok{"_Acc_18.xlsx"}\NormalTok{))}
\KeywordTok{accuracy.estimate}\NormalTok{(freq}\FloatTok{.15}\NormalTok{, ct}\OperatorTok{$}\NormalTok{MAP_VAL}\FloatTok{.15}\NormalTok{c}\OperatorTok{$}\NormalTok{table , }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/"}\NormalTok{, VALSET, }\StringTok{"_Acc_15.xlsx"}\NormalTok{))}
\KeywordTok{accuracy.estimate}\NormalTok{(freq}\FloatTok{.03}\NormalTok{, ct}\OperatorTok{$}\NormalTok{MAP_VAL}\FloatTok{.03}\NormalTok{c}\OperatorTok{$}\NormalTok{table , }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/"}\NormalTok{, VALSET, }\StringTok{"_Acc_03.xlsx"}\NormalTok{))}

\KeywordTok{accuracy.estimate}\NormalTok{(freq.}\FloatTok{03.15}\NormalTok{, ct}\OperatorTok{$}\NormalTok{MAP_VAL.}\FloatTok{03.15}\NormalTok{c}\OperatorTok{$}\NormalTok{table , }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/"}\NormalTok{, VALSET, }\StringTok{"_Acc_03-15.xlsx"}\NormalTok{))}
\KeywordTok{accuracy.estimate}\NormalTok{(freq.}\FloatTok{15.18}\NormalTok{, ct}\OperatorTok{$}\NormalTok{MAP_VAL.}\FloatTok{15.18}\NormalTok{c}\OperatorTok{$}\NormalTok{table , }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/"}\NormalTok{, VALSET, }\StringTok{"_Acc_15-18.xlsx"}\NormalTok{))}
\KeywordTok{accuracy.estimate}\NormalTok{(freq.}\FloatTok{03.18}\NormalTok{, ct}\OperatorTok{$}\NormalTok{MAP_VAL.}\FloatTok{03.18}\NormalTok{c}\OperatorTok{$}\NormalTok{table , }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/"}\NormalTok{, VALSET, }\StringTok{"_Acc_03-18.xlsx"}\NormalTok{))}

\KeywordTok{accuracy.estimate}\NormalTok{(freq.}\DecValTok{03}\NormalTok{.}\FloatTok{15.18}\NormalTok{, ct}\OperatorTok{$}\NormalTok{MAP_VAL.}\DecValTok{03}\NormalTok{.}\FloatTok{15.18}\NormalTok{c}\OperatorTok{$}\NormalTok{table , }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(FCC.VAL.DIR, }\StringTok{"/"}\NormalTok{, VALSET, }\StringTok{"_Acc_03-15-18.xlsx"}\NormalTok{))}

\CommentTok{# calculate forest cover, loss and gains ---------------------}

\NormalTok{res <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{year     =} \KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{,         }\DecValTok{2015}\NormalTok{,             }\DecValTok{2018}\NormalTok{),}
                  \DataTypeTok{total.ha =} \KeywordTok{c}\NormalTok{(freq}\FloatTok{.03}\NormalTok{[}\StringTok{"1"}\NormalTok{], freq}\FloatTok{.15}\NormalTok{[}\StringTok{"1"}\NormalTok{],     freq}\FloatTok{.18}\NormalTok{[}\StringTok{"1"}\NormalTok{])     }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{,}
                  \DataTypeTok{defor.ha =} \KeywordTok{c}\NormalTok{(}\OtherTok{NA}\NormalTok{,           freq.}\FloatTok{03.15}\NormalTok{[}\StringTok{"13"}\NormalTok{], freq.}\FloatTok{15.18}\NormalTok{[}\StringTok{"13"}\NormalTok{]) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{,}
                  \DataTypeTok{regen.ha =} \KeywordTok{c}\NormalTok{(}\OtherTok{NA}\NormalTok{,           freq.}\FloatTok{03.15}\NormalTok{[}\StringTok{"31"}\NormalTok{], freq.}\FloatTok{15.18}\NormalTok{[}\StringTok{"31"}\NormalTok{]) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{)}
                  



\CommentTok{# Example from Olofsson et al. (2014)}
\CommentTok{# -----------------------------------}
\CommentTok{# ct <- matrix(data=c(66,  0,   5,   4,}
\CommentTok{#                     0, 55,   8,  12,}
\CommentTok{#                     1,  0, 153,  11,}
\CommentTok{#                     2,  1,   9, 313),}
\CommentTok{#              nrow=4,}
\CommentTok{#              byrow=TRUE,}
\CommentTok{#              dimnames = list(Prediction=c("FN", "NF", "FF", "NN"), Reference=c("FN", "NF", "FF", "NN")))}
\CommentTok{# }
\CommentTok{# px <- c(FN=200000, NF=150000, FF=3200000, NN=6450000)}
\CommentTok{# }
\CommentTok{# accuracy.estimate(px, ct)}
\end{Highlighting}
\end{Shaded}

\hypertarget{analyse-des-cartes}{%
\subsubsection{Analyse des cartes}\label{analyse-des-cartes}}

Les cartes forêt/non-forêt nettoyées de 1987 à 2018 sont utilisées pour créer des cartes des changements forestiers. En utilisant la fonction \texttt{fc()} les pixels qui passent d'une situation ``non-forêt'' ou ``régénération potentielle'' à ``régénération'' sont enregistrés comme gains de surface forestière dans l'année correspondante, les pixels qui passent d'une situation ``forêt'' ou ``régénération'' à ``non-forêt'' sont enregistrés comme perte de surface forestière. Sur cette base, pour chaque année disponible dans la série, une \textbf{compilation des surfaces forestières, de la surface régénérée et de la régénération potentielle, ainsi que des gains et pertes de forêts dans la période précédente} est effectuée.

Le tableau de la superficie forestière sert à son tour de base pour déterminer les \textbf{changements annuelles de la surface forestière sur différentes périodes de temps} à l'aide de la fonction \texttt{fcc()}. En plus des changements annuelles absolues, les taux de changement correspondants sont calculés selon la formule suivante : \(r = (1/(t2 - t1)) \times ln(A2/A1)\) (\href{https://www.sciencedirect.com/science/article/abs/pii/S0378112702003353}{Puyravaud, 2003}).

La fonction \texttt{plot.fc()} affiche graphiquement le tableau des surfaces forestières et montre comment la surface forestière et la régénération se développent. La fonction \texttt{plot.fcc()} crée un diagramme en barres des gains et des pertes annuelles de la surface forestières sur certaines périodes de temps.

Enfin, des \textbf{cartes de la perte de forêts, de la régénération potentielle et de la régénération} sont créées, avec les années de changement observées comme valeurs de pixel.

\hypertarget{example-6}{%
\paragraph{Example}\label{example-6}}
\addcontentsline{toc}{paragraph}{Example}

\textbf{Tableau des superfaces forestières pour le Togo } La surface forestière initiale (existant depuis 1987), la superficie forestière secondaire (régénérée depuis 1987), la surface de la régénération potentielle (\textless{} 10 ans) et la déforestation et l'accroissement enregistrés dans la période précédente. Tous les chiffres sont exprimés en hectares.

\begin{longtable}[]{@{}rrrrrrr@{}}
\toprule
\begin{minipage}[b]{0.04\columnwidth}\raggedleft
Année\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\raggedleft
Surface f. totale\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\raggedleft
Surface f. initiale\strut
\end{minipage} & \begin{minipage}[b]{0.15\columnwidth}\raggedleft
Surface f. secondaire\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\raggedleft
Régén. potentielle\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\raggedleft
Pertes surface f.\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\raggedleft
Gains surface f.\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.04\columnwidth}\raggedleft
1987\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
1'265'377\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
1'265'377\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
0\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
133'038\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
---\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
---\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.04\columnwidth}\raggedleft
2003\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
1'359'051\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
1'193'731\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
165'320\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
90'972\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-71'646\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
165'320\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.04\columnwidth}\raggedleft
2005\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
1'321'963\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
1'166'156\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
155'807\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
122'718\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-37'088\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.04\columnwidth}\raggedleft
2007\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
1'281'909\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
1'136'373\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
145'536\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
161'787\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-40'154\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
101\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.04\columnwidth}\raggedleft
2015\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
1'290'948\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
1'059'301\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
231'647\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
156'237\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-99'560\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
108'600\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.04\columnwidth}\raggedleft
2017\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
1'290'615\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
1'035'724\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
254'891\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
169'171\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-39'503\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
39'170\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.04\columnwidth}\raggedleft
2018\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
1'280'513\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
1'019'489\strut
\end{minipage} & \begin{minipage}[t]{0.15\columnwidth}\raggedleft
261'024\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
188'715\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-27'027\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
16'925\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\textbf{Changement annuelle de la superficie forestière au Togo}, pour 2003 -- 2015, 2015 -- 2018 et toute la période 2003 -- 2018, montrant les pertes et les gains brutes des forêts, et le changement net de la surface forestière en hectares par an et les taux correspondants en \%/an.

\begin{longtable}[]{@{}rrrrrrr@{}}
\toprule
\begin{minipage}[b]{0.10\columnwidth}\raggedleft
Période\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\raggedleft
Pertes (ha/an)\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\raggedleft
Gains (ha/an)\strut
\end{minipage} & \begin{minipage}[b]{0.13\columnwidth}\raggedleft
Ch. net (ha/an)\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\raggedleft
Pertes (\%/an)\strut
\end{minipage} & \begin{minipage}[b]{0.11\columnwidth}\raggedleft
Gains (\%/an)\strut
\end{minipage} & \begin{minipage}[b]{0.12\columnwidth}\raggedleft
Ch. net (\%/an)\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.10\columnwidth}\raggedleft
2003 -- 2015\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-14'734\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
9'058\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
-5'675\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
-1.2\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.6\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-0.4\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\raggedleft
2015 -- 2018\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-22'177\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
18'699\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
-3'478\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
-1.8\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
1.4\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-0.3\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.10\columnwidth}\raggedleft
2003 -- 2018\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-16'222\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
10'986\strut
\end{minipage} & \begin{minipage}[t]{0.13\columnwidth}\raggedleft
-5'236\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
-1.3\strut
\end{minipage} & \begin{minipage}[t]{0.11\columnwidth}\raggedleft
0.8\strut
\end{minipage} & \begin{minipage}[t]{0.12\columnwidth}\raggedleft
-0.4\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\textbf{Changement de la surface forestière du Togo 2003 -- 2018} Changement de la superficie forestière (à gauche) ansi que les gains et les pertes annuelles pour les périodes 2003 -- 2015 et 2015 -- 2018 (à droite).

\includegraphics[width=0.5\linewidth]{images/TGO_fc} \includegraphics[width=0.5\linewidth]{images/TGO_fcc}

\textbf{Complexité de l'évolution de la superficie forestière} en prenant l'exemple d'une petite partie de la région des Plateaux. Pertes de forêts 2003 -- 2018 (jaune à orange) et croissance des forêts au cours de la même période (bleu à blanc). Le fond noir est non-forêt sur toute la période.

\includegraphics{images/FCC-changemap.png}

\hypertarget{mcf05_analyse-fc-maps.r}{%
\paragraph{\texorpdfstring{\emph{MCF/05\_analyse-fc-maps.R}}{MCF/05\_analyse-fc-maps.R}}\label{mcf05_analyse-fc-maps.r}}
\addcontentsline{toc}{paragraph}{\emph{MCF/05\_analyse-fc-maps.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{##########################################################################}
\CommentTok{# NERF_Togo/FCC/8_analyse-fc-maps.R: analyze clean forest cover maps}
\CommentTok{# ------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 20 May 2019}

\NormalTok{COV.FC         <-}\StringTok{ }\DecValTok{30}

\CommentTok{# Function for building forest cover table ---------------------------------}

\NormalTok{fc <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(map, }\DataTypeTok{aoi=}\OtherTok{NULL}\NormalTok{) \{}
  
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(aoi)) map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(map, aoi), aoi)}
  
  \CommentTok{# convert non-forest to 0}
  \CommentTok{# potential regeneration to 1}
  \CommentTok{# regeneration to 2}
  \CommentTok{# forest to 3}
  
\NormalTok{  tab.fc <-}\StringTok{ }\NormalTok{map[]}
\NormalTok{  tab.fc[tab.fc }\OperatorTok{==}\StringTok{ }\DecValTok{3}\NormalTok{] <-}\StringTok{ }\DecValTok{0}
\NormalTok{  tab.fc[tab.fc }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{] <-}\StringTok{ }\DecValTok{3}
\NormalTok{  tab.fc[tab.fc }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{1}
  
  
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{2}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(tab.fc)) \{}
\NormalTok{    tab.fc[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(tab.fc[,i]) }\OperatorTok{&}\StringTok{ }\NormalTok{tab.fc[,i] }\OperatorTok{==}\StringTok{ }\DecValTok{3} \OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(tab.fc[,i}\DecValTok{-1}\NormalTok{]) }\OperatorTok{&}\StringTok{ }\NormalTok{tab.fc[,i}\DecValTok{-1}\NormalTok{] }\OperatorTok{<}\StringTok{ }\DecValTok{3}\NormalTok{, i] <-}\StringTok{ }\DecValTok{2}  \CommentTok{# mark as regeneration when it was non-forest or regeneration before}
\NormalTok{  \}}
  
\NormalTok{  tab.fcc <-}\StringTok{ }\NormalTok{tab.fc[,}\DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(tab.fc)}\OperatorTok{-}\DecValTok{1}\NormalTok{]}
\NormalTok{  tab.fcc[] <-}\StringTok{ }\DecValTok{0}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(tab.fcc)) \{}
\NormalTok{    tab.fcc[tab.fc[,i] }\OperatorTok{<=}\StringTok{ }\DecValTok{1} \OperatorTok{&}\StringTok{ }\NormalTok{tab.fc[,i}\OperatorTok{+}\DecValTok{1}\NormalTok{] }\OperatorTok{>=}\StringTok{ }\DecValTok{2}\NormalTok{, i]   <-}\StringTok{ }\DecValTok{1}           \CommentTok{# mark forest gain}
\NormalTok{    tab.fcc[tab.fc[,i] }\OperatorTok{>=}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\NormalTok{tab.fc[,i}\OperatorTok{+}\DecValTok{1}\NormalTok{] }\OperatorTok{<=}\StringTok{ }\DecValTok{1}\NormalTok{, i]   <-}\StringTok{ }\DecValTok{2}           \CommentTok{# mark forest loss}
\NormalTok{  \}}
  
\NormalTok{  dates <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{substr}\NormalTok{(}\KeywordTok{names}\NormalTok{(map), }\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{))}
  
\NormalTok{  fc <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{year     =}\NormalTok{ dates, }
                   \DataTypeTok{initi.ha =} \KeywordTok{colSums}\NormalTok{(tab.fc}\OperatorTok{==}\DecValTok{3}\NormalTok{, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{, }
                   \DataTypeTok{secon.ha =} \KeywordTok{colSums}\NormalTok{(tab.fc}\OperatorTok{==}\DecValTok{2}\NormalTok{, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{,}
                   \DataTypeTok{poten.ha =} \KeywordTok{colSums}\NormalTok{(tab.fc}\OperatorTok{==}\DecValTok{1}\NormalTok{, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{)}
  
\NormalTok{  fc}\OperatorTok{$}\NormalTok{total.ha <-}\StringTok{   }\NormalTok{fc}\OperatorTok{$}\NormalTok{initi.ha }\OperatorTok{+}\StringTok{ }\NormalTok{fc}\OperatorTok{$}\NormalTok{secon.ha}
\NormalTok{  fc}\OperatorTok{$}\NormalTok{defor.ha <-}\StringTok{   }\OperatorTok{-}\KeywordTok{c}\NormalTok{(}\KeywordTok{colSums}\NormalTok{(tab.fcc}\OperatorTok{==}\DecValTok{2}\NormalTok{, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{, }\OtherTok{NA}\NormalTok{)}
\NormalTok{  fc}\OperatorTok{$}\NormalTok{regen.ha <-}\StringTok{    }\KeywordTok{c}\NormalTok{(}\KeywordTok{colSums}\NormalTok{(tab.fcc}\OperatorTok{==}\DecValTok{1}\NormalTok{, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2}\OperatorTok{/}\DecValTok{10000}\NormalTok{, }\OtherTok{NA}\NormalTok{)}
    
  \KeywordTok{return}\NormalTok{(fc)}
\NormalTok{\}}
     
\NormalTok{fcc <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(fc.tab, }\DataTypeTok{years=}\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{year) \{}
  
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{(}\KeywordTok{length}\NormalTok{(years)}\OperatorTok{-}\DecValTok{1}\NormalTok{)) \{}
\NormalTok{    fc.tab}\OperatorTok{$}\NormalTok{defor.ha.yr[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(fc.tab}\OperatorTok{$}\NormalTok{defor.ha[fc.tab}\OperatorTok{$}\NormalTok{year }\OperatorTok{>=}\StringTok{ }\NormalTok{years[i] }\OperatorTok{&}\StringTok{ }\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{year }\OperatorTok{<}\StringTok{ }\NormalTok{years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]])}\OperatorTok{/}\NormalTok{(years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]}\OperatorTok{-}\NormalTok{years[i])}
\NormalTok{    fc.tab}\OperatorTok{$}\NormalTok{regen.ha.yr[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(fc.tab}\OperatorTok{$}\NormalTok{regen.ha[fc.tab}\OperatorTok{$}\NormalTok{year }\OperatorTok{>=}\StringTok{ }\NormalTok{years[i] }\OperatorTok{&}\StringTok{ }\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{year }\OperatorTok{<}\StringTok{ }\NormalTok{years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]])}\OperatorTok{/}\NormalTok{(years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]}\OperatorTok{-}\NormalTok{years[i])}
\NormalTok{    fc.tab}\OperatorTok{$}\NormalTok{netch.ha.yr[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]] <-}\StringTok{ }\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{defor.ha.yr[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]] }\OperatorTok{+}\StringTok{ }\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{regen.ha.yr[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]]}
    
\NormalTok{    fc.tab}\OperatorTok{$}\NormalTok{defor.pc.yr[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]] <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\DecValTok{100} \OperatorTok{*}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{(years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]}\OperatorTok{-}\NormalTok{years[i]) }\OperatorTok{*}\StringTok{ }\KeywordTok{log}\NormalTok{((fc.tab}\OperatorTok{$}\NormalTok{total.ha[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]] }\OperatorTok{-}\StringTok{ }\KeywordTok{sum}\NormalTok{(fc.tab}\OperatorTok{$}\NormalTok{regen.ha[fc.tab}\OperatorTok{$}\NormalTok{year }\OperatorTok{>=}\StringTok{ }\NormalTok{years[i] }\OperatorTok{&}\StringTok{ }\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{year }\OperatorTok{<}\StringTok{ }\NormalTok{years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]]))}\OperatorTok{/}\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{total.ha[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]]), }\DecValTok{3}\NormalTok{)}
\NormalTok{    fc.tab}\OperatorTok{$}\NormalTok{regen.pc.yr[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]] <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\DecValTok{100} \OperatorTok{*}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{(years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]}\OperatorTok{-}\NormalTok{years[i]) }\OperatorTok{*}\StringTok{ }\KeywordTok{log}\NormalTok{((fc.tab}\OperatorTok{$}\NormalTok{total.ha[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]] }\OperatorTok{-}\StringTok{ }\KeywordTok{sum}\NormalTok{(fc.tab}\OperatorTok{$}\NormalTok{defor.ha[fc.tab}\OperatorTok{$}\NormalTok{year }\OperatorTok{>=}\StringTok{ }\NormalTok{years[i] }\OperatorTok{&}\StringTok{ }\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{year }\OperatorTok{<}\StringTok{ }\NormalTok{years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]]))}\OperatorTok{/}\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{total.ha[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]]), }\DecValTok{3}\NormalTok{)}
\NormalTok{    fc.tab}\OperatorTok{$}\NormalTok{netch.pc.yr[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]] <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\DecValTok{100} \OperatorTok{*}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{(years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]}\OperatorTok{-}\NormalTok{years[i]) }\OperatorTok{*}\StringTok{ }\KeywordTok{log}\NormalTok{(fc.tab}\OperatorTok{$}\NormalTok{total.ha[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]]}\OperatorTok{/}\NormalTok{fc.tab}\OperatorTok{$}\NormalTok{total.ha[fc.tab}\OperatorTok{$}\NormalTok{year}\OperatorTok{==}\NormalTok{years[i]]), }\DecValTok{3}\NormalTok{)}
\NormalTok{  \}}
  
  \KeywordTok{return}\NormalTok{(fc.tab)}
\NormalTok{\}}
  
\CommentTok{# Function for plotting evolution of forest cover -----------------------------------------}

\NormalTok{plot.fc <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(fc, zone, }\DataTypeTok{filename=}\OtherTok{NULL}\NormalTok{) \{}
  
  \ControlFlowTok{if}\NormalTok{(zone}\OperatorTok{==}\StringTok{"TGO"}\NormalTok{) \{}
\NormalTok{    title    <-}\StringTok{ "Togo: Évolution de la couverure forestière 2003 - 2018"}
\NormalTok{    ylim     <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1400000}\NormalTok{)}
\NormalTok{    ybreaks  <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1400000}\NormalTok{, }\DecValTok{200000}\NormalTok{)}
\NormalTok{    ymbreaks <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1400000}\NormalTok{, }\DecValTok{100000}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    title    <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(zone, }\StringTok{": Évolution de la couverure forestière 2003 - 2018"}\NormalTok{)}
\NormalTok{    ylim     <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{500000}\NormalTok{)}
\NormalTok{    ybreaks  <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{500000}\NormalTok{, }\DecValTok{100000}\NormalTok{)}
\NormalTok{    ymbreaks <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{500000}\NormalTok{, }\DecValTok{50000}\NormalTok{)}
\NormalTok{  \} }
  
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename)) }\KeywordTok{pdf}\NormalTok{(filename)}
  
  \KeywordTok{print}\NormalTok{(}
\NormalTok{    fc }\OperatorTok{%>%}\StringTok{  }\KeywordTok{gather}\NormalTok{(variable, value, secon.ha, initi.ha) }\OperatorTok{%>%}
\StringTok{      }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y=}\NormalTok{value, }\DataTypeTok{fill=}\NormalTok{variable)) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\KeywordTok{geom_area}\NormalTok{(}\DataTypeTok{position=}\KeywordTok{position_stack}\NormalTok{(}\DataTypeTok{reverse=}\OtherTok{TRUE}\NormalTok{)) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\KeywordTok{scale_fill_manual}\NormalTok{(}\DataTypeTok{name =} \OtherTok{NULL}\NormalTok{, }\DataTypeTok{breaks=}\KeywordTok{c}\NormalTok{(}\StringTok{"secon.ha"}\NormalTok{, }\StringTok{"initi.ha"}\NormalTok{), }\DataTypeTok{values=}\KeywordTok{c}\NormalTok{(}\KeywordTok{alpha}\NormalTok{(}\StringTok{"#009E73"}\NormalTok{, }\FloatTok{0.8}\NormalTok{), }\KeywordTok{alpha}\NormalTok{(}\StringTok{"#00BFC4"}\NormalTok{, }\FloatTok{0.5}\NormalTok{)), }\DataTypeTok{labels=}\KeywordTok{c}\NormalTok{(}\StringTok{"Régéneration"}\NormalTok{, }\StringTok{"Forêt depuis 1987"}\NormalTok{)) }\OperatorTok{+}
\StringTok{      }\KeywordTok{xlab}\NormalTok{(}\StringTok{"Année"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ylab}\NormalTok{(}\StringTok{"Hectares"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(title) }\OperatorTok{+}
\StringTok{      }\KeywordTok{scale_x_continuous}\NormalTok{(}\DataTypeTok{minor_breaks =} \OtherTok{NULL}\NormalTok{, }\DataTypeTok{breaks=}\KeywordTok{c}\NormalTok{(}\DecValTok{1991}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2005}\NormalTok{, }\DecValTok{2010}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2018}\NormalTok{)) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\KeywordTok{scale_y_continuous}\NormalTok{(}\DataTypeTok{breaks=}\NormalTok{ybreaks, }\DataTypeTok{minor_breaks =}\NormalTok{ ymbreaks) }\OperatorTok{+}\StringTok{ }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{ylim=}\NormalTok{ylim) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\KeywordTok{theme_light}\NormalTok{() }\OperatorTok{+}\StringTok{ }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.6}\NormalTok{,}\FloatTok{0.2}\NormalTok{), }\DataTypeTok{legend.box =} \StringTok{"horizontal"}\NormalTok{, }\DataTypeTok{legend.justification=}\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\FloatTok{0.2}\NormalTok{,}\FloatTok{1.2}\NormalTok{))}
\NormalTok{  )}
  
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename)) }\KeywordTok{dev.off}\NormalTok{()}
\NormalTok{\}}

\CommentTok{# Function for plotting forest cover change -----------------------------------}

\NormalTok{plot.fcc <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(fc, }\DataTypeTok{zone=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{breaks=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{filename=}\OtherTok{NULL}\NormalTok{) \{}
  
\NormalTok{  my.fcc <-}\StringTok{ }\KeywordTok{fcc}\NormalTok{(fc)}
\NormalTok{  fcc.breaks <-}\StringTok{ }\NormalTok{my.fcc}
 
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(breaks)) fcc.breaks <-}\StringTok{ }\KeywordTok{fcc}\NormalTok{(fc, breaks)[fc}\OperatorTok{$}\NormalTok{year }\OperatorTok{%in%}\StringTok{ }\NormalTok{breaks,]}
  
\NormalTok{  my.fcc}\OperatorTok{$}\NormalTok{period <-}\StringTok{ }\KeywordTok{c}\NormalTok{(my.fcc}\OperatorTok{$}\NormalTok{year[}\DecValTok{2}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(my.fcc)] }\OperatorTok{-}\StringTok{ }\NormalTok{my.fcc}\OperatorTok{$}\NormalTok{year[}\DecValTok{1}\OperatorTok{:}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(my.fcc)}\OperatorTok{-}\DecValTok{1}\NormalTok{)], }\OtherTok{NA}\NormalTok{)}
\NormalTok{  my.fcc}\OperatorTok{$}\NormalTok{center <-}\StringTok{ }\NormalTok{my.fcc}\OperatorTok{$}\NormalTok{year }\OperatorTok{+}\StringTok{ }\NormalTok{my.fcc}\OperatorTok{$}\NormalTok{period}\OperatorTok{/}\DecValTok{2} 

\NormalTok{  fcc.breaks}\OperatorTok{$}\NormalTok{period <-}\StringTok{ }\KeywordTok{c}\NormalTok{(fcc.breaks}\OperatorTok{$}\NormalTok{year[}\DecValTok{2}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(fcc.breaks)] }\OperatorTok{-}\StringTok{ }\NormalTok{fcc.breaks}\OperatorTok{$}\NormalTok{year[}\DecValTok{1}\OperatorTok{:}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(fcc.breaks)}\OperatorTok{-}\DecValTok{1}\NormalTok{)], }\OtherTok{NA}\NormalTok{)}
\NormalTok{  fcc.breaks}\OperatorTok{$}\NormalTok{center <-}\StringTok{ }\NormalTok{fcc.breaks}\OperatorTok{$}\NormalTok{year }\OperatorTok{+}\StringTok{ }\NormalTok{fcc.breaks}\OperatorTok{$}\NormalTok{period}\OperatorTok{/}\DecValTok{2} 
  
  
  \ControlFlowTok{if}\NormalTok{(zone}\OperatorTok{==}\StringTok{"TGO"}\NormalTok{) \{}
\NormalTok{    title    <-}\StringTok{ "Togo: Changements bruts et nets des surfaces forestières 2003 - 2018"}
\NormalTok{    ylim     <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\DecValTok{35000}\NormalTok{, }\DecValTok{20000}\NormalTok{)}
\NormalTok{    ybreaks  <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\OperatorTok{-}\DecValTok{35000}\NormalTok{, }\DecValTok{20000}\NormalTok{, }\DecValTok{5000}\NormalTok{)}
\NormalTok{    ymbreaks <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\OperatorTok{-}\DecValTok{35000}\NormalTok{, }\DecValTok{20000}\NormalTok{, }\DecValTok{2500}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    title    <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(zone, }\StringTok{": Changements bruts et nets des surfaces forestières 2003 - 2018"}\NormalTok{)}
\NormalTok{    ylim     <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\DecValTok{15000}\NormalTok{, }\DecValTok{10000}\NormalTok{)}
\NormalTok{    ybreaks  <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\OperatorTok{-}\DecValTok{15000}\NormalTok{, }\DecValTok{10000}\NormalTok{, }\DecValTok{5000}\NormalTok{)}
\NormalTok{    ymbreaks <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\OperatorTok{-}\DecValTok{15000}\NormalTok{, }\DecValTok{10000}\NormalTok{, }\DecValTok{2500}\NormalTok{)}
\NormalTok{  \} }

  
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename)) }\KeywordTok{pdf}\NormalTok{(filename)}
  
\NormalTok{  fcc.breaks}\OperatorTok{$}\NormalTok{netdefor.ha.yr <-}\StringTok{ }\NormalTok{fcc.breaks}\OperatorTok{$}\NormalTok{netch.ha.yr }
\NormalTok{  fcc.breaks}\OperatorTok{$}\NormalTok{netdefor.ha.yr[fcc.breaks}\OperatorTok{$}\NormalTok{netdefor.ha.yr }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\DecValTok{0}
\NormalTok{  fcc.breaks}\OperatorTok{$}\NormalTok{netregen.ha.yr <-}\StringTok{ }\NormalTok{fcc.breaks}\OperatorTok{$}\NormalTok{netch.ha.yr }
\NormalTok{  fcc.breaks}\OperatorTok{$}\NormalTok{netregen.ha.yr[fcc.breaks}\OperatorTok{$}\NormalTok{netregen.ha.yr }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\DecValTok{0}
  
  \KeywordTok{print}\NormalTok{(}
\NormalTok{    fcc.breaks[}\OperatorTok{-}\KeywordTok{nrow}\NormalTok{(fcc.breaks),] }\OperatorTok{%>%}\StringTok{ }\KeywordTok{gather}\NormalTok{(variable, value, defor.ha.yr, regen.ha.yr, netdefor.ha.yr, netregen.ha.yr) }\OperatorTok{%>%}
\StringTok{      }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{y=}\NormalTok{value, }\DataTypeTok{x =}\NormalTok{ center, }\DataTypeTok{width=}\NormalTok{period}\FloatTok{-0.7}\NormalTok{)) }\OperatorTok{+}
\StringTok{      }\KeywordTok{geom_bar}\NormalTok{(}\DataTypeTok{data=}\NormalTok{. }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(variable }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"defor.ha.yr"}\NormalTok{, }\StringTok{"regen.ha.yr"}\NormalTok{)), }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill=}\NormalTok{variable), }\DataTypeTok{stat =} \StringTok{"identity"}\NormalTok{) }\OperatorTok{+}
\StringTok{      }\KeywordTok{geom_bar}\NormalTok{(}\DataTypeTok{data=}\NormalTok{. }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(variable }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"netdefor.ha.yr"}\NormalTok{, }\StringTok{"netregen.ha.yr"}\NormalTok{)), }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill=}\NormalTok{variable), }\DataTypeTok{stat =} \StringTok{"identity"}\NormalTok{) }\OperatorTok{+}
\StringTok{      }\KeywordTok{geom_errorbar}\NormalTok{(}\DataTypeTok{data=}\NormalTok{my.fcc[}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{,], }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{center, }\DataTypeTok{y=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{ymax=}\NormalTok{defor.ha.yr, }\DataTypeTok{ymin=}\NormalTok{defor.ha.yr, }\DataTypeTok{width=}\NormalTok{period}\FloatTok{-0.7}\NormalTok{), }\DataTypeTok{colour=}\KeywordTok{alpha}\NormalTok{(}\StringTok{"#F8766D"}\NormalTok{, }\DecValTok{1}\NormalTok{)) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\KeywordTok{geom_hline}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{yintercept=}\DecValTok{0}\NormalTok{)) }\OperatorTok{+}
\StringTok{      }\KeywordTok{scale_fill_manual}\NormalTok{(}\DataTypeTok{name =} \OtherTok{NULL}\NormalTok{, }\DataTypeTok{breaks =} \KeywordTok{c}\NormalTok{(}\StringTok{"defor.ha.yr"}\NormalTok{, }\StringTok{"netdefor.ha.yr"}\NormalTok{, }\StringTok{"netregen.ha.yr"}\NormalTok{, }\StringTok{"regen.ha.yr"}\NormalTok{), }\DataTypeTok{values=}\KeywordTok{c}\NormalTok{(}\StringTok{"regen.ha.yr"}\NormalTok{ =}\StringTok{ }\KeywordTok{alpha}\NormalTok{(}\StringTok{"#00BFC4"}\NormalTok{, }\FloatTok{0.4}\NormalTok{), }\StringTok{"netregen.ha.yr"}\NormalTok{ =}\StringTok{ "#00BFC4"}\NormalTok{, }\StringTok{"netdefor.ha.yr"}\NormalTok{ =}\StringTok{ "#F8766D"}\NormalTok{, }\StringTok{"defor.ha.yr"}\NormalTok{ =}\StringTok{ }\KeywordTok{alpha}\NormalTok{(}\StringTok{"#F8766D"}\NormalTok{, }\FloatTok{0.4}\NormalTok{)), }\DataTypeTok{labels=}\KeywordTok{c}\NormalTok{(}\StringTok{"Perte brutte"}\NormalTok{, }\StringTok{"Perte nette"}\NormalTok{, }\StringTok{"Gain net"}\NormalTok{, }\StringTok{"Gain brut"}\NormalTok{)) }\OperatorTok{+}\StringTok{  }
\StringTok{      }\KeywordTok{xlab}\NormalTok{(}\StringTok{"Année"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ylab}\NormalTok{(}\StringTok{"Hectares par année"}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{ggtitle}\NormalTok{(title) }\OperatorTok{+}
\StringTok{      }\KeywordTok{scale_x_continuous}\NormalTok{(}\DataTypeTok{minor_breaks =} \OtherTok{NULL}\NormalTok{, }\DataTypeTok{breaks=}\KeywordTok{c}\NormalTok{(}\DecValTok{1991}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2005}\NormalTok{, }\DecValTok{2010}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2018}\NormalTok{)) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\KeywordTok{scale_y_reverse}\NormalTok{(}\DataTypeTok{breaks=}\NormalTok{ybreaks, }\DataTypeTok{minor_breaks =}\NormalTok{ ymbreaks) }\OperatorTok{+}\StringTok{ }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{ylim=}\NormalTok{ylim) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\KeywordTok{theme_light}\NormalTok{() }\OperatorTok{+}\StringTok{ }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\DataTypeTok{legend.box =} \StringTok{"horizontal"}\NormalTok{, }\DataTypeTok{legend.justification=}\KeywordTok{c}\NormalTok{(}\OperatorTok{-}\FloatTok{0.2}\NormalTok{,}\FloatTok{1.2}\NormalTok{))  }
\NormalTok{  )}
  
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(filename)) }\KeywordTok{dev.off}\NormalTok{()}
\NormalTok{\}}



\CommentTok{# DO THE WORK ##############################}

\CommentTok{# Load and rename forest-cover maps ----------------------------}

\NormalTok{maps <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(}\KeywordTok{dir}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(FCC.CLN.DIR, }\StringTok{"/FC"}\NormalTok{, COV.FC, }\StringTok{"/TGO"}\NormalTok{), }\DataTypeTok{pattern =} \StringTok{"cf.tif"}\NormalTok{, }\DataTypeTok{full.names =} \OtherTok{TRUE}\NormalTok{))}
\KeywordTok{names}\NormalTok{(maps) <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"X"}\NormalTok{, }\KeywordTok{substr}\NormalTok{(}\KeywordTok{names}\NormalTok{(maps), }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{))}

\CommentTok{# Create forest cover tables for different periods ------------------------------------}

\NormalTok{fc.all      <-}\StringTok{ }\KeywordTok{fc}\NormalTok{(maps)}
\KeywordTok{write.csv}\NormalTok{(fc.all, }\KeywordTok{paste0}\NormalTok{(FCC.RES.DIR, }\StringTok{"/TGO/TGO_fc.csv"}\NormalTok{), }\DataTypeTok{row.names=}\OtherTok{FALSE}\NormalTok{)}

\NormalTok{fc.all <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(FCC.RES.DIR, }\StringTok{"/TGO/TGO_fc.csv"}\NormalTok{))}

\NormalTok{fc.cln <-}\StringTok{ }\NormalTok{fc.all}
\NormalTok{fc.cln <-}\StringTok{ }\NormalTok{fc.cln[}\OperatorTok{!}\NormalTok{fc.cln}\OperatorTok{$}\NormalTok{year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1987}\NormalTok{, }\DecValTok{1991}\NormalTok{, }\DecValTok{2000}\NormalTok{), ]}

\KeywordTok{fcc}\NormalTok{(fc.cln)}
\KeywordTok{fcc}\NormalTok{(fc.cln, }\KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{, }\DecValTok{2018}\NormalTok{))}
\KeywordTok{fcc}\NormalTok{(fc.cln, }\KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2017}\NormalTok{, }\DecValTok{2018}\NormalTok{))}

\KeywordTok{write.xlsx}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"Total"}\NormalTok{ =}\StringTok{ }\KeywordTok{fcc}\NormalTok{(fc.cln)), }\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(FCC.RES.DIR, }\StringTok{"/TGO/TGO_fcc-all-dates.xlsx"}\NormalTok{))}
\KeywordTok{write.xlsx}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"Total"}\NormalTok{ =}\StringTok{ }\KeywordTok{fcc}\NormalTok{(fc.cln, }\KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{, }\DecValTok{2018}\NormalTok{))), }\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(FCC.RES.DIR, }\StringTok{"/TGO/TGO_fcc-03-18.xlsx"}\NormalTok{))}
\KeywordTok{write.xlsx}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"Total"}\NormalTok{ =}\StringTok{ }\KeywordTok{fcc}\NormalTok{(fc.cln, }\KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2018}\NormalTok{))), }\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(FCC.RES.DIR, }\StringTok{"/TGO/TGO_fcc-03-15-18.xlsx"}\NormalTok{))}

\KeywordTok{plot.fc}\NormalTok{(fc.cln,  }\StringTok{"TGO"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(FCC.RES.DIR, }\StringTok{"/TGO/TGO_fc.pdf"}\NormalTok{))}
\KeywordTok{plot.fcc}\NormalTok{(}\DataTypeTok{fc =}\NormalTok{ fc.cln, }\DataTypeTok{zone =} \StringTok{"TGO"}\NormalTok{, }\DataTypeTok{breaks=}\KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2018}\NormalTok{), }\DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(FCC.RES.DIR, }\StringTok{"/TGO/TGO_fcc.pdf"}\NormalTok{))}

\KeywordTok{registerDoParallel}\NormalTok{(.env}\OperatorTok{$}\NormalTok{numCores}\DecValTok{-1}\NormalTok{)}
\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{i=}\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(TGO.reg)) }\OperatorTok{%do%}\StringTok{ }\NormalTok{\{}
  
\NormalTok{  region <-}\StringTok{ }\NormalTok{TGO.reg[i,]}
  \CommentTok{# fc.all <- fc(maps, aoi=region)}
  \CommentTok{# write.csv(fc.all, paste0(RESULTS.DIR, "/tables/", region$NAME_1, "_fc.csv"), row.names=FALSE)}
  
\NormalTok{  fc.all <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/tables/"}\NormalTok{, region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }\StringTok{"_fc.csv"}\NormalTok{))}
  
\NormalTok{  fc.cln <-}\StringTok{ }\NormalTok{fc.all[}\OperatorTok{!}\NormalTok{fc.all}\OperatorTok{$}\NormalTok{year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1987}\NormalTok{, }\DecValTok{1991}\NormalTok{, }\DecValTok{2000}\NormalTok{), ]}
  
  \KeywordTok{plot.fc}\NormalTok{(fc.cln,  region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/figures/"}\NormalTok{, region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }\StringTok{"_fc.pdf"}\NormalTok{))}
  \KeywordTok{plot.fcc}\NormalTok{(fc.cln, region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }\DataTypeTok{breaks=}\KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2018}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/figures/"}\NormalTok{, region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }\StringTok{"_fcc.pdf"}\NormalTok{))}
  
  \KeywordTok{write.xlsx}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"Total"}\NormalTok{ =}\StringTok{ }\KeywordTok{fcc}\NormalTok{(fc.cln)), }\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/tables/"}\NormalTok{, region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }\StringTok{"_fcc-all-dates.xlsx"}\NormalTok{))}
  \KeywordTok{write.xlsx}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"Total"}\NormalTok{ =}\StringTok{ }\KeywordTok{fcc}\NormalTok{(fc.cln, }\KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{, }\DecValTok{2018}\NormalTok{))), }\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/tables/"}\NormalTok{, region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }\StringTok{"_fcc-03-18.xlsx"}\NormalTok{))}
  \KeywordTok{write.xlsx}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"Total"}\NormalTok{ =}\StringTok{ }\KeywordTok{fcc}\NormalTok{(fc.cln, }\KeywordTok{c}\NormalTok{(}\DecValTok{2003}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2018}\NormalTok{))), }\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/tables/"}\NormalTok{, region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }\StringTok{"_fcc-03-15-18.xlsx"}\NormalTok{))}
  
\NormalTok{\}}






\CommentTok{# creating GIS layers for forest loss and forest gain per date ---------------------------------------------}

\NormalTok{forest.loss <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(maps)}
\NormalTok{forest.gain <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(maps)      }\CommentTok{# create empty rasters from stack}
\NormalTok{forest.pote <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(maps)}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{(}\KeywordTok{nlayers}\NormalTok{(maps)}\OperatorTok{-}\DecValTok{1}\NormalTok{)) \{}
  \KeywordTok{print}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"Checking deforestation / reforestation in year "}\NormalTok{, maps.dates[i]))}
\NormalTok{  forest.loss[}\KeywordTok{is.na}\NormalTok{(forest.loss) }\OperatorTok{&}\StringTok{ }\KeywordTok{is.na}\NormalTok{(forest.gain) }\OperatorTok{&}\StringTok{ }\NormalTok{maps[[i]] }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{&}\StringTok{ }\NormalTok{maps[[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]] }\OperatorTok{==}\StringTok{ }\DecValTok{3}\NormalTok{] <-}\StringTok{ }\NormalTok{maps.dates[i] }\CommentTok{# take the first date of forest loss observed and only if no regeneration before that }
\NormalTok{  forest.gain[maps[[i]] }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{) }\OperatorTok{&}\StringTok{ }\NormalTok{maps[[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]] }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{] <-}\StringTok{ }\NormalTok{maps.dates[i]}
\NormalTok{  forest.pote[maps[[i]] }\OperatorTok{==}\DecValTok{3} \OperatorTok{&}\StringTok{ }\NormalTok{maps[[i}\OperatorTok{+}\DecValTok{1}\NormalTok{]] }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{] <-}\StringTok{ }\NormalTok{maps.dates[i]}
\NormalTok{\}}

\CommentTok{# special layer for forest gain in areas where loss has been observed before}
\NormalTok{loss.gain <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(maps)}
\NormalTok{loss.gain[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(forest.loss) }\OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(forest.gain) }\OperatorTok{&}\StringTok{ }\NormalTok{forest.gain }\OperatorTok{>}\StringTok{ }\NormalTok{forest.loss] <-}\StringTok{ }\NormalTok{forest.gain[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(forest.loss) }\OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(forest.gain) }\OperatorTok{&}\StringTok{ }\NormalTok{forest.gain }\OperatorTok{>}\StringTok{ }\NormalTok{forest.loss]}

\NormalTok{forest}\FloatTok{.2018}\NormalTok{ <-}\StringTok{ }\NormalTok{maps}\OperatorTok{$}\NormalTok{X2018}
\NormalTok{forest}\FloatTok{.2018}\NormalTok{[forest}\FloatTok{.2018}\OperatorTok{==}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{3}

\KeywordTok{writeRaster}\NormalTok{(forest}\FloatTok{.2018}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/maps/forest-2018.tif"}\NormalTok{),      }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{writeRaster}\NormalTok{(forest.loss, }\KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/maps/forest-loss.tif"}\NormalTok{),      }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{writeRaster}\NormalTok{(forest.gain, }\KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/maps/forest-gain.tif"}\NormalTok{),      }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{writeRaster}\NormalTok{(forest.pote, }\KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/maps/forest-potential.tif"}\NormalTok{), }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{writeRaster}\NormalTok{(loss.gain,   }\KeywordTok{paste0}\NormalTok{(RESULTS.DIR, }\StringTok{"/maps/loss-gain.tif"}\NormalTok{),        }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{NRF-analyse-AGB}{%
\subsection{Analyse biomasse aérienne}\label{NRF-analyse-AGB}}

Comme pour le couvert forestier, \textbf{la biomasse aérienne est également cartographiée} à la résolution des images Landsat (30 x 30 mètres). Tout d'abord, les données d'inventaire IFN-1 des années 2015/16 sont évalués pour leur biomasse aérienne. \textbf{La biomasse aérienne trouvé sur les parcelles d'échantillon IFN-1 sont ensuite utilisées pour calibrer un modèle de régression \emph{RandomForest} sur base des images satellitaires Landsat de l'année 2015 et les données climatiques WorldClim}. Ce modèle de biomasse est ensuite appliqué à l'ensemble de l'image Landsat et les données WorldClim pour obtenir une carte complète de la biomasse aérienne pour l'année de référence 2015.

Le schéma ci-dessous montre le processus d'analyse.

\includegraphics{images/AGB-Schema.png}

\textbf{La carte de référence de la biomasse aérienne 2015 sert comme base pour déterminer des cartes correspondantes pour les années 2003 (début de la période de référence) et 2018 (fin de la période de référence).}

Finalement, les différences entre les cartes de la biomasse 2003 et 2018 servent comme \textbf{facteurs d'émission pour les pixels déterminés comme déforestation ou reboisement} par l'analyse des surfaces forestiers au cours de la même période (voir section \ref{NRF-analyse-MCF}).

\hypertarget{analyse-des-donnees-ifn}{%
\subsubsection{Analyse des données IFN}\label{analyse-des-donnees-ifn}}

\hypertarget{description}{%
\paragraph{Description}\label{description}}
\addcontentsline{toc}{paragraph}{Description}

La détermination de la biomasse arborée est basée sur les données de l'inventaire forestier IFN-1 réalisé en 2015/16, en utilisant les données des parcelles (coordonnées du centre de la parcelle et strate de couverture du sol IFN), ainsi que les espèces d'arbres, le diamètre à hauteur poitrine (D à 1.3m) et la hauteur de \textbf{tous les arbres avec DHP ≥ 10 cm enregistrés dans un rayon de 20 mètres autour du centre de la parcelle}.

Toutes les espèces d'arbres sont attribuées avec leur \textbf{densité de bois basale ou infradensité, compilée par l'étude de la biomasse de Fonton et al (2018) en utilisant les bases de données \href{https://doi.org/10.5061/dryad.234}{GlobalWoodDensityDatabase} de Zanne et al. (2009) et \href{http://db.worldagroforestry.org/wd}{ICRAF Wood Density}}. La fonction allométrique de \href{https://onlinelibrary.wiley.com/doi/abs/10.1111/gcb.12629}{Chave et al. (2014)} est utilisé pour estimer la biomasse aérienne des arbres sur base de la densité du bois \(\rho\), du diamètre à hauteur poitrine \(D\) et de la hauteur totale \(H\) des arbres: \(B_{aérienne} = 0.0673 (\rho D^2 H)^{0.976}\). Selon l'étude de Fonton et al.~2018 \textbf{la fonction allométrique de \href{https://onlinelibrary.wiley.com/doi/abs/10.1111/gcb.12629}{Chave et al. (2014)} est la fonction la plus approprié pour l'estimation de la biomasse aérienne des arbres au Togo}.

Par la suite, les biomasses des arbres en surface sont additionnées pour toutes les parcelles et converties en tonnes de matière sèche par hectare. Cela est fait séparément pour les arbres vivants et les arbres morts. Sur la base de la biomasse aérienne par hectare, la biomasse racinaire est estimée à l'aide du \textbf{rapport racine-tige de \href{https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1365-2486.2005.001043.x}{Mokany et al (2006)} pour les forêts sèches tropicales} (0,563 ± 0,086 pour les forêts avec \(B_{aérienne} ≤ 20\) t/ha et 0,275 ± 0,003 pour les forêts avec \(B_{aérienne} > 20\) t/ha).

\hypertarget{example-7}{%
\paragraph{Example}\label{example-7}}

Répartition spatiale des \textbf{945 placettes d'inventaire de l'IFN-1} (la taille du cercle correspond à la biomasse trouvée sur les placettes) et répartition de la biomasse aérienne dans les différentes strates de l'IFN (données en tonnes de matière sèche par hectare).

\includegraphics{images/AGB-IFN.png}
Biomasse déterminée à partir des données IFN-1 (en tonnes de matière sèche par hectare) par strate IFN et par compartiment : biomasse aérienne des arbres, bois mort, biomasse racinaire des arbres, et biomasse totale des arbres.

\begin{table}[H]
\centering
\begin{tabular}{l|r|r|r|r|r|r|r|r|r}
\hline
\multicolumn{1}{c|}{ } & \multicolumn{1}{c|}{ } & \multicolumn{2}{c|}{\$B\_\{aérienne\}\$} & \multicolumn{2}{c|}{\$B\_\{morte\}\$} & \multicolumn{2}{c|}{\$B\_\{racinaire\}\$} & \multicolumn{2}{c}{\$B\_\{totale\}\$} \\
\cline{3-4} \cline{5-6} \cline{7-8} \cline{9-10}
Strate IFN & \$n\$ & \$\textbackslash{}\textbackslash{}\textbackslash{}mu\$ & \$\textbackslash{}\textbackslash{}\textbackslash{}sigma\$ & \$\textbackslash{}\textbackslash{}\textbackslash{}mu\$ & \$\textbackslash{}\textbackslash{}\textbackslash{}sigma\$ & \$\textbackslash{}\textbackslash{}\textbackslash{}mu\$ & \$\textbackslash{}\textbackslash{}\textbackslash{}sigma\$ & \$\textbackslash{}\textbackslash{}\textbackslash{}mu\$ & \$\textbackslash{}\textbackslash{}\textbackslash{}sigma\$\\
\hline
Cultures\_Jachères/Fourrées & 108 & 20.0 & 31.7 & 2.3 & 8.6 & 6.6 & 8.4 & 28.9 & 40.6\\
\hline
Forêts claires/savanes boisées & 251 & 50.1 & 33.5 & 2.1 & 5.2 & 14.4 & 8.7 & 66.6 & 42.6\\
\hline
Forêts denses & 138 & 96.8 & 69.7 & 3.8 & 7.5 & 26.8 & 19.0 & 127.3 & 89.3\\
\hline
Forêts riveraines/marécageuses & 101 & 84.1 & 66.1 & 3.5 & 5.9 & 23.3 & 18.0 & 110.8 & 84.9\\
\hline
Plantations forestières & 24 & 23.3 & 19.6 & 0.1 & 0.1 & 7.9 & 4.8 & 31.2 & 24.1\\
\hline
Plantations fruitières et de palmiers & 19 & 18.9 & 21.0 & 0.4 & 1.4 & 6.0 & 5.4 & 25.3 & 27.1\\
\hline
Savane arborée/savane arbustive & 277 & 16.4 & 15.4 & 0.7 & 1.6 & 6.3 & 4.1 & 23.3 & 19.7\\
\hline
NA & 27 & 0.0 & 0.0 & 0.0 & 0.0 & 0.0 & 0.0 & 0.0 & 0.0\\
\hline
\end{tabular}
\end{table}

\hypertarget{script-r-03_nrf-mrv02_agb_src01_compile-agb.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{03\_NRF-MRV/02\_AGB/\_src/01\_compile-AGB.R}}{Script R: 03\_NRF-MRV/02\_AGB/\_src/01\_compile-AGB.R}}\label{script-r-03_nrf-mrv02_agb_src01_compile-agb.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{03\_NRF-MRV/02\_AGB/\_src/01\_compile-AGB.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# 01_compile-AGB.R: Évaluation de la biomasse des données de l'IFN}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}

\NormalTok{PLOT.SIZE <-}\StringTok{ }\DecValTok{20}\OperatorTok{^}\DecValTok{2}\OperatorTok{*}\NormalTok{pi  }\CommentTok{# Taille de la parcelle en mètres carrés}

\CommentTok{# Rapports racines-tige forêts tropicales sèches selon Mokany et al. (2006)}
\CommentTok{# https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1365-2486.2005.001043.x}
\NormalTok{RSR.Y    <-}\StringTok{ }\FloatTok{0.563}     \CommentTok{# moyenne pour la jeune forêt      }
\NormalTok{RSR.Y.SE <-}\StringTok{ }\FloatTok{0.086}     \CommentTok{# écart type pour la jeune forêt  }
\NormalTok{RSR.O    <-}\StringTok{ }\FloatTok{0.275}     \CommentTok{# moyenne pour les forêts matures }
\NormalTok{RSR.O.SE <-}\StringTok{ }\FloatTok{0.003}     \CommentTok{# écart type pour les forêts matures}
\NormalTok{RSR.AGB  <-}\StringTok{ }\DecValTok{20}        \CommentTok{# Seuil biomasse aérienne jeunes forêts <-> forêts matures}


\CommentTok{# Lire et préparer les données IFN-1 ==========================================}

\NormalTok{plots <-}\StringTok{ }\KeywordTok{read.xlsx}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.RAW.DAT, }\StringTok{"/IFN/IFN-Togo-2015.xlsx"}\NormalTok{), }\StringTok{"placettes"}\NormalTok{)[,}\DecValTok{1}\OperatorTok{:}\DecValTok{4}\NormalTok{]}
\KeywordTok{names}\NormalTok{(plots) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"PlotID"}\NormalTok{, }\StringTok{"X"}\NormalTok{, }\StringTok{"Y"}\NormalTok{, }\StringTok{"LULC"}\NormalTok{)}

\NormalTok{trees <-}\StringTok{ }\KeywordTok{read.xlsx}\NormalTok{(}\StringTok{"~/Downloads/IFN-Togo-2015.xlsx"}\NormalTok{, }\StringTok{"arbres"}\NormalTok{)[,}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{4}\OperatorTok{:}\DecValTok{6}\NormalTok{,}\DecValTok{8}\NormalTok{)]}
\KeywordTok{names}\NormalTok{(trees) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"PlotID"}\NormalTok{, }\StringTok{"Species"}\NormalTok{, }\StringTok{"Status"}\NormalTok{, }\StringTok{"DBH"}\NormalTok{, }\StringTok{"H"}\NormalTok{)}

\CommentTok{# Tableau avec les espèces et le nombre d'observations}
\NormalTok{species <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{table}\NormalTok{(trees}\OperatorTok{$}\NormalTok{Species))}
\KeywordTok{names}\NormalTok{(species) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Species"}\NormalTok{, }\StringTok{"Count"}\NormalTok{)}

\CommentTok{# fusionner avec les densités de bois basales ---------------------------------}
\CommentTok{# Densité basale: rapport entre mass anhydre et volume vert (à l'état saturé)}
\CommentTok{# Source des données: étude biomasse de Fonton et al. 2018}
\NormalTok{fonton <-}\StringTok{ }\KeywordTok{read.csv2}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.RAW.DAT, }\StringTok{"/IFN/donnees_Tg_Fonton.csv"}\NormalTok{), }\DataTypeTok{encoding=}\StringTok{"latin1"}\NormalTok{)[,}\KeywordTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{,}\DecValTok{7}\NormalTok{)]}
\NormalTok{fonton <-}\StringTok{ }\KeywordTok{aggregate}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\DataTypeTok{D=}\NormalTok{fonton}\OperatorTok{$}\NormalTok{wsg), }\DataTypeTok{by=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{Species=}\NormalTok{fonton}\OperatorTok{$}\NormalTok{NOM), }\DataTypeTok{FUN=}\NormalTok{modal)}
\NormalTok{species <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(species[,}\KeywordTok{c}\NormalTok{(}\StringTok{"Species"}\NormalTok{, }\StringTok{"Count"}\NormalTok{)], }
\NormalTok{                     fonton[,}\KeywordTok{c}\NormalTok{(}\StringTok{"Species"}\NormalTok{, }\StringTok{"D"}\NormalTok{)], }\DataTypeTok{by=}\StringTok{"Species"}\NormalTok{)}
\NormalTok{species}\OperatorTok{$}\NormalTok{Source <-}\StringTok{ "Fonton"}

\CommentTok{# fusionner avec les arbres dans l'IFN-1}
\NormalTok{trees <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(trees, species, }\DataTypeTok{by=}\StringTok{"Species"}\NormalTok{, }\DataTypeTok{all.x=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# estimer la biomasse aérienne des arbres  ------------------------------------}
\CommentTok{# en utilisant la fonction allométrique de Chave et al. (2014)}
\CommentTok{# https://onlinelibrary.wiley.com/doi/abs/10.1111/gcb.12629}
\NormalTok{trees}\OperatorTok{$}\NormalTok{AGB <-}\StringTok{ }\FloatTok{0.0673} \OperatorTok{*}\StringTok{ }\NormalTok{(trees}\OperatorTok{$}\NormalTok{D }\OperatorTok{*}\StringTok{ }\NormalTok{trees}\OperatorTok{$}\NormalTok{DBH}\OperatorTok{^}\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{trees}\OperatorTok{$}\NormalTok{H)}\OperatorTok{^}\FloatTok{0.976}

\CommentTok{# distinguer la biomasse des arbres vivants et celle des arbres morts}
\NormalTok{trees}\OperatorTok{$}\NormalTok{AGBm <-}\StringTok{ }\NormalTok{trees}\OperatorTok{$}\NormalTok{AGBv <-}\StringTok{ }\NormalTok{trees}\OperatorTok{$}\NormalTok{AGB    }\CommentTok{# Dupliquer les valeurs de la biomasse ...}
\NormalTok{trees}\OperatorTok{$}\NormalTok{AGBv[trees}\OperatorTok{$}\NormalTok{Status }\OperatorTok{!=}\StringTok{ "V"}\NormalTok{] <-}\StringTok{ }\DecValTok{0}     \CommentTok{# ... et mettre à 0 aux endroits appropriés}
\NormalTok{trees}\OperatorTok{$}\NormalTok{AGBm[trees}\OperatorTok{$}\NormalTok{Status }\OperatorTok{==}\StringTok{ "V"}\NormalTok{] <-}\StringTok{ }\DecValTok{0}       

\CommentTok{# biomasse aérienne et bois mort par parcelle (somme des arbres) --------------}
\NormalTok{plots <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(plots, }
               \KeywordTok{aggregate}\NormalTok{(trees[,}\KeywordTok{c}\NormalTok{(}\StringTok{"AGBv"}\NormalTok{, }\StringTok{"AGBm"}\NormalTok{)], }
                         \DataTypeTok{by=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{PlotID=}\NormalTok{trees}\OperatorTok{$}\NormalTok{PlotID), }
                         \CommentTok{# somme dbiomasse es arbres -> à l'héctare -> en tonne}
                         \DataTypeTok{FUN=}\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{sum}\NormalTok{(x) }\OperatorTok{*}\StringTok{ }\DecValTok{10000} \OperatorTok{/}\StringTok{ }\NormalTok{PLOT.SIZE }\OperatorTok{/}\StringTok{ }\DecValTok{1000}\NormalTok{),  }
               \DataTypeTok{by=}\StringTok{"PlotID"}\NormalTok{, }\DataTypeTok{all.x=}\OtherTok{TRUE}\NormalTok{)  }
\CommentTok{# mettre à 0 la biomasse et le bois mort pour les parcelles sans valeurs (NA)}
\NormalTok{plots}\OperatorTok{$}\NormalTok{AGBv[}\KeywordTok{is.na}\NormalTok{(plots}\OperatorTok{$}\NormalTok{AGBv)] <-}\StringTok{ }\DecValTok{0}                                            
\NormalTok{plots}\OperatorTok{$}\NormalTok{AGBm[}\KeywordTok{is.na}\NormalTok{(plots}\OperatorTok{$}\NormalTok{AGBm)] <-}\StringTok{ }\DecValTok{0}
\NormalTok{plots}\OperatorTok{$}\NormalTok{AGB <-}\StringTok{ }\NormalTok{plots}\OperatorTok{$}\NormalTok{AGBv }\OperatorTok{+}\StringTok{ }\NormalTok{plots}\OperatorTok{$}\NormalTok{AGBm}


\CommentTok{# estimer la biomasse racinaire par parcelle ----------------------------------}
\CommentTok{# avec les facteurs root-shoot de Mokany et al. (2006) }

\CommentTok{# jeunes forêts}
\NormalTok{plots}\OperatorTok{$}\NormalTok{BGB[plots}\OperatorTok{$}\NormalTok{AGBv }\OperatorTok{<=}\StringTok{ }\NormalTok{RSR.AGB] <-}\StringTok{ }\NormalTok{plots}\OperatorTok{$}\NormalTok{AGBv[plots}\OperatorTok{$}\NormalTok{AGBv }\OperatorTok{<=}\StringTok{ }\NormalTok{RSR.AGB] }\OperatorTok{*}\StringTok{ }\NormalTok{RSR.Y}
\CommentTok{# forêts matures}
\NormalTok{plots}\OperatorTok{$}\NormalTok{BGB[plots}\OperatorTok{$}\NormalTok{AGBv  }\OperatorTok{>}\StringTok{ }\NormalTok{RSR.AGB] <-}\StringTok{ }\NormalTok{plots}\OperatorTok{$}\NormalTok{AGBv[plots}\OperatorTok{$}\NormalTok{AGBv  }\OperatorTok{>}\StringTok{ }\NormalTok{RSR.AGB] }\OperatorTok{*}\StringTok{ }\NormalTok{RSR.O }

\CommentTok{# Biomasse totale = biomasse aérienne (vivant et mort) + biomasse racinaire}
\NormalTok{plots}\OperatorTok{$}\NormalTok{BM <-}\StringTok{ }\NormalTok{plots}\OperatorTok{$}\NormalTok{AGB }\OperatorTok{+}\StringTok{ }\NormalTok{plots}\OperatorTok{$}\NormalTok{BGB}


\CommentTok{# Sauvegarder le résultat et production des figures et tableaux ===============}
\CommentTok{# Note: sur Mac utiliser fileEncoding = "macintosh" }

\KeywordTok{write.csv}\NormalTok{(plots, }\KeywordTok{paste0}\NormalTok{(DIR.MRV.AGB.REF, }\StringTok{"/IFN-plots.csv"}\NormalTok{), }
          \DataTypeTok{row.names =} \OtherTok{FALSE}\NormalTok{) }\CommentTok{#, fileEncoding = "macintosh")}


\CommentTok{# distribution des biomasses par strate IFN ------------------------------------}

\CommentTok{# boxplot biomasse aérienne}
\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.MRV.AGB.REF, }\StringTok{"/AGB-vs-LULC.pdf"}\NormalTok{))}
\KeywordTok{par}\NormalTok{(}\DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\DecValTok{11}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\DataTypeTok{cex.axis=}\FloatTok{0.7}\NormalTok{)}
\KeywordTok{boxplot}\NormalTok{(plots}\OperatorTok{$}\NormalTok{AGBv}\OperatorTok{~}\NormalTok{plots}\OperatorTok{$}\NormalTok{LULC, }\DataTypeTok{las=}\DecValTok{2}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"AGB (t/ha)"}\NormalTok{, }\DataTypeTok{xlab=}\OtherTok{NULL}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}

\CommentTok{# boxplot bois mort}
\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(AGB.REF.DIR, }\StringTok{"/AGBm-vs-LULC.pdf"}\NormalTok{))}
\KeywordTok{par}\NormalTok{(}\DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\DecValTok{11}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\DataTypeTok{cex.axis=}\FloatTok{0.7}\NormalTok{)}
\KeywordTok{boxplot}\NormalTok{(plots}\OperatorTok{$}\NormalTok{AGBm}\OperatorTok{~}\NormalTok{plots}\OperatorTok{$}\NormalTok{LULC, }\DataTypeTok{las=}\DecValTok{2}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Bmort (t/ha)"}\NormalTok{, }\DataTypeTok{xlab=}\OtherTok{NULL}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}

\CommentTok{# tableau biomass per LU/LC category (moyenne et écart type)}
\NormalTok{bm.lulc.tab <-}\StringTok{ }\NormalTok{plots }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(LULC) }\OperatorTok{%>%}\StringTok{            }\CommentTok{# grouper par strate}
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{n=}\KeywordTok{length}\NormalTok{(AGB),      }\CommentTok{# definir colonnes et calcul des valeurs}
            \DataTypeTok{AGBv.mean=}\KeywordTok{mean}\NormalTok{(AGBv), }\DataTypeTok{AGBv.sd=}\KeywordTok{sd}\NormalTok{(AGBv),     }
            \DataTypeTok{BGB.mean=}\KeywordTok{mean}\NormalTok{(BGB), }\DataTypeTok{BGB.sd=}\KeywordTok{sd}\NormalTok{(BGB),}
            \DataTypeTok{AGBm.mean=}\KeywordTok{mean}\NormalTok{(AGBm), }\DataTypeTok{AGBm.sd=}\KeywordTok{sd}\NormalTok{(AGBm), }
            \DataTypeTok{BM.mean =}\KeywordTok{mean}\NormalTok{(BM),  }\DataTypeTok{BM.sd =}\KeywordTok{sd}\NormalTok{(BM))}
\KeywordTok{write.csv}\NormalTok{(bm.lulc.tab, }\KeywordTok{paste0}\NormalTok{(AGB.REF.DIR, }\StringTok{"/AGB_LULC.csv"}\NormalTok{), }
          \DataTypeTok{row.names =} \OtherTok{FALSE}\NormalTok{) }\CommentTok{#, fileEncoding = "macintosh")}

\CommentTok{# différences biomasse par type de conversion LU/LC ---------------------------}
\NormalTok{dbm.lulc.tab <-}\StringTok{ }\NormalTok{bm.lulc.tab }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{expand}\NormalTok{(}\DataTypeTok{FROM =} \KeywordTok{nesting}\NormalTok{(LULC, AGB.mean, AGB.sd, BGB.mean, BGB.sd, BM.mean, BM.sd), }
         \DataTypeTok{TO   =} \KeywordTok{nesting}\NormalTok{(LULC, AGB.mean, AGB.sd, BGB.mean, BGB.sd, BM.mean, BM.sd)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{from =}\NormalTok{ FROM}\OperatorTok{$}\NormalTok{LULC, }\DataTypeTok{to =}\NormalTok{ TO}\OperatorTok{$}\NormalTok{LULC,}
         \DataTypeTok{dAGB.mean =}\NormalTok{ TO}\OperatorTok{$}\NormalTok{AGB.mean }\OperatorTok{-}\StringTok{ }\NormalTok{FROM}\OperatorTok{$}\NormalTok{AGB.mean, }\DataTypeTok{dAGB.sd=}\KeywordTok{sqrt}\NormalTok{(FROM}\OperatorTok{$}\NormalTok{AGB.sd}\OperatorTok{^}\DecValTok{2} \OperatorTok{+}\StringTok{ }\NormalTok{TO}\OperatorTok{$}\NormalTok{AGB.sd}\OperatorTok{^}\DecValTok{2}\NormalTok{),}
         \DataTypeTok{dBGB.mean =}\NormalTok{ TO}\OperatorTok{$}\NormalTok{BGB.mean }\OperatorTok{-}\StringTok{ }\NormalTok{FROM}\OperatorTok{$}\NormalTok{BGB.mean, }\DataTypeTok{dBGB.sd=}\KeywordTok{sqrt}\NormalTok{(FROM}\OperatorTok{$}\NormalTok{BGB.sd}\OperatorTok{^}\DecValTok{2} \OperatorTok{+}\StringTok{ }\NormalTok{TO}\OperatorTok{$}\NormalTok{BGB.sd}\OperatorTok{^}\DecValTok{2}\NormalTok{),}
         \DataTypeTok{dBM.mean  =}\NormalTok{ TO}\OperatorTok{$}\NormalTok{BM.mean  }\OperatorTok{-}\StringTok{ }\NormalTok{FROM}\OperatorTok{$}\NormalTok{BM.mean,  }\DataTypeTok{dBM.sd =}\KeywordTok{sqrt}\NormalTok{(FROM}\OperatorTok{$}\NormalTok{BM.sd}\OperatorTok{^}\DecValTok{2}  \OperatorTok{+}\StringTok{ }\NormalTok{TO}\OperatorTok{$}\NormalTok{BM.sd}\OperatorTok{^}\DecValTok{2}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(}\KeywordTok{c}\NormalTok{(from, to, dAGB.mean, dAGB.sd, dBGB.mean, dBGB.sd, dBM.mean, dBM.sd))}
\KeywordTok{write.csv}\NormalTok{(dbm.lulc.tab, }\KeywordTok{paste0}\NormalTok{(AGB.REF.DIR, }\StringTok{"/AGB_LULC-diff.csv"}\NormalTok{), }
          \DataTypeTok{row.names =} \OtherTok{FALSE}\NormalTok{) }\CommentTok{#, fileEncoding = "macintosh")}
\end{Highlighting}
\end{Shaded}

\hypertarget{NRF-agb-maps}{%
\subsubsection{Calibration et prédiction}\label{NRF-agb-maps}}

\hypertarget{description-1}{%
\paragraph{Description}\label{description-1}}
\addcontentsline{toc}{paragraph}{Description}

A partir de la \textbf{biomasse aérienne déterminée sur les parcelles IFN en 2015/16} (t/ha matière sèche), un modèle de biomasse est calibré sur bases de \protect\hyperlink{SSTS-Landsat}{l'image satellitaire Landsat} de 2015 (bandes et indices \texttt{B,\ G,\ R,\ NIR,\ SWIR1,\ SWIR2,\ nbr,\ ndmi,\ ndvi,\ evi}) et les \protect\hyperlink{SSTS-Worldclim}{données climatiques Worldclim} (\texttt{BIO1,\ BIO4,\ BIO12,\ BIO15}). Ce sont les mêmes variables qui ont déjà été utilisées pour la \protect\hyperlink{NRF-create-fc-maps}{classification forêt/non-forêt}.

\textbf{Dans une première étape, les variables sont extraites}, c'est-à-dire que les valeurs des pixels sous les rayons des parcelles sont lues à partir des images Landsat et Worldclim et moyennées en conséquence. Ensuite, les variable sont mis en correspandance avec les biomasses aériennes à travers un \textbf{modèle de régression \texttt{RandomForest}}. Ce modèle est utilisé pour créer une carte de la biomasse aérienne pour l'année 2015.

En supposant que la biomasse sur la plupart des pixels reste constante, \textbf{la carte de la biomasse aérienne 2015 est utilisée comme base pour calibrer des cartes pour les années 2003 et 2018} (début et fin de la période de référence) avec la même méthode: 0,1\% des pixels de la carte de la biomasse 2015 (environ 100 000 pixels) sont utilisés comme pixels d'entraînement pour la calibration d'un modèle RandomForest qui est ensuite utilisé pour la production de la carte.

\hypertarget{example-8}{%
\paragraph{Example}\label{example-8}}

Répartition spatiale des \textbf{945 placettes d'inventaire de l'IFN-1} (la taille du cercle correspond à la biomasse trouvée sur les placettes) et carte de la biomasse aérienne résultant. Le diagramme de dispersion montre la correlation entre la biomasse sur la carte et celle trouvé sur les parcelles de l'IFN (R\textsuperscript{2} = 70.7\%). La carte sous-estime les fortes biomasses (effet de saturation).

\includegraphics{images/AGB-refmap-2015.png}

Utilisation de la \textbf{carte de biomasse 2015 comme référence pour la calibration des cartes 2003 et 2018}. Le détail montre une région au sud de Kpalimé.

\includegraphics{images/AGB-rawmaps.png}

\hypertarget{script-r-03_nrf-mrv02_agb_src02_create-agb-maps.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{03\_NRF-MRV/02\_AGB/\_src/02\_create-AGB-maps.R}}{Script R: 03\_NRF-MRV/02\_AGB/\_src/02\_create-AGB-maps.R}}\label{script-r-03_nrf-mrv02_agb_src02_create-agb-maps.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{03\_NRF-MRV/02\_AGB/\_src/02\_create-AGB-maps.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# 02_create-AGB-maps.R: Modélisation et création des cartes de biomasse}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}

\NormalTok{AGB.STRATA     <-}\StringTok{ }\DecValTok{10}     \CommentTok{# Nombre de strates de biomasse pour l'échantillonnage}
\NormalTok{N.PIXELS       <-}\StringTok{ }\OtherTok{NA}     \CommentTok{# Nombre de pixels non-NA (sera déterminé plus tard)}
\NormalTok{SAMPLE.RATIO   <-}\StringTok{ }\FloatTok{0.001}  \CommentTok{# Rapport des pixels non-NA à échantilloner}
\NormalTok{CAL.RATIO      <-}\StringTok{ }\DecValTok{1}      \CommentTok{# Rapport des pixels à échantillonner pour la calibration }

\CommentTok{# Bandes à utiliser pour la modélisation forêt vs. non-forêt}
\NormalTok{PREDICTORS  <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"B"}\NormalTok{, }\StringTok{"G"}\NormalTok{, }\StringTok{"R"}\NormalTok{, }\StringTok{"NIR"}\NormalTok{, }\StringTok{"SWIR1"}\NormalTok{, }\StringTok{"SWIR2"}\NormalTok{,}
                 \StringTok{"nbr"}\NormalTok{, }\StringTok{"ndmi"}\NormalTok{, }\StringTok{"ndvi"}\NormalTok{, }\StringTok{"evi"}\NormalTok{,          }
                 \StringTok{"BIO1"}\NormalTok{, }\StringTok{"BIO4"}\NormalTok{, }\StringTok{"BIO12"}\NormalTok{, }\StringTok{"BIO15"}\NormalTok{) }

\CommentTok{# Répertoires}
\NormalTok{LANDSAT.DIR <-}\StringTok{ }\NormalTok{DIR.SST.DAT.LST}
\NormalTok{WORLDCLIM.DIR <-}\StringTok{ }\NormalTok{DIR.SST.DAT.WC2}
\NormalTok{REF.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.AGB.REF}


\CommentTok{# Définitions des fonctions ===================================================}

\CommentTok{# Charger un image Landsat ----------------------------------------------------}
\CommentTok{#}
\CommentTok{# @param filename  Chemin du fichier landsat}
\CommentTok{#}
\CommentTok{# @return          Image Landsat avec bandes nommées }
\CommentTok{#}

\NormalTok{load.image <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(filename) \{}
\NormalTok{  image <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(LANDSAT.DIR, filename))}
  \KeywordTok{names}\NormalTok{(image) <-}\StringTok{ }\NormalTok{SST.LSBANDS}
  \KeywordTok{return}\NormalTok{(image)}
\NormalTok{\}}

\CommentTok{# Prédiction d'une carte biomasse ---------------------------------------------}
\CommentTok{#}
\CommentTok{# @param image      Image Landsat à classifier      }
\CommentTok{# @param filename   Nom de fichier pour la sauvegarde de la carte}
\CommentTok{# @param bioclim    Raster des variables bioclimatiques à utiliser}
\CommentTok{# @param train.dat  Tableau des données d'entraînement}
\CommentTok{# @param ref.map    Carte de référence}
\CommentTok{# @param n.ref.map  Nombre de points à échantilloner}
\CommentTok{# @param cal.map    Carte de calibration (autre chemin WRS)}
\CommentTok{# @param n.cal.map  Nombre de points à échantilloner}
\CommentTok{# @param mask       Masque à utiliser pour ref.map et cal.map}
\CommentTok{# @param preds      Variables à utiliser pour le modèle}
\CommentTok{# @param type       Modèle de classification ou de regression}
\CommentTok{# @param crossval   Faire validation croisée (3 * 10-fold)}
\CommentTok{# @param bias.corr  Faire une correction linéaire du bias}
\CommentTok{# @param n.cores    Nombre de processeurs à utiliser pour prédiction}
\CommentTok{#}
\CommentTok{# @return           List avec les éléments }
\CommentTok{#                   - model RandomForest, }
\CommentTok{#                   - model linéaire du correction du bias}
\CommentTok{#                   - carte biomasse}
\CommentTok{#}

\NormalTok{agb.map <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(image, filename, }\DataTypeTok{bioclim=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{train.dat=}\OtherTok{NULL}\NormalTok{, }
                    \DataTypeTok{ref.map=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{n.ref.map=}\OtherTok{NULL}\NormalTok{, }
                    \DataTypeTok{cal.map=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{n.cal.map=}\OtherTok{NULL}\NormalTok{, }
                    \DataTypeTok{mask=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{preds=}\OtherTok{NULL}\NormalTok{, }
                    \DataTypeTok{crossval=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{bias.corr=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{n.cores=}\DecValTok{8}\NormalTok{) \{}
  
  \CommentTok{# Ouvrir le fichier journal}
\NormalTok{  name <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\StringTok{"[.]tif$"}\NormalTok{, }\StringTok{""}\NormalTok{, filename)}
\NormalTok{  txtfile <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\KeywordTok{sub}\NormalTok{(}\StringTok{"[.]tif$"}\NormalTok{, }\StringTok{""}\NormalTok{, filename), }\StringTok{".txt"}\NormalTok{)}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"-- Biomass map: "}\NormalTok{, }\KeywordTok{basename}\NormalTok{(filename), }\StringTok{"/"}\NormalTok{, }\KeywordTok{date}\NormalTok{(), }\StringTok{" --}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile)}
  
  \CommentTok{# Tirer des données d'entraînement d'une carte de référence -------}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(ref.map)) \{}
    \KeywordTok{cat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"    -Masking / buffering reference map ... }\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
    \CommentTok{# ... couper/masquer avec l'image}
\NormalTok{    ref.map  <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(ref.map, image[[}\DecValTok{1}\NormalTok{]]), }\KeywordTok{crop}\NormalTok{(image[[}\DecValTok{1}\NormalTok{]], ref.map))}
    \CommentTok{# ... et masque additionelle (si disponible) }
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(mask)) ref.map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(ref.map, mask)                     }
    \CommentTok{# Découper la carte de calibration (si disponible) }
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(cal.map)) \{}
\NormalTok{       tmp <-}\StringTok{ }\KeywordTok{extend}\NormalTok{(}\KeywordTok{crop}\NormalTok{(cal.map, ref.map), ref.map)}
\NormalTok{       ref.map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(ref.map, tmp, }\DataTypeTok{inverse=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{    \}}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"    "}\NormalTok{)}
    \CommentTok{# Tirer des points d'échantillon (stratifié selon classe biomasse) ...}
    \KeywordTok{cat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"    -Sampling map (n="}\NormalTok{, AGB.STRATA, }\StringTok{"*"}\NormalTok{, }\KeywordTok{round}\NormalTok{(n.ref.map}\OperatorTok{/}\NormalTok{AGB.STRATA), }\StringTok{") ... "}\NormalTok{))}
\NormalTok{    ref.pts <-}\StringTok{ }\KeywordTok{sampleStratified}\NormalTok{(}\KeywordTok{cut}\NormalTok{(ref.map, AGB.STRATA), }
                                \KeywordTok{round}\NormalTok{(n.ref.map}\OperatorTok{/}\NormalTok{AGB.STRATA), }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{]  }
    \KeywordTok{names}\NormalTok{(ref.pts) <-}\StringTok{ "AGB"}
    \CommentTok{# ... extraire les valeurs spectrales et bioclimatique correspondantes ...}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"extracting values ... }\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    ref.dat <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(}\DataTypeTok{AGB=}\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(ref.map, ref.pts, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{], }
\NormalTok{                     raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(image, ref.pts, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{],}
\NormalTok{                     raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(bioclim, ref.pts, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{])}
    
    \KeywordTok{cat}\NormalTok{(}\StringTok{"Ref-map points: "}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(ref.dat), }\StringTok{"/"}\NormalTok{, ref.map}\OperatorTok{@}\NormalTok{file}\OperatorTok{@}\NormalTok{name, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
    \CommentTok{# ... et ajouter aux données d'entraînement (si disponible)}
    \ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(train.dat)) \{}
\NormalTok{      train.dat <-}\StringTok{ }\NormalTok{ref.dat}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      train.dat <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(train.dat, ref.dat)}
\NormalTok{    \}}
\NormalTok{  \}}
  
  \CommentTok{# Ajouter des points d'une carte de calibration -------------------}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(cal.map)) \{}
    \KeywordTok{cat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"    -Masking calibration map ... }\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
    \CommentTok{# ... couper/masquer avec l'image}
\NormalTok{    cal.map  <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(cal.map, image[[}\DecValTok{1}\NormalTok{]]), }\KeywordTok{crop}\NormalTok{(image[[}\DecValTok{1}\NormalTok{]], cal.map))}
    \CommentTok{# ... et masque additionelle (si disponible)}
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(mask)) cal.map <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(cal.map, mask)}
    \CommentTok{# Tirer des points d'échantillon (stratifié selon classe biomasse) ...}
    \KeywordTok{cat}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"    -Sampling map (n="}\NormalTok{, AGB.STRATA, }\StringTok{"*"}\NormalTok{, }\KeywordTok{round}\NormalTok{(n.cal.map}\OperatorTok{/}\NormalTok{AGB.STRATA), }\StringTok{") ... "}\NormalTok{))}
\NormalTok{    cal.pts <-}\StringTok{ }\KeywordTok{sampleStratified}\NormalTok{(}\KeywordTok{cut}\NormalTok{(cal.map, AGB.STRATA), }
                                \KeywordTok{round}\NormalTok{(n.cal.map}\OperatorTok{/}\NormalTok{AGB.STRATA), }\DataTypeTok{sp=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{]}
    \KeywordTok{names}\NormalTok{(cal.pts) <-}\StringTok{ "AGB"}
    \CommentTok{# ... extraire les valeurs spectrales et bioclimatique correspondantes ...}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"extracting values ... }\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    cal.dat <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(}\DataTypeTok{AGB=}\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(cal.map, cal.pts, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{], }
\NormalTok{                     raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(image, cal.pts, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{],}
\NormalTok{                     raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(bioclim, cal.pts, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\OperatorTok{-}\DecValTok{1}\NormalTok{])}
    \CommentTok{# ... et ajouter aux points d'entraînement}
    \ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(train.dat)) \{}
\NormalTok{        train.dat <-}\StringTok{ }\NormalTok{cal.dat}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        train.dat <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(train.dat, cal.dat)}
\NormalTok{    \}}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"Cal-map points: "}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(cal.dat), }
        \StringTok{"from"}\NormalTok{, cal.map}\OperatorTok{@}\NormalTok{file}\OperatorTok{@}\NormalTok{name, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \CommentTok{# Nombre total des points d'entraînement}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"Total points:   "}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(train.dat), }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
  
  
  \CommentTok{# Calibration du modèle Random Forest -----------------------------}
  \CommentTok{# Utiliser toutes les variables si non-spécifiées dans les paramètres}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(preds)) \{}
\NormalTok{    preds <-}\StringTok{ }\KeywordTok{names}\NormalTok{(image)}
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(bioclim)) preds <-}\StringTok{ }\KeywordTok{c}\NormalTok{(preds, }\KeywordTok{names}\NormalTok{(bioclim))}
\NormalTok{  \}}
  \CommentTok{# calibrer RandomForest (mode de régression) }
  \KeywordTok{cat}\NormalTok{(}\StringTok{"    -Calibrating RandomForest ... "}\NormalTok{)}
  \KeywordTok{sink}\NormalTok{(txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
  \CommentTok{# Utiliser caret::train pour validation croisée (a besoin de beaucoup de temps)}
  \ControlFlowTok{if}\NormalTok{(crossval) \{}
\NormalTok{    map.model.cv <-}\StringTok{ }\KeywordTok{train}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ train.dat[,}\DecValTok{1}\NormalTok{], }
                          \DataTypeTok{x =}\NormalTok{ train.dat[,preds],}
                          \DataTypeTok{method =} \StringTok{"rf"}\NormalTok{,              }\CommentTok{# RandomForest}
                          \DataTypeTok{importance =} \OtherTok{TRUE}\NormalTok{,}
                          \DataTypeTok{trControl =} \KeywordTok{trainControl}\NormalTok{(}
                            \DataTypeTok{method =} \StringTok{"repeatedcv"}\NormalTok{,}
                            \DataTypeTok{number =} \DecValTok{10}\NormalTok{,              }\CommentTok{# k-fold}
                            \DataTypeTok{repeats =} \DecValTok{3}\NormalTok{))             }\CommentTok{# répétitions}
    \KeywordTok{print}\NormalTok{(map.model.cv)}
\NormalTok{    map.model <-}\StringTok{ }\NormalTok{map.model.cv}\OperatorTok{$}\NormalTok{finalModel}
    \KeywordTok{print}\NormalTok{(map.model)}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \KeywordTok{print}\NormalTok{(}\KeywordTok{varImp}\NormalTok{(map.model, }\DataTypeTok{scale=}\OtherTok{FALSE}\NormalTok{))}
  \CommentTok{# autrement randomForest directement}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    map.model <-}\StringTok{ }\KeywordTok{randomForest}\NormalTok{(}\DataTypeTok{y=}\NormalTok{train.dat[,}\DecValTok{1}\NormalTok{], }\DataTypeTok{x=}\NormalTok{train.dat[,preds], }
                              \DataTypeTok{importance=}\OtherTok{TRUE}\NormalTok{) }\CommentTok{# , do.trace=100)}
    \KeywordTok{print}\NormalTok{(map.model)}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \KeywordTok{print}\NormalTok{(}\KeywordTok{varImp}\NormalTok{(map.model))}
\NormalTok{  \}}
  \KeywordTok{sink}\NormalTok{()}
  \CommentTok{# Mesures des erreurs}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"R2:"}\NormalTok{, }\KeywordTok{round}\NormalTok{(map.model}\OperatorTok{$}\NormalTok{rsq[}\DecValTok{500}\NormalTok{], }\DecValTok{2}\NormalTok{), }
      \StringTok{"RMSE:"}\NormalTok{, }\KeywordTok{round}\NormalTok{(}\KeywordTok{sqrt}\NormalTok{(map.model}\OperatorTok{$}\NormalTok{mse[}\DecValTok{500}\NormalTok{]), }\DecValTok{2}\NormalTok{), }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \CommentTok{# Model linéaire de correction du bias}
  \ControlFlowTok{if}\NormalTok{(bias.corr) \{}
\NormalTok{    bc <-}\StringTok{ }\KeywordTok{lm}\NormalTok{(train.dat}\OperatorTok{$}\NormalTok{AGB }\OperatorTok{~}\StringTok{ }\NormalTok{map.model}\OperatorTok{$}\NormalTok{predicted)}
    \KeywordTok{sink}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(name, }\StringTok{"_bc.txt"}\NormalTok{), }\DataTypeTok{split=}\OtherTok{TRUE}\NormalTok{)}
    \KeywordTok{print}\NormalTok{(}\KeywordTok{summary}\NormalTok{(bc))}
    \KeywordTok{sink}\NormalTok{()}
    \KeywordTok{save}\NormalTok{(bc, }\DataTypeTok{file=}\KeywordTok{paste0}\NormalTok{(name, }\StringTok{"_bc.RData"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    bc <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{  \}}
  \CommentTok{# Diagramme de dispersion prédiction vs. observation}
  \KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(name, }\StringTok{".pdf"}\NormalTok{))}
  \KeywordTok{plot}\NormalTok{(train.dat}\OperatorTok{$}\NormalTok{AGB }\OperatorTok{~}\StringTok{ }\NormalTok{map.model}\OperatorTok{$}\NormalTok{predicted, }
       \DataTypeTok{ylab=}\StringTok{"AGB (tDM/ha)"}\NormalTok{, }\DataTypeTok{xlab=}\StringTok{"Predicted AGB (tDM/ha)"}\NormalTok{)}
  \KeywordTok{abline}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{, }\DataTypeTok{lty=}\DecValTok{2}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(bias.corr) \{}
    \KeywordTok{abline}\NormalTok{(bc, }\DataTypeTok{lty=}\DecValTok{3}\NormalTok{, }\DataTypeTok{col=}\StringTok{"red"}\NormalTok{)}
\NormalTok{  \}}
  \KeywordTok{dev.off}\NormalTok{()}
  
  \CommentTok{# Classification de la carte biomasse -----------------------------}
  \KeywordTok{dir.create}\NormalTok{(}\KeywordTok{dirname}\NormalTok{(filename), }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{showWarnings=}\OtherTok{FALSE}\NormalTok{)}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"    -Creating map ... "}\NormalTok{)}
  \CommentTok{# empiler les couches Landsat et bioclim}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(bioclim)) image <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(image, }\KeywordTok{crop}\NormalTok{(bioclim, image))}
  \CommentTok{# classifier l'image sur différents procésseurs en parallèle}
  \KeywordTok{beginCluster}\NormalTok{(}\DataTypeTok{n=}\NormalTok{n.cores)}
\NormalTok{  map <-}\StringTok{ }\KeywordTok{clusterR}\NormalTok{(image, predict, }\DataTypeTok{args=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{model=}\NormalTok{map.model))}
  \KeywordTok{endCluster}\NormalTok{()}
  \CommentTok{# appliquer la correction du bias (si disponible)}
  \ControlFlowTok{if}\NormalTok{(bias.corr) \{}
    \KeywordTok{cat}\NormalTok{(}\StringTok{"Applying linear bias correction ..."}\NormalTok{)}
\NormalTok{    map <-}\StringTok{ }\KeywordTok{calc}\NormalTok{(map, }\DataTypeTok{fun=}\ControlFlowTok{function}\NormalTok{(x)\{bc}\OperatorTok{$}\NormalTok{coefficients[}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\StringTok{ }\NormalTok{bc}\OperatorTok{$}\NormalTok{coefficients[}\DecValTok{2}\NormalTok{]}\OperatorTok{*}\NormalTok{x\})}
\NormalTok{  \} }
  \CommentTok{# sauvegarder la carte}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"writing map ... "}\NormalTok{)}
\NormalTok{  map <-}\StringTok{ }\KeywordTok{writeRaster}\NormalTok{(map, }\DataTypeTok{filename=}\NormalTok{filename, }
                     \DataTypeTok{format=}\StringTok{"GTiff"}\NormalTok{, }\DataTypeTok{datatype=}\StringTok{"INT2U"}\NormalTok{, }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"done}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  
  
  \KeywordTok{cat}\NormalTok{(}\StringTok{"-- Done: "}\NormalTok{, }\KeywordTok{basename}\NormalTok{(filename), }\StringTok{"/"}\NormalTok{, }\KeywordTok{date}\NormalTok{(), }\StringTok{" --}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\DataTypeTok{file=}\NormalTok{txtfile, }\DataTypeTok{append=}\OtherTok{TRUE}\NormalTok{)}
  
  \KeywordTok{invisible}\NormalTok{(}\KeywordTok{list}\NormalTok{(}
    \StringTok{"rf.model"}\NormalTok{ =}\StringTok{ }\NormalTok{map.model,}
    \StringTok{"bc.model"}\NormalTok{ =}\StringTok{ }\NormalTok{bc,}
    \StringTok{"map"}\NormalTok{      =}\StringTok{ }\NormalTok{map}
\NormalTok{  ))}
\NormalTok{\}}
  


\CommentTok{# COMMENCER LE TRAITEMENT #####################################################}

\CommentTok{# Carte de référence 2015 =====================================================}

\CommentTok{# Charger images 2015 ---------------------------------------------------------}
\NormalTok{ref.p192 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IMAGES.DIR, }\StringTok{"/p192/p192_2015_m.tif"}\NormalTok{))}
\NormalTok{ref.p193 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IMAGES.DIR, }\StringTok{"/p193/p193_2015_m.tif"}\NormalTok{))}
\NormalTok{ref.p194 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IMAGES.DIR, }\StringTok{"/p194/p194_2015_m.tif"}\NormalTok{))}
\KeywordTok{names}\NormalTok{(ref.p192) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(ref.p193) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(ref.p194) <-}\StringTok{ }\NormalTok{BANDS}
\NormalTok{ref.images <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{p192=}\NormalTok{ref.p192, }\DataTypeTok{p193=}\NormalTok{ref.p193, }\DataTypeTok{p194=}\NormalTok{ref.p194)}

\CommentTok{# Détérminer le nombre de pixels non-NA}
\NormalTok{N.PIXELS <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{p192 =} \KeywordTok{ncell}\NormalTok{(ref.p192[[}\StringTok{"B"}\NormalTok{]]) }\OperatorTok{-}\StringTok{ }\KeywordTok{summary}\NormalTok{(ref.p192)[}\StringTok{"NA's"}\NormalTok{,}\StringTok{"B"}\NormalTok{],}
                 \DataTypeTok{p193 =} \KeywordTok{ncell}\NormalTok{(ref.p193[[}\StringTok{"B"}\NormalTok{]]) }\OperatorTok{-}\StringTok{ }\KeywordTok{summary}\NormalTok{(ref.p193)[}\StringTok{"NA's"}\NormalTok{,}\StringTok{"B"}\NormalTok{],}
                 \DataTypeTok{p194 =} \KeywordTok{ncell}\NormalTok{(ref.p194[[}\StringTok{"B"}\NormalTok{]]) }\OperatorTok{-}\StringTok{ }\KeywordTok{summary}\NormalTok{(ref.p194)[}\StringTok{"NA's"}\NormalTok{,}\StringTok{"B"}\NormalTok{])}

\CommentTok{# Charger variables bioclim}
\NormalTok{bioclim.p192 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IMAGES.DIR, }\StringTok{"/p192/p192_bioclim.tif"}\NormalTok{))}
\NormalTok{bioclim.p193 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IMAGES.DIR, }\StringTok{"/p193/p193_bioclim.tif"}\NormalTok{))}
\NormalTok{bioclim.p194 <-}\StringTok{ }\KeywordTok{brick}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(IMAGES.DIR, }\StringTok{"/p194/p194_bioclim.tif"}\NormalTok{))}
\KeywordTok{names}\NormalTok{(bioclim.p192) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(bioclim.p193) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(bioclim.p194) <-}\StringTok{ }\NormalTok{BIOCLIM}
\NormalTok{bioclim <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{p192=}\NormalTok{bioclim.p192, }\DataTypeTok{p193=}\NormalTok{bioclim.p193, }\DataTypeTok{p194=}\NormalTok{bioclim.p194)}


\CommentTok{# Charger les données d'inventaire --------------------------------------------}
\NormalTok{plots      <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/IFN-plots.csv"}\NormalTok{)) }\CommentTok{# , fileEncoding="macintosh")}

\CommentTok{# Convertir en points spatiales en utilisant les coordonnées}
\KeywordTok{coordinates}\NormalTok{(plots) <-}\StringTok{ }\ErrorTok{~}\NormalTok{X}\OperatorTok{+}\NormalTok{Y   }
\KeywordTok{proj4string}\NormalTok{(plots) <-}\StringTok{ }\NormalTok{utm}\FloatTok{.31}

\CommentTok{# Figure de distribution spatiale des points}
\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/IFN-plots_location.pdf"}\NormalTok{),}
    \DataTypeTok{width=}\FloatTok{3.5}\NormalTok{, }\DataTypeTok{height=}\DecValTok{7}\NormalTok{)}
\KeywordTok{par}\NormalTok{(}\DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(}\KeywordTok{spTransform}\NormalTok{(TGO, utm}\FloatTok{.31}\NormalTok{), }\DataTypeTok{col=}\StringTok{"lightyellow"}\NormalTok{)}
\KeywordTok{plot}\NormalTok{(plots, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{col=}\StringTok{"black"}\NormalTok{, }\DataTypeTok{pch=}\DecValTok{16}\NormalTok{, }\DataTypeTok{cex=}\FloatTok{0.3}\NormalTok{)}
\KeywordTok{plot}\NormalTok{(plots, }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{col=}\StringTok{"darkgreen"}\NormalTok{, }\DataTypeTok{pch=}\DecValTok{1}\NormalTok{, }\DataTypeTok{cex=}\NormalTok{plots}\OperatorTok{$}\NormalTok{AGB}\OperatorTok{/}\DecValTok{100}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}

\CommentTok{# Convertir les polygones des parcelles en points spatiaux (centroïdes)}
\NormalTok{plots.poly <-}\StringTok{ }\KeywordTok{SpatialPolygonsDataFrame}\NormalTok{(}\KeywordTok{gBuffer}\NormalTok{(plots, }\DataTypeTok{byid=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{width=}\DecValTok{20}\NormalTok{), plots}\OperatorTok{@}\NormalTok{data)}


\CommentTok{# Extraire les valeurs spéctrales pour les parcelles IFN ----------------------}
\KeywordTok{registerDoParallel}\NormalTok{(CORES)}
\CommentTok{# ... pour chaque image Landsat (chemin WRS) ...}
\NormalTok{x <-}\StringTok{ }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{i=}\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(ref.images), }\DataTypeTok{.combine=}\NormalTok{cbind) }\OperatorTok{%:%}\StringTok{ }
\StringTok{  }\CommentTok{# ... et pour chaque couche spéctrale (bandes et indices) ...}
\StringTok{  }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{j=}\DecValTok{1}\OperatorTok{:}\KeywordTok{nlayers}\NormalTok{(ref.images[[i]]), }\DataTypeTok{.combine=}\NormalTok{cbind) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
      \CommentTok{# ... calculer la valeur moyenne pondérée au dessous de la parcelle IFN}
\NormalTok{      raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(ref.images[[i]][[j]], plots.poly, }\DataTypeTok{weights=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{fun=}\NormalTok{mean, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\DecValTok{2}\NormalTok{]}
\NormalTok{  \}}

\CommentTok{# Extraire les valeurs bioclimatiques pour les parcelles IFN (en parallèle)}
\NormalTok{x2 <-}\StringTok{ }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{i=}\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(bioclim), }\DataTypeTok{.combine=}\NormalTok{cbind) }\OperatorTok{%:%}\StringTok{ }
\StringTok{  }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{j=}\DecValTok{1}\OperatorTok{:}\KeywordTok{nlayers}\NormalTok{(bioclim[[i]]), }\DataTypeTok{.combine=}\NormalTok{cbind) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
\NormalTok{    raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(bioclim[[i]][[j]], plots, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\DecValTok{2}\NormalTok{]}
\NormalTok{  \}}

\CommentTok{# Séparer les données d'entraînement selon les différents chemins WRS}
\CommentTok{# (13 variables spéctrales et 19 variables bioclim pour chaque chemin WRS)}
\NormalTok{dat.p192 <-}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(}\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(plots}\OperatorTok{$}\NormalTok{AGB, x[,}\DecValTok{1}\OperatorTok{:}\DecValTok{13}\NormalTok{], x2[,}\DecValTok{1}\OperatorTok{:}\DecValTok{19}\NormalTok{])))}
\NormalTok{dat.p193 <-}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(}\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(plots}\OperatorTok{$}\NormalTok{AGB, x[,}\DecValTok{14}\OperatorTok{:}\DecValTok{26}\NormalTok{], x2[,}\DecValTok{20}\OperatorTok{:}\DecValTok{38}\NormalTok{])))}
\NormalTok{dat.p194 <-}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(}\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(plots}\OperatorTok{$}\NormalTok{AGB, x[,}\DecValTok{27}\OperatorTok{:}\DecValTok{39}\NormalTok{], x2[,}\DecValTok{39}\OperatorTok{:}\DecValTok{57}\NormalTok{])))}
\KeywordTok{names}\NormalTok{(dat.p192) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(dat.p193) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(dat.p194) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AGB"}\NormalTok{, SSTS.LSBANDS, SSTS.BIOCLIM)}
\NormalTok{train.data <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{p192=}\NormalTok{dat.p192, }\DataTypeTok{p193=}\NormalTok{dat.p193, }\DataTypeTok{p194=}\NormalTok{dat.p194)}


\CommentTok{# Séléction des variables explicatives ----------------------------------------}
\CommentTok{# }\AlertTok{TODO}\CommentTok{: inclure la carte de régénération comme prédicteur !}

\NormalTok{agb.varsel <-}\StringTok{ }\KeywordTok{rfe}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ dat.p193[,}\DecValTok{1}\NormalTok{],           }\CommentTok{# biomasse (1ère colonne)}
                  \DataTypeTok{x =}\NormalTok{ dat.p193[,}\OperatorTok{-}\DecValTok{1}\NormalTok{],          }\CommentTok{# prédicteurs (reste)}
                  \DataTypeTok{sizes =} \KeywordTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{10}\NormalTok{),}
                  \DataTypeTok{rfeControl =} \KeywordTok{rfeControl}\NormalTok{(}
                    \DataTypeTok{functions =}\NormalTok{ rfFuncs,      }\CommentTok{# utiliser RandomForest}
                    \DataTypeTok{method  =} \StringTok{"repeatedcv"}\NormalTok{,   }\CommentTok{# validation croisée}
                    \DataTypeTok{number  =} \DecValTok{10}\NormalTok{,             }\CommentTok{# 10-fold}
                    \DataTypeTok{repeats =} \DecValTok{3}\NormalTok{))             }\CommentTok{# 3 répétitions}

\KeywordTok{sink}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2015_AGB_varsel-fin.txt"}\NormalTok{), }\DataTypeTok{split=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{predictors}\NormalTok{(agb.varsel)}
\KeywordTok{print}\NormalTok{(agb.varsel)}
\KeywordTok{sink}\NormalTok{()}

\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2015_AGB_varsel-fin.pdf"}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(var.sel, }\DataTypeTok{type=}\KeywordTok{c}\NormalTok{(}\StringTok{"g"}\NormalTok{, }\StringTok{"o"}\NormalTok{))}
\KeywordTok{dev.off}\NormalTok{()}

\CommentTok{# Cartes de référence biomasse aérienne 2015 -------------------------------}

\CommentTok{# Chemin WRS p193}
\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p193.}\FloatTok{2015.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p193/p193_2015_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p193"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2015_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =}\NormalTok{ train.data[[}\StringTok{"p193"}\NormalTok{]],}
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{TRUE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{)}

\CommentTok{# Chemins WRS p192 and p194, utilisant p193 pour calibration}
\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p192.}\FloatTok{2015.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p192/p192_2015_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p192"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p192_2015_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =}\NormalTok{ train.data[[}\StringTok{"p192"}\NormalTok{]],}
                         \CommentTok{# calibration avec carte p193 ...}
                         \DataTypeTok{cal.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2015_AGB_R.tif"}\NormalTok{)),}
                         \CommentTok{# ... avec au moin 200 points}
                         \DataTypeTok{n.cal.map =} \KeywordTok{max}\NormalTok{(}\DecValTok{200}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(train.data[[}\StringTok{"p192"}\NormalTok{]])}\OperatorTok{*}\NormalTok{CAL.RATIO), }
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{,}
                         \DataTypeTok{mask      =}\NormalTok{ TGO)}

\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p194.}\FloatTok{2015.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p194/p194_2015_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p194"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p194_2015_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =}\NormalTok{ train.data[[}\StringTok{"p194"}\NormalTok{]],}
                         \CommentTok{# calibration avec carte p193 ...}
                         \DataTypeTok{cal.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2015_AGB_R.tif"}\NormalTok{)),}
                         \CommentTok{# ... avec au moin 200 points}
                         \DataTypeTok{n.cal.map =} \KeywordTok{max}\NormalTok{(}\DecValTok{200}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(train.data[[}\StringTok{"p194"}\NormalTok{]])}\OperatorTok{*}\NormalTok{CAL.RATIO), }
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{,}
                         \DataTypeTok{mask      =}\NormalTok{ TGO) }

\CommentTok{# Fusionner les cartes des chemins p192, p193 et p194}
\NormalTok{agb}\FloatTok{.2015}\NormalTok{ <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{mosaic}\NormalTok{(}\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p192_2015_AGB_R.tif"}\NormalTok{)),}
                             \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2015_AGB_R.tif"}\NormalTok{)), }
                             \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p194_2015_AGB_R.tif"}\NormalTok{)),}
                             \DataTypeTok{fun=}\NormalTok{mean),  }\CommentTok{# valeur moyenne pour les superpositions}
\NormalTok{                      TGO), }
\NormalTok{                 TGO, }
                 \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{), }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# Sauvgarder un image de la carte biomasse 2015}
\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.pdf"}\NormalTok{),}
    \DataTypeTok{width=}\FloatTok{3.5}\NormalTok{, }\DataTypeTok{height=}\DecValTok{7}\NormalTok{)}
\KeywordTok{par}\NormalTok{(}\DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(agb}\FloatTok{.2015}\NormalTok{, }\DataTypeTok{axes=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{col=}\KeywordTok{brewer.pal}\NormalTok{(}\DecValTok{9}\NormalTok{, }\StringTok{"YlGn"}\NormalTok{), }\DataTypeTok{zlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{220}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(}\KeywordTok{spTransform}\NormalTok{(TGO, utm}\FloatTok{.31}\NormalTok{), }\DataTypeTok{add=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}


\CommentTok{# Correction de la sous-estimation des valeurs biomasse élevés ----------------}

\CommentTok{# Diagramme de dispersion carte biomasse 2015 vs. observation parcelles IFN}
\NormalTok{plots.poly}\OperatorTok{$}\NormalTok{AGB.pred <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(agb}\FloatTok{.2015}\NormalTok{, plots.poly, }\DataTypeTok{weights=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{fun=}\NormalTok{mean, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\DecValTok{2}\NormalTok{]}
\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/AGB-model_2015.pdf"}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(plots.poly}\OperatorTok{$}\NormalTok{AGB.pred }\OperatorTok{~}\StringTok{ }\NormalTok{plots.poly}\OperatorTok{$}\NormalTok{AGB, }
     \DataTypeTok{xlab=}\StringTok{"Biomasse aérienne IFN (t/ha)"}\NormalTok{, }
     \DataTypeTok{ylab=}\StringTok{"Carte AGB 2015 (t/ha)"}\NormalTok{, }
     \DataTypeTok{xlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{350}\NormalTok{), }\DataTypeTok{ylim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{350}\NormalTok{))}
\KeywordTok{abline}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DataTypeTok{lty=}\StringTok{"dashed"}\NormalTok{)}
\KeywordTok{dev.off}\NormalTok{()}

\CommentTok{# Correction pour réduire la sous-estimation des valeurs élevés}
\NormalTok{cv <-}\StringTok{ }\KeywordTok{train}\NormalTok{(AGB }\OperatorTok{~}\StringTok{ }\NormalTok{AGB.pred, }
            \DataTypeTok{data=}\NormalTok{plots.poly}\OperatorTok{@}\NormalTok{data[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(plots.poly}\OperatorTok{$}\NormalTok{AGB.pred),], }
            \DataTypeTok{method =} \StringTok{"lm"}\NormalTok{,        }\CommentTok{# régression linéaire}
            \DataTypeTok{trControl =} \KeywordTok{trainControl}\NormalTok{(}
              \DataTypeTok{method =} \StringTok{"cv"}\NormalTok{,      }\CommentTok{# validation croisée}
              \DataTypeTok{number =} \DecValTok{10}\NormalTok{))       }\CommentTok{# 10-fold}
\NormalTok{model <-}\StringTok{ }\KeywordTok{lm}\NormalTok{(AGB }\OperatorTok{~}\StringTok{ }\NormalTok{AGB.pred, }\DataTypeTok{data=}\NormalTok{plots.poly}\OperatorTok{@}\NormalTok{data[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(plots.poly}\OperatorTok{$}\NormalTok{AGB.pred),])}
\KeywordTok{sink}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_Rc.txt"}\NormalTok{), }\DataTypeTok{split=}\OtherTok{TRUE}\NormalTok{)}
\KeywordTok{print}\NormalTok{(cv)}
\KeywordTok{summary}\NormalTok{(model)}
\KeywordTok{sink}\NormalTok{()}
\NormalTok{agb}\FloatTok{.2015}\NormalTok{ <-}\StringTok{ }\KeywordTok{writeRaster}\NormalTok{(model}\OperatorTok{$}\NormalTok{coefficients[}\StringTok{"(Intercept)"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\NormalTok{model}\OperatorTok{$}\NormalTok{coefficients[}\StringTok{"AGB.pred"}\NormalTok{] }\OperatorTok{*}\StringTok{ }\NormalTok{agb}\FloatTok{.2015}\NormalTok{, }
                        \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{), }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# Diagramme de dispersion carte biomasse 2015 corrigé vs. observation parcelles IFN}
\NormalTok{agb.pred.c <-}\StringTok{ }\NormalTok{raster}\OperatorTok{::}\KeywordTok{extract}\NormalTok{(agb}\FloatTok{.2015}\NormalTok{, plots.poly, }\DataTypeTok{weights=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{fun=}\NormalTok{mean, }\DataTypeTok{df=}\OtherTok{TRUE}\NormalTok{)[,}\DecValTok{2}\NormalTok{]}
\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/AGB-model_2015_c.pdf"}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(agb.pred }\OperatorTok{~}\StringTok{ }\NormalTok{plots.poly}\OperatorTok{$}\NormalTok{AGB, }
     \DataTypeTok{xlab=}\StringTok{"Biomasse aérienne IFN (t/ha)"}\NormalTok{, }
     \DataTypeTok{ylab=}\StringTok{"Carte AGB 2015 (t/ha)"}\NormalTok{, }
     \DataTypeTok{xlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{350}\NormalTok{), }\DataTypeTok{ylim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{350}\NormalTok{))}
\KeywordTok{abline}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DataTypeTok{lty=}\StringTok{"dashed"}\NormalTok{) }
\KeywordTok{dev.off}\NormalTok{()}


\CommentTok{# Carte biomasse 2003 (sur base de la carte 2015) =============================}

\CommentTok{# Chemins WRS p193}
\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p193.}\FloatTok{2003.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p193/p193_2003_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p193"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2003_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =} \OtherTok{NULL}\NormalTok{,}
                         \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.ref.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p193"}\NormalTok{]],}
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{TRUE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{)}

\CommentTok{# Chemins WRS p192 and p194, utilisant p193 pour calibration}
\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p192.}\FloatTok{2003.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p192/p192_2003_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p192"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p192_2003_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =} \OtherTok{NULL}\NormalTok{,}
                         \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.ref.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p192"}\NormalTok{]] }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{CAL.RATIO),}
                         \DataTypeTok{cal.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2003_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.cal.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p192"}\NormalTok{]] }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{CAL.RATIO),}
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{,}
                         \DataTypeTok{mask      =}\NormalTok{ TGO)}

\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p194.}\FloatTok{2003.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p194/p194_2003_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p194"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p194_2003_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =} \OtherTok{NULL}\NormalTok{,}
                         \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.ref.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p194"}\NormalTok{]] }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{CAL.RATIO),}
                         \DataTypeTok{cal.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2003_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.cal.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p194"}\NormalTok{]] }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{CAL.RATIO), }
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{,}
                         \DataTypeTok{mask      =}\NormalTok{ TGO)}

\CommentTok{# Fusionner les cartes des chemins p192, p193 et p194}
\NormalTok{agb}\FloatTok{.2003}\NormalTok{ <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{mosaic}\NormalTok{(}\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p192_2003_AGB_R.tif"}\NormalTok{)),}
                             \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2003_AGB_R.tif"}\NormalTok{)), }
                             \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p194_2003_AGB_R.tif"}\NormalTok{)),}
                             \DataTypeTok{fun=}\NormalTok{mean),}
\NormalTok{                      TGO), }
\NormalTok{                 TGO, }
                 \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2003_AGB_R.tif"}\NormalTok{), }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}


\CommentTok{# Carte biomasse 2003 (sur base de la carte 2015) =============================}

\CommentTok{# Chemins WRS p193}
\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p193.}\FloatTok{2018.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p193/p193_2018_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p193"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2018_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =} \OtherTok{NULL}\NormalTok{,}
                         \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.ref.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p193"}\NormalTok{]],}
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{TRUE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{)}

\CommentTok{# Chemins WRS p192 and p194, utilisant p193 pour calibration}
\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p192.}\FloatTok{2018.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p192/p192_2018_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p192"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p192_2018_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =} \OtherTok{NULL}\NormalTok{,}
                         \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.ref.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p192"}\NormalTok{]] }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{CAL.RATIO),}
                         \DataTypeTok{cal.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2018_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.cal.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p192"}\NormalTok{]] }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{CAL.RATIO),}
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{,}
                         \DataTypeTok{mask      =}\NormalTok{ TGO)}

\KeywordTok{set.RSEED}\NormalTok{(RSEED)}
\NormalTok{p194.}\FloatTok{2018.}\NormalTok{agb <-}\StringTok{ }\KeywordTok{agb.map}\NormalTok{(}\DataTypeTok{image     =} \KeywordTok{load.image}\NormalTok{(}\StringTok{"/p194/p194_2018_m.tif"}\NormalTok{), }
                         \DataTypeTok{bioclim   =}\NormalTok{ bioclim[[}\StringTok{"p194"}\NormalTok{]],}
                         \DataTypeTok{filename  =} \KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p194_2018_AGB_R.tif"}\NormalTok{),}
                         \DataTypeTok{train.dat =} \OtherTok{NULL}\NormalTok{,}
                         \DataTypeTok{ref.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.ref.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p194"}\NormalTok{]] }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\NormalTok{CAL.RATIO),}
                         \DataTypeTok{cal.map   =} \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2018_AGB_R.tif"}\NormalTok{)),}
                         \DataTypeTok{n.cal.map =}\NormalTok{ SAMPLE.RATIO }\OperatorTok{*}\StringTok{ }\NormalTok{N.PIXELS[[}\StringTok{"p194"}\NormalTok{]] }\OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{+}\StringTok{ }\DecValTok{1}\OperatorTok{/}\NormalTok{CAL.RATIO), }
                         \DataTypeTok{preds     =}\NormalTok{ PREDICTORS,}
                         \DataTypeTok{crossval  =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{bias.corr =} \OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{n.cores   =} \DecValTok{32}\NormalTok{,}
                         \DataTypeTok{mask      =}\NormalTok{ TGO)}

\CommentTok{# Fusionner les cartes des chemins p192, p193 et p194}
\NormalTok{agb}\FloatTok{.2018}\NormalTok{ <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(}\KeywordTok{mosaic}\NormalTok{(}\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p192_2018_AGB_R.tif"}\NormalTok{)),}
                             \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p193_2018_AGB_R.tif"}\NormalTok{)), }
                             \KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/p194_2018_AGB_R.tif"}\NormalTok{)),}
                             \DataTypeTok{fun=}\NormalTok{mean),}
\NormalTok{                      TGO), }
\NormalTok{                 TGO, }
                 \DataTypeTok{filename=}\KeywordTok{paste0}\NormalTok{(REF.DIR, }\StringTok{"/TGO_2018_AGB_R.tif"}\NormalTok{), }\DataTypeTok{overwrite=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{analyse-emissionssequestrations}{%
\subsection{Analyse émissions/séquestrations}\label{analyse-emissionssequestrations}}

\hypertarget{description-2}{%
\paragraph{Description}\label{description-2}}
\addcontentsline{toc}{paragraph}{Description}

Le calcul des \textbf{émissions de CO\textsubscript{2} dues à la déforestation et à la séquestration par le reboisement} au cours de la période de référence 2003--2018 est basé sur les \protect\hyperlink{NRF-clean-fc-maps}{cartes forêt/non-forêt néttoyées} de 2003 et 2018, ainsi que sur les \protect\hyperlink{NRF-agb-maps}{cartes de la biomasse aérienne} des années correspondantes.

Dans une première étape, la \textbf{biomasse racinaire est calculée sur la base des cartes de la biomasse aérienne}, en utilisant les \textbf{rapports racine-tige de \href{https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1365-2486.2005.001043.x}{Mokany et al (2006)} pour les forêts sèches tropicales}.

\textbf{Le calcul des émissions de CO\textsubscript{2}, et fait sur base des cartes de biomasse (aérienne et racinaire) de l'année 2003, en considerant que les pixels qui ont été classés comme forêt en 2003 et comme non-forêt en 2018}. La biomasse restant après la déforestation est pris en compte par la soustraction de la biomasse moyenne des pixels non-forêt en 2018. Pour les pixels où une différence négative en résulte (augmentation de la biomasse malgré la déforestation), celle-ci est fixée à 0. La conversion de la biomasse en CO\textsubscript{2} se fait au moyen d'une teneur en carbone de la biomasse de 0,47 (\href{https://www.ipcc-nggip.iges.or.jp/public/2006gl/pdf/4_Volume4/V4_04_Ch4_Forest_Land.pdf\#page=48}{GIEC, 2006}) et du rapport des poids moléculaires CO\textsubscript{2}/C de 44/12.

\textbf{La même procédure est utilisée pour calculer la séquestration due au reboisement entre 2003 et 2018}. La biomasse des pixels reboisés de 2003 est soustraite de celle de 2018. Lorsque la différence est négative (diminution de la biomasse malgré le reboisement), elle est fixée à 0.

\hypertarget{example-9}{%
\paragraph{Example}\label{example-9}}

\textbf{Les résultats sont évalués pour l'ensemble du territoire du Togo et les différents régions}: La superficie annuelle déboisée (ha/a), la perte moyenne de biomasse et de CO\textsubscript{2} due à la déforestation par hectare déboisé (tCO\textsubscript{2}/ha) et la perte annuelle totale sur la zone analysée (tCO\textsubscript{2}/a). L'évaluation de la croissance de la biomasse et de la séquestration du CO\textsubscript{2} due au reboisement est effectuée de manière analogue.

\begin{table}[H]
\centering
\begin{tabular}{l|r|r|r|r|r|r|r|r}
\hline
\multicolumn{1}{c|}{ } & \multicolumn{3}{c|}{Déforestation} & \multicolumn{3}{c|}{Reboisement} & \multicolumn{2}{c}{Total} \\
\cline{2-4} \cline{5-7} \cline{8-9}
Région & ha/a & tCO\textasciitilde{}2\textasciitilde{}/ha & tCO\textasciitilde{}2\textasciitilde{}/a & ha/a & tCO\textasciitilde{}2\textasciitilde{}/ha & tCO\textasciitilde{}2\textasciitilde{}/a & ha/a & tCO\textasciitilde{}2\textasciitilde{}/a\\
\hline
TGO & -15'060 & -62.7 & -944'475 & 9'824 & 21.8 & 213'885 & -5'236 & -730'590\\
\hline
Centre & -4'683 & -95.2 & -445'750 & 2'883 & 26.5 & 76'489 & -1'799 & -369'261\\
\hline
Kara & -1'545 & -56.7 & -87'631 & 694 & 28.7 & 19'896 & -851 & -67'735\\
\hline
Maritime & -3'273 & -1.6 & -5'306 & 2'467 & 8.8 & 21'784 & -806 & 16'479\\
\hline
Plateaux & -5'284 & -65.8 & -347'859 & 3'666 & 22.7 & 83'157 & -1'618 & -264'702\\
\hline
Savanes & -275 & -52.4 & -14'399 & 114 & 32.9 & 3'745 & -161 & -10'654\\
\hline
\end{tabular}
\end{table}

\hypertarget{script-r-03_nrf-mrv02_agb_src04_analyze-er.r}{%
\paragraph{\texorpdfstring{Script R: \texttt{03\_NRF-MRV/02\_AGB/\_src/04\_analyze-ER.R}}{Script R: 03\_NRF-MRV/02\_AGB/\_src/04\_analyze-ER.R}}\label{script-r-03_nrf-mrv02_agb_src04_analyze-er.r}}
\addcontentsline{toc}{paragraph}{Script R: \texttt{03\_NRF-MRV/02\_AGB/\_src/04\_analyze-ER.R}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{###############################################################################}
\CommentTok{# 04_analyze-ER.R: Analyse des émissions et séquestrations CO2}
\CommentTok{# -----------------------------------------------------------------------------}
\CommentTok{# Bern University of Applied Sciences}
\CommentTok{# Oliver Gardi, <oliver.gardi@bfh.ch>}
\CommentTok{# 13 Mai 2020}

\CommentTok{# Définitions des variables ===================================================}

\CommentTok{# Rapports racines-tige forêts tropicales sèches selon Mokany et al. (2006)}
\CommentTok{# https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1365-2486.2005.001043.x}
\NormalTok{RSR.Y    <-}\StringTok{ }\FloatTok{0.563}     \CommentTok{# moyenne pour la jeune forêt      }
\NormalTok{RSR.Y.SE <-}\StringTok{ }\FloatTok{0.086}     \CommentTok{# écart type pour la jeune forêt  }
\NormalTok{RSR.O    <-}\StringTok{ }\FloatTok{0.275}     \CommentTok{# moyenne pour les forêts matures }
\NormalTok{RSR.O.SE <-}\StringTok{ }\FloatTok{0.003}     \CommentTok{# écart type pour les forêts matures}
\NormalTok{RSR.AGB  <-}\StringTok{ }\DecValTok{20}        \CommentTok{# Seuil biomasse aérienne jeunes forêts <-> forêts matures}

\CommentTok{# Teneur en carbone de la biomasse (valeur défault IPCC 2006)}
\CommentTok{# https://www.ipcc-nggip.iges.or.jp/public/2006gl/pdf/4_Volume4/V4_04_Ch4_Forest_Land.pdf#page=48}
\NormalTok{C.RATIO  <-}\StringTok{ }\FloatTok{0.47}

\CommentTok{# Répétoires des cartes biomasse et des résultats}
\NormalTok{AGB.REF.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.AGB.REF}
\NormalTok{AGB.RES.DIR <-}\StringTok{ }\NormalTok{DIR.MRV.AGB.RES}



\CommentTok{# Analyse des cartes de biomasse aérienne =====================================}

\CommentTok{# Biomasse aérienne par strate IFN (carte RapidEye) ---------------------------}

\NormalTok{agb}\FloatTok{.2015}\NormalTok{ <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(AGB.REF.DIR, }\StringTok{"/TGO_2015_AGB_R.tif"}\NormalTok{))}
\NormalTok{strata  <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.RAW.DAT, }\StringTok{"/RapidEye/TGO_30m.tif"}\NormalTok{))}

\KeywordTok{zonal}\NormalTok{(agb}\FloatTok{.2015}\NormalTok{, strata, }\DataTypeTok{fun=}\StringTok{"mean"}\NormalTok{)}
\KeywordTok{zonal}\NormalTok{(agb}\FloatTok{.2015}\NormalTok{, strata, }\DataTypeTok{fun=}\StringTok{"sd"}\NormalTok{)}

\CommentTok{# Distribution des biomasses aériennes (densité) ------------------------------}

\CommentTok{# Charger cartes biomasse aérienne 2003, 2015 et 2018}
\NormalTok{files <-}\StringTok{ }\KeywordTok{dir}\NormalTok{(AGB.REF.DIR, }\DataTypeTok{pattern=}\StringTok{"^TGO.*}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{.tif$"}\NormalTok{, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{maps <-}\StringTok{ }\KeywordTok{stack}\NormalTok{(files)}
\KeywordTok{names}\NormalTok{(maps) <-}\StringTok{ }\KeywordTok{substr}\NormalTok{(}\KeywordTok{names}\NormalTok{(maps), }\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{)}

\CommentTok{# Sélectionner les années 2003 et 2018}
\NormalTok{maps.dat <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(maps[[}\KeywordTok{c}\NormalTok{(}\StringTok{"X2003"}\NormalTok{, }\StringTok{"X2018"}\NormalTok{)]][]))}

\CommentTok{# production de la figure}
\NormalTok{dens.plot <-}\StringTok{ }\NormalTok{maps.dat }\OperatorTok{%>%}\StringTok{ }\KeywordTok{gather}\NormalTok{(variable, value, X2003, X2018) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{value, }\DataTypeTok{color=}\NormalTok{variable, }\DataTypeTok{linetype=}\NormalTok{variable)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_density}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_light}\NormalTok{() }

\KeywordTok{pdf}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(AGB.RES.DIR, }\StringTok{"/AGB-densities_03-18.pdf"}\NormalTok{))}
\KeywordTok{print}\NormalTok{(dens.plot)}
\KeywordTok{dev.off}\NormalTok{() }


\CommentTok{# Analyze des émissions et séquestrations CO2 2003-2018 =======================}

\CommentTok{# charger cartes de biomasse 2003 et 2018 et calcule de la biomasse racinaire}
\NormalTok{agb}\FloatTok{.2003}\NormalTok{ <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(AGB.REF.DIR, }\StringTok{"/TGO_2003_AGB_R.tif"}\NormalTok{))}
\NormalTok{bgb}\FloatTok{.2003}\NormalTok{ <-}\StringTok{ }\NormalTok{agb}\FloatTok{.2003} \OperatorTok{*}\StringTok{ }\NormalTok{RSR.O}
\NormalTok{bgb}\FloatTok{.2003}\NormalTok{[agb}\FloatTok{.2003} \OperatorTok{<=}\StringTok{ }\NormalTok{RSR.AGB] <-}\StringTok{ }\NormalTok{agb}\FloatTok{.2003}\NormalTok{[agb}\FloatTok{.2003} \OperatorTok{<=}\StringTok{ }\NormalTok{RSR.AGB] }\OperatorTok{*}\StringTok{ }\NormalTok{RSR.Y}

\NormalTok{agb}\FloatTok{.2018}\NormalTok{ <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(AGB.REF.DIR, }\StringTok{"/TGO_2018_AGB_R.tif"}\NormalTok{))}
\NormalTok{bgb}\FloatTok{.2018}\NormalTok{ <-}\StringTok{ }\NormalTok{agb}\FloatTok{.2018} \OperatorTok{*}\StringTok{ }\NormalTok{RSR.O}
\NormalTok{bgb}\FloatTok{.2018}\NormalTok{[agb}\FloatTok{.2018} \OperatorTok{<=}\StringTok{ }\NormalTok{RSR.AGB] <-}\StringTok{ }\NormalTok{agb}\FloatTok{.2018}\NormalTok{[agb}\FloatTok{.2018} \OperatorTok{<=}\StringTok{ }\NormalTok{RSR.AGB] }\OperatorTok{*}\StringTok{ }\NormalTok{RSR.Y}

\CommentTok{# charger cartes des surfaces forestiers 2003 et 2018}
\NormalTok{fc}\FloatTok{.2003}\NormalTok{ <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.MRV.MCF.CLN, }\StringTok{"/FC30/TGO/TGO_2003_F30cf.tif"}\NormalTok{))}
\NormalTok{fc}\FloatTok{.2018}\NormalTok{ <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(DIR.MRV.MCF.CLN, }\StringTok{"/FC30/TGO/TGO_2018_F30cf.tif"}\NormalTok{))}


\CommentTok{# Carte des pertes de biomasse ------------------------------------------------}

\CommentTok{# Masque forêt en 2003 et non-forêt en 2018}
\NormalTok{defor <-}\StringTok{ }\NormalTok{fc}\FloatTok{.2003} \OperatorTok{==}\StringTok{ }\NormalTok{FOREST }\OperatorTok{&}\StringTok{ }\NormalTok{fc}\FloatTok{.2018} \OperatorTok{!=}\StringTok{ }\NormalTok{FOREST       }

\CommentTok{# moyenne biomasse non-forêt (aérienne et racinaire)}
\NormalTok{nf.agb <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(agb}\FloatTok{.2018}\NormalTok{[fc}\FloatTok{.2018} \OperatorTok{==}\StringTok{ }\DecValTok{3}\NormalTok{], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)   }
\NormalTok{nf.bgb <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(bgb}\FloatTok{.2018}\NormalTok{[fc}\FloatTok{.2018} \OperatorTok{==}\StringTok{ }\DecValTok{3}\NormalTok{], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}

\CommentTok{# Perte de biomasse due à la déforestation = biomasse 2003 - moyenne biomasse non-forêt}
\NormalTok{defor.agb <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(agb}\FloatTok{.2003}\NormalTok{, defor, }\DataTypeTok{maskvalue=}\DecValTok{0}\NormalTok{) }\OperatorTok{-}\StringTok{ }\NormalTok{nf.agb}
\NormalTok{defor.bgb <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(bgb}\FloatTok{.2003}\NormalTok{, defor, }\DataTypeTok{maskvalue=}\DecValTok{0}\NormalTok{) }\OperatorTok{-}\StringTok{ }\NormalTok{nf.bgb}

\CommentTok{# Mettre à 0, là ou la perte est négative}
\NormalTok{defor.agb[defor.agb }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\DecValTok{0}  
\NormalTok{defor.bgb[defor.bgb }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\DecValTok{0} 


\CommentTok{# Carte des gains de biomasse -------------------------------------------------}

\CommentTok{# Masque non-forêt en 2003 et forêt en 2018}
\NormalTok{regen <-}\StringTok{ }\NormalTok{fc}\FloatTok{.2003} \OperatorTok{!=}\StringTok{ }\NormalTok{FOREST }\OperatorTok{&}\StringTok{ }\NormalTok{fc}\FloatTok{.2018} \OperatorTok{==}\StringTok{ }\NormalTok{FOREST}

\CommentTok{# Gain de biomasse due à la régénération = biomasse 2018 - biomasse 2003}
\NormalTok{regen.agb}\FloatTok{.2003}\NormalTok{ <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(agb}\FloatTok{.2003}\NormalTok{, regen, }\DataTypeTok{maskvalue=}\DecValTok{0}\NormalTok{)}
\NormalTok{regen.bgb}\FloatTok{.2003}\NormalTok{ <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(bgb}\FloatTok{.2003}\NormalTok{, regen, }\DataTypeTok{maskvalue=}\DecValTok{0}\NormalTok{)}
\NormalTok{regen.agb}\FloatTok{.2018}\NormalTok{ <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(agb}\FloatTok{.2018}\NormalTok{, regen, }\DataTypeTok{maskvalue=}\DecValTok{0}\NormalTok{)}
\NormalTok{regen.bgb}\FloatTok{.2018}\NormalTok{ <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(bgb}\FloatTok{.2018}\NormalTok{, regen, }\DataTypeTok{maskvalue=}\DecValTok{0}\NormalTok{)}
\NormalTok{regen.agb <-}\StringTok{ }\NormalTok{regen.agb}\FloatTok{.2018} \OperatorTok{-}\StringTok{ }\NormalTok{regen.agb}\FloatTok{.2003}
\NormalTok{regen.bgb <-}\StringTok{ }\NormalTok{regen.bgb}\FloatTok{.2018} \OperatorTok{-}\StringTok{ }\NormalTok{regen.bgb}\FloatTok{.2003}

\CommentTok{# Mettre à 0, là ou le gain est négative}
\NormalTok{regen.agb[regen.agb }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\DecValTok{0}
\NormalTok{regen.bgb[regen.bgb }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\DecValTok{0}


\CommentTok{# Calculer émissions ets séquestrations pour une région -----------------------}
\CommentTok{#}
\CommentTok{# @param defor      Carte des pixels déforestés     }
\CommentTok{# @param defor.agb  Carte des pertes de biomasse aérienne}
\CommentTok{# @param defor.bgb  Carte des pertes de biomasse racinaire}
\CommentTok{# @param regen      Carte des pixels régénérés}
\CommentTok{# @param regen.agb  Carte des gains de biomasse aérienne}
\CommentTok{# @param regen.bgb  Carte des gains de biomasse racinaire}
\CommentTok{# @param aoi        Zone d'intérêt (région)}
\CommentTok{# @param years      Nombre d'années entre les observations}
\CommentTok{#}
\CommentTok{# @return           List avec les éléments }
\CommentTok{#                   - defor.area     Surface déforestée}
\CommentTok{#                   - defor.area.a   Surface déforestée par année}
\CommentTok{#                   - defor.agb.ha   Perte de biomasse aérienne par hectare déforestée}
\CommentTok{#                   - defor.agb.a    Perte de biomasse aérienne par année}
\CommentTok{#                   - defor.bgb.ha   ... même chose pour la biomasse racinaire ...}
\CommentTok{#                   - defor.bgb.a}
\CommentTok{#                   - defor.co2.ha   ... et converti en CO2eq ...}
\CommentTok{#                   - defor.co2.a}
\CommentTok{#                   - regen.area     Surface régénérée}
\CommentTok{#                   - regen.area.a   Surface régénérée par année}
\CommentTok{#                   - regen.agb.ha   Gain de biomasse aérienne par hectare régénérée}
\CommentTok{#                   - regen.agb.a    Gain de biomasse aérienne par année}
\CommentTok{#                   - regen.bgb.ha   ... même chose pour la biomasse racinaire ...}
\CommentTok{#                   - regen.bgb.a}
\CommentTok{#                   - regen.co2.ha   ... et converti en CO2eq ...}
\CommentTok{#                   - regen.co2.a}
\CommentTok{#}
\CommentTok{#}

\NormalTok{emissions <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(defor, defor.agb, defor.bgb, }
\NormalTok{                      regen, regen.agb, regen.bgb, }\DataTypeTok{aoi=}\OtherTok{NULL}\NormalTok{, }\DataTypeTok{years=}\DecValTok{15}\NormalTok{) \{}
  
  \CommentTok{# couper la zone d'intérêt}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(aoi)) \{}
\NormalTok{    defor     <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(defor, aoi), aoi)}
\NormalTok{    defor.agb <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(defor.agb, aoi), aoi)}
\NormalTok{    defor.bgb <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(defor.agb, aoi), aoi)}
\NormalTok{    regen     <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(regen, aoi), aoi)}
\NormalTok{    regen.agb <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(regen.agb, aoi), aoi)}
\NormalTok{    regen.bgb <-}\StringTok{ }\KeywordTok{mask}\NormalTok{(}\KeywordTok{crop}\NormalTok{(regen.bgb, aoi), aoi)}
\NormalTok{  \}}
  
  \CommentTok{# convertir biomasse aérienne et racinaire en CO2eq}
\NormalTok{  defor.co2    <-}\StringTok{ }\NormalTok{(defor.agb }\OperatorTok{+}\StringTok{ }\NormalTok{defor.bgb) }\OperatorTok{*}\StringTok{ }\NormalTok{C.RATIO }\OperatorTok{*}\StringTok{ }\DecValTok{44}\OperatorTok{/}\DecValTok{12}
  \CommentTok{# déterminer la surface (taille d'un pixel Landsat = 30mx30m)}
\NormalTok{  defor.area   <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(defor[], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2} \OperatorTok{/}\StringTok{ }\DecValTok{10000}
\NormalTok{  defor.area.a <-}\StringTok{ }\NormalTok{defor.area }\OperatorTok{/}\StringTok{ }\NormalTok{years}
  \CommentTok{# moyenne des pertes (par hectare)}
\NormalTok{  defor.agb.ha <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(defor.agb[], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  defor.bgb.ha <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(defor.bgb[], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  defor.co2.ha <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(defor.co2[], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
  
  \CommentTok{# la même chose pour la régénération}
\NormalTok{  regen.co2    <-}\StringTok{ }\NormalTok{(regen.agb }\OperatorTok{+}\StringTok{ }\NormalTok{regen.bgb) }\OperatorTok{*}\StringTok{ }\NormalTok{C.RATIO }\OperatorTok{*}\StringTok{ }\DecValTok{44}\OperatorTok{/}\DecValTok{12}
\NormalTok{  regen.area   <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(regen[], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{*}\StringTok{ }\DecValTok{30}\OperatorTok{^}\DecValTok{2} \OperatorTok{/}\StringTok{ }\DecValTok{10000}
\NormalTok{  regen.area.a <-}\StringTok{ }\NormalTok{regen.area }\OperatorTok{/}\StringTok{ }\NormalTok{years}
\NormalTok{  regen.agb.ha <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(regen.agb[], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  regen.bgb.ha <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(regen.bgb[], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  regen.co2.ha <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(regen.co2[], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
  
  \KeywordTok{return}\NormalTok{(}\KeywordTok{list}\NormalTok{(}
    \DataTypeTok{defor.area   =}\NormalTok{ defor.area, }
    \DataTypeTok{defor.area.a =}\NormalTok{ defor.area.a,}
    \DataTypeTok{defor.agb.ha =}\NormalTok{ defor.agb.ha,}
    \DataTypeTok{defor.agb.a  =}\NormalTok{ defor.agb.ha }\OperatorTok{*}\StringTok{ }\NormalTok{defor.area.a,}
    \DataTypeTok{defor.bgb.ha =}\NormalTok{ defor.bgb.ha,}
    \DataTypeTok{defor.bgb.a  =}\NormalTok{ defor.bgb.ha }\OperatorTok{*}\StringTok{ }\NormalTok{defor.area.a,}
    \DataTypeTok{defor.co2.ha =}\NormalTok{ defor.co2.ha,}
    \DataTypeTok{defor.co2.a  =}\NormalTok{ defor.co2.ha }\OperatorTok{*}\StringTok{ }\NormalTok{defor.area.a,}
    \DataTypeTok{regen.area   =}\NormalTok{ regen.area, }
    \DataTypeTok{regen.area.a =}\NormalTok{ regen.area.a,}
    \DataTypeTok{regen.agb.ha =}\NormalTok{ regen.agb.ha,}
    \DataTypeTok{regen.agb.a  =}\NormalTok{ regen.agb.ha }\OperatorTok{*}\StringTok{ }\NormalTok{regen.area.a,}
    \DataTypeTok{regen.bgb.ha =}\NormalTok{ regen.bgb.ha,}
    \DataTypeTok{regen.bgb.a  =}\NormalTok{ regen.bgb.ha }\OperatorTok{*}\StringTok{ }\NormalTok{regen.area.a,}
    \DataTypeTok{regen.co2.ha =}\NormalTok{ regen.co2.ha,}
    \DataTypeTok{regen.co2.a  =}\NormalTok{ regen.co2.ha }\OperatorTok{*}\StringTok{ }\NormalTok{regen.area.a}
\NormalTok{  ))}
\NormalTok{\}}


\CommentTok{# COMMENCER LE TRAITEMENT #####################################################}

\CommentTok{# Analyse des pertes de biomasse et CO2 dà cause de la déforestation}
\CommentTok{# et les gains à cause de la régénération pour Togo et les régions ------------}

\CommentTok{# traitement en parallèle}
\KeywordTok{registerDoParallel}\NormalTok{(CORES)}
\NormalTok{res <-}\StringTok{ }\KeywordTok{foreach}\NormalTok{(}\DataTypeTok{i=}\DecValTok{0}\OperatorTok{:}\KeywordTok{length}\NormalTok{(TGO.REG), }\DataTypeTok{.combine=}\NormalTok{rbind) }\OperatorTok{%dopar%}\StringTok{ }\NormalTok{\{}
  
  \ControlFlowTok{if}\NormalTok{(i}\OperatorTok{==}\DecValTok{0}\NormalTok{) \{}
    \CommentTok{# Analyse pour l'ensemble du Togo}
    \KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{reg =} \StringTok{"TGO"}\NormalTok{, }
               \KeywordTok{emissions}\NormalTok{(defor, defor.agb, defor.bgb, regen, regen.agb, regen.bgb))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \CommentTok{# Analyse pour une région}
\NormalTok{    region <-}\StringTok{ }\NormalTok{TGO.reg[i,]}
    \KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{reg =}\NormalTok{ region}\OperatorTok{$}\NormalTok{NAME_}\DecValTok{1}\NormalTok{, }
               \KeywordTok{emissions}\NormalTok{(defor, defor.agb, defor.bgb, regen, regen.agb, regen.bgb, }
                         \DataTypeTok{aoi=}\NormalTok{region))}
\NormalTok{  \}}
\NormalTok{\}}

\CommentTok{# sauvegarder le tableau des résultats}
\KeywordTok{write.csv}\NormalTok{(res, }\KeywordTok{paste0}\NormalTok{(AGB.RES.DIR, }\StringTok{"/NERF-Results.csv"}\NormalTok{), }\DataTypeTok{row.names=}\OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\printindex

\end{document}
