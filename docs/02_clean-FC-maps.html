<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4.1.2 Nettoyage des cartes brutes | _main.utf8</title>
  <meta name="description" content="République Togolaise —<br />
Système Nationale de Surveillance des Forêts</div>" />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="4.1.2 Nettoyage des cartes brutes | _main.utf8" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://ogardi.github.io/SNSF-Togo" />
  <meta property="og:image" content="https://ogardi.github.io/SNSF-Togoimages/NERF-Togo.png" />
  
  <meta name="github-repo" content="ogardi/NERF-Togo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4.1.2 Nettoyage des cartes brutes | _main.utf8" />
  
  
  <meta name="twitter:image" content="https://ogardi.github.io/SNSF-Togoimages/NERF-Togo.png" />

<meta name="author" content="Oliver Gardi, Fifonsi Dangbo, Sophie Dzigbod, Ditorgue Bakabima" />


<meta name="date" content="2020-06-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="01_create-FC-maps.html"/>
<link rel="next" href="03_validate-FC-maps.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://ogardi.github.io/SNSF-Togo"><b>Manuel SNSF Togo</b><br>NRF v1.1 ( <i>en révision</i> )</a></li>
<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Préface</a></li>
<li class="chapter" data-level="1" data-path="00_introduction.html"><a href="00_introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="01_arrangements.html"><a href="01_arrangements.html"><i class="fa fa-check"></i><b>1.1</b> Arrangements institutionelles</a></li>
<li class="chapter" data-level="1.2" data-path="02_how-to.html"><a href="02_how-to.html"><i class="fa fa-check"></i><b>1.2</b> Pour commencer</a><ul>
<li class="chapter" data-level="1.2.1" data-path="02_how-to.html"><a href="02_how-to.html#travailler-avec-le-snsf"><i class="fa fa-check"></i><b>1.2.1</b> Travailler avec le SNSF</a></li>
<li class="chapter" data-level="1.2.2" data-path="03_commencer.html"><a href="03_commencer.html"><i class="fa fa-check"></i><b>1.2.2</b> Structure du répértoire</a></li>
<li class="chapter" data-level="1.2.3" data-path="03_commencer.html"><a href="03_commencer.html#creation-dun-nouveau-projet"><i class="fa fa-check"></i><b>1.2.3</b> Création d’un nouveau projet</a></li>
<li class="chapter" data-level="1.2.4" data-path="03_commencer.html"><a href="03_commencer.html#NRF-set-up.R"><i class="fa fa-check"></i><b>1.2.4</b> Définition des variables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="00_STSS.html"><a href="00_STSS.html"><i class="fa fa-check"></i><b>2</b> Système de Surveillance Terrestre</a><ul>
<li class="chapter" data-level="2.1" data-path="01_Landsat.html"><a href="01_Landsat.html"><i class="fa fa-check"></i><b>2.1</b> Données de base</a><ul>
<li class="chapter" data-level="2.1.1" data-path="01_Landsat.html"><a href="01_Landsat.html#SSTS-Landsat"><i class="fa fa-check"></i><b>2.1.1</b> Images Landsat</a></li>
<li class="chapter" data-level="2.1.2" data-path="02_Worldclim.html"><a href="02_Worldclim.html"><i class="fa fa-check"></i><b>2.1.2</b> WorldClim</a></li>
<li class="chapter" data-level="2.1.3" data-path="03_SRTM.html"><a href="03_SRTM.html"><i class="fa fa-check"></i><b>2.1.3</b> SRTM</a></li>
<li class="chapter" data-level="2.1.4" data-path="04_SoilGrids.html"><a href="04_SoilGrids.html"><i class="fa fa-check"></i><b>2.1.4</b> SoilGrids</a></li>
<li class="chapter" data-level="2.1.5" data-path="05_ProREDD.html"><a href="05_ProREDD.html"><i class="fa fa-check"></i><b>2.1.5</b> ProREDD</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="01_sampling-grid.html"><a href="01_sampling-grid.html"><i class="fa fa-check"></i><b>2.2</b> Collecte des données</a><ul>
<li class="chapter" data-level="2.2.1" data-path="01_sampling-grid.html"><a href="01_sampling-grid.html#reseau-dechantillonnage"><i class="fa fa-check"></i><b>2.2.1</b> Réseau d’échantillonnage</a></li>
<li class="chapter" data-level="2.2.2" data-path="02_training-plots.html"><a href="02_training-plots.html"><i class="fa fa-check"></i><b>2.2.2</b> Parcelles d’entraînement</a></li>
<li class="chapter" data-level="2.2.3" data-path="03_validation-plots.html"><a href="03_validation-plots.html"><i class="fa fa-check"></i><b>2.2.3</b> Parcelles de validation</a></li>
<li class="chapter" data-level="2.2.4" data-path="04_outil-QGIS.html"><a href="04_outil-QGIS.html"><i class="fa fa-check"></i><b>2.2.4</b> Outil QGIS</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="00_IFN.html"><a href="00_IFN.html"><i class="fa fa-check"></i><b>3</b> Inventaire Forestier National</a><ul>
<li class="chapter" data-level="3.1" data-path="01_IFN-1.html"><a href="01_IFN-1.html"><i class="fa fa-check"></i><b>3.1</b> IFN-1 (2015/16)</a><ul>
<li class="chapter" data-level="3.1.1" data-path="01_IFN-1.html"><a href="01_IFN-1.html#methode"><i class="fa fa-check"></i><b>3.1.1</b> <span>Méthode</span></a></li>
<li class="chapter" data-level="3.1.2" data-path="01_IFN-1.html"><a href="01_IFN-1.html#donnees"><i class="fa fa-check"></i><b>3.1.2</b> Données</a></li>
<li class="chapter" data-level="3.1.3" data-path="01_IFN-1.html"><a href="01_IFN-1.html#resultats"><i class="fa fa-check"></i><b>3.1.3</b> <span>Résultats</span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="00_NRF-MRV.html"><a href="00_NRF-MRV.html"><i class="fa fa-check"></i><b>4</b> Analyses NRF/MRV</a><ul>
<li class="chapter" data-level="4.1" data-path="00_analyse-FCC.html"><a href="00_analyse-FCC.html"><i class="fa fa-check"></i><b>4.1</b> Analyse surfaces forestiers</a><ul>
<li class="chapter" data-level="4.1.1" data-path="01_create-FC-maps.html"><a href="01_create-FC-maps.html"><i class="fa fa-check"></i><b>4.1.1</b> Production des cartes Forêt/Non-Forêt</a></li>
<li class="chapter" data-level="4.1.2" data-path="02_clean-FC-maps.html"><a href="02_clean-FC-maps.html"><i class="fa fa-check"></i><b>4.1.2</b> Nettoyage des cartes brutes</a></li>
<li class="chapter" data-level="4.1.3" data-path="03_validate-FC-maps.html"><a href="03_validate-FC-maps.html"><i class="fa fa-check"></i><b>4.1.3</b> Validation des cartes</a></li>
<li class="chapter" data-level="4.1.4" data-path="04_FC-maps-accuracy.html"><a href="04_FC-maps-accuracy.html"><i class="fa fa-check"></i><b>4.1.4</b> Analyse de la précision</a></li>
<li class="chapter" data-level="4.1.5" data-path="05_analyse-FC-maps.html"><a href="05_analyse-FC-maps.html"><i class="fa fa-check"></i><b>4.1.5</b> Analyse des cartes</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="00_analyse-AGB.html"><a href="00_analyse-AGB.html"><i class="fa fa-check"></i><b>4.2</b> Analyse biomasse aérienne</a><ul>
<li class="chapter" data-level="4.2.1" data-path="01_compile-IFN.html"><a href="01_compile-IFN.html"><i class="fa fa-check"></i><b>4.2.1</b> Analyse des données IFN</a></li>
<li class="chapter" data-level="4.2.2" data-path="02_create-AGB-maps.html"><a href="02_create-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.2</b> Calibration et prédiction</a></li>
<li class="chapter" data-level="4.2.3" data-path="03_clean-AGB-maps.html"><a href="03_clean-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.3</b> Nettoyage des cartes brutes</a></li>
<li class="chapter" data-level="4.2.4" data-path="04_analyze-AGB-maps.html"><a href="04_analyze-AGB-maps.html"><i class="fa fa-check"></i><b>4.2.4</b> Production des résultats</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/ogardi/SNSF-Togo">Dépôt du code sur GitHub</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><div class="line-block">République Togolaise —<br />
Système Nationale de Surveillance des Forêts</div></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="NRF-clean-fc-maps" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Nettoyage des cartes brutes</h3>
<p>Les series temporelles des cartes forêt/non-forêt brutes sont <strong>lissées et filtrées pixel par pixel</strong> pour les raisons suivantes:</p>
<ul>
<li>Remplissage des <strong>données manquantes</strong> (nuages, ombres, L7 SLC-off),</li>
<li>Lissage des <strong>bruits</strong> (pixels qui changent entre forêt et non-forêt plusieurs fois)</li>
<li>Filtrer la <strong>régénération temporaire par les fourrés</strong>, observée sur les jachères.</li>
</ul>
<ol style="list-style-type: decimal">
<li>La première étappe, est la <strong>remplissage des données manquantes</strong>: les données manquantes entre deux observations de forêt deviennent forêt, celles entre deux observations de non-forêt deviennent non-forêt.</li>
</ol>
<center>
<img src="images/FCC-clean-1.png" />
</center>
<ol start="2" style="list-style-type: decimal">
<li>Ensuite, une <strong>fenêtre coulissante de taille 5</strong> est appliquée, c’est-à-dire qu’une observation est attribuée à la classe qui est observé le plus fréquemment dans la fenêtre qui inclu les deux observations précédentes et les deux suivantes. Pour l’évaluation de la deuxième et de l’avant-dernière observation, une fenêtre coulissante de taille 3 est appliquée. <strong>La première et la dernière observation ne sont pas ajustées, il faut les ignorer dans la suite.</strong> Les observations manquantes sont remplis dans la mesure possible. Toute la procédure est répétée jusqu’à ce qu’il n’y a plus de changements.</li>
</ol>
<center>
<img src="images/FCC-clean-2.png" />
</center>
<ol start="3" style="list-style-type: decimal">
<li>Les années manquantes sont ajoutées pour créer une série annuelle. Les observations manquantes sont remplacées par la classe de l’observation précédente. Lorsque les observations initiales sont manquantes, elles sont remplacées par la classe de l’observation suivante. <strong>Dans les situations de régénération (forêt suit non-forêt), les 9 premières années sont marquées comme “reboisement potentiel”. Si la forêt disparaît à nouveau après moins de 10 ans, les observations sont remplacées par la classe non-forêt. Si la régénération reste, elle est considérée comme un reboisement après 10 ans.</strong></li>
</ol>
<center>
<img src="images/FCC-clean-3.png" />
</center>
<p>Après la nettoyage des séries temporelles pixel par pixel, <strong>une nettoyage spatiale</strong> est réalisé pour éliminer les surfaces forestières &lt; 0,5 hectares. Pour cela, une carte est créée de tous les pixels qui étaient une fois observées comme forêt sur toute la série des cartes. Sur cette carte, toutes les surfaces forestières ayant moins de 6 pixels liés (soit moins de 0,54 hectares) sont éliminées. Ce masque forestier est ensuite appliqué à toutes les cartes forêt/non-forêt de la série. Cela signifie que <strong>seuls les pixels forestier qui ont fait partie d’une surface forestière ≥ 0,54 hectares dans la série des cartes sont retenus comme forêt.</strong></p>
<div id="NRF-clean-fc-maps-figure" class="section level4 unnumbered">
<h4>Example</h4>
<p>La figure suivante montre les <strong>cartes forêt/non-forêt après la nettoyage temporelle et spatiale</strong> pour une région au sud de Kpalimé (voir <a href="01_create-FC-maps.html#NRF-create-fc-maps-figure">série des cartes brutes</a> pour comparaison).</p>
<p><img src="images/FCC-clnmaps.png" /></p>
</div>
<div id="script-r-03_nrf-mrv01_mcf_src02_clean-fc-maps.r" class="section level4 unnumbered">
<h4>Script R: <code>03_NRF-MRV/01_MCF/_src/02_clean-fc-maps.R</code></h4>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co">###############################################################################</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="co"># 02_clean-fc-maps.R: nettoyage des cartes brutes du couvert forestier</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co"># -----------------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="co"># Bern University of Applied Sciences</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="co"># Oliver Gardi, &lt;oliver.gardi@bfh.ch&gt;</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co"># 13 Mai 2020</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co"># Définitions des variables ===================================================</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"></a>
<a class="sourceLine" id="cb17-11" data-line-number="11">COV.FC         &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12"></a>
<a class="sourceLine" id="cb17-13" data-line-number="13">RAW.DIR &lt;-<span class="st"> </span>DIR.MRV.MCF.RAW</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">CLN.DIR &lt;-<span class="st"> </span>DIR.MRV.MCF.CLN</a>
<a class="sourceLine" id="cb17-15" data-line-number="15"></a>
<a class="sourceLine" id="cb17-16" data-line-number="16"><span class="co"># Définitions des fonctions ===================================================</span></a>
<a class="sourceLine" id="cb17-17" data-line-number="17"></a>
<a class="sourceLine" id="cb17-18" data-line-number="18"><span class="co"># Nettoyage temporel d&#39;une série d&#39;images -------------------------------------</span></a>
<a class="sourceLine" id="cb17-19" data-line-number="19"><span class="co">#</span></a>
<a class="sourceLine" id="cb17-20" data-line-number="20"><span class="co"># @param path  Chemin WRS</span></a>
<a class="sourceLine" id="cb17-21" data-line-number="21"><span class="co">#</span></a>
<a class="sourceLine" id="cb17-22" data-line-number="22"><span class="co"># @return       -- </span></a>
<a class="sourceLine" id="cb17-23" data-line-number="23"><span class="co">#</span></a>
<a class="sourceLine" id="cb17-24" data-line-number="24"></a>
<a class="sourceLine" id="cb17-25" data-line-number="25">clean.temporal &lt;-<span class="st"> </span><span class="cf">function</span>(path) {</a>
<a class="sourceLine" id="cb17-26" data-line-number="26"></a>
<a class="sourceLine" id="cb17-27" data-line-number="27">  <span class="co"># Préparation des images --------------------------------</span></a>
<a class="sourceLine" id="cb17-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb17-29" data-line-number="29">  <span class="co"># Charger les cartes brutes</span></a>
<a class="sourceLine" id="cb17-30" data-line-number="30">  maps &lt;-<span class="st"> </span><span class="kw">stack</span>(<span class="kw">dir</span>(<span class="kw">paste0</span>(RAW.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/&quot;</span>, path), </a>
<a class="sourceLine" id="cb17-31" data-line-number="31">                    <span class="dt">pattern=</span><span class="st">&quot;.*[[:digit:]]{4}</span><span class="ch">\\</span><span class="st">_F.*</span><span class="ch">\\</span><span class="st">.tif$&quot;</span>, <span class="dt">full.names=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb17-32" data-line-number="32">  map.names &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;r$&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">names</span>(maps))</a>
<a class="sourceLine" id="cb17-33" data-line-number="33">  <span class="co"># Noms de cartes à utiliser dans les colonnes de la matrice</span></a>
<a class="sourceLine" id="cb17-34" data-line-number="34">  map.cols  &lt;-<span class="st"> </span><span class="kw">sub</span>(<span class="kw">paste0</span>(path, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">_&quot;</span>), <span class="st">&quot;X&quot;</span>, <span class="kw">sub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">_[[:alnum:]]+$&quot;</span>, <span class="st">&quot;M&quot;</span>, map.names))</a>
<a class="sourceLine" id="cb17-35" data-line-number="35">  <span class="co"># Names à utiliser pour les années sans carte</span></a>
<a class="sourceLine" id="cb17-36" data-line-number="36">  no.map.cols &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;X&quot;</span>, YEARS.ALL[<span class="op">!</span>YEARS.ALL <span class="op">%in%</span><span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;[[:alpha:]]&quot;</span>, <span class="st">&quot;&quot;</span>, map.cols)], <span class="st">&quot;_&quot;</span>)</a>
<a class="sourceLine" id="cb17-37" data-line-number="37">  <span class="co"># Joindre et ordonner les noms de colonnes</span></a>
<a class="sourceLine" id="cb17-38" data-line-number="38">  col.order &lt;-<span class="st"> </span><span class="kw">c</span>(map.cols, no.map.cols)[<span class="kw">order</span>(<span class="kw">c</span>(map.cols, no.map.cols))]</a>
<a class="sourceLine" id="cb17-39" data-line-number="39">  <span class="co"># Convertir les cartes en matrice (une carte par colonne, prend du temps)</span></a>
<a class="sourceLine" id="cb17-40" data-line-number="40">  maps.values &lt;-<span class="st"> </span><span class="kw">values</span>(maps)                           </a>
<a class="sourceLine" id="cb17-41" data-line-number="41">  <span class="kw">colnames</span>(maps.values) &lt;-<span class="st"> </span>map.cols</a>
<a class="sourceLine" id="cb17-42" data-line-number="42">  </a>
<a class="sourceLine" id="cb17-43" data-line-number="43">  <span class="co"># Nettoyage parallèle des trajectoires des pixels -------</span></a>
<a class="sourceLine" id="cb17-44" data-line-number="44">  </a>
<a class="sourceLine" id="cb17-45" data-line-number="45">  <span class="co"># Définir des sous-ensembles des pixels (lignes) pour le traitement parallèle</span></a>
<a class="sourceLine" id="cb17-46" data-line-number="46">  nsubsets &lt;-<span class="st"> </span>CORES               </a>
<a class="sourceLine" id="cb17-47" data-line-number="47">  subsets  &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">floor</span>((<span class="dv">1</span><span class="op">:</span>nsubsets)<span class="op">*</span>(<span class="kw">nrow</span>(maps.values)<span class="op">/</span>nsubsets)))    </a>
<a class="sourceLine" id="cb17-48" data-line-number="48">  <span class="co"># Traitement en parallèle</span></a>
<a class="sourceLine" id="cb17-49" data-line-number="49">  <span class="kw">registerDoParallel</span>(CORES)</a>
<a class="sourceLine" id="cb17-50" data-line-number="50">  maps.values.clean &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">i=</span><span class="dv">1</span><span class="op">:</span>nsubsets, <span class="dt">.combine=</span>rbind) <span class="op">%dopar%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb17-51" data-line-number="51">    </a>
<a class="sourceLine" id="cb17-52" data-line-number="52">    <span class="co"># 0. obtenir un sous-ensemble à partir de maps.values</span></a>
<a class="sourceLine" id="cb17-53" data-line-number="53">    val &lt;-<span class="st"> </span>maps.values[(subsets[i]<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>subsets[i<span class="op">+</span><span class="dv">1</span>], ]     </a>
<a class="sourceLine" id="cb17-54" data-line-number="54">    <span class="co"># mettre tout en NA qui n&#39;est pas de la forêt ou non-forêt</span></a>
<a class="sourceLine" id="cb17-55" data-line-number="55">    val[<span class="op">!</span>(<span class="kw">is.na</span>(val) <span class="op">|</span><span class="st"> </span>val <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(FOREST,NONFOR))] &lt;-<span class="st"> </span><span class="ot">NA</span>    </a>
<a class="sourceLine" id="cb17-56" data-line-number="56">    </a>
<a class="sourceLine" id="cb17-57" data-line-number="57">    <span class="co"># 1. Supprimer les NA isolées ----</span></a>
<a class="sourceLine" id="cb17-58" data-line-number="58">    str   &lt;-<span class="st"> </span><span class="kw">apply</span>(val, <span class="dv">1</span>, paste, <span class="dt">collapse=</span><span class="st">&quot;&quot;</span>)  <span class="co"># convertir en chaînes de caractères</span></a>
<a class="sourceLine" id="cb17-59" data-line-number="59">    str.c &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;NA&quot;</span>, <span class="st">&quot;9&quot;</span>, str)               <span class="co"># remplacer NA avec 9</span></a>
<a class="sourceLine" id="cb17-60" data-line-number="60">    <span class="co"># Nettoyer jusqu&#39;à la convergence</span></a>
<a class="sourceLine" id="cb17-61" data-line-number="61">    <span class="cf">while</span>(<span class="op">!</span><span class="kw">identical</span>(str, str.c)) {             </a>
<a class="sourceLine" id="cb17-62" data-line-number="62">      str &lt;-<span class="st"> </span>str.c</a>
<a class="sourceLine" id="cb17-63" data-line-number="63">      <span class="co"># Mettre NA dans la classe correspondante (forêt ou non-forêt)</span></a>
<a class="sourceLine" id="cb17-64" data-line-number="64">      str.c &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="kw">paste0</span>(<span class="st">&quot;^(.*&quot;</span>, NONFOR, <span class="st">&quot;)9(9*&quot;</span>, NONFOR, <span class="st">&quot;.*)$&quot;</span>), <span class="kw">paste0</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>, NONFOR, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2&quot;</span>), str.c) </a>
<a class="sourceLine" id="cb17-65" data-line-number="65">      str.c &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="kw">paste0</span>(<span class="st">&quot;^(.*&quot;</span>, FOREST, <span class="st">&quot;)9(9*&quot;</span>, FOREST, <span class="st">&quot;.*)$&quot;</span>), <span class="kw">paste0</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>, FOREST, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2&quot;</span>), str.c)                 </a>
<a class="sourceLine" id="cb17-66" data-line-number="66">    }                                                       </a>
<a class="sourceLine" id="cb17-67" data-line-number="67">    <span class="co"># Reconvertir en matrice numérique</span></a>
<a class="sourceLine" id="cb17-68" data-line-number="68">    val &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">as.numeric</span>(<span class="kw">unlist</span>(<span class="kw">strsplit</span>(str.c, <span class="st">&quot;&quot;</span>))), <span class="dt">ncol=</span><span class="kw">ncol</span>(val), <span class="dt">byrow=</span><span class="ot">TRUE</span>)   </a>
<a class="sourceLine" id="cb17-69" data-line-number="69">    val[val<span class="op">==</span><span class="dv">9</span>] &lt;-<span class="st"> </span><span class="ot">NA</span>                           <span class="co"># remplacer les 9 avec NA</span></a>
<a class="sourceLine" id="cb17-70" data-line-number="70">    <span class="kw">colnames</span>(val) &lt;-<span class="st"> </span>map.cols</a>
<a class="sourceLine" id="cb17-71" data-line-number="71">    </a>
<a class="sourceLine" id="cb17-72" data-line-number="72">    <span class="co"># 2. nettoyer les trajectoires avec fenêtre coulissante ----</span></a>
<a class="sourceLine" id="cb17-73" data-line-number="73">    val.c   &lt;-<span class="st"> </span>val</a>
<a class="sourceLine" id="cb17-74" data-line-number="74">    val.o &lt;-<span class="st"> </span>val[] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb17-75" data-line-number="75">    iter    &lt;-<span class="st"> </span><span class="dv">0</span>   </a>
<a class="sourceLine" id="cb17-76" data-line-number="76">    <span class="co"># Nettoyer jusqu&#39;à la convergence</span></a>
<a class="sourceLine" id="cb17-77" data-line-number="77">    <span class="cf">while</span>(<span class="op">!</span><span class="kw">identical</span>(val, val.c) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">identical</span>(val.o, val.c)) {   </a>
<a class="sourceLine" id="cb17-78" data-line-number="78">      iter &lt;-<span class="st"> </span>iter<span class="op">+</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb17-79" data-line-number="79">      <span class="kw">message</span>(<span class="st">&quot;    -Clean modal: iteration &quot;</span>, iter, <span class="st">&quot; ... &quot;</span>, <span class="dt">appendLF =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb17-80" data-line-number="80">      val.o &lt;-<span class="st"> </span>val  <span class="co"># valeurs actuelles -&gt; anciennes valeurs</span></a>
<a class="sourceLine" id="cb17-81" data-line-number="81">      val &lt;-<span class="st"> </span>val.c  <span class="co"># valeurs nettoyées -&gt; valuers actuelles</span></a>
<a class="sourceLine" id="cb17-82" data-line-number="82">      <span class="co"># 3ème - 3ème l&#39;année dernière : fenêtre modale taille 5 </span></a>
<a class="sourceLine" id="cb17-83" data-line-number="83">      <span class="cf">for</span>(l <span class="cf">in</span> <span class="dv">3</span><span class="op">:</span>(<span class="kw">ncol</span>(val)<span class="op">-</span><span class="dv">2</span>)) {                             </a>
<a class="sourceLine" id="cb17-84" data-line-number="84">        val.c[,l] &lt;-<span class="st"> </span><span class="kw">apply</span>(val[,(l<span class="dv">-2</span>)<span class="op">:</span>(l<span class="op">+</span><span class="dv">2</span>)], <span class="dv">1</span>, modal, <span class="dt">na.rm=</span><span class="ot">TRUE</span>, <span class="dt">ties=</span><span class="st">&#39;NA&#39;</span>)</a>
<a class="sourceLine" id="cb17-85" data-line-number="85">      }</a>
<a class="sourceLine" id="cb17-86" data-line-number="86">      <span class="co"># 2e et 2e l&#39;année dernière : fenêtre modale taille 3 </span></a>
<a class="sourceLine" id="cb17-87" data-line-number="87">      <span class="cf">for</span>(l <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="kw">ncol</span>(val)<span class="op">-</span><span class="dv">1</span>)) {                           </a>
<a class="sourceLine" id="cb17-88" data-line-number="88">        val.c[,l] &lt;-<span class="st"> </span><span class="kw">apply</span>(val.c[,(l<span class="dv">-1</span>)<span class="op">:</span>(l<span class="op">+</span><span class="dv">1</span>)], <span class="dv">1</span>, modal, <span class="dt">na.rm=</span><span class="ot">TRUE</span>, <span class="dt">ties=</span><span class="st">&#39;NA&#39;</span>)</a>
<a class="sourceLine" id="cb17-89" data-line-number="89">      }</a>
<a class="sourceLine" id="cb17-90" data-line-number="90">      <span class="kw">message</span>(<span class="st">&quot;done&quot;</span>)</a>
<a class="sourceLine" id="cb17-91" data-line-number="91">    }</a>
<a class="sourceLine" id="cb17-92" data-line-number="92">    val &lt;-<span class="st"> </span>val.c    <span class="co"># valeurs nettoyées -&gt; valuers actuelles</span></a>
<a class="sourceLine" id="cb17-93" data-line-number="93">    </a>
<a class="sourceLine" id="cb17-94" data-line-number="94">    <span class="co"># 3. nettoyage final regexp ----</span></a>
<a class="sourceLine" id="cb17-95" data-line-number="95">    <span class="co"># ajouter des années sans observation (cartes)</span></a>
<a class="sourceLine" id="cb17-96" data-line-number="96">    val   &lt;-<span class="st"> </span><span class="kw">cbind</span>(val, <span class="kw">matrix</span>(<span class="dt">nrow=</span><span class="kw">nrow</span>(val),                            </a>
<a class="sourceLine" id="cb17-97" data-line-number="97">                               <span class="dt">ncol=</span><span class="kw">length</span>(no.map.cols), <span class="dt">dimnames=</span><span class="kw">list</span>(<span class="ot">NULL</span>, no.map.cols)))</a>
<a class="sourceLine" id="cb17-98" data-line-number="98">    <span class="co"># ordonner correctement </span></a>
<a class="sourceLine" id="cb17-99" data-line-number="99">    val   &lt;-<span class="st"> </span>val[, col.order]                                        </a>
<a class="sourceLine" id="cb17-100" data-line-number="100">    str   &lt;-<span class="st"> </span><span class="kw">apply</span>(val, <span class="dv">1</span>, paste, <span class="dt">collapse=</span><span class="st">&quot;&quot;</span>)           <span class="co"># convertir en chaînes de caractères</span></a>
<a class="sourceLine" id="cb17-101" data-line-number="101">    str.c &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;NA&quot;</span>, <span class="st">&quot;9&quot;</span>, str)                        <span class="co"># remplacer NA avec 9</span></a>
<a class="sourceLine" id="cb17-102" data-line-number="102">    <span class="co"># Nettoyer jusqu&#39;à la convergence</span></a>
<a class="sourceLine" id="cb17-103" data-line-number="103">    <span class="cf">while</span>(<span class="op">!</span><span class="kw">identical</span>(str, str.c)) {                     </a>
<a class="sourceLine" id="cb17-104" data-line-number="104">      str &lt;-<span class="st"> </span>str.c</a>
<a class="sourceLine" id="cb17-105" data-line-number="105">      <span class="co"># 3.1 remplacer NA par la classe précédente</span></a>
<a class="sourceLine" id="cb17-106" data-line-number="106">      str.c &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="kw">paste0</span>(NONFOR, <span class="st">&quot;9&quot;</span>), <span class="kw">paste0</span>(NONFOR, NONFOR), str.c)                   </a>
<a class="sourceLine" id="cb17-107" data-line-number="107">      str.c &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="kw">paste0</span>(FOREST, <span class="st">&quot;9&quot;</span>), <span class="kw">paste0</span>(FOREST, FOREST), str.c)                </a>
<a class="sourceLine" id="cb17-108" data-line-number="108">    }</a>
<a class="sourceLine" id="cb17-109" data-line-number="109">    str &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb17-110" data-line-number="110">    <span class="co"># Nettoyer jusqu&#39;à la convergence</span></a>
<a class="sourceLine" id="cb17-111" data-line-number="111">    <span class="cf">while</span>(<span class="op">!</span><span class="kw">identical</span>(str, str.c)) {                         </a>
<a class="sourceLine" id="cb17-112" data-line-number="112">      str &lt;-<span class="st"> </span>str.c</a>
<a class="sourceLine" id="cb17-113" data-line-number="113">      <span class="co"># 3.2 remplacer NA par la classe suivante</span></a>
<a class="sourceLine" id="cb17-114" data-line-number="114">      str.c &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="kw">paste0</span>(<span class="st">&quot;9&quot;</span>, NONFOR), <span class="kw">paste0</span>(NONFOR, NONFOR), str.c)                   </a>
<a class="sourceLine" id="cb17-115" data-line-number="115">      str.c &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="kw">paste0</span>(<span class="st">&quot;9&quot;</span>, FOREST), <span class="kw">paste0</span>(FOREST, FOREST), str.c)                </a>
<a class="sourceLine" id="cb17-116" data-line-number="116">    }</a>
<a class="sourceLine" id="cb17-117" data-line-number="117">    str &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb17-118" data-line-number="118">    <span class="co"># Nettoyer jusqu&#39;à la convergence</span></a>
<a class="sourceLine" id="cb17-119" data-line-number="119">    <span class="cf">while</span>(<span class="op">!</span><span class="kw">identical</span>(str, str.c)) {</a>
<a class="sourceLine" id="cb17-120" data-line-number="120">      str &lt;-<span class="st"> </span>str.c</a>
<a class="sourceLine" id="cb17-121" data-line-number="121">      <span class="co"># 3.3 suppression des 1 isolés jusqu&#39;à une longueur de 10 (régénération qui est à nouveau perdue)</span></a>
<a class="sourceLine" id="cb17-122" data-line-number="122">      str.c &lt;-<span class="kw">gsub</span>(<span class="kw">paste0</span>(<span class="st">&quot;^(.*&quot;</span>, NONFOR, <span class="st">&quot;)&quot;</span>, FOREST, <span class="st">&quot;(&quot;</span>, FOREST, <span class="st">&quot;{0,9}&quot;</span>, NONFOR, <span class="st">&quot;.*)$&quot;</span>), </a>
<a class="sourceLine" id="cb17-123" data-line-number="123">                   <span class="kw">paste0</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>, NONFOR, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2&quot;</span>), str.c) </a>
<a class="sourceLine" id="cb17-124" data-line-number="124">    }</a>
<a class="sourceLine" id="cb17-125" data-line-number="125">    str &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb17-126" data-line-number="126">    <span class="co"># Nettoyer jusqu&#39;à la convergence</span></a>
<a class="sourceLine" id="cb17-127" data-line-number="127">    <span class="cf">while</span>(<span class="op">!</span><span class="kw">identical</span>(str, str.c)) {</a>
<a class="sourceLine" id="cb17-128" data-line-number="128">      str &lt;-<span class="st"> </span>str.c</a>
<a class="sourceLine" id="cb17-129" data-line-number="129">      <span class="co"># 3.4 considérer la régénération seulement comme une forêt à partir de 10 ans </span></a>
<a class="sourceLine" id="cb17-130" data-line-number="130">      <span class="co"># avant qu&#39;elle ne soit considérée comme une régénération potentielle PREGEN</span></a>
<a class="sourceLine" id="cb17-131" data-line-number="131">      str.c &lt;-<span class="kw">gsub</span>(<span class="kw">paste0</span>(<span class="st">&quot;^(.*&quot;</span>,NONFOREST,PREGEN, <span class="st">&quot;{0,8})&quot;</span>, FOREST, <span class="st">&quot;(.*)$&quot;</span>), </a>
<a class="sourceLine" id="cb17-132" data-line-number="132">                   <span class="kw">paste0</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>, PREGEN, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2&quot;</span>), str.c)</a>
<a class="sourceLine" id="cb17-133" data-line-number="133">    }</a>
<a class="sourceLine" id="cb17-134" data-line-number="134">    str &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb17-135" data-line-number="135">    <span class="co"># Reconvertir en matrice numérique</span></a>
<a class="sourceLine" id="cb17-136" data-line-number="136">    val &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">as.numeric</span>(<span class="kw">unlist</span>(<span class="kw">strsplit</span>(str.c, <span class="st">&quot;&quot;</span>))), <span class="dt">ncol=</span><span class="kw">ncol</span>(val), <span class="dt">byrow=</span><span class="ot">TRUE</span>) </a>
<a class="sourceLine" id="cb17-137" data-line-number="137">    val[val<span class="op">==</span><span class="dv">9</span>] &lt;-<span class="st"> </span><span class="ot">NA</span>                           <span class="co"># remplacer les 9 avec NA</span></a>
<a class="sourceLine" id="cb17-138" data-line-number="138">    <span class="kw">colnames</span>(val) &lt;-<span class="st"> </span>col.order</a>
<a class="sourceLine" id="cb17-139" data-line-number="139">    val[,<span class="kw">grepl</span>(<span class="st">&quot;M$&quot;</span>, <span class="kw">colnames</span>(val))]            <span class="co"># et extraire les données pour les années des cartes</span></a>
<a class="sourceLine" id="cb17-140" data-line-number="140">  }</a>
<a class="sourceLine" id="cb17-141" data-line-number="141">  </a>
<a class="sourceLine" id="cb17-142" data-line-number="142">  <span class="co"># Sauvegarder le résultat -------------------------------</span></a>
<a class="sourceLine" id="cb17-143" data-line-number="143">  <span class="kw">values</span>(maps) &lt;-<span class="st"> </span>maps.values.clean</a>
<a class="sourceLine" id="cb17-144" data-line-number="144">  <span class="co"># supprimer la première et la dernière carte &quot;non nettoyée&quot;</span></a>
<a class="sourceLine" id="cb17-145" data-line-number="145">  <span class="kw">writeRaster</span>(<span class="kw">dropLayer</span>(maps, <span class="kw">c</span>(<span class="dv">1</span>,<span class="kw">nlayers</span>(maps))), </a>
<a class="sourceLine" id="cb17-146" data-line-number="146">              <span class="dt">filename=</span><span class="kw">paste0</span>(CLN.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/&quot;</span>, path, <span class="st">&quot;/&quot;</span>, map.names[<span class="dv">2</span><span class="op">:</span>(<span class="kw">nlayers</span>(maps)<span class="op">-</span><span class="dv">1</span>)], <span class="st">&quot;c.tif&quot;</span>), </a>
<a class="sourceLine" id="cb17-147" data-line-number="147">              <span class="dt">bylayer=</span><span class="ot">TRUE</span>, <span class="dt">format=</span><span class="st">&quot;GTiff&quot;</span>, <span class="dt">datatype=</span><span class="st">&quot;INT2U&quot;</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-148" data-line-number="148">  </a>
<a class="sourceLine" id="cb17-149" data-line-number="149">  <span class="co"># écrire des trajectoires dans un fichier texte</span></a>
<a class="sourceLine" id="cb17-150" data-line-number="150">  maps.strings &lt;-<span class="st"> </span><span class="kw">apply</span>(maps.values.clean, <span class="dv">1</span>, paste, <span class="dt">collapse=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb17-151" data-line-number="151">  <span class="kw">sink</span>(<span class="kw">paste0</span>(CLN.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/&quot;</span>, path, <span class="st">&quot;/Trajectories.txt&quot;</span>))</a>
<a class="sourceLine" id="cb17-152" data-line-number="152">  <span class="kw">print</span>(<span class="kw">table</span>(maps.strings))</a>
<a class="sourceLine" id="cb17-153" data-line-number="153">  <span class="kw">sink</span>()</a>
<a class="sourceLine" id="cb17-154" data-line-number="154"></a>
<a class="sourceLine" id="cb17-155" data-line-number="155">}</a>
<a class="sourceLine" id="cb17-156" data-line-number="156"></a>
<a class="sourceLine" id="cb17-157" data-line-number="157"></a>
<a class="sourceLine" id="cb17-158" data-line-number="158"><span class="co"># Nettoyage spatiale d&#39;une série d&#39;images -------------------------------------</span></a>
<a class="sourceLine" id="cb17-159" data-line-number="159"><span class="co">#</span></a>
<a class="sourceLine" id="cb17-160" data-line-number="160"><span class="co"># @description Supprimer les pixels de forêt/déforestion/régénération qui n&#39;ont </span></a>
<a class="sourceLine" id="cb17-161" data-line-number="161"><span class="co">#              JAMAIS fait partie de &quot;forêt &gt; 0,5 ha&quot; depuis 2003</span></a>
<a class="sourceLine" id="cb17-162" data-line-number="162"><span class="co">#</span></a>
<a class="sourceLine" id="cb17-163" data-line-number="163"><span class="co"># @param maps           Série des cartes</span></a>
<a class="sourceLine" id="cb17-164" data-line-number="164"><span class="co"># @param exclude        Cartes à ignorer</span></a>
<a class="sourceLine" id="cb17-165" data-line-number="165"><span class="co"># @param size           Nombre minimal de pixels connectés</span></a>
<a class="sourceLine" id="cb17-166" data-line-number="166"><span class="co"># @param connectedness  Nombre de pixels qui comptent comme connectés</span></a>
<a class="sourceLine" id="cb17-167" data-line-number="167"><span class="co">#</span></a>
<a class="sourceLine" id="cb17-168" data-line-number="168"><span class="co"># @return       -- </span></a>
<a class="sourceLine" id="cb17-169" data-line-number="169"><span class="co">#</span></a>
<a class="sourceLine" id="cb17-170" data-line-number="170"></a>
<a class="sourceLine" id="cb17-171" data-line-number="171"><span class="co"># </span></a>
<a class="sourceLine" id="cb17-172" data-line-number="172">clean.spatial.forest &lt;-<span class="st"> </span><span class="cf">function</span>(maps, <span class="dt">exclude =</span> <span class="ot">NULL</span>, <span class="dt">size=</span><span class="dv">6</span>, <span class="dt">connectedness=</span><span class="dv">8</span>){</a>
<a class="sourceLine" id="cb17-173" data-line-number="173">  </a>
<a class="sourceLine" id="cb17-174" data-line-number="174">  tmp1 &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">pattern =</span> <span class="st">&quot;&quot;</span>, <span class="dt">fileext =</span> <span class="st">&quot;.tif&quot;</span>)</a>
<a class="sourceLine" id="cb17-175" data-line-number="175">  tmp2 &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">pattern =</span> <span class="st">&quot;&quot;</span>, <span class="dt">fileext =</span> <span class="st">&quot;.tif&quot;</span>)</a>
<a class="sourceLine" id="cb17-176" data-line-number="176">  </a>
<a class="sourceLine" id="cb17-177" data-line-number="177">  fcc.map &lt;-<span class="st"> </span><span class="kw">apply</span>(maps[[<span class="op">-</span>exclude]][], <span class="dv">1</span>, paste, <span class="dt">collapse=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb17-178" data-line-number="178">  onceforest.map &lt;-<span class="st"> </span><span class="kw">raster</span>(maps)</a>
<a class="sourceLine" id="cb17-179" data-line-number="179">  onceforest.map[] &lt;-<span class="st"> </span><span class="ot">NA</span> </a>
<a class="sourceLine" id="cb17-180" data-line-number="180">  </a>
<a class="sourceLine" id="cb17-181" data-line-number="181">  <span class="co"># créer une carte &quot;forêt une fois&quot;</span></a>
<a class="sourceLine" id="cb17-182" data-line-number="182">  onceforest.map[<span class="kw">grepl</span>(<span class="kw">paste0</span>(<span class="st">&quot;^&quot;</span>, NONFOR, <span class="st">&quot;*$&quot;</span>),    fcc.map)] &lt;-<span class="st"> </span>NONFOR</a>
<a class="sourceLine" id="cb17-183" data-line-number="183">  onceforest.map[<span class="kw">grepl</span>(<span class="kw">paste0</span>(<span class="st">&quot;^.*&quot;</span>, FOREST, <span class="st">&quot;.*$&quot;</span>), fcc.map)] &lt;-<span class="st"> </span>FOREST</a>
<a class="sourceLine" id="cb17-184" data-line-number="184">  onceforest.map[<span class="kw">grepl</span>(<span class="kw">paste0</span>(<span class="st">&quot;^.*&quot;</span>, PREGEN, <span class="st">&quot;.*$&quot;</span>), fcc.map)] &lt;-<span class="st"> </span>FOREST</a>
<a class="sourceLine" id="cb17-185" data-line-number="185">  <span class="kw">writeRaster</span>(onceforest.map, tmp1)</a>
<a class="sourceLine" id="cb17-186" data-line-number="186">  </a>
<a class="sourceLine" id="cb17-187" data-line-number="187">  <span class="co"># supprimer les parcelles de forêt isolées &lt; xy ha</span></a>
<a class="sourceLine" id="cb17-188" data-line-number="188">  <span class="kw">system</span>(<span class="kw">paste0</span>(<span class="st">&quot;gdal_sieve.py -st &quot;</span>, size, <span class="st">&quot; -&quot;</span>, connectedness, <span class="st">&quot; -nomask &quot;</span>, tmp1, <span class="st">&quot; &quot;</span>, tmp2))</a>
<a class="sourceLine" id="cb17-189" data-line-number="189">  onceforest.map.clean &lt;-<span class="st"> </span><span class="kw">raster</span>(tmp2)</a>
<a class="sourceLine" id="cb17-190" data-line-number="190">  onceforest.map.clean[onceforest.map.clean <span class="op">==</span><span class="st"> </span><span class="dv">-2147483648</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb17-191" data-line-number="191">                                                        </a>
<a class="sourceLine" id="cb17-192" data-line-number="192">  <span class="co"># masquer les cartes avec cette carte forestière nettoyée</span></a>
<a class="sourceLine" id="cb17-193" data-line-number="193">  maps.clean &lt;-<span class="st"> </span><span class="kw">mask</span>(maps, onceforest.map.clean, <span class="dt">maskvalue=</span>NONFOR, <span class="dt">updatevalue=</span>NONFOR)</a>
<a class="sourceLine" id="cb17-194" data-line-number="194">  <span class="kw">writeRaster</span>(maps.clean, <span class="dt">filename=</span><span class="kw">paste0</span>(CLN.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/TGO/&quot;</span>, <span class="kw">names</span>(maps.clean), <span class="st">&quot;f.tif&quot;</span>), </a>
<a class="sourceLine" id="cb17-195" data-line-number="195">              <span class="dt">bylayer=</span><span class="ot">TRUE</span>, <span class="dt">format=</span><span class="st">&quot;GTiff&quot;</span>, <span class="dt">datatype=</span><span class="st">&quot;INT2U&quot;</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-196" data-line-number="196">  </a>
<a class="sourceLine" id="cb17-197" data-line-number="197">}</a>
<a class="sourceLine" id="cb17-198" data-line-number="198"></a>
<a class="sourceLine" id="cb17-199" data-line-number="199"></a>
<a class="sourceLine" id="cb17-200" data-line-number="200"><span class="co"># COMMENCER LE TRAITEMENT #####################################################</span></a>
<a class="sourceLine" id="cb17-201" data-line-number="201"></a>
<a class="sourceLine" id="cb17-202" data-line-number="202"><span class="co"># changer l&#39;étendue de p192_2019 à l&#39;étendue des autres images p192 -----------</span></a>
<a class="sourceLine" id="cb17-203" data-line-number="203"><span class="co"># </span><span class="al">TODO</span><span class="co"> : à faire déjà dans 01_SSTS/01_data/_src/prep-Landsat.R</span></a>
<a class="sourceLine" id="cb17-204" data-line-number="204"><span class="kw">extend</span>(<span class="kw">brick</span>(<span class="kw">paste0</span>(RAW.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/p192/p192_2019_F&quot;</span>, COV.FC, <span class="st">&quot;r.tif&quot;</span>)), <span class="kw">raster</span>(<span class="kw">paste0</span>(RAW.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/p192/p192_2018_F&quot;</span>, COV.FC, <span class="st">&quot;r.tif&quot;</span>)), </a>
<a class="sourceLine" id="cb17-205" data-line-number="205">       <span class="dt">filename=</span><span class="kw">paste0</span>(RAW.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/p192/p192_2019_F&quot;</span>, COV.FC, <span class="st">&quot;rt.tif&quot;</span>), <span class="dt">format=</span><span class="st">&quot;GTiff&quot;</span>, <span class="dt">datatype=</span><span class="st">&quot;INT2U&quot;</span>)</a>
<a class="sourceLine" id="cb17-206" data-line-number="206"><span class="kw">file.rename</span>(<span class="kw">paste0</span>(RAW.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/p192/p192_2019_F&quot;</span>, COV.FC, <span class="st">&quot;rt.tif&quot;</span>), <span class="kw">paste0</span>(RAW.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/p192/p192_2019_F&quot;</span>, COV.FC, <span class="st">&quot;r.tif&quot;</span>))</a>
<a class="sourceLine" id="cb17-207" data-line-number="207"></a>
<a class="sourceLine" id="cb17-208" data-line-number="208"><span class="co"># Nettoyage temporel des chemins ----------------------------------------------</span></a>
<a class="sourceLine" id="cb17-209" data-line-number="209"><span class="cf">for</span>(path <span class="cf">in</span> <span class="kw">c</span>(<span class="st">&quot;p192&quot;</span>, <span class="st">&quot;p193&quot;</span>, <span class="st">&quot;p194&quot;</span>)) {</a>
<a class="sourceLine" id="cb17-210" data-line-number="210">  <span class="kw">clean.temporal</span>(path)</a>
<a class="sourceLine" id="cb17-211" data-line-number="211">} </a>
<a class="sourceLine" id="cb17-212" data-line-number="212"></a>
<a class="sourceLine" id="cb17-213" data-line-number="213"><span class="co"># Fusionner les cartes p192, p193 et p194 pour les dates conjointes -----------</span></a>
<a class="sourceLine" id="cb17-214" data-line-number="214"><span class="cf">for</span>(year <span class="cf">in</span> YEARS.JNT) {</a>
<a class="sourceLine" id="cb17-215" data-line-number="215">  <span class="kw">merge</span>(<span class="kw">mask</span>(<span class="kw">crop</span>(<span class="kw">brick</span>(<span class="kw">paste0</span>(CLN.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/p193/p193_&quot;</span>, year, <span class="st">&quot;_F&quot;</span>, COV.FC, <span class="st">&quot;c.tif&quot;</span>)), TGO), TGO),</a>
<a class="sourceLine" id="cb17-216" data-line-number="216">        <span class="kw">mask</span>(<span class="kw">crop</span>(<span class="kw">brick</span>(<span class="kw">paste0</span>(CLN.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/p192/p192_&quot;</span>, year, <span class="st">&quot;_F&quot;</span>, COV.FC, <span class="st">&quot;c.tif&quot;</span>)), TGO), TGO),</a>
<a class="sourceLine" id="cb17-217" data-line-number="217">        <span class="kw">mask</span>(<span class="kw">crop</span>(<span class="kw">brick</span>(<span class="kw">paste0</span>(CLN.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/p194/p194_&quot;</span>, year, <span class="st">&quot;_F&quot;</span>, COV.FC, <span class="st">&quot;c.tif&quot;</span>)), TGO), TGO),</a>
<a class="sourceLine" id="cb17-218" data-line-number="218">        <span class="dt">filename=</span><span class="kw">paste0</span>(CLN.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/TGO/TGO_&quot;</span>, year, <span class="st">&quot;_F&quot;</span>, COV.FC, <span class="st">&quot;c.tif&quot;</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-219" data-line-number="219">}</a>
<a class="sourceLine" id="cb17-220" data-line-number="220"></a>
<a class="sourceLine" id="cb17-221" data-line-number="221"><span class="co"># Spatial cleaning of results (only from 2003 onwards) -----------------------------------</span></a>
<a class="sourceLine" id="cb17-222" data-line-number="222"><span class="co"># exclure la première couche (1987) pour la création du masque forêt/non-forêt  </span></a>
<a class="sourceLine" id="cb17-223" data-line-number="223"><span class="kw">clean.spatial.forest</span>(<span class="dt">maps =</span> <span class="kw">stack</span>(<span class="kw">dir</span>(<span class="kw">paste0</span>(CLN.DIR, <span class="st">&quot;/FC&quot;</span>, COV.FC, <span class="st">&quot;/TGO&quot;</span>), <span class="dt">pattern =</span> <span class="st">&quot;c</span><span class="ch">\\</span><span class="st">.tif&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)),</a>
<a class="sourceLine" id="cb17-224" data-line-number="224">                     <span class="dt">exclude =</span> <span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">size =</span> <span class="dv">6</span>, <span class="dt">connectedness =</span> <span class="dv">8</span>) </a></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="01_create-FC-maps.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="03_validate-FC-maps.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true,
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
